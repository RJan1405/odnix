{% extends 'chat/base.html' %}
{% load static %}

{% block title %}Omzo - Odnix{% endblock %}

{% block extra_head %}
<style>
    /* Omzo specific styles */
    .omzo-wrapper {
        background: #000;
        min-height: 100vh;
        display: flex;
        justify-content: center;
    }

    .omzo-container {
        height: 100vh;
        /* Fallback */
        height: 100dvh;
        /* Dynamic viewport height */
        width: 100%;
        max-width: 450px;
        /* Mobile width constraint on desktop */
        overflow-y: scroll;
        scroll-snap-type: y mandatory;
        background: #000;
        position: relative;
        /* Hide scrollbar */
        scrollbar-width: none;
        /* Firefox */
        -ms-overflow-style: none;
        /* IE and Edge */
    }

    .omzo-container::-webkit-scrollbar {
        display: none;
    }

    .reel-item {
        height: 100%;
        width: 100%;
        scroll-snap-align: start;
        scroll-snap-stop: always;
        position: relative;
        display: flex;
        align-items: center;
        justify-content: center;
        background: #111;
    }

    .reel-video {
        width: 100%;
        height: 100%;
        object-fit: cover;
        /* Immersive full screen */
    }

    .reel-play-overlay {
        position: absolute;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
        display: none;
        align-items: center;
        justify-content: center;
        background: rgba(0, 0, 0, 0.3);
        cursor: pointer;
        z-index: 15;
    }

    .reel-video:paused~.reel-play-overlay {
        display: flex;
    }

    /* Overlays */
    .reel-overlay {
        position: absolute;
        bottom: 0;
        left: 0;
        right: 0;
        padding: 20px;
        background: linear-gradient(transparent, rgba(0, 0, 0, 0.8));
        color: white;
        z-index: 10;
        padding-bottom: 80px;
        /* Space for navbar if visible */
        pointer-events: none;
        /* Let clicks pass through to video */
    }

    .reel-info {
        pointer-events: auto;
    }

    .reel-actions {
        position: absolute;
        right: 16px;
        bottom: 120px;
        display: flex;
        flex-direction: column;
        gap: 20px;
        z-index: 20;
    }

    .action-btn {
        display: flex;
        flex-direction: column;
        align-items: center;
        color: white;
        background: none;
        border: none;
        cursor: pointer;
        font-size: 13px;
        font-weight: 500;
        text-shadow: 0 1px 2px rgba(0, 0, 0, 0.5);
        padding: 8px;
        border-radius: 50%;
        transition: background 0.2s, transform 0.2s;
        min-width: 56px;
        min-height: 56px;
    }

    .action-btn:hover {
        background: rgba(255, 255, 255, 0.1);
    }

    .action-btn i,
    .action-btn svg {
        width: 28px !important;
        height: 28px !important;
        margin-bottom: 4px;
        filter: drop-shadow(0 2px 4px rgba(0, 0, 0, 0.5));
        transition: transform 0.2s;
    }

    .action-btn:active {
        transform: scale(0.9);
    }

    .action-btn:active i,
    .action-btn:active svg {
        transform: scale(0.9);
    }

    /* Desktop improvements for action buttons */
    @media (min-width: 768px) {
        .action-btn {
            min-width: 64px;
            min-height: 64px;
            padding: 12px;
        }

        .action-btn i,
        .action-btn svg {
            width: 32px !important;
            height: 32px !important;
        }

        .reel-actions {
            right: 20px;
            gap: 16px;
        }
    }

    .reel-user {
        display: flex;
        align-items: center;
        gap: 10px;
        margin-bottom: 12px;
        font-weight: 600;
    }

    .reel-avatar {
        width: 36px;
        height: 36px;
        border-radius: 50%;
        border: 2px solid white;
    }

    .reel-caption {
        font-size: 14px;
        margin-bottom: 10px;
        line-height: 1.4;
        text-shadow: 0 1px 2px rgba(0, 0, 0, 0.8);
    }

    .reel-audio {
        display: flex;
        align-items: center;
        gap: 8px;
        font-size: 13px;
        opacity: 0.9;
    }

    .upload-fab {
        position: fixed;
        top: 90px;
        right: 30px;
        z-index: 100;
        background: var(--odnix-gradient);
        width: 56px;
        height: 56px;
        border-radius: 50%;
        display: flex;
        align-items: center;
        justify-content: center;
        color: white;
        cursor: pointer;
        box-shadow: 0 4px 20px rgba(0, 0, 0, 0.4);
        transition: transform 0.2s;
    }

    .upload-fab:hover {
        transform: scale(1.1);
    }

    /* Hide desktop navbar elements for immersion */
    .sidebar-enhanced {
        display: none !important;
    }

    /* Adjust bottom nav for mobile immersion */
    .liked-heart {
        fill: #ff3040;
        color: #ff3040;
    }

    /* ===== Custom Toast Notifications for Omzo ===== */
    .reel-toast-container {
        position: fixed;
        top: 80px;
        left: 50%;
        transform: translateX(-50%);
        z-index: 10000;
        display: flex;
        flex-direction: column;
        gap: 10px;
        pointer-events: none;
    }

    .reel-toast {
        background: rgba(30, 30, 30, 0.95);
        backdrop-filter: blur(20px);
        -webkit-backdrop-filter: blur(20px);
        color: white;
        padding: 14px 20px;
        border-radius: 12px;
        display: flex;
        align-items: center;
        gap: 12px;
        min-width: 280px;
        max-width: 400px;
        box-shadow: 0 8px 32px rgba(0, 0, 0, 0.4);
        animation: toastSlideIn 0.3s ease-out;
        pointer-events: auto;
        border: 1px solid rgba(255, 255, 255, 0.1);
    }

    .reel-toast.success {
        border-left: 4px solid #4ade80;
    }

    .reel-toast.error {
        border-left: 4px solid #f87171;
    }

    .reel-toast.info {
        border-left: 4px solid #60a5fa;
    }

    .reel-toast.uploading {
        border-left: 4px solid #fbbf24;
    }

    .reel-toast-icon {
        width: 24px;
        height: 24px;
        flex-shrink: 0;
    }

    .reel-toast.success .reel-toast-icon {
        color: #4ade80;
    }

    .reel-toast.error .reel-toast-icon {
        color: #f87171;
    }

    .reel-toast.info .reel-toast-icon {
        color: #60a5fa;
    }

    .reel-toast.uploading .reel-toast-icon {
        color: #fbbf24;
    }

    .reel-toast-content {
        flex: 1;
    }

    .reel-toast-title {
        font-weight: 600;
        font-size: 14px;
        margin-bottom: 2px;
    }

    .reel-toast-message {
        font-size: 13px;
        opacity: 0.9;
        line-height: 1.4;
    }

    .reel-toast-progress {
        height: 3px;
        background: rgba(255, 255, 255, 0.2);
        border-radius: 2px;
        margin-top: 8px;
        overflow: hidden;
    }

    .reel-toast-progress-bar {
        height: 100%;
        background: linear-gradient(90deg, #fbbf24, #f59e0b);
        border-radius: 2px;
        animation: progressPulse 1.5s ease-in-out infinite;
        width: 30%;
    }

    @keyframes toastSlideIn {
        from {
            transform: translateY(-20px);
            opacity: 0;
        }

        to {
            transform: translateY(0);
            opacity: 1;
        }
    }

    @keyframes toastSlideOut {
        from {
            transform: translateY(0);
            opacity: 1;
        }

        to {
            transform: translateY(-20px);
            opacity: 0;
        }
    }

    @keyframes progressPulse {

        0%,
        100% {
            width: 30%;
            margin-left: 0;
        }

        50% {
            width: 60%;
            margin-left: 20%;
        }
    }

    /* ===== Comments Modal ===== */
    .reel-comments-modal {
        display: none;
        position: fixed;
        bottom: 0;
        left: 0;
        right: 0;
        top: 0;
        background: rgba(0, 0, 0, 0.6);
        z-index: 2000;
        align-items: flex-end;
        justify-content: center;
    }

    .reel-comments-modal.show {
        display: flex;
    }

    .reel-comments-container {
        background: #1e1e1e;
        width: 100%;
        max-width: 450px;
        max-height: 70vh;
        border-radius: 20px 20px 0 0;
        display: flex;
        flex-direction: column;
        animation: slideUp 0.3s ease-out;
    }

    @keyframes slideUp {
        from {
            transform: translateY(100%);
        }

        to {
            transform: translateY(0);
        }
    }

    .reel-comments-header {
        padding: 16px 20px;
        border-bottom: 1px solid rgba(255, 255, 255, 0.1);
        display: flex;
        align-items: center;
        justify-content: space-between;
    }

    .reel-comments-header h3 {
        color: white;
        font-size: 16px;
        font-weight: 600;
        margin: 0;
    }

    .reel-comments-close {
        background: none;
        border: none;
        color: white;
        cursor: pointer;
        padding: 8px;
        border-radius: 50%;
        display: flex;
        align-items: center;
        justify-content: center;
    }

    .reel-comments-close:hover {
        background: rgba(255, 255, 255, 0.1);
    }

    .reel-comments-list {
        flex: 1;
        overflow-y: auto;
        padding: 16px 20px;
        min-height: 200px;
    }

    .reel-comment-item {
        display: flex;
        gap: 12px;
        margin-bottom: 16px;
    }

    .reel-comment-avatar {
        width: 36px;
        height: 36px;
        border-radius: 50%;
        object-fit: cover;
        flex-shrink: 0;
    }

    .reel-comment-content {
        flex: 1;
    }

    .reel-comment-username {
        color: white;
        font-weight: 600;
        font-size: 14px;
        margin-bottom: 2px;
    }

    .reel-comment-text {
        color: rgba(255, 255, 255, 0.9);
        font-size: 14px;
        line-height: 1.4;
    }

    .reel-comment-time {
        color: rgba(255, 255, 255, 0.5);
        font-size: 12px;
        margin-top: 4px;
    }

    .reel-comments-empty {
        text-align: center;
        padding: 40px 20px;
        color: rgba(255, 255, 255, 0.6);
    }

    .reel-comments-empty i,
    .reel-comments-empty svg {
        width: 48px;
        height: 48px;
        opacity: 0.5;
        margin-bottom: 12px;
    }

    .reel-comments-input-container {
        padding: 12px 16px;
        border-top: 1px solid rgba(255, 255, 255, 0.1);
        display: flex;
        gap: 12px;
        align-items: center;
        background: #262626;
    }

    .reel-comments-input {
        flex: 1;
        background: #3a3a3a;
        border: none;
        border-radius: 20px;
        padding: 10px 16px;
        color: white;
        font-size: 14px;
        outline: none;
    }

    .reel-comments-input::placeholder {
        color: rgba(255, 255, 255, 0.5);
    }

    .reel-comments-submit {
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        border: none;
        color: white;
        padding: 10px 16px;
        border-radius: 20px;
        font-weight: 600;
        font-size: 14px;
        cursor: pointer;
        transition: opacity 0.2s;
    }

    .reel-comments-submit:hover {
        opacity: 0.9;
    }

    .reel-comments-submit:disabled {
        opacity: 0.5;
        cursor: not-allowed;
    }

    /* ===== Caption Input Modal ===== */
    .caption-modal {
        display: none;
        position: fixed;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
        background: rgba(0, 0, 0, 0.8);
        z-index: 3000;
        align-items: center;
        justify-content: center;
        padding: 20px;
    }

    .caption-modal.show {
        display: flex;
    }

    .caption-modal-content {
        background: #1e1e1e;
        border-radius: 16px;
        width: 100%;
        max-width: 400px;
        overflow: hidden;
        animation: modalZoomIn 0.2s ease-out;
    }

    @keyframes modalZoomIn {
        from {
            transform: scale(0.9);
            opacity: 0;
        }

        to {
            transform: scale(1);
            opacity: 1;
        }
    }

    .caption-modal-header {
        padding: 16px 20px;
        border-bottom: 1px solid rgba(255, 255, 255, 0.1);
        display: flex;
        align-items: center;
        justify-content: space-between;
    }

    .caption-modal-header h3 {
        color: white;
        font-size: 18px;
        font-weight: 600;
        margin: 0;
    }

    .caption-modal-close {
        background: none;
        border: none;
        color: white;
        cursor: pointer;
        padding: 8px;
        opacity: 0.7;
    }

    .caption-modal-close:hover {
        opacity: 1;
    }

    .caption-modal-body {
        padding: 20px;
    }

    .caption-preview {
        margin-bottom: 16px;
        position: relative;
        border-radius: 12px;
        overflow: hidden;
        background: #000;
    }

    .caption-preview video {
        width: 100%;
        max-height: 200px;
        object-fit: contain;
    }

    .caption-input {
        width: 100%;
        background: #3a3a3a;
        border: none;
        border-radius: 12px;
        padding: 14px 16px;
        color: white;
        font-size: 14px;
        resize: none;
        min-height: 80px;
        outline: none;
        font-family: inherit;
    }

    .caption-input::placeholder {
        color: rgba(255, 255, 255, 0.5);
    }

    .caption-modal-actions {
        padding: 16px 20px;
        border-top: 1px solid rgba(255, 255, 255, 0.1);
        display: flex;
        gap: 12px;
    }

    .caption-modal-btn {
        flex: 1;
        padding: 12px;
        border-radius: 10px;
        font-size: 14px;
        font-weight: 600;
        cursor: pointer;
        transition: opacity 0.2s;
    }

    .caption-modal-btn.cancel {
        background: transparent;
        border: 1px solid rgba(255, 255, 255, 0.3);
        color: white;
    }

    .caption-modal-btn.submit {
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        border: none;
        color: white;
    }

    .caption-modal-btn:hover {
        opacity: 0.9;
    }

    /* ===== Report Modal & Options ===== */
    .report-modal {
        display: none;
        position: fixed;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
        background: rgba(0, 0, 0, 0.5);
        z-index: 3500;
        align-items: flex-end;
        /* show as bottom sheet */
        justify-content: center;
        padding: 20px;
    }

    .report-modal.show {
        display: flex;
    }

    .report-modal-content {
        background: #1e1e1e;
        border-radius: 20px 20px 0 0;
        width: 100%;
        max-width: 450px;
        /* match omzo container */
        max-height: 70vh;
        /* match comments sheet height */
        overflow: hidden;
        display: flex;
        flex-direction: column;
    }

    .report-modal-header {
        padding: 16px 20px;
        border-bottom: 1px solid rgba(255, 255, 255, 0.1);
        display: flex;
        align-items: center;
        justify-content: space-between;
    }

    .report-modal-header h3 {
        color: #fff;
        font-size: 18px;
        font-weight: 600;
        margin: 0;
    }

    .report-modal-body {
        padding: 16px 20px;
        background: #1e1e1e;
        color: #e5e7eb;
        overflow-y: auto;
        /* scrollable content */
        flex: 1;
        scrollbar-width: thin;
        scrollbar-color: #3a3a3a #141414;
    }

    .report-modal-body::-webkit-scrollbar {
        width: 10px;
    }

    .report-modal-body::-webkit-scrollbar-track {
        background: #141414;
    }

    .report-modal-body::-webkit-scrollbar-thumb {
        background: #3a3a3a;
        border-radius: 999px;
        border: 2px solid #141414;
    }

    .report-modal-body::-webkit-scrollbar-thumb:hover {
        background: #4a4a4a;
    }

    .report-reasons {
        display: grid;
        grid-template-columns: 1fr;
        gap: 10px;
        margin-bottom: 12px;
    }

    .report-reason-item {
        display: flex;
        align-items: center;
        gap: 10px;
        background: #262626;
        border: 1px solid rgba(255, 255, 255, 0.1);
        border-radius: 10px;
        padding: 10px 12px;
        cursor: pointer;
        transition: border-color 0.2s, background 0.2s;
    }

    .report-reason-item:hover {
        background: #2f2f2f;
        border-color: rgba(255, 255, 255, 0.18);
    }

    .report-description {
        width: 100%;
        background: #3a3a3a;
        border: 1px solid rgba(255, 255, 255, 0.12);
        border-radius: 10px;
        padding: 10px 12px;
        color: #e5e7eb;
        min-height: 70px;
        resize: vertical;
        outline: none;
        transition: border-color 0.2s, background 0.2s;
    }

    .report-description:focus {
        border-color: rgba(102, 126, 234, 0.5);
        background: #444;
    }

    .report-modal-actions {
        padding: 16px 20px;
        border-top: 1px solid rgba(255, 255, 255, 0.1);
        background: #262626;
        display: flex;
        gap: 12px;
    }

    .report-btn {
        flex: 1;
        padding: 12px;
        border-radius: 10px;
        font-size: 14px;
        font-weight: 600;
        cursor: pointer;
        transition: opacity 0.2s;
    }

    .report-btn.cancel {
        background: #3a3a3a;
        border: none;
        color: #fff;
    }

    .report-btn.submit {
        background: linear-gradient(135deg, #ef4444 0%, #f97316 100%);
        border: none;
        color: #fff;
    }
</style>
{% endblock %}

{% block content %}
<div class="omzo-wrapper">
    <!-- Navbar is included in base. For omzo we might want a minimal transparent header or just use absolute positioning -->

    <div class="omzo-container" id="omzoContainer">
        {% for reel in reels %}
        <div class="reel-item" data-id="{{ reel.id }}">
            <video class="reel-video" loop playsinline autoplay muted src="{{ reel.url }}"
                onclick="toggleReelPlay(this)"></video>

            <div class="reel-actions">
                <button class="action-btn mute-btn" onclick="toggleReelMute(this, event)" data-muted="false"
                    title="Toggle sound">
                    <i data-lucide="volume-x"></i>
                </button>
                <button class="action-btn" onclick="toggleReelLike({{ reel.id }}, this)" title="Like">
                    <i data-lucide="heart" class="{% if reel.is_liked %}liked-heart{% endif %}"></i>
                    <span class="like-count">{{ reel.likes }}</span>
                </button>
                <button class="action-btn" onclick="openReelComments({{ reel.id }})" title="Comments">
                    <i data-lucide="message-circle"></i>
                    <span class="comment-count" data-reel-id="{{ reel.id }}">{{ reel.comments_count }}</span>
                </button>
                <button class="action-btn" onclick="shareReel('{{ reel.url }}')" title="Share">
                    <i data-lucide="share-2"></i>
                    <span>Share</span>
                </button>
                <button class="action-btn" onclick="openReportModal({{ reel.id }})" title="More">
                    <i data-lucide="more-vertical"></i>
                    <span>Report</span>
                </button>
            </div>

            <div class="reel-overlay">
                <div class="reel-info">
                    <div class="reel-user">
                        <img src="{% if reel.user.profile_picture %}{{ reel.user.profile_picture.url }}{% else %}https://ui-avatars.com/api/?name={{ reel.user.username }}{% endif %}"
                            class="reel-avatar">
                        <span>{{ reel.user.username }}</span>
                        {% if user != reel.user %}
                        <button
                            style="background: transparent; border: 1px solid rgba(255,255,255,0.8); color: white; border-radius: 6px; padding: 4px 12px; font-size: 12px; font-weight: 600; margin-left: 10px; cursor: pointer;">Follow</button>
                        {% endif %}
                    </div>
                    {% if reel.caption %}
                    <p class="reel-caption">{{ reel.caption }}</p>
                    {% endif %}
                    <div class="reel-audio">
                        <i data-lucide="music-2" style="width: 14px; height: 14px;"></i>
                        <span style="font-weight: 500;">Original Audio â€¢ {{ reel.user.username }}</span>
                    </div>
                </div>
            </div>
        </div>
        {% empty %}
        <div class="reel-item" style="background: #000; color: white;">
            <div style="text-align: center; padding: 20px;">
                <i data-lucide="film" style="width: 64px; height: 64px; opacity: 0.5; margin-bottom: 20px;"></i>
                <h3>No Omzo yet</h3>
                <p style="opacity: 0.7; margin-top: 10px;">Be the first to create one!</p>
                <button onclick="document.getElementById('uploadReelInput').click()" style="margin-top: 20px; background: var(--odnix-gradient); border: none; padding: 10px 20px;
                border-radius: 20px; color: white; font-weight: 600; cursor: pointer;">Create
                    Reel</button>
                <p style="color: #ff4444; font-size: 12px; margin-top: 10px; font-weight: 500;">Note: Omzo should be 2
                    mins max</p>
            </div>
        </div>
        {% endfor %}
    </div>

    <!-- Error Modal -->
    <div id="errorModal"
        style="display: none; position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.8); z-index: 1000; align-items: center; justify-content: center;">
        <div
            style="background: #1e1e1e; padding: 25px; border-radius: 12px; max-width: 90%; width: 350px; text-align: center; border: 1px solid #333;">
            <div
                style="width: 50px; height: 50px; background: rgba(255, 68, 68, 0.1); border-radius: 50%; display: flex; align-items: center; justify-content: center; margin: 0 auto 15px;">
                <i data-lucide="alert-circle" style="color: #ff4444; width: 28px; height: 28px;"></i>
            </div>
            <h3 style="color: white; margin: 0 0 10px; font-size: 18px;">Video Too Long</h3>
            <p id="errorModalText" style="color: #bbb; font-size: 14px; margin-bottom: 20px; line-height: 1.5;"></p>
            <p
                style="color: #ff4444; font-size: 12px; margin-bottom: 20px; font-weight: 500; background: rgba(255, 68, 68, 0.05); padding: 8px; border-radius: 6px;">
                Note: Upload omzo only of 2 mins
            </p>
            <button onclick="closeErrorModal()"
                style="background: white; color: black; border: none; padding: 10px 24px; border-radius: 20px; font-weight: 600; cursor: pointer; width: 100%;">Got
                it</button>
        </div>
    </div>



    <!-- Upload FAB removed as per requirement -->
    <input type="file" id="uploadReelInput" accept="video/*" style="display: none;" onchange="handleReelUpload(this)">

    <!-- Toast Container -->
    <div class="reel-toast-container" id="reelToastContainer"></div>

    <!-- Comments Modal -->
    <div class="reel-comments-modal" id="reelCommentsModal" onclick="closeReelComments(event)">
        <div class="reel-comments-container" onclick="event.stopPropagation()">
            <div class="reel-comments-header">
                <h3>Comments</h3>
                <button class="reel-comments-close" onclick="closeReelComments()">
                    <i data-lucide="x" style="width: 20px; height: 20px;"></i>
                </button>
            </div>
            <div class="reel-comments-list" id="reelCommentsList">
                <!-- Comments will be loaded here -->
            </div>
            <div class="reel-comments-input-container">
                <input type="text" class="reel-comments-input" id="reelCommentInput" placeholder="Add a comment..."
                    onkeydown="if(event.key === 'Enter') submitReelComment()">
                <button class="reel-comments-submit" onclick="submitReelComment()">Post</button>
            </div>
        </div>
    </div>

    <!-- Caption Modal -->
    <div class="caption-modal" id="captionModal">
        <div class="caption-modal-content">
            <div class="caption-modal-header">
                <h3>New Reel</h3>
                <button class="caption-modal-close" onclick="closeCaptionModal()">
                    <i data-lucide="x" style="width: 20px; height: 20px;"></i>
                </button>
            </div>
            <div class="caption-modal-body">
                <div class="caption-preview">
                    <video id="captionPreviewVideo" muted loop></video>
                </div>
                <textarea class="caption-input" id="captionInput" placeholder="Write a caption for your reel..."
                    maxlength="500"></textarea>
            </div>
            <div class="caption-modal-actions">
                <button class="caption-modal-btn cancel" onclick="closeCaptionModal()">Cancel</button>
                <button class="caption-modal-btn submit" onclick="submitReel()">Share Reel</button>
            </div>
        </div>
    </div>

    <!-- Report Modal -->
    <div class="report-modal" id="reportModal" onclick="closeReportModal(event)">
        <div class="report-modal-content" onclick="event.stopPropagation()">
            <div class="report-modal-header">
                <h3>Report Omzo</h3>
                <button class="caption-modal-close" onclick="closeReportModal()"
                    style="background:none;border:none;color:#fff;cursor:pointer;padding:8px;">
                    <i data-lucide="x" style="width:20px;height:20px;"></i>
                </button>
            </div>
            <div class="report-modal-body">
                <div style="font-size:13px;opacity:.8;margin-bottom:10px;">Select a reason:</div>
                <div class="report-reasons">
                    <label class="report-reason-item"><input type="radio" name="reportReason" value="copyright">
                        <span>Copyright Infringement</span></label>
                    <label class="report-reason-item"><input type="radio" name="reportReason" value="spam">
                        <span>Spam</span></label>
                    <label class="report-reason-item"><input type="radio" name="reportReason" value="inappropriate">
                        <span>Inappropriate Content</span></label>
                    <label class="report-reason-item"><input type="radio" name="reportReason" value="harassment">
                        <span>Harassment or Bullying</span></label>
                    <label class="report-reason-item"><input type="radio" name="reportReason" value="violence">
                        <span>Violence or Threats</span></label>
                    <label class="report-reason-item"><input type="radio" name="reportReason" value="hate_speech">
                        <span>Hate Speech</span></label>
                    <label class="report-reason-item"><input type="radio" name="reportReason" value="false_info">
                        <span>False Information</span></label>
                    <label class="report-reason-item"><input type="radio" name="reportReason" value="other">
                        <span>Other</span></label>
                </div>
                <textarea id="reportDescription" class="report-description"
                    placeholder="Optional details (helps our review team)"></textarea>
            </div>
            <div class="report-modal-actions">
                <button class="report-btn cancel" onclick="closeReportModal()">Cancel</button>
                <button class="report-btn submit" onclick="submitReelReport()">Submit Report</button>
            </div>
        </div>
    </div>
</div>

<script>
    // Global state
    let currentReelId = null;
    let pendingReelFile = null;

    // --- NEW REELS LOGIC START ---
    // Optimistic: Default to TRUE (Sound On) if no preference is saved.
    // This attempts to play sound immediately. If browser blocks it, our fail-safe handles it.
    let storedSoundObj = localStorage.getItem('omzo_sound_unlocked');
    let soundUnlocked = storedSoundObj === null ? true : (storedSoundObj === 'true');

    // Safe autoplay
    function autoPlay(video) {
        // Try to respect preference
        video.muted = !soundUnlocked;

        var playPromise = video.play();
        if (playPromise !== undefined) {
            playPromise.catch(error => {
                // Browser blocked audio autoplay.
                // We MUST fall back to muted to allow playback.
                if (!video.muted) {
                    video.muted = true;
                    video.play().then(() => {
                        // Inform user ONLY if they expected sound (soundUnlocked is true)
                        if (soundUnlocked) {
                            showReelToast('Tap to Unmute', 'Browser blocked auto-sound', 'info', false);
                        }
                    });
                }
            });
        }
    }

    // Single source of truth for Icon Sync
    // When the browser or our code changes video.muted, this updates the icon.
    function syncMuteIcon(video) {
        const btn = video.closest('.reel-item').querySelector('.mute-btn');
        if (!btn) return;
        const icon = btn.querySelector('i') || btn.querySelector('svg');
        if (icon) {
            icon.setAttribute('data-lucide', video.muted ? 'volume-x' : 'volume-2');
            if (typeof lucide !== 'undefined') lucide.createIcons();
        }
    }

    // IntersectionObserver for reels
    const observer = new IntersectionObserver(entries => {
        entries.forEach(entry => {
            const video = entry.target.querySelector('video');
            if (!video) return;

            if (entry.isIntersecting) {
                // Attach sync listener
                video.onvolumechange = () => syncMuteIcon(video);

                // Trigger Autoplay
                autoPlay(video);

                // Initial sync
                syncMuteIcon(video);

            } else {
                video.pause();
                // We DO NOT reset soundUnlocked here. If user left sound on, it stays on for the next reel.
            }
        });
    }, { threshold: 0.6 });

    // Observe all reels
    document.addEventListener('DOMContentLoaded', () => {
        document.querySelectorAll('.reel-item').forEach(item => {
            observer.observe(item);
        });
        if (typeof lucide !== 'undefined') {
            lucide.createIcons();
        }
    });

    // Play/Pause on Tap
    function toggleReelPlay(video) {
        if (video.paused) {
            video.play();
        } else {
            video.pause();
        }
    }

    // Mute Button Logic
    function toggleReelMute(btn, e) {
        e.stopPropagation();
        const video = btn.closest('.reel-item').querySelector('video');

        video.muted = !video.muted;

        // UPDATE GLOBAL SESSION STATE
        // If user explicitly unmutes one video, they likely want the next ones to have sound too.
        // If they explicitly mute, they likely want silence.
        soundUnlocked = !video.muted;
        localStorage.setItem('omzo_sound_unlocked', soundUnlocked);

        const icon = btn.querySelector('i') || btn.querySelector('svg');
        if (icon) {
            icon.setAttribute('data-lucide', video.muted ? 'volume-x' : 'volume-2');
        }

        if (typeof lucide !== 'undefined') {
            lucide.createIcons();
        }
    }
    // --- NEW REELS LOGIC END ---

    // ===== Toast Notifications =====
    function showReelToast(title, message, type = 'info', persistent = false) {
        const container = document.getElementById('reelToastContainer');
        const toastId = 'toast-' + Date.now();

        const iconMap = {
            'success': 'check-circle',
            'error': 'alert-circle',
            'info': 'info',
            'uploading': 'upload'
        };

        const toast = document.createElement('div');
        toast.className = `reel-toast ${type}`;
        toast.id = toastId;
        toast.innerHTML = `
            <i data-lucide="${iconMap[type] || 'info'}" class="reel-toast-icon"></i>
            <div class="reel-toast-content">
                <div class="reel-toast-title">${title}</div>
                <div class="reel-toast-message">${message}</div>
                ${type === 'uploading' ? '<div class="reel-toast-progress"><div class="reel-toast-progress-bar"></div></div>' : ''}
            </div>
        `;

        container.appendChild(toast);

        if (typeof lucide !== 'undefined') {
            lucide.createIcons();
        }

        if (!persistent) {
            setTimeout(() => {
                removeToast(toastId);
            }, 4000);
        }

        return toastId;
    }

    function removeToast(toastId) {
        const toast = document.getElementById(toastId);
        if (toast) {
            toast.style.animation = 'toastSlideOut 0.3s ease-out forwards';
            setTimeout(() => toast.remove(), 300);
        }
    }

    // ===== Reel Upload Handling =====
    function handleReelUpload(input) {
        if (!input.files || !input.files[0]) return;

        const file = input.files[0];

        // Validate file size (100MB max)
        if (file.size > 100 * 1024 * 1024) {
            showReelToast('File Too Large', 'Please upload a video under 100MB.', 'error');
            input.value = '';
            return;
        }

        // Validate video duration
        const video = document.createElement('video');
        video.preload = 'metadata';

        video.onloadedmetadata = function () {
            URL.revokeObjectURL(video.src);

            if (video.duration > 120) {
                showReelToast('Video Too Long', 'Omzo must be 2 minutes or less.', 'error');
                input.value = '';
                return;
            }

            // Store the file and show caption modal
            pendingReelFile = file;
            openCaptionModal(file);
        };

        video.src = URL.createObjectURL(file);
    }

    function openCaptionModal(file) {
        const modal = document.getElementById('captionModal');
        const preview = document.getElementById('captionPreviewVideo');
        const captionInput = document.getElementById('captionInput');

        // Set preview
        preview.src = URL.createObjectURL(file);
        preview.play();

        // Clear previous caption
        captionInput.value = '';

        // Show modal
        modal.classList.add('show');

        if (typeof lucide !== 'undefined') {
            lucide.createIcons();
        }

        // Focus on caption input
        setTimeout(() => captionInput.focus(), 100);
    }

    function closeCaptionModal() {
        const modal = document.getElementById('captionModal');
        const preview = document.getElementById('captionPreviewVideo');

        modal.classList.remove('show');
        preview.pause();
        preview.src = '';
        pendingReelFile = null;

        // Reset file input
        document.getElementById('uploadReelInput').value = '';
    }

    function submitReel() {
        if (!pendingReelFile) return;

        const caption = document.getElementById('captionInput').value.trim();

        // Close caption modal
        closeCaptionModal();

        // Show uploading toast
        const toastId = showReelToast('Uploading Reel', 'Please wait while your reel is being processed...', 'uploading', true);

        const formData = new FormData();
        formData.append('video', pendingReelFile);
        formData.append('caption', caption);

        fetch('/chat/api/reels/upload/', {
            method: 'POST',
            body: formData,
            headers: { 'X-CSRFToken': '{{ csrf_token }}' }
        })
            .then(r => r.json())
            .then(data => {
                removeToast(toastId);

                if (data.success) {
                    showReelToast('Reel Posted!', 'Your reel has been shared successfully.', 'success');

                    // Reload after a short delay to show the success message
                    setTimeout(() => {
                        if (window.location.pathname.includes('/reels')) {
                            location.reload();
                        } else {
                            window.location.href = '{% url "reels" %}';
                        }
                    }, 1500);
                } else {
                    showReelToast('Upload Failed', data.error || 'Something went wrong. Please try again.', 'error');
                }
            })
            .catch(err => {
                removeToast(toastId);
                console.error(err);
                showReelToast('Upload Failed', 'Network error. Please check your connection.', 'error');
            });
    }

    // ===== Comments Functionality =====
    function openReelComments(reelId) {
        currentReelId = reelId;
        const modal = document.getElementById('reelCommentsModal');
        const list = document.getElementById('reelCommentsList');

        // Show modal
        modal.classList.add('show');

        // Show loading state
        list.innerHTML = '<div class="reel-comments-empty"><div style="color: rgba(255,255,255,0.6);">Loading comments...</div></div>';

        if (typeof lucide !== 'undefined') {
            lucide.createIcons();
        }

        // Fetch comments
        fetch(`/chat/api/reels/${reelId}/comments/`, {
            headers: { 'X-CSRFToken': '{{ csrf_token }}' }
        })
            .then(r => r.json())
            .then(data => {
                if (data.success && data.comments) {
                    renderComments(data.comments);
                } else {
                    list.innerHTML = `
                    <div class="reel-comments-empty">
                        <i data-lucide="message-circle"></i>
                        <p>No comments yet</p>
                        <p style="font-size: 13px; opacity: 0.7;">Be the first to comment!</p>
                    </div>
                `;
                }
                if (typeof lucide !== 'undefined') {
                    lucide.createIcons();
                }
            })
            .catch(err => {
                console.error(err);
                list.innerHTML = `
                <div class="reel-comments-empty">
                    <i data-lucide="message-circle"></i>
                    <p>No comments yet</p>
                    <p style="font-size: 13px; opacity: 0.7;">Be the first to comment!</p>
                </div>
            `;
                if (typeof lucide !== 'undefined') {
                    lucide.createIcons();
                }
            });
    }

    function renderComments(comments) {
        const list = document.getElementById('reelCommentsList');

        if (!comments || comments.length === 0) {
            list.innerHTML = `
                <div class="reel-comments-empty">
                    <i data-lucide="message-circle"></i>
                    <p>No comments yet</p>
                    <p style="font-size: 13px; opacity: 0.7;">Be the first to comment!</p>
                </div>
            `;
            return;
        }

        list.innerHTML = comments.map(c => `
            <div class="reel-comment-item">
                <img src="${c.user.avatar || 'https://ui-avatars.com/api/?name=' + c.user.username}" class="reel-comment-avatar">
                <div class="reel-comment-content">
                    <div class="reel-comment-username">${c.user.username}</div>
                    <div class="reel-comment-text">${c.content}</div>
                    <div class="reel-comment-time">${c.time_ago || ''}</div>
                </div>
            </div>
        `).join('');
    }

    function closeReelComments(event) {
        if (event && event.target !== event.currentTarget) return;
        const modal = document.getElementById('reelCommentsModal');
        modal.classList.remove('show');
        currentReelId = null;
        document.getElementById('reelCommentInput').value = '';
    }

    function submitReelComment() {
        if (!currentReelId) return;

        const input = document.getElementById('reelCommentInput');
        const text = input.value.trim();

        if (!text) return;

        // Disable submit button
        const submitBtn = document.querySelector('.reel-comments-submit');
        submitBtn.disabled = true;

        fetch('/chat/api/reels/comment/', {
            method: 'POST',
            body: JSON.stringify({ reel_id: currentReelId, content: text }),
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': '{{ csrf_token }}'
            }
        })
            .then(r => r.json())
            .then(data => {
                submitBtn.disabled = false;

                if (data.success) {
                    input.value = '';

                    // Update comment count on the reel
                    const countEl = document.querySelector(`.comment-count[data-reel-id="${currentReelId}"]`);
                    if (countEl && data.comments_count !== undefined) {
                        countEl.textContent = data.comments_count;
                    }

                    // Refresh comments
                    openReelComments(currentReelId);

                    showReelToast('Comment Posted', 'Your comment has been added.', 'success');
                } else {
                    showReelToast('Error', data.error || 'Failed to post comment.', 'error');
                }
            })
            .catch(err => {
                submitBtn.disabled = false;
                console.error(err);
                showReelToast('Error', 'Failed to post comment. Please try again.', 'error');
            });
    }

    // ===== Mute/Sound Controls =====




    // ===== Like Functionality =====
    function toggleReelLike(reelId, btn) {
        fetch('/chat/api/reels/like/', {
            method: 'POST',
            body: JSON.stringify({ reel_id: reelId }),
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': '{{ csrf_token }}'
            }
        })
            .then(r => r.json())
            .then(data => {
                if (data.success) {
                    const icon = btn.querySelector('svg') || btn.querySelector('i');
                    const count = btn.querySelector('.like-count');

                    if (data.is_liked) {
                        icon.style.fill = '#ff3040';
                        icon.style.color = '#ff3040';
                        icon.classList.add('liked-heart');
                    } else {
                        icon.style.fill = 'none';
                        icon.style.color = 'white';
                        icon.classList.remove('liked-heart');
                    }
                    count.textContent = data.likes_count;
                }
            });
    }

    // ===== Share Functionality =====
    function shareReel(url) {
        const fullUrl = window.location.origin + url;

        if (navigator.share) {
            navigator.share({
                title: 'Check out this reel on Odnix',
                url: fullUrl
            }).catch(console.error);
        } else {
            navigator.clipboard.writeText(fullUrl).then(() => {
                showReelToast('Link Copied', 'Reel link copied to clipboard!', 'success');
            }).catch(err => {
                console.error('Failed to copy: ', err);
                showReelToast('Error', 'Failed to copy link.', 'error');
            });
        }
    }

    // ===== Auto-play on scroll =====


    // ===== Error Modal (legacy, keeping for compatibility) =====
    function closeErrorModal() {
        document.getElementById('errorModal').style.display = 'none';
    }

    // ===== Report Reel =====
    function openReportModal(reelId) {
        currentReelId = reelId;
        const modal = document.getElementById('reportModal');
        modal.classList.add('show');
        if (typeof lucide !== 'undefined') { lucide.createIcons(); }
        // Clear previous selection
        document.querySelectorAll('input[name="reportReason"]').forEach(r => r.checked = false);
        document.getElementById('reportDescription').value = '';
    }

    function closeReportModal(event) {
        if (event && event.target !== event.currentTarget) return;
        const modal = document.getElementById('reportModal');
        modal.classList.remove('show');
    }

    function submitReelReport() {
        if (!currentReelId) return;
        const reasonEl = document.querySelector('input[name="reportReason"]:checked');
        const reason = reasonEl ? reasonEl.value : null;
        const description = document.getElementById('reportDescription').value.trim();

        if (!reason) {
            showReelToast('Select a Reason', 'Please choose a report reason.', 'error');
            return;
        }

        fetch('/chat/api/reels/report/', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': '{{ csrf_token }}'
            },
            body: JSON.stringify({ reel_id: currentReelId, reason: reason, description: description })
        })
            .then(r => r.json())
            .then(data => {
                if (data.success) {
                    showReelToast('Reported', 'Thanks. We will review this reel shortly.', 'success');
                    closeReportModal();
                } else {
                    showReelToast('Unable to Report', data.error || 'Please try again later.', 'error');
                }
            })
            .catch(err => {
                console.error(err);
                showReelToast('Error', 'Failed to submit report.', 'error');
            });
    }

    // ===== Initialize Omzo =====
    // Handle opening specific reel from Explore page
    window.addEventListener('DOMContentLoaded', () => {
        const urlParams = new URLSearchParams(window.location.search);
        const targetReelId = urlParams.get('reel');
        
        if (targetReelId) {
            // Find the reel and jump directly to it without scrolling animation
            const container = document.getElementById('omzoContainer');
            const reels = container.querySelectorAll('.reel-item');
            let targetIndex = -1;
            
            // Find the index of the target reel
            reels.forEach((reel, index) => {
                if (reel.getAttribute('data-id') === targetReelId) {
                    targetIndex = index;
                }
            });
            
            if (targetIndex !== -1) {
                // Jump directly to the reel without scroll animation
                // Each reel is full viewport height
                const scrollPosition = targetIndex * window.innerHeight;
                container.scrollTop = scrollPosition;
            } else {
                console.warn(`Reel ${targetReelId} not found in feed`);
            }
            
            // Clean up the URL to hide the reel parameter
            window.history.replaceState({}, document.title, window.location.pathname);
        }
    });

</script>
{% endblock %}