{% extends 'chat/base.html' %}
{% load static %}
{% load tweet_extras %}

{% block title %}Explore - Odnix{% endblock %}

{% block extra_head %}
<meta name="user-id" content="{{ user.id }}">
<meta name="csrf-token" content="{{ csrf_token }}">
<style>
    .sidebar-enhanced {
        display: none !important;
    }

    .bottom-navbar {
        display: none !important;
    }

    .ig-discover-container {
        padding-top: 90px;
        padding-bottom: 100px;
        min-height: 100vh;
        background: var(--ig-bg);
    }

    .ig-discover-content {
        max-width: 1100px;
        margin: 0 auto;
        padding: 0 var(--spacing-lg);
    }

    .ig-discover-header {
        margin-bottom: var(--spacing-xl);
        display: flex;
        flex-direction: column;
        gap: 8px;
    }

    .ig-discover-title {
        font-size: 28px;
        font-weight: 700;
        color: var(--ig-text-primary);
        margin: 0;
    }

    .ig-discover-subtitle {
        color: var(--ig-text-secondary);
        margin: 0;
    }

    .ig-explore-grid {
        display: grid;
        grid-template-columns: repeat(auto-fill, 300px);
        gap: var(--spacing-lg);
        justify-content: start;
    }

    .explore-card {
        background: var(--ig-surface);
        border: 1px solid var(--ig-border);
        border-radius: 16px;
        padding: 0;
        display: flex;
        flex-direction: column;
        gap: 0;
        box-shadow: 0 10px 30px rgba(0, 0, 0, 0.04);
        overflow: hidden;
        position: relative;
        aspect-ratio: 1;
        cursor: pointer;
        width: 100%;
    }

    .explore-card:hover {
        opacity: 0.9;
    }

    .explore-card-media-container {
        position: relative;
        width: 100%;
        height: 100%;
        overflow: hidden;
        background: #000;
    }

    .explore-card-media {
        width: 100%;
        height: 100%;
        object-fit: cover;
        display: block;
    }

    .explore-card-overlay {
        position: absolute;
        inset: 0;
        background: linear-gradient(180deg, transparent 50%, rgba(0,0,0,0.3) 100%);
        padding: 16px;
        display: flex;
        flex-direction: column;
        justify-content: flex-end;
        opacity: 0;
        transition: opacity 0.2s;
    }

    .explore-card:hover .explore-card-overlay {
        opacity: 1;
    }

    .explore-card-tag {
        align-self: flex-start;
        background: rgba(255, 255, 255, 0.2);
        backdrop-filter: blur(10px);
        color: white;
        border: 1px solid rgba(255, 255, 255, 0.3);
        padding: 4px 10px;
        border-radius: 999px;
        font-size: 11px;
        font-weight: 600;
        margin-bottom: 8px;
    }

    .explore-card-caption {
        color: white;
        font-size: 12px;
        line-height: 1.4;
        display: -webkit-box;
        -webkit-line-clamp: 2;
        -webkit-box-orient: vertical;
        overflow: hidden;
    }

    .explore-reel-play-icon {
        position: absolute;
        top: 50%;
        left: 50%;
        transform: translate(-50%, -50%);
        width: 48px;
        height: 48px;
        background: rgba(255, 255, 255, 0.3);
        backdrop-filter: blur(10px);
        border-radius: 50%;
        display: flex;
        align-items: center;
        justify-content: center;
        opacity: 0;
        transition: opacity 0.2s;
    }

    .explore-card:hover .explore-reel-play-icon {
        opacity: 1;
    }

    /* Hide people and groups by default */
    .explore-card[data-type="person"]:not(.search-active),
    .explore-card[data-type="group"]:not(.search-active) {
        display: none;
    }

    .explore-reel-play-icon i,
    .explore-reel-play-icon svg {
        width: 24px;
        height: 24px;
        color: white;
    }

    .ig-empty-state {
        text-align: center;
        padding: 60px 20px;
        color: var(--ig-text-secondary);
        border: 1px solid var(--ig-border);
        border-radius: 16px;
        background: var(--ig-surface);
        display: flex;
        flex-direction: column;
        gap: 12px;
        align-items: center;
    }

    .ig-empty-state h3 {
        margin: 0;
        color: var(--ig-text-primary);
    }

    .ig-empty-state p {
        margin: 0;
    }

    .ig-empty-state i,
    .ig-empty-state svg {
        width: 28px;
        height: 28px;
        color: var(--ig-text-secondary);
    }

    .ig-discover-search {
        display: flex;
        align-items: center;
        gap: 12px;
        background: var(--ig-input-bg);
        border: 1px solid var(--ig-border);
        border-radius: 24px;
        padding: 10px 16px;
        margin-top: 16px;
    }

    .ig-discover-search i,
    .ig-discover-search svg {
        width: 18px;
        height: 18px;
        color: var(--ig-text-secondary);
        flex-shrink: 0;
    }

    .ig-discover-search input {
        flex: 1;
        background: none;
        border: none;
        outline: none;
        color: var(--ig-text-primary);
        font-size: 14px;
        font-family: inherit;
    }

    .ig-discover-search input::placeholder {
        color: var(--ig-text-secondary);
    }

    .ig-search-no-results {
        text-align: center;
        padding: 40px 20px;
        color: var(--ig-text-secondary);
    }

    .ig-search-no-results i,
    .ig-search-no-results svg {
        width: 40px;
        height: 40px;
        opacity: 0.5;
        margin-bottom: 12px;
    }

    /* Post Modal Styles */
    .post-modal-overlay {
        display: none;
        position: fixed;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
        background: rgba(0, 0, 0, 0.5);
        z-index: 1000;
        align-items: center;
        justify-content: center;
        padding: 20px;
        overflow-y: auto;
    }

    .post-modal-overlay.show {
        display: flex;
    }

    .post-modal-content {
        background: var(--ig-surface);
        border-radius: 16px;
        width: 100%;
        max-width: 600px;
        max-height: 90vh;
        overflow: hidden;
        position: relative;
        display: flex;
        flex-direction: column;
    }

    .post-modal-close {
        position: absolute;
        top: 16px;
        right: 16px;
        background: var(--ig-surface-hover);
        border: 1px solid var(--ig-border);
        border-radius: 50%;
        width: 36px;
        height: 36px;
        display: flex;
        align-items: center;
        justify-content: center;
        cursor: pointer;
        z-index: 10;
        transition: background 0.2s;
    }

    .post-modal-close:hover {
        background: var(--ig-bg);
    }

    .post-modal-close i,
    .post-modal-close svg {
        width: 20px;
        height: 20px;
        color: var(--ig-text-primary);
    }

    .post-modal-body {
        padding: 0;
        display: flex;
        flex-direction: column;
        max-height: 90vh;
    }

    .post-modal-image-section {
        flex-shrink: 0;
        background: #000;
    }

    .post-modal-info {
        flex: 1;
        overflow-y: auto;
        padding: 16px;
    }

    .post-modal-actions {
        flex-shrink: 0;
        padding: 12px 16px;
        border-top: 1px solid var(--ig-border);
        display: flex;
        gap: 0;
    }

    .post-modal-action-btn {
        flex: 1;
        display: flex;
        align-items: center;
        justify-content: center;
        gap: 8px;
        padding: 12px;
        background: none;
        border: none;
        color: var(--ig-text-primary);
        cursor: pointer;
        font-size: 13px;
        transition: background 0.2s;
    }

    .post-modal-action-btn:hover {
        background: var(--ig-surface-hover);
    }

    .post-modal-action-btn.liked {
        color: #e63946;
    }

    .post-modal-comments-section {
        flex: 1;
        overflow-y: auto;
        padding: 16px;
        border-top: 1px solid var(--ig-border);
        max-height: 300px;
    }

    .post-modal-comment-item {
        padding: 12px 0;
        border-bottom: 1px solid var(--ig-border);
    }

    .post-modal-comment-item:last-child {
        border-bottom: none;
    }

    .post-modal-comment-input {
        flex-shrink: 0;
        padding: 12px 16px;
        border-top: 1px solid var(--ig-border);
        display: flex;
        gap: 8px;
        align-items: center;
    }

    .post-modal-comment-input input {
        flex: 1;
        background: var(--ig-bg);
        border: 1px solid var(--ig-border);
        border-radius: 20px;
        padding: 8px 16px;
        color: var(--ig-text-primary);
        font-size: 13px;
        outline: none;
    }

    .post-modal-comment-input input::placeholder {
        color: var(--ig-text-secondary);
    }

    .post-modal-comment-input button {
        background: none;
        border: none;
        color: var(--ig-link);
        font-weight: 600;
        font-size: 13px;
        cursor: pointer;
        padding: 8px 12px;
    }

    .post-modal-comment-input button:disabled {
        opacity: 0.3;
        cursor: default;
    }


    .post-modal-header {
        display: flex;
        gap: 12px;
        align-items: center;
        margin-bottom: 16px;
        padding-bottom: 16px;
        border-bottom: 1px solid var(--ig-border);
    }

    .post-modal-avatar {
        width: 40px;
        height: 40px;
        border-radius: 50%;
        object-fit: cover;
    }

    .post-modal-user-info {
        flex: 1;
    }

    .post-modal-username {
        font-weight: 700;
        color: var(--ig-text-primary);
        font-size: 14px;
    }

    .post-modal-time {
        color: var(--ig-text-secondary);
        font-size: 12px;
    }

    .post-modal-image {
        width: 100%;
        border-radius: 12px;
        margin-bottom: 16px;
    }

    .post-modal-caption {
        color: var(--ig-text-primary);
        line-height: 1.5;
        margin-bottom: 16px;
    }

    .post-modal-stats {
        display: flex;
        gap: 20px;
        padding-top: 16px;
        border-top: 1px solid var(--ig-border);
        color: var(--ig-text-secondary);
        font-size: 13px;
    }

    .post-modal-loading {
        text-align: center;
        padding: 40px 20px;
        color: var(--ig-text-secondary);
    }

    @media (max-width: 768px) {
        .ig-discover-container {
            padding-top: 72px;
            padding-bottom: 80px;
        }

        .ig-discover-content {
            padding: 0 var(--spacing-md);
        }

        .ig-discover-title {
            font-size: 24px;
        }

        .ig-explore-grid {
            grid-template-columns: 1fr;
        }

        .explore-reel-video {
            height: 500px;
        }

        .ig-bottom-nav {
            display: flex !important;
            align-items: center;
            justify-content: space-around;
        }

        .ig-top-nav {
            display: none !important;
        }
    }
</style>
{% endblock %}

{% block content %}
{% include 'chat/partials/navbar.html' %}

<div class="ig-discover-container">
    <div class="ig-discover-content">
        <header class="ig-discover-header">
            <h1 class="ig-discover-title">Explore</h1>
            <p class="ig-discover-subtitle">Dive into random Scribes and Omzo picks.</p>
            <div class="ig-discover-search">
                <i data-lucide="search"></i>
                <input type="text" id="exploreSearchInput" placeholder="Search people, groups, scribes, omzo..." 
                    onkeyup="filterExploreContent(this.value)">
            </div>
        </header>

        {% if mixed_content %}
        <div class="ig-explore-grid" id="exploreGrid">
            {% for item in mixed_content %}
                {% if item.type == 'scribe' %}
                    {% with scribe=item.object %}
                    <article class="explore-card" data-type="scribe" data-search-text="{{ scribe.user.full_name|default:scribe.user.username }} @{{ scribe.user.username }} {{ scribe.content }}" onclick="openScribePost({{ scribe.id }})">
                        <div class="explore-card-media-container">
                            {% if scribe.image_url %}
                            <img src="{{ scribe.image_url }}" alt="Scribe media" loading="lazy" class="explore-card-media">
                            {% else %}
                            <div class="explore-card-media" style="background: var(--ig-surface-hover); display: flex; align-items: center; justify-content: center;">
                                <i data-lucide="image" style="width: 48px; height: 48px; opacity: 0.3;"></i>
                            </div>
                            {% endif %}
                            <div class="explore-card-overlay">
                                <div class="explore-card-tag">Scribe</div>
                                {% if scribe.content %}
                                <div class="explore-card-caption">{{ scribe.content|truncatewords:15 }}</div>
                                {% endif %}
                            </div>
                        </div>
                    </article>
                    {% endwith %}
                {% elif item.type == 'reel' %}
                    {% with reel=item.object %}
                    <article class="explore-card" data-type="reel" data-search-text="{{ reel.user.full_name|default:reel.user.username }} @{{ reel.user.username }} {{ reel.caption }}" onclick="openReelInOmzo({{ reel.id }})">
                        <div class="explore-card-media-container">
                            {% if reel.video_file %}
                            <video class="explore-card-media" muted autoplay loop playsinline onclick="event.stopPropagation(); openReelInOmzo({{ reel.id }})">
                                <source src="{{ reel.video_file.url }}" type="video/mp4">
                            </video>
                            <div class="explore-reel-play-icon" onclick="event.stopPropagation(); openReelInOmzo({{ reel.id }})">
                                <i data-lucide="play"></i>
                            </div>
                            {% else %}
                            <div class="explore-card-media" style="background: var(--ig-surface-hover); display: flex; align-items: center; justify-content: center;">
                                <i data-lucide="video" style="width: 48px; height: 48px; opacity: 0.3;"></i>
                            </div>
                            {% endif %}
                            <div class="explore-card-overlay">
                                <div class="explore-card-tag">Omzo</div>
                                {% if reel.caption %}
                                <div class="explore-card-caption">{{ reel.caption|truncatewords:15 }}</div>
                                {% endif %}
                            </div>
                        </div>
                    </article>
                    {% endwith %}
                {% elif item.type == 'person' %}
                    {% with person=item.object %}
                    <article class="explore-card" data-type="person" data-search-text="{{ person.full_name|default:person.username }} @{{ person.username }}" onclick="window.location.href='{% url 'user_profile' person.username %}'">
                        <div class="explore-card-media-container" style="background: linear-gradient(135deg, #f8f9fa 0%, #e9ecef 100%); display: flex; align-items: center; justify-content: center;">
                            <div style="text-align: center;">
                                {% if person.profile_picture %}
                                    <img src="{{ person.profile_picture.url }}" alt="{{ person.full_name }}" style="width: 80px; height: 80px; border-radius: 50%; object-fit: cover; margin-bottom: 12px;" onerror="this.style.display='none';">
                                {% else %}
                                    <div style="width: 80px; height: 80px; border-radius: 50%; background-color: var(--ig-surface); margin: 0 auto 12px; display: flex; align-items: center; justify-content: center; color: var(--ig-text-secondary);">
                                        <i data-lucide="user" style="width: 36px; height: 36px;"></i>
                                    </div>
                                {% endif %}
                                <div style="font-weight: 600; color: var(--ig-text-primary); font-size: 14px; margin-bottom: 4px;">{{ person.full_name|default:person.username }}</div>
                                <div style="color: var(--ig-text-secondary); font-size: 12px;">@{{ person.username }}</div>
                            </div>
                        </div>
                    </article>
                    {% endwith %}
                {% elif item.type == 'group' %}
                    {% with group=item.object %}
                    <article class="explore-card" data-type="group" data-search-text="{{ group.name }}" onclick="window.location.href='{% url 'chat_detail' group.id %}'">
                        <div class="explore-card-media-container" style="background: linear-gradient(135deg, #f8f9fa 0%, #e9ecef 100%); display: flex; align-items: center; justify-content: center;">
                            <div style="text-align: center;">
                                <div style="width: 80px; height: 80px; border-radius: 50%; background-color: var(--ig-surface); margin: 0 auto 12px; display: flex; align-items: center; justify-content: center;">
                                    <i data-lucide="users" style="width: 36px; height: 36px; color: var(--ig-text-secondary);"></i>
                                </div>
                                <div style="font-weight: 600; color: var(--ig-text-primary); font-size: 14px; margin-bottom: 4px;">{{ group.name }}</div>
                                <div style="color: var(--ig-text-secondary); font-size: 12px;">Group</div>
                            </div>
                        </div>
                    </article>
                    {% endwith %}
                {% endif %}
            {% endfor %}
        </div>
        {% else %}
        <div class="ig-empty-state">
            <i data-lucide="sparkles"></i>
            <h3>Nothing to explore yet</h3>
            <p>Post a Scribe or Omzo to be featured here.</p>
        </div>
        {% endif %}
    </div>
</div>

<!-- Post Modal -->
<div class="post-modal-overlay" id="postModal" onclick="closePostModal(event)">
    <div class="post-modal-content" onclick="event.stopPropagation()">
        <div class="post-modal-close" onclick="closePostModal()">
            <i data-lucide="x"></i>
        </div>
        <div class="post-modal-body" id="postModalBody">
            <div class="post-modal-loading">
                <div style="animation: spin 1s linear infinite;">
                    <i data-lucide="loader" style="width: 32px; height: 32px;"></i>
                </div>
                <p style="margin-top: 16px;">Loading post...</p>
            </div>
        </div>
    </div>
</div>

<style>
    @keyframes spin {
        from { transform: rotate(0deg); }
        to { transform: rotate(360deg); }
    }
</style>

<script>
// Open scribe/post detail in modal
function openScribePost(postId) {
    const modal = document.getElementById('postModal');
    const body = document.getElementById('postModalBody');
    
    // Show modal with loading state
    modal.classList.add('show');
    body.innerHTML = `
        <div class="post-modal-loading">
            <div style="animation: spin 1s linear infinite;">
                <i data-lucide="loader" style="width: 32px; height: 32px;"></i>
            </div>
            <p style="margin-top: 16px;">Loading post...</p>
        </div>
    `;
    
    if (typeof lucide !== 'undefined') {
        lucide.createIcons();
    }
    
    // Fetch post data
    fetch(`/chat/api/tweet/${postId}/`)
        .then(r => r.json())
        .then(data => {
            if (data.success && data.tweet) {
                const tweet = data.tweet;
                const isLiked = tweet.is_liked || false;
                
                body.innerHTML = `
                    <div style="display: flex; flex-direction: column; height: 100%; max-height: 90vh;">
                        <!-- Image Section -->
                        <div class="post-modal-image-section" style="flex-shrink: 0;">
                            ${tweet.image_url ? `<img src="${tweet.image_url}" alt="Post image" style="width: 100%; height: auto; max-height: 400px; object-fit: cover;">` : `<div style="width: 100%; height: 250px; background: var(--ig-surface-hover); display: flex; align-items: center; justify-content: center; color: var(--ig-text-secondary);"><i data-lucide="image" style="width: 48px; height: 48px; opacity: 0.3;"></i></div>`}
                        </div>

                        <!-- Info Section -->
                        <div class="post-modal-info" style="flex-shrink: 0;">
                            <div style="display: flex; align-items: center; gap: 12px; margin-bottom: 12px;">
                                <img src="${tweet.avatar || 'https://ui-avatars.com/api/?name=' + tweet.username}" style="width: 32px; height: 32px; border-radius: 50%; object-fit: cover;" onerror="this.style.display='none';">
                                <div>
                                    <div style="font-weight: 600; color: var(--ig-text-primary); font-size: 13px;">${tweet.full_name || tweet.username}</div>
                                    <div style="color: var(--ig-text-secondary); font-size: 12px;">@${tweet.username}</div>
                                </div>
                            </div>

                            ${tweet.content ? `<div style="color: var(--ig-text-primary); font-size: 14px; line-height: 1.5; margin-bottom: 12px;">${tweet.content}</div>` : ''}

                            <div style="display: flex; gap: 16px; font-size: 13px; color: var(--ig-text-secondary);">
                                <span id="likeCount${postId}"><strong style="color: var(--ig-text-primary);">${tweet.like_count || 0}</strong> Likes</span>
                                <span id="commentCount${postId}"><strong style="color: var(--ig-text-primary);">${tweet.comment_count || 0}</strong> Comments</span>
                                <span style="color: var(--ig-text-secondary); font-size: 11px;">${tweet.time_ago}</span>
                            </div>
                        </div>

                        <!-- Action Buttons -->
                        <div class="post-modal-actions">
                            <button class="post-modal-action-btn like-btn ${isLiked ? 'liked' : ''}" onclick="event.stopPropagation(); toggleLikeInModal(${postId}, this)" data-liked="${isLiked ? 'true' : 'false'}" data-post-id="${postId}">
                                <i data-lucide="heart" style="width: 18px; height: 18px; ${isLiked ? 'fill: currentColor;' : ''};"></i>
                                <span>Like</span>
                            </button>
                            <button class="post-modal-action-btn" onclick="event.stopPropagation(); document.getElementById('commentInput${postId}').focus()">
                                <i data-lucide="message-circle" style="width: 18px; height: 18px;"></i>
                                <span>Comment</span>
                            </button>
                        </div>

                        <!-- Comments Section -->
                        <div class="post-modal-comments-section" id="commentsSection${postId}">
                            <div style="text-align: center; padding: 20px; color: var(--ig-text-secondary);">
                                <i data-lucide="loader" style="width: 24px; height: 24px; animation: spin 1s linear infinite;"></i>
                            </div>
                        </div>

                        <!-- Comment Input -->
                        <div class="post-modal-comment-input">
                            <input type="text" id="commentInput${postId}" placeholder="Add a comment..." onkeypress="if(event.key === 'Enter' && this.value.trim()) { postComment(${postId}, this.value); this.value = ''; }">
                            <button onclick="event.stopPropagation(); const input = document.getElementById('commentInput${postId}'); if(input.value.trim()) { postComment(${postId}, input.value); input.value = ''; }" id="commentBtn${postId}">Post</button>
                        </div>
                    </div>
                `;
                
                // Load comments
                loadCommentsInModal(postId);
            } else {
                body.innerHTML = `
                    <div class="post-modal-loading">
                        <i data-lucide="alert-circle" style="width: 40px; height: 40px; opacity: 0.5;"></i>
                        <p style="margin-top: 12px;">Failed to load post</p>
                    </div>
                `;
            }
            
            if (typeof lucide !== 'undefined') {
                lucide.createIcons();
            }
        })
        .catch(err => {
            console.error(err);
            body.innerHTML = `
                <div class="post-modal-loading">
                    <i data-lucide="alert-circle" style="width: 40px; height: 40px; opacity: 0.5;"></i>
                    <p style="margin-top: 12px;">Error loading post</p>
                </div>
            `;
            if (typeof lucide !== 'undefined') {
                lucide.createIcons();
            }
        });
}

// Toggle like on a post in modal
function toggleLikeInModal(postId, button) {
    const isLiked = button.getAttribute('data-liked') === 'true';
    
    fetch(`/chat/api/toggle-like/`, {
        method: 'POST',
        headers: {
            'X-CSRFToken': document.querySelector('meta[name="csrf-token"]').content,
            'Content-Type': 'application/json'
        },
        body: JSON.stringify({ tweet_id: postId })
    })
    .then(r => r.json())
    .then(data => {
        if (data.success) {
            const newIsLiked = !isLiked;
            button.setAttribute('data-liked', newIsLiked ? 'true' : 'false');
            if (newIsLiked) {
                button.classList.add('liked');
            } else {
                button.classList.remove('liked');
            }
            
            // Update like count
            const likeCountEl = document.getElementById('likeCount' + postId);
            if (likeCountEl && data.like_count !== undefined) {
                likeCountEl.innerHTML = `<strong style="color: var(--ig-text-primary);">${data.like_count}</strong> Likes`;
            }
            
            if (typeof lucide !== 'undefined') {
                lucide.createIcons();
            }
        }
    })
    .catch(err => console.error('Like error:', err));
}

// Load comments in modal
function loadCommentsInModal(postId) {
    const commentsSection = document.getElementById('commentsSection' + postId);
    if (!commentsSection) return;
    
    fetch(`/chat/api/tweet/${postId}/comments/`)
        .then(r => r.json())
        .then(data => {
            if (data.success && data.comments) {
                const comments = data.comments;
                if (comments.length === 0) {
                    commentsSection.innerHTML = `
                        <div style="text-align: center; padding: 20px; color: var(--ig-text-secondary);">
                            <i data-lucide="message-circle" style="width: 24px; height: 24px; opacity: 0.3; margin-bottom: 8px;"></i>
                            <div style="font-size: 13px;">No comments yet</div>
                            <div style="font-size: 12px; margin-top: 4px;">Be the first to comment!</div>
                        </div>
                    `;
                } else {
                    commentsSection.innerHTML = comments.map(comment => `
                        <div class="post-modal-comment-item">
                            <div style="display: flex; gap: 10px;">
                                <img src="${comment.avatar || 'https://ui-avatars.com/api/?name=' + comment.username}" style="width: 32px; height: 32px; border-radius: 50%; object-fit: cover; flex-shrink: 0;" onerror="this.style.display='none';">
                                <div style="flex: 1;">
                                    <div style="margin-bottom: 4px;">
                                        <span style="font-weight: 600; color: var(--ig-text-primary); font-size: 13px;">${comment.full_name || comment.username}</span>
                                        <span style="color: var(--ig-text-secondary); font-size: 12px; margin-left: 6px;">@${comment.username}</span>
                                    </div>
                                    <div style="color: var(--ig-text-primary); font-size: 13px; line-height: 1.4;">${comment.content || ''}</div>
                                    <div style="color: var(--ig-text-secondary); font-size: 11px; margin-top: 6px;">${comment.time_ago || ''}</div>
                                </div>
                            </div>
                        </div>
                    `).join('');
                }
            } else {
                commentsSection.innerHTML = `
                    <div style="text-align: center; padding: 20px; color: var(--ig-text-secondary);">
                        <i data-lucide="alert-circle" style="width: 24px; height: 24px; opacity: 0.3;"></i>
                        <div style="font-size: 13px; margin-top: 8px;">Failed to load comments</div>
                    </div>
                `;
            }
            if (typeof lucide !== 'undefined') {
                lucide.createIcons();
            }
        })
        .catch(err => {
            console.error('Comments error:', err);
            commentsSection.innerHTML = `
                <div style="text-align: center; padding: 20px; color: var(--ig-text-secondary);">
                    <i data-lucide="alert-circle" style="width: 24px; height: 24px; opacity: 0.3;"></i>
                    <div style="font-size: 13px; margin-top: 8px;">Error loading comments</div>
                </div>
            `;
            if (typeof lucide !== 'undefined') {
                lucide.createIcons();
            }
        });
}

// Post a comment
function postComment(postId, commentText) {
    if (!commentText || !commentText.trim()) return;
    
    fetch(`/chat/api/add-comment/`, {
        method: 'POST',
        headers: {
            'X-CSRFToken': document.querySelector('meta[name="csrf-token"]').content,
            'Content-Type': 'application/json'
        },
        body: JSON.stringify({
            tweet_id: postId,
            content: commentText.trim()
        })
    })
    .then(r => r.json())
    .then(data => {
        if (data.success) {
            // Reload comments to show the new one
            loadCommentsInModal(postId);
            
            // Update comment count
            const commentCountEl = document.getElementById('commentCount' + postId);
            if (commentCountEl && data.comment_count !== undefined) {
                commentCountEl.innerHTML = `<strong style="color: var(--ig-text-primary);">${data.comment_count}</strong> Comments`;
            }
        } else {
            alert('Failed to post comment');
        }
    })
    .catch(err => {
        console.error('Comment error:', err);
        alert('Error posting comment');
    });
}

// Toggle like on a post (kept for backwards compatibility)
function toggleLikePost(postId, button, event) {
    if (event) event.stopPropagation();
    toggleLikeInModal(postId, button);
}

// Toggle comments view (kept for backwards compatibility)
function toggleCommentsView(postId) {
    openViewComments(postId);
}

// Load and display comments for a post
function loadComments(postId) {
    const commentsSection = document.getElementById('commentsSection');
    
    fetch(`/chat/api/tweet/${postId}/comments/`)
        .then(r => r.json())
        .then(data => {
            if (data.success && data.comments) {
                const comments = data.comments;
                if (comments.length === 0) {
                    commentsSection.innerHTML = `
                        <div style="text-align: center; padding: 20px; color: var(--ig-text-secondary);">
                            <i data-lucide="message-circle" style="width: 24px; height: 24px; opacity: 0.5; display: block; margin-bottom: 8px;"></i>
                            No comments yet
                        </div>
                    `;
                } else {
                    commentsSection.innerHTML = comments.map(comment => `
                        <div style="padding: 12px; border-bottom: 1px solid var(--ig-border);">
                            <div style="display: flex; gap: 8px; margin-bottom: 8px;">
                                <img src="${comment.avatar || 'https://ui-avatars.com/api/?name=' + comment.username}" style="width: 28px; height: 28px; border-radius: 50%; object-fit: cover;" onerror="this.style.display='none';">
                                <div style="flex: 1;">
                                    <div style="font-weight: 500; color: var(--ig-text-primary); font-size: 13px;">
                                        ${comment.full_name || comment.username}
                                        <span style="color: var(--ig-text-secondary); font-weight: normal;"> @${comment.username}</span>
                                    </div>
                                    <div style="color: var(--ig-text-primary); font-size: 13px; margin-top: 4px;">${comment.content || ''}</div>
                                    <div style="color: var(--ig-text-secondary); font-size: 12px; margin-top: 6px;">${comment.time_ago || ''}</div>
                                </div>
                            </div>
                        </div>
                    `).join('');
                }
            } else {
                commentsSection.innerHTML = `
                    <div style="text-align: center; padding: 20px; color: var(--ig-text-secondary);">
                        <i data-lucide="alert-circle" style="width: 24px; height: 24px; opacity: 0.5; display: block; margin-bottom: 8px;"></i>
                        Failed to load comments
                    </div>
                `;
            }
            if (typeof lucide !== 'undefined') {
                lucide.createIcons();
            }
        })
        .catch(err => {
            console.error('Comments error:', err);
            commentsSection.innerHTML = `
                <div style="text-align: center; padding: 20px; color: var(--ig-text-secondary);">
                    <i data-lucide="alert-circle" style="width: 24px; height: 24px; opacity: 0.5; display: block; margin-bottom: 8px;"></i>
                    Error loading comments
                </div>
            `;
        });
}


function closePostModal(event) {
    if (event && event.target !== event.currentTarget) return;
    const modal = document.getElementById('postModal');
    modal.classList.remove('show');
}

// Store the scroll position and return URL for back navigation
function openReelInOmzo(reelId) {
    // Save current scroll position and page state
    sessionStorage.setItem('exploreScrollPosition', window.scrollY);
    sessionStorage.setItem('exploreReturnPage', window.location.pathname);
    
    // Navigate to Omzo page with the specific reel using href to preserve history
    window.location.href = `/chat/reels/?reel=${reelId}`;
}

// Filter explore content based on search query
function filterExploreContent(query) {
    const grid = document.getElementById('exploreGrid');
    if (!grid) {
        console.warn('Explore grid not found');
        return;
    }
    
    const cards = grid.querySelectorAll('.explore-card');
    const searchText = query.toLowerCase().trim();
    let visibleCount = 0;
    
    if (!searchText) {
        // Show only scribes and reels if search is empty
        cards.forEach(card => {
            const dataType = card.getAttribute('data-type');
            card.classList.remove('search-active');
            if (dataType === 'scribe' || dataType === 'reel') {
                card.style.display = '';
            } else {
                card.style.display = 'none';
            }
        });
        // Remove no results message if visible
        const noResultsMsg = document.getElementById('exploreNoResults');
        if (noResultsMsg) {
            noResultsMsg.remove();
        }
        return;
    }
    
    // When searching, show all types that match
    cards.forEach(card => {
        const cardSearchText = card.getAttribute('data-search-text') || '';
        const dataType = card.getAttribute('data-type');
        const matches = cardSearchText.toLowerCase().includes(searchText);
        
        if (matches) {
            card.classList.add('search-active');
            card.style.display = '';
            visibleCount++;
        } else {
            card.classList.remove('search-active');
            card.style.display = 'none';
        }
    });
    
    // Show "no results" message if nothing matches
    let noResultsMsg = document.getElementById('exploreNoResults');
    if (visibleCount === 0 && !noResultsMsg) {
        noResultsMsg = document.createElement('div');
        noResultsMsg.id = 'exploreNoResults';
        noResultsMsg.className = 'ig-search-no-results';
        noResultsMsg.innerHTML = `
            <i data-lucide="search"></i>
            <h3 style="color: var(--ig-text-primary); margin: 12px 0 8px 0;">No results found</h3>
            <p>Try searching for different keywords</p>
        `;
        grid.parentNode.insertBefore(noResultsMsg, grid.nextSibling);
        if (typeof lucide !== 'undefined') {
            lucide.createIcons();
        }
    } else if (visibleCount > 0 && noResultsMsg) {
        noResultsMsg.remove();
    }
}

// On page load, restore scroll position if returning from Omzo
document.addEventListener('DOMContentLoaded', function () {
    if (window.lucide) {
        window.lucide.createIcons();
    }

    // Check if we're returning from Omzo
    const returnPage = sessionStorage.getItem('exploreReturnPage');
    const scrollPos = sessionStorage.getItem('exploreScrollPosition');
    
    if (returnPage === window.location.pathname && scrollPos) {
        // Restore scroll position after a short delay to ensure DOM is ready
        setTimeout(() => {
            window.scrollTo(0, parseInt(scrollPos));
            // Clear the stored values
            sessionStorage.removeItem('exploreScrollPosition');
            sessionStorage.removeItem('exploreReturnPage');
        }, 100);
    }
});
</script>
{% endblock %}
