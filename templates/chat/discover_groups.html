{% extends 'chat/base.html' %}
{% load static %}
{% load tweet_extras %}

{% block title %}Explore - Odnix{% endblock %}

{% block extra_head %}
<meta name="user-id" content="{{ user.id }}">
<meta name="csrf-token" content="{{ csrf_token }}">
<style>
    .sidebar-enhanced {
        display: none !important;
    }

    .bottom-navbar {
        display: none !important;
    }

    .ig-discover-container {
        padding-top: 90px;
        padding-bottom: 100px;
        min-height: 100vh;
        background: var(--ig-bg);
    }

    .ig-discover-content {
        max-width: 1100px;
        margin: 0 auto;
        padding: 0 var(--spacing-lg);
    }

    .ig-discover-header {
        margin-bottom: var(--spacing-xl);
        display: flex;
        flex-direction: column;
        gap: 8px;
    }

    .ig-discover-title {
        font-size: 28px;
        font-weight: 700;
        color: var(--ig-text-primary);
        margin: 0;
    }

    .ig-discover-subtitle {
        color: var(--ig-text-secondary);
        margin: 0;
    }

    .ig-explore-grid {
        display: grid;
        grid-template-columns: repeat(auto-fill, 300px);
        gap: var(--spacing-lg);
        justify-content: start;
    }

    .explore-card {
        background: var(--ig-surface);
        border: 1px solid var(--ig-border);
        border-radius: 16px;
        padding: 0;
        display: flex;
        flex-direction: column;
        gap: 0;
        box-shadow: 0 10px 30px rgba(0, 0, 0, 0.04);
        overflow: hidden;
        position: relative;
        aspect-ratio: 1;
        cursor: pointer;
        width: 100%;
    }

    .explore-card:hover {
        opacity: 0.9;
    }

    .explore-card-media-container {
        position: relative;
        width: 100%;
        height: 100%;
        overflow: hidden;
        background: #000;
    }

    .explore-card-media {
        width: 100%;
        height: 100%;
        object-fit: cover;
        display: block;
    }

    .explore-card-overlay {
        position: absolute;
        inset: 0;
        background: linear-gradient(180deg, transparent 50%, rgba(0, 0, 0, 0.3) 100%);
        padding: 16px;
        display: flex;
        flex-direction: column;
        justify-content: flex-end;
        opacity: 0;
        transition: opacity 0.2s;
    }

    .explore-card:hover .explore-card-overlay {
        opacity: 1;
    }

    .explore-card-tag {
        align-self: flex-start;
        background: rgba(255, 255, 255, 0.2);
        backdrop-filter: blur(10px);
        color: white;
        border: 1px solid rgba(255, 255, 255, 0.3);
        padding: 4px 10px;
        border-radius: 999px;
        font-size: 11px;
        font-weight: 600;
        margin-bottom: 8px;
    }

    .explore-card-caption {
        color: white;
        font-size: 12px;
        line-height: 1.4;
        display: -webkit-box;
        -webkit-line-clamp: 2;
        line-clamp: 2;
        -webkit-box-orient: vertical;
        overflow: hidden;
    }

    .explore-reel-play-icon {
        position: absolute;
        top: 8px;
        right: 8px;
        width: 32px;
        height: 32px;
        background: rgba(255, 255, 255, 0.4);
        backdrop-filter: blur(10px);
        border-radius: 50%;
        display: flex;
        align-items: center;
        justify-content: center;
        opacity: 1;
        transition: background 0.2s;
    }

    .explore-card:hover .explore-reel-play-icon {
        background: rgba(255, 255, 255, 0.6);
    }

    .explore-reel-play-icon i,
    .explore-reel-play-icon svg {
        width: 16px;
        height: 16px;
        color: white;
    }

    /* Code scribe badge */
    .explore-card[data-type="scribe"] .explore-code-badge {
        position: absolute;
        top: 8px;
        right: 8px;
        background: rgba(0, 149, 246, 0.8);
        backdrop-filter: blur(10px);
        border-radius: 6px;
        padding: 4px 8px;
        font-size: 10px;
        font-weight: 600;
        color: white;
        text-transform: uppercase;
        display: none;
    }

    .explore-card[data-has-code="true"] .explore-code-badge {
        display: block;
    }

    .ig-empty-state {
        text-align: center;
        padding: 60px 20px;
        color: var(--ig-text-secondary);
        border: 1px solid var(--ig-border);
        border-radius: 16px;
        background: var(--ig-surface);
        display: flex;
        flex-direction: column;
        gap: 12px;
        align-items: center;
    }

    .ig-empty-state h3 {
        margin: 0;
        color: var(--ig-text-primary);
    }

    .ig-empty-state p {
        margin: 0;
    }

    .ig-empty-state i,
    .ig-empty-state svg {
        width: 28px;
        height: 28px;
        color: var(--ig-text-secondary);
    }

    .ig-discover-search {
        display: flex;
        align-items: center;
        gap: 12px;
        background: var(--ig-input-bg);
        border: 1px solid var(--ig-border);
        border-radius: 24px;
        padding: 10px 16px;
        margin-top: 16px;
    }

    .ig-discover-search i,
    .ig-discover-search svg {
        width: 18px;
        height: 18px;
        color: var(--ig-text-secondary);
        flex-shrink: 0;
    }

    .ig-discover-search input {
        flex: 1;
        background: none;
        border: none;
        outline: none;
        color: var(--ig-text-primary);
        font-size: 14px;
        font-family: inherit;
    }

    .ig-discover-search input::placeholder {
        color: var(--ig-text-secondary);
    }

    .ig-search-no-results {
        text-align: center;
        padding: 40px 20px;
        color: var(--ig-text-secondary);
    }

    .ig-search-no-results i,
    .ig-search-no-results svg {
        width: 40px;
        height: 40px;
        opacity: 0.5;
        margin-bottom: 12px;
    }

    /* Post Modal Styles */
    .post-modal-overlay {
        display: none;
        position: fixed;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
        background: rgba(0, 0, 0, 0.5);
        z-index: 1000;
        align-items: center;
        justify-content: center;
        padding: 20px;
        overflow-y: auto;
    }

    .post-modal-overlay.show {
        display: flex;
    }

    .post-modal-content {
        background: var(--ig-surface);
        border-radius: 16px;
        width: 100%;
        max-width: 600px;
        max-height: 90vh;
        overflow: hidden;
        position: relative;
        display: flex;
        flex-direction: column;
    }

    .post-modal-close {
        position: absolute;
        top: 16px;
        right: 16px;
        background: var(--ig-surface-hover);
        border: 1px solid var(--ig-border);
        border-radius: 50%;
        width: 36px;
        height: 36px;
        display: flex;
        align-items: center;
        justify-content: center;
        cursor: pointer;
        z-index: 10;
        transition: background 0.2s;
    }

    .post-modal-close:hover {
        background: var(--ig-bg);
    }

    .post-modal-close i,
    .post-modal-close svg {
        width: 20px;
        height: 20px;
        color: var(--ig-text-primary);
    }

    .post-modal-body {
        padding: 0;
        display: flex;
        flex-direction: column;
        max-height: 90vh;
    }

    .post-modal-image-section {
        flex-shrink: 0;
        background: #000;
    }

    .post-modal-info {
        flex: 1;
        overflow-y: auto;
        padding: 16px;
    }

    .post-modal-actions {
        flex-shrink: 0;
        padding: 12px 16px;
        border-top: 1px solid var(--ig-border);
        display: flex;
        gap: 0;
    }

    .post-modal-action-btn {
        flex: 1;
        display: flex;
        align-items: center;
        justify-content: center;
        gap: 8px;
        padding: 12px;
        background: none;
        border: none;
        color: var(--ig-text-primary);
        cursor: pointer;
        font-size: 13px;
        transition: background 0.2s;
    }

    .post-modal-action-btn:hover {
        background: var(--ig-surface-hover);
    }

    .post-modal-action-btn.liked {
        color: #e63946;
    }

    .post-modal-comments-section {
        flex: 1;
        overflow-y: auto;
        padding: 16px;
        border-top: 1px solid var(--ig-border);
        max-height: 300px;
    }

    .post-modal-comment-item {
        padding: 12px 0;
        border-bottom: 1px solid var(--ig-border);
    }

    .post-modal-comment-item:last-child {
        border-bottom: none;
    }

    .post-modal-comment-input {
        flex-shrink: 0;
        padding: 12px 16px;
        border-top: 1px solid var(--ig-border);
        display: flex;
        gap: 8px;
        align-items: center;
    }

    .post-modal-comment-input input {
        flex: 1;
        background: var(--ig-bg);
        border: 1px solid var(--ig-border);
        border-radius: 20px;
        padding: 8px 16px;
        color: var(--ig-text-primary);
        font-size: 13px;
        outline: none;
    }

    .post-modal-comment-input input::placeholder {
        color: var(--ig-text-secondary);
    }

    .post-modal-comment-input button {
        background: none;
        border: none;
        color: var(--ig-link);
        font-weight: 600;
        font-size: 13px;
        cursor: pointer;
        padding: 8px 12px;
    }

    .post-modal-comment-input button:disabled {
        opacity: 0.3;
        cursor: default;
    }


    .post-modal-header {
        display: flex;
        gap: 12px;
        align-items: center;
        margin-bottom: 16px;
        padding-bottom: 16px;
        border-bottom: 1px solid var(--ig-border);
    }

    .post-modal-avatar {
        width: 40px;
        height: 40px;
        border-radius: 50%;
        object-fit: cover;
    }

    .post-modal-user-info {
        flex: 1;
    }

    .post-modal-username {
        font-weight: 700;
        color: var(--ig-text-primary);
        font-size: 14px;
    }

    .post-modal-time {
        color: var(--ig-text-secondary);
        font-size: 12px;
    }

    .post-modal-image {
        width: 100%;
        border-radius: 12px;
        margin-bottom: 16px;
    }

    .post-modal-caption {
        color: var(--ig-text-primary);
        line-height: 1.5;
        margin-bottom: 16px;
    }

    .post-modal-stats {
        display: flex;
        gap: 20px;
        padding-top: 16px;
        border-top: 1px solid var(--ig-border);
        color: var(--ig-text-secondary);
        font-size: 13px;
    }

    .post-modal-loading {
        text-align: center;
        padding: 40px 20px;
        color: var(--ig-text-secondary);
    }

    @media (max-width: 768px) {
        .ig-discover-container {
            padding-top: 60px;
            padding-bottom: 80px;
        }

        .ig-discover-content {
            padding: 0;
            max-width: 100%;
        }

        .ig-discover-header {
            padding: 0 16px;
            margin-bottom: 12px;
        }

        .ig-discover-search {
            display: none;
        }

        .ig-discover-title {
            font-size: 22px;
            margin-bottom: 8px;
        }

        .ig-discover-subtitle {
            display: none;
        }

        .ig-explore-grid {
            grid-template-columns: repeat(3, 1fr);
            gap: 1px;
            margin: 0;
            width: 100vw;
            margin-left: calc(-50vw + 50%);
        }

        .explore-card {
            border-radius: 0;
            border: none;
        }

        .ig-bottom-nav {
            display: flex !important;
            align-items: center;
            justify-content: space-around;
        }

        .ig-top-nav {
            display: none !important;
        }
    }

    @media (max-width: 480px) {
        .ig-explore-grid {
            grid-template-columns: repeat(2, 1fr);
            gap: 1px;
        }

        .ig-discover-title {
            font-size: 20px;
        }

        .explore-card-tag {
            font-size: 10px;
        }

        .explore-card-caption {
            font-size: 11px;
        }
    }
</style>
{% endblock %}

{% block content %}
{% include 'chat/partials/navbar.html' %}

<div class="ig-discover-container">
    <div class="ig-discover-content">
        <header class="ig-discover-header">
            <h1 class="ig-discover-title">Explore</h1>
            <p class="ig-discover-subtitle">Dive into random Scribes and Omzo picks.</p>
            <div class="ig-discover-search">
                <i data-lucide="search"></i>
                <input type="text" id="exploreSearchInput" placeholder="Search people, groups, scribes, omzo..."
                    onkeyup="filterExploreContent(this.value)">
            </div>
        </header>

        {% if mixed_content %}
        <div class="ig-explore-grid" id="exploreGrid">
            {% for item in mixed_content %}
            {% if item.type == 'scribe' %}
            {% with scribe=item.object %}
            <article class="explore-card" data-type="scribe"
                data-has-code="{% if scribe.code_bundle or scribe.code_html %}true{% else %}false{% endif %}"
                data-search-text="{{ scribe.user.full_name|default:scribe.user.username }} @{{ scribe.user.username }} {{ scribe.content }}"
                onclick="openScribePost({{ scribe.id }})">
                <div class="explore-card-media-container">
                    {% if scribe.image_url %}
                    <img src="{{ scribe.image_url }}" alt="Scribe media" loading="lazy" class="explore-card-media">
                    {% elif scribe.code_bundle %}
                    <iframe class="explore-card-media" srcdoc="{{ scribe.code_bundle|escape }}"
                        style="border: none; width: 100%; height: 100%; pointer-events: none;" sandbox="allow-scripts"
                        loading="lazy">
                    </iframe>
                    {% elif scribe.code_html %}
                    <iframe class="explore-card-media"
                        srcdoc="<style>{{ scribe.code_css|default:'' }}</style>{{ scribe.code_html }}<script>{{ scribe.code_js|default:'' }}</script>"
                        style="border: none; width: 100%; height: 100%; pointer-events: none;" sandbox="allow-scripts"
                        loading="lazy">
                    </iframe>
                    {% else %}
                    <div class="explore-card-media"
                        style="background: var(--ig-surface-hover); display: flex; align-items: center; justify-content: center;">
                        <i data-lucide="file-text" style="width: 48px; height: 48px; opacity: 0.3;"></i>
                    </div>
                    {% endif %}
                    {% if scribe.code_bundle or scribe.code_html %}<span class="explore-code-badge"><i data-lucide="code" style="width: 10px; height: 10px; display: inline-block;"></i> Code</span>{% endif %}
                    <div class="explore-card-overlay">
                        <div class="explore-card-tag">{% if scribe.code_bundle or scribe.code_html %}Code Scribe{% else
                            %}Scribe{% endif %}</div>
                        {% if scribe.content %}
                        <div class="explore-card-caption">{{ scribe.content|truncatewords:15 }}</div>
                        {% endif %}
                    </div>
                </div>
            </article>
            {% endwith %}
            {% elif item.type == 'reel' %}
            {% with reel=item.object %}
            <article class="explore-card" data-type="reel"
                data-search-text="{{ reel.user.full_name|default:reel.user.username }} @{{ reel.user.username }} {{ reel.caption }}"
                onclick="openReelInOmzo({{ reel.id }})">
                <div class="explore-card-media-container">
                    {% if reel.video_file %}
                    <video class="explore-card-media" muted autoplay loop playsinline
                        onclick="event.stopPropagation(); openReelInOmzo({{ reel.id }})">
                        <source src="{{ reel.video_file.url }}" type="video/mp4">
                    </video>
                    <div class="explore-reel-play-icon"
                        onclick="event.stopPropagation(); openReelInOmzo({{ reel.id }})">
                        <i data-lucide="play"></i>
                    </div>
                    {% else %}
                    <div class="explore-card-media"
                        style="background: var(--ig-surface-hover); display: flex; align-items: center; justify-content: center;">
                        <i data-lucide="video" style="width: 48px; height: 48px; opacity: 0.3;"></i>
                    </div>
                    {% endif %}
                    <div class="explore-card-overlay">
                        <div class="explore-card-tag">Omzo</div>
                        {% if reel.caption %}
                        <div class="explore-card-caption">{{ reel.caption|truncatewords:15 }}</div>
                        {% endif %}
                    </div>
                </div>
            </article>
            {% endwith %}
            {% elif item.type == 'person' %}
            {% with person=item.object %}
            <article class="explore-card" data-type="person"
                data-search-text="{{ person.full_name|default:person.username }} @{{ person.username }}"
                onclick="window.location.href='{% url 'user_profile' person.username %}'">
                <div class="explore-card-media-container"
                    style="background: linear-gradient(135deg, #f8f9fa 0%, #e9ecef 100%); display: flex; align-items: center; justify-content: center;">
                    <div style="text-align: center;">
                        {% if person.profile_picture %}
                        <img src="{{ person.profile_picture.url }}" alt="{{ person.full_name }}"
                            style="width: 80px; height: 80px; border-radius: 50%; object-fit: cover; margin-bottom: 12px;"
                            onerror="this.style.display='none';">
                        {% else %}
                        <div
                            style="width: 80px; height: 80px; border-radius: 50%; background-color: var(--ig-surface); margin: 0 auto 12px; display: flex; align-items: center; justify-content: center; color: var(--ig-text-secondary);">
                            <i data-lucide="user" style="width: 36px; height: 36px;"></i>
                        </div>
                        {% endif %}
                        <div
                            style="font-weight: 600; color: var(--ig-text-primary); font-size: 14px; margin-bottom: 4px;">
                            {{ person.full_name|default:person.username }}</div>
                        <div style="color: var(--ig-text-secondary); font-size: 12px;">@{{ person.username }}</div>
                    </div>
                </div>
            </article>
            {% endwith %}
            {% elif item.type == 'group' %}
            {% with group=item.object %}
            <article class="explore-card" data-type="group" data-search-text="{{ group.name }}"
                onclick="window.location.href='{% url 'chat_detail' group.id %}'">
                <div class="explore-card-media-container"
                    style="background: linear-gradient(135deg, #f8f9fa 0%, #e9ecef 100%); display: flex; align-items: center; justify-content: center;">
                    <div style="text-align: center;">
                        <div
                            style="width: 80px; height: 80px; border-radius: 50%; background-color: var(--ig-surface); margin: 0 auto 12px; display: flex; align-items: center; justify-content: center;">
                            <i data-lucide="users"
                                style="width: 36px; height: 36px; color: var(--ig-text-secondary);"></i>
                        </div>
                        <div
                            style="font-weight: 600; color: var(--ig-text-primary); font-size: 14px; margin-bottom: 4px;">
                            {{ group.name }}</div>
                        <div style="color: var(--ig-text-secondary); font-size: 12px;">Group</div>
                    </div>
                </div>
            </article>
            {% endwith %}
            {% endif %}
            {% endfor %}
        </div>
        {% else %}
        <div class="ig-empty-state">
            <i data-lucide="sparkles"></i>
            <h3>Nothing to explore yet</h3>
            <p>Post a Scribe or Omzo to be featured here.</p>
        </div>
        {% endif %}
    </div>
</div>

<!-- Post Modal -->
<div class="post-modal-overlay" id="postModal">
    <div class="post-modal-content">
        <button class="post-modal-close" onclick="document.getElementById('postModal').classList.remove('show')">
            <i data-lucide="x"></i>
        </button>
        <div class="post-modal-body" id="postModalBody"></div>
    </div>
</div>

<!-- Reel Modal -->
<div class="post-modal-overlay" id="reelModal">
    <div class="post-modal-content">
        <button class="post-modal-close" onclick="document.getElementById('reelModal').classList.remove('show')">
            <i data-lucide="x"></i>
        </button>
        <div class="post-modal-body" id="reelModalBody"></div>
    </div>
</div>

<script>
    // Global State
    let currentPage = 1;
    let isLoading = false;
    let hasMore = true;

    // --- Modal Functions ---

    function openScribePost(postId) {
        const modal = document.getElementById('postModal');
        const body = document.getElementById('postModalBody');

        modal.classList.add('show');
        body.innerHTML = `
            <div class="post-modal-loading">
                <div style="animation: spin 1s linear infinite;">
                    <i data-lucide="loader" style="width: 32px; height: 32px;"></i>
                </div>
                <p style="margin-top: 16px;">Loading post...</p>
            </div>
        `;

        if (typeof lucide !== 'undefined') lucide.createIcons();

        fetch(`/chat/api/tweet/${postId}/`)
            .then(r => r.json())
            .then(data => {
                if (data.success && data.tweet) {
                    const tweet = data.tweet;
                    const isLiked = tweet.is_liked || false;

                    // Render Image/Media Section
                    let mediaSection = '';
                    if (tweet.image_url) {
                        mediaSection = `<img src="${tweet.image_url}" alt="Post image" style="width: 100%; height: auto; max-height: 400px; object-fit: cover;">`;
                    } else if (tweet.code_bundle || tweet.code_html) {
                        // Render code scribe using iframe
                        const srcContent = tweet.code_bundle ? escapeHtml(tweet.code_bundle) :
                            escapeHtml(`<style>${tweet.code_css || ''}</style>${tweet.code_html}<script>${tweet.code_js || ''}<\/script>`);
                        mediaSection = `<iframe style="width: 100%; height: 400px; border: none;" sandbox="allow-scripts" srcdoc="${srcContent}"></iframe>`;
                    } else {
                        mediaSection = `<div style="width: 100%; height: 250px; background: var(--ig-surface-hover); display: flex; align-items: center; justify-content: center; color: var(--ig-text-secondary);"><i data-lucide="file-text" style="width: 48px; height: 48px; opacity: 0.3;"></i></div>`;
                    }

                    body.innerHTML = `
                        <div style="display: flex; flex-direction: column; height: 100%; max-height: 90vh;">
                            <div class="post-modal-image-section" style="flex-shrink: 0; overflow: hidden; background: #000;">
                                ${mediaSection}
                            </div>
                            
                            <div class="post-modal-info" style="flex-shrink: 0;">
                                <div style="display: flex; align-items: center; gap: 12px; margin-bottom: 12px;">
                                    <img src="${tweet.avatar || 'https://ui-avatars.com/api/?name=' + tweet.username}" style="width: 32px; height: 32px; border-radius: 50%; object-fit: cover;" onerror="this.style.display='none';">
                                    <div>
                                        <div style="font-weight: 600; color: var(--ig-text-primary); font-size: 13px;">${tweet.full_name || tweet.username}</div>
                                        <div style="color: var(--ig-text-secondary); font-size: 12px;">@${tweet.username}</div>
                                    </div>
                                </div>
                                
                                ${tweet.content ? `<div style="color: var(--ig-text-primary); font-size: 14px; line-height: 1.5; margin-bottom: 12px;">${tweet.content}</div>` : ''}
                                
                                <div style="display: flex; gap: 16px; font-size: 13px; color: var(--ig-text-secondary);">
                                    <span id="likeCount${postId}"><strong style="color: var(--ig-text-primary);">${tweet.like_count || 0}</strong> Likes</span>
                                    <span id="commentCount${postId}"><strong style="color: var(--ig-text-primary);">${tweet.comment_count || 0}</strong> Comments</span>
                                    <span style="color: var(--ig-text-secondary); font-size: 11px;">${tweet.time_ago}</span>
                                </div>
                            </div>
                            
                            <div class="post-modal-actions">
                                <button class="post-modal-action-btn like-btn ${isLiked ? 'liked' : ''}" onclick="event.stopPropagation(); toggleLikeInModal(${postId}, this)" data-liked="${isLiked ? 'true' : 'false'}" data-post-id="${postId}">
                                    <i data-lucide="heart" style="width: 18px; height: 18px; ${isLiked ? 'fill: currentColor;' : ''}"></i>
                                    <span>Like</span>
                                </button>
                                <button class="post-modal-action-btn" onclick="event.stopPropagation(); document.getElementById('commentInput${postId}').focus()">
                                    <i data-lucide="message-circle" style="width: 18px; height: 18px;"></i>
                                    <span>Comment</span>
                                </button>
                            </div>
                            
                            <div class="post-modal-comments-section" id="commentsSection${postId}">
                                <div style="text-align: center; padding: 20px; color: var(--ig-text-secondary);">
                                    <i data-lucide="loader" style="width: 24px; height: 24px; animation: spin 1s linear infinite;"></i>
                                </div>
                            </div>
                            
                            <div class="post-modal-comment-input">
                                <input type="text" id="commentInput${postId}" placeholder="Add a comment..." onkeypress="if(event.key === 'Enter' && this.value.trim()) { postComment(${postId}, this.value); this.value = ''; }">
                                <button onclick="event.stopPropagation(); const input = document.getElementById('commentInput${postId}'); if(input.value.trim()) { postComment(${postId}, input.value); input.value = ''; }" id="commentBtn${postId}">Post</button>
                            </div>
                        </div>
                    `;

                    loadCommentsInModal(postId);
                } else {
                    body.innerHTML = renderErrorState('Failed to load post');
                }
                if (typeof lucide !== 'undefined') lucide.createIcons();
            })
            .catch(err => {
                console.error(err);
                body.innerHTML = renderErrorState('Error loading post');
                if (typeof lucide !== 'undefined') lucide.createIcons();
            });
    }

    function renderErrorState(message) {
        return `
            <div class="post-modal-loading">
                <i data-lucide="alert-circle" style="width: 40px; height: 40px; opacity: 0.5;"></i>
                <p style="margin-top: 12px;">${message}</p>
            </div>
        `;
    }

    function toggleLikeInModal(postId, button) {
        const isLiked = button.getAttribute('data-liked') === 'true';
        fetch(`/chat/api/toggle-like/`, {
            method: 'POST',
            headers: {
                'X-CSRFToken': document.querySelector('meta[name="csrf-token"]').content,
                'Content-Type': 'application/json'
            },
            body: JSON.stringify({ tweet_id: postId })
        })
            .then(r => r.json())
            .then(data => {
                if (data.success) {
                    const newIsLiked = !isLiked;
                    button.setAttribute('data-liked', newIsLiked ? 'true' : 'false');
                    button.classList.toggle('liked', newIsLiked);

                    // Update icon fill
                    const icon = button.querySelector('svg') || button.querySelector('i');
                    if (icon) {
                        icon.style.fill = newIsLiked ? 'currentColor' : 'none';
                    }

                    const likeCountEl = document.getElementById('likeCount' + postId);
                    if (likeCountEl && data.like_count !== undefined) {
                        likeCountEl.innerHTML = `<strong style="color: var(--ig-text-primary);">${data.like_count}</strong> Likes`;
                    }
                }
            })
            .catch(console.error);
    }

    function loadCommentsInModal(postId) {
        const commentsSection = document.getElementById('commentsSection' + postId);
        if (!commentsSection) return;

        fetch(`/chat/api/tweet/${postId}/comments/`)
            .then(r => r.json())
            .then(data => {
                if (data.success && data.comments) {
                    if (data.comments.length === 0) {
                        commentsSection.innerHTML = `
                            <div style="text-align: center; padding: 20px; color: var(--ig-text-secondary);">
                                <i data-lucide="message-circle" style="width: 24px; height: 24px; opacity: 0.3; margin-bottom: 8px;"></i>
                                <div style="font-size: 13px;">No comments yet</div>
                            </div>
                        `;
                    } else {
                        commentsSection.innerHTML = data.comments.map(comment => `
                            <div class="post-modal-comment-item">
                                <div style="display: flex; gap: 10px;">
                                    <img src="${comment.avatar || 'https://ui-avatars.com/api/?name=' + comment.username}" style="width: 32px; height: 32px; border-radius: 50%; object-fit: cover; flex-shrink: 0;" onerror="this.style.display='none';">
                                    <div style="flex: 1;">
                                        <div style="margin-bottom: 4px;">
                                            <span style="font-weight: 600; color: var(--ig-text-primary); font-size: 13px;">${comment.full_name || comment.username}</span>
                                            <span style="color: var(--ig-text-secondary); font-size: 12px; margin-left: 6px;">@${comment.username}</span>
                                        </div>
                                        <div style="color: var(--ig-text-primary); font-size: 13px; line-height: 1.4;">${comment.content || ''}</div>
                                        <div style="color: var(--ig-text-secondary); font-size: 11px; margin-top: 6px;">${comment.time_ago || ''}</div>
                                    </div>
                                </div>
                            </div>
                        `).join('');
                    }
                } else {
                    commentsSection.innerHTML = `<div style="text-align: center; padding: 20px; font-size:13px; color: var(--ig-text-secondary);">Failed to load comments</div>`;
                }
                if (typeof lucide !== 'undefined') lucide.createIcons();
            })
            .catch(() => {
                commentsSection.innerHTML = `<div style="text-align: center; padding: 20px; font-size:13px; color: var(--ig-text-secondary);">Error loading comments</div>`;
            });
    }

    function postComment(postId, commentText) {
        if (!commentText || !commentText.trim()) return;
        fetch(`/chat/api/add-comment/`, {
            method: 'POST',
            headers: {
                'X-CSRFToken': document.querySelector('meta[name="csrf-token"]').content,
                'Content-Type': 'application/json'
            },
            body: JSON.stringify({ tweet_id: postId, content: commentText.trim() })
        })
            .then(r => r.json())
            .then(data => {
                if (data.success) {
                    loadCommentsInModal(postId);
                    const commentCountEl = document.getElementById('commentCount' + postId);
                    if (commentCountEl && data.comment_count !== undefined) {
                        commentCountEl.innerHTML = `<strong style="color: var(--ig-text-primary);">${data.comment_count}</strong> Comments`;
                    }
                } else {
                    alert('Failed to post comment');
                }
            })
            .catch(() => alert('Error posting comment'));
    }

    function closePostModal(event) {
        if (event && event.target !== event.currentTarget) return;
        const modal = document.getElementById('postModal');
        modal.classList.remove('show');
    }

    function openReelInOmzo(reelId) {
        sessionStorage.setItem('exploreScrollPosition', window.scrollY);
        sessionStorage.setItem('exploreReturnPage', window.location.pathname);
        window.location.href = `/chat/reels/?reel=${reelId}`;
    }

    function filterExploreContent(query) {
        const grid = document.getElementById('exploreGrid');
        if (!grid) return;
        const cards = grid.querySelectorAll('.explore-card');
        const searchText = query.toLowerCase().trim();
        let visibleCount = 0;

        cards.forEach(card => {
            if (!searchText) {
                // If search empty, only show those meant for initial display? 
                // Actually, just show everything loaded.
                card.classList.remove('search-active');
                card.style.display = '';
                return;
            }
            const cardSearchText = card.getAttribute('data-search-text') || '';
            if (cardSearchText.toLowerCase().includes(searchText)) {
                card.classList.add('search-active');
                card.style.display = '';
                visibleCount++;
            } else {
                card.classList.remove('search-active');
                card.style.display = 'none';
            }
        });

        // Toggle No Results
        let noResults = document.getElementById('exploreNoResults');
        if (searchText && visibleCount === 0) {
            if (!noResults) {
                noResults = document.createElement('div');
                noResults.id = 'exploreNoResults';
                noResults.className = 'ig-search-no-results';
                noResults.innerHTML = `
                    <i data-lucide="search"></i>
                    <h3 style="color: var(--ig-text-primary); margin: 12px 0 8px 0;">No results found</h3>
                    <p>Try searching for different keywords</p>
                `;
                grid.parentNode.insertBefore(noResults, grid.nextSibling);
                if (typeof lucide !== 'undefined') lucide.createIcons();
            }
        } else if (noResults) {
            noResults.remove();
        }
    }

    // --- Infinite Scroll ---

    // --- Infinite Scroll (Intersection Observer) ---

    // Create a sentinel element for intersection observer
    function createSentinel() {
        let sentinel = document.getElementById('explore-sentinel');
        if (!sentinel) {
            sentinel = document.createElement('div');
            sentinel.id = 'explore-sentinel';
            sentinel.style.height = '10px';
            sentinel.style.width = '100%';
            sentinel.style.marginTop = '20px';

            // Append to the container of the grid, or after the grid
            const grid = document.getElementById('exploreGrid');
            if (grid && grid.parentNode) {
                grid.parentNode.insertBefore(sentinel, grid.nextSibling);
            }
        }
        return sentinel;
    }

    // Initialize Observer with fallback
    function initIntersectionObserver() {
        const sentinel = createSentinel();

        // Options: trigger when sentinel is within 200px of viewport bottom
        const options = {
            root: null,
            rootMargin: '200px',
            threshold: 0
        };

        const observer = new IntersectionObserver((entries) => {
            entries.forEach(entry => {
                if (entry.isIntersecting && hasMore && !isLoading) {
                    console.log('Sentinel intersected, loading more...');
                    loadMoreContent();
                }
            });
        }, options);

        observer.observe(sentinel);

        // Fallback: Manual scroll listener
        window.addEventListener('scroll', () => {
            if (isLoading || !hasMore) return;
            // Trigger if scroll is within 500px of the bottom of the document
            if ((window.innerHeight + window.scrollY) >= document.body.offsetHeight - 500) {
                console.log('Manual scroll trigger');
                loadMoreContent();
            }
        }, { passive: true });
    }

    // Call init on load
    document.addEventListener('DOMContentLoaded', function () {
        if (typeof lucide !== 'undefined') {
            lucide.createIcons();
        }
        // Initialize observer after a short delay to ensure DOM is ready
        setTimeout(initIntersectionObserver, 500);
    });

    function loadMoreContent() {
        if (isLoading || !hasMore) return;
        isLoading = true;

        // Show indicator
        showLoadingIndicator();

        fetch(`/chat/api/explore/load-more/?page=${currentPage + 1}`)
            .then(response => response.json())
            .then(data => {
                if (data.success && data.content.length > 0) {
                    const grid = document.getElementById('exploreGrid');
                    const fragment = document.createDocumentFragment();
                    data.content.forEach(item => {
                        const card = createExploreCard(item);
                        if (card) fragment.appendChild(card);
                    });
                    grid.appendChild(fragment);
                    currentPage = data.page;
                    hasMore = data.has_next;

                    // Move sentinel to bottom if needed (usually it stays at bottom logically)
                    const sentinel = document.getElementById('explore-sentinel');
                    if (sentinel && grid.parentNode) {
                        grid.parentNode.appendChild(sentinel);
                    }

                    if (typeof lucide !== 'undefined') lucide.createIcons();
                } else {
                    hasMore = false;
                    // Remove sentinel if no more content
                    const sentinel = document.getElementById('explore-sentinel');
                    if (sentinel) sentinel.remove();
                }
            })
            .catch(err => {
                console.error('Loader error:', err);
                hasMore = false;
            })
            .finally(() => {
                isLoading = false;
                hideLoadingIndicator();
            });
    }

    function createExploreCard(item) {
        const article = document.createElement('article');
        article.className = 'explore-card';
        article.setAttribute('data-type', item.type);

        let content = '';
        if (item.type === 'scribe') {
            article.setAttribute('data-search-text', `${item.user.full_name} @${item.user.username} ${item.content}`);
            article.onclick = () => openScribePost(item.id);

            let mediaHTML = '';
            let tag = 'Scribe';
            let isCode = false;

            if (item.image_url) {
                mediaHTML = `<img src="${item.image_url}" alt="Scribe media" loading="lazy" class="explore-card-media">`;
            } else if (item.code_bundle) {
                tag = 'Code Scribe';
                isCode = true;
                const escapedBundle = escapeHtml(item.code_bundle);
                mediaHTML = `<iframe class="explore-card-media" srcdoc="${escapedBundle}" style="border: none; width: 100%; height: 100%; pointer-events: none;" sandbox="allow-scripts" loading="lazy"></iframe>`;
            } else if (item.code_html) {
                tag = 'Code Scribe';
                isCode = true;
                const rawDoc = `<style>${item.code_css || ''}</style>${item.code_html}<script>${item.code_js || ''}<\/script>`;
                const escapedDoc = escapeHtml(rawDoc);
                mediaHTML = `<iframe class="explore-card-media" srcdoc="${escapedDoc}" style="border: none; width: 100%; height: 100%; pointer-events: none;" sandbox="allow-scripts" loading="lazy"></iframe>`;
            } else {
                mediaHTML = `<div class="explore-card-media" style="background: var(--ig-surface-hover); display: flex; align-items: center; justify-content: center;"><i data-lucide="file-text" style="width: 48px; height: 48px; opacity: 0.3;"></i></div>`;
            }

            article.setAttribute('data-has-code', isCode ? 'true' : 'false');

            content = `
                <div class="explore-card-media-container">
                    ${mediaHTML}
                    ${isCode ? '<span class="explore-code-badge"><i data-lucide="code" style="width: 10px; height: 10px; display: inline-block;"></i> Code</span>' : ''}
                    <div class="explore-card-overlay">
                        <div class="explore-card-tag">${tag}</div>
                        ${item.content ? `<div class="explore-card-caption">${truncateText(item.content, 15)}</div>` : ''}
                    </div>
                </div>
            `;

        } else if (item.type === 'reel') {
            article.setAttribute('data-search-text', `${item.user.full_name} @${item.user.username} ${item.caption}`);
            article.onclick = () => openReelInOmzo(item.id);

            const mediaHTML = item.video_url ?
                `<video class="explore-card-media" muted autoplay loop playsinline onclick="event.stopPropagation(); openReelInOmzo(${item.id})"><source src="${item.video_url}" type="video/mp4"></video><div class="explore-reel-play-icon" onclick="event.stopPropagation(); openReelInOmzo(${item.id})"><i data-lucide="play"></i></div>` :
                `<div class="explore-card-media" style="background: var(--ig-surface-hover); display: flex; align-items: center; justify-content: center;"><i data-lucide="video" style="width: 48px; height: 48px; opacity: 0.3;"></i></div>`;

            content = `
                <div class="explore-card-media-container">
                    ${mediaHTML}
                    <div class="explore-card-overlay">
                        <div class="explore-card-tag">Omzo</div>
                        ${item.caption ? `<div class="explore-card-caption">${truncateText(item.caption, 15)}</div>` : ''}
                    </div>
                </div>
            `;
        } else if (item.type === 'person') {
            article.setAttribute('data-search-text', `${item.full_name} @${item.username}`);
            article.onclick = () => window.location.href = `/chat/profile/${item.username}/`;

            const avatarHTML = item.profile_picture ?
                `<img src="${item.profile_picture}" alt="${item.full_name}" style="width: 80px; height: 80px; border-radius: 50%; object-fit: cover; margin-bottom: 12px;">` :
                `<div style="width: 80px; height: 80px; border-radius: 50%; background-color: var(--ig-surface); margin: 0 auto 12px; display: flex; align-items: center; justify-content: center; color: var(--ig-text-secondary);"><i data-lucide="user" style="width: 36px; height: 36px;"></i></div>`;

            content = `
                <div class="explore-card-media-container" style="background: linear-gradient(135deg, #f8f9fa 0%, #e9ecef 100%); display: flex; align-items: center; justify-content: center;">
                    <div style="text-align: center;">
                        ${avatarHTML}
                        <div style="font-weight: 600; color: var(--ig-text-primary); font-size: 14px; margin-bottom: 4px;">${item.full_name || item.username}</div>
                        <div style="color: var(--ig-text-secondary); font-size: 12px;">@${item.username}</div>
                    </div>
                </div>
            `;
        } else if (item.type === 'group') {
            article.setAttribute('data-search-text', item.name);
            article.onclick = () => window.location.href = `/chat/chat/${item.id}/`;

            content = `
                <div class="explore-card-media-container" style="background: linear-gradient(135deg, #f8f9fa 0%, #e9ecef 100%); display: flex; align-items: center; justify-content: center;">
                    <div style="text-align: center;">
                        <div style="width: 80px; height: 80px; border-radius: 50%; background-color: var(--ig-surface); margin: 0 auto 12px; display: flex; align-items: center; justify-content: center;"><i data-lucide="users" style="width: 36px; height: 36px; color: var(--ig-text-secondary);"></i></div>
                        <div style="font-weight: 600; color: var(--ig-text-primary); font-size: 14px; margin-bottom: 4px;">${item.name}</div>
                        <div style="color: var(--ig-text-secondary); font-size: 12px;">Group</div>
                    </div>
                </div>
            `;
        }

        article.innerHTML = content;
        return article;
    }

    // --- Helpers ---

    function escapeHtml(text) {
        if (!text) return '';
        const div = document.createElement('div');
        div.textContent = text;
        return div.innerHTML.replace(/"/g, '&quot;');
    }

    function truncateText(str, n) {
        if (!str) return '';
        const words = str.split(' ');
        if (words.length > n) {
            return words.slice(0, n).join(' ') + '...';
        }
        return str;
    }

    function showLoadingIndicator() {
        let indicator = document.getElementById('loadingIndicator');
        if (!indicator) {
            indicator = document.createElement('div');
            indicator.id = 'loadingIndicator';
            indicator.style.cssText = 'position: fixed; bottom: 40px; left: 50%; transform: translateX(-50%); background: var(--ig-surface); border: 1px solid var(--ig-border); border-radius: 8px; padding: 12px 20px; display: flex; align-items: center; gap: 12px; z-index: 100; box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);';
            indicator.innerHTML = '<i data-lucide="loader" style="width: 20px; height: 20px; animation: spin 1s linear infinite;"></i><span style="color: var(--ig-text-primary); font-size: 14px;">Loading more content...</span>';
            document.body.appendChild(indicator);
            if (typeof lucide !== 'undefined') lucide.createIcons();
        }
        indicator.style.display = 'flex';
    }

    function hideLoadingIndicator() {
        const indicator = document.getElementById('loadingIndicator');
        if (indicator) indicator.style.display = 'none';
    }

    // --- Initialization ---

    document.addEventListener('DOMContentLoaded', function () {
        if (typeof lucide !== 'undefined') {
            lucide.createIcons();
        }

        const returnPage = sessionStorage.getItem('exploreReturnPage');
        const scrollPos = sessionStorage.getItem('exploreScrollPosition');
        if (returnPage === window.location.pathname && scrollPos) {
            setTimeout(() => {
                window.scrollTo(0, parseInt(scrollPos));
                sessionStorage.removeItem('exploreScrollPosition');
                sessionStorage.removeItem('exploreReturnPage');
            }, 100);
        }
    });
</script>

<style>
    @keyframes spin {
        from {
            transform: rotate(0deg);
        }

        to {
            transform: rotate(360deg);
        }
    }
</style>

{% endblock %}