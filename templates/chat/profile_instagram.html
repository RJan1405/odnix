{% extends 'chat/base.html' %}
{% load tweet_extras %}

{% block title %}
{% if is_own_profile %}Your Profile{% else %}{{ profile_user.full_name }}{% endif %} - Odnix
{% endblock %}

{% block extra_head %}
<meta name="user-id" content="{{ current_user.id }}">
<meta name="csrf-token" content="{{ csrf_token }}">
<style>
    /* Adjust for shared navbar */
    .sidebar-enhanced {
        display: none !important;
    }

    .bottom-navbar {
        display: none !important;
    }

    .ig-profile-container {
        padding-top: 90px !important;
        padding-bottom: 100px !important;
    }

    /* ===== PROFILE RESPONSIVE STYLES ===== */
    @media (max-width: 1024px) {
        .ig-profile {
            max-width: 100%;
            padding: 0 20px;
        }

        .ig-profile-header {
            gap: 24px;
        }
    }

    @media (max-width: 768px) {
        .ig-profile-container {
            padding-top: 20px !important;
            padding-bottom: 80px !important;
        }

        .ig-profile-header {
            flex-direction: column;
            align-items: center;
            text-align: center;
            gap: 16px;
            padding: 20px 16px;
        }

        .ig-profile-avatar-section {
            margin: 0 auto;
        }

        .ig-profile-avatar-container {
            width: 100px;
            height: 100px;
        }

        .ig-profile-avatar-ring {
            width: 100px;
            height: 100px;
        }

        .ig-profile-avatar {
            width: 92px;
            height: 92px;
        }

        .ig-profile-info {
            width: 100%;
            text-align: center;
        }

        .ig-profile-username-row {
            flex-direction: column;
            align-items: center;
            gap: 12px;
        }

        .ig-profile-username {
            font-size: 20px;
        }

        .ig-profile-stats {
            justify-content: center;
            gap: 24px;
            padding: 16px 0;
            border-top: 1px solid var(--ig-border);
            border-bottom: 1px solid var(--ig-border);
            margin: 16px 0;
        }

        .ig-profile-stat {
            flex-direction: column;
        }

        .ig-stat-count {
            font-size: 18px;
        }

        .ig-stat-label {
            font-size: 13px;
        }

        .ig-profile-bio {
            text-align: center;
            padding: 0 16px;
        }

        .desktop-only {
            display: none !important;
        }

        .mobile-only {
            display: flex !important;
        }

        .ig-profile-posts-grid {
            grid-template-columns: repeat(3, 1fr);
            gap: 3px;
        }

        .ig-profile-post-overlay {
            gap: 8px;
        }

        .ig-profile-post-stat {
            font-size: 12px;
        }
    }

    @media (max-width: 480px) {
        .ig-profile-container {
            padding-top: 16px !important;
        }

        .ig-profile-header {
            padding: 16px 12px;
        }

        .ig-profile-avatar-container {
            width: 80px;
            height: 80px;
        }

        .ig-profile-avatar-ring {
            width: 80px;
            height: 80px;
        }

        .ig-profile-avatar {
            width: 74px;
            height: 74px;
        }

        .ig-profile-username {
            font-size: 18px;
        }

        .ig-profile-stats {
            gap: 16px;
        }

        .ig-stat-count {
            font-size: 16px;
        }

        .ig-profile-btn {
            padding: 8px 16px;
            font-size: 13px;
        }

        .ig-profile-posts-grid {
            gap: 2px;
        }

        .ig-profile-tabs {
            gap: 0;
        }

        .ig-profile-tab {
            padding: 12px 8px;
            font-size: 12px;
        }
    }

    @media (max-width: 374px) {
        .ig-profile-header {
            padding: 12px 8px;
        }

        .ig-profile-avatar-container {
            width: 70px;
            height: 70px;
        }

        .ig-profile-avatar-ring {
            width: 70px;
            height: 70px;
        }

        .ig-profile-avatar {
            width: 64px;
            height: 64px;
        }

        .ig-profile-username {
            font-size: 16px;
        }

        .ig-profile-stats {
            gap: 12px;
        }

        .ig-stat-count {
            font-size: 15px;
        }

        .ig-stat-label {
            font-size: 11px;
        }
    }

    /* Make bottom nav visible on mobile for profile page */
    @media (max-width: 768px) {
        .ig-bottom-nav {
            display: flex !important;
            align-items: center;
            justify-content: space-around;
        }

        .ig-top-nav {
            display: none !important;
        }
    }

    /* Create Post Modal Responsive */
    @media (max-width: 768px) {
        .ig-create-modal {
            width: 100% !important;
            max-width: 100% !important;
            max-height: 95vh !important;
            border-radius: 20px 20px 0 0 !important;
        }
    }

    @media (max-width: 480px) {
        .ig-create-modal {
            max-height: 100vh !important;
            border-radius: 0 !important;
        }
    }

    /* Enhanced Highlights Section */
    .ig-highlights {
        display: flex;
        gap: 20px;
        padding: 20px 0;
        overflow-x: auto;
        scrollbar-width: none;
        -ms-overflow-style: none;
        margin-bottom: 8px;
    }

    .ig-highlights::-webkit-scrollbar {
        display: none;
    }

    .ig-highlight-item {
        display: flex;
        flex-direction: column;
        align-items: center;
        gap: 10px;
        background: none;
        border: none;
        cursor: pointer;
        flex-shrink: 0;
        transition: transform 0.2s;
    }

    .ig-highlight-item:hover {
        transform: scale(1.05);
    }

    .ig-highlight-add {
        width: 77px;
        height: 77px;
        border-radius: 22%;
        border: 2px dashed var(--ig-border);
        display: flex;
        align-items: center;
        justify-content: center;
        background: var(--ig-surface);
        transition: all 0.3s;
    }

    .ig-highlight-add:hover {
        border-color: var(--color-primary);
        background: rgba(99, 102, 241, 0.08);
        border-style: solid;
    }

    .ig-highlight-add svg {
        width: 28px;
        height: 28px;
        color: var(--ig-text-secondary);
        transition: color 0.3s;
    }

    .ig-highlight-add:hover svg {
        color: var(--color-primary);
    }

    .ig-highlight-preview {
        width: 77px;
        height: 77px;
        border-radius: 22%;
        border: 3px solid transparent;
        background: linear-gradient(var(--ig-surface), var(--ig-surface)) padding-box,
            linear-gradient(45deg, #f09433, #e6683c, #dc2743, #cc2366, #bc1888) border-box;
        display: flex;
        align-items: center;
        justify-content: center;
        overflow: hidden;
        transition: all 0.3s;
        box-shadow: 0 4px 15px rgba(0, 0, 0, 0.1);
    }

    .ig-highlight-story:hover .ig-highlight-preview {
        transform: scale(1.08);
        box-shadow: 0 6px 20px rgba(0, 0, 0, 0.15);
    }

    .ig-highlight-text-preview {
        font-size: 11px;
        color: white;
        text-shadow: 0 1px 3px rgba(0, 0, 0, 0.6);
        text-align: center;
        padding: 6px;
        word-break: break-word;
        font-weight: 500;
    }

    .ig-highlight-label {
        font-size: 12px;
        color: var(--ig-text-primary);
        max-width: 77px;
        text-overflow: ellipsis;
        overflow: hidden;
        white-space: nowrap;
        font-weight: 500;
    }

    /* ===== IMPROVED CREATE POST MODAL STYLES ===== */
    #createPostModal .ig-create-modal {
        max-width: 580px;
        border-radius: 20px;
    }

    #createPostModal .ig-create-body {
        display: flex;
        flex-direction: column;
    }

    #createPostModal .ig-create-sidebar {
        width: 100%;
        padding: 20px;
        background: var(--ig-surface);
        box-sizing: border-box;
    }

    .ig-create-user {
        display: flex;
        align-items: center;
        gap: 12px;
        margin-bottom: 16px;
    }

    .ig-create-avatar {
        width: 48px;
        height: 48px;
        border-radius: 50%;
        object-fit: cover;
        border: 2px solid transparent;
        background: linear-gradient(var(--ig-surface), var(--ig-surface)) padding-box,
            var(--odnix-gradient) border-box;
    }

    .ig-create-avatar-placeholder {
        width: 48px;
        height: 48px;
        border-radius: 50%;
        background: var(--odnix-gradient);
        display: flex;
        align-items: center;
        justify-content: center;
        font-weight: 600;
        color: white;
        font-size: 16px;
    }

    .ig-create-user-info {
        display: flex;
        flex-direction: column;
        gap: 2px;
    }

    .ig-create-username {
        font-weight: 600;
        font-size: 15px;
        color: var(--ig-text-primary);
    }

    .ig-create-visibility {
        display: flex;
        align-items: center;
        gap: 4px;
        font-size: 12px;
        color: var(--ig-text-secondary);
    }

    .ig-create-textarea-wrapper {
        position: relative;
    }

    #createPostModal .ig-create-textarea {
        width: 100%;
        min-height: 120px;
        max-height: 200px;
        border: none;
        background: transparent;
        resize: none;
        font-size: 18px;
        color: var(--ig-text-primary);
        padding: 0;
        line-height: 1.5;
        font-family: inherit;
        box-sizing: border-box;
    }

    #createPostModal .ig-create-textarea:focus {
        outline: none;
    }

    #createPostModal .ig-create-textarea::placeholder {
        color: var(--ig-text-secondary);
    }

    .ig-create-image-preview {
        position: relative;
        margin-top: 16px;
        border-radius: 16px;
        overflow: hidden;
        background: var(--ig-bg);
        border: 1px solid var(--ig-border);
    }

    .ig-create-image-preview img {
        width: 100%;
        max-height: 350px;
        object-fit: contain;
        display: block;
    }

    .ig-create-image-remove {
        position: absolute;
        top: 12px;
        right: 12px;
        width: 32px;
        height: 32px;
        border-radius: 50%;
        background: rgba(0, 0, 0, 0.7);
        border: none;
        cursor: pointer;
        display: flex;
        align-items: center;
        justify-content: center;
        z-index: 10;
        transition: all 0.2s;
    }

    .ig-create-image-remove:hover {
        background: rgba(0, 0, 0, 0.85);
        transform: scale(1.1);
    }

    .ig-create-image-remove i {
        width: 18px;
        height: 18px;
        color: white;
    }

    .ig-create-actions {
        display: flex;
        justify-content: space-between;
        align-items: center;
        padding-top: 16px;
        margin-top: 16px;
        border-top: 1px solid var(--ig-border);
    }

    .ig-create-actions-left {
        display: flex;
        gap: 4px;
    }

    .ig-create-action-btn {
        display: flex;
        align-items: center;
        justify-content: center;
        width: 42px;
        height: 42px;
        border-radius: 50%;
        background: transparent;
        border: none;
        cursor: pointer;
        transition: all 0.2s;
        color: var(--color-primary);
    }

    .ig-create-action-btn:hover {
        background: var(--ig-surface-hover);
        transform: scale(1.1);
    }

    .ig-create-action-btn i {
        width: 22px;
        height: 22px;
    }

    .ig-create-actions-right {
        display: flex;
        align-items: center;
        gap: 12px;
    }

    .ig-create-char-count {
        position: relative;
        width: 30px;
        height: 30px;
    }

    .ig-char-circle {
        width: 30px;
        height: 30px;
        transform: rotate(-90deg);
    }

    .ig-char-bg {
        fill: none;
        stroke: var(--ig-border);
        stroke-width: 2;
    }

    .ig-char-progress {
        fill: none;
        stroke: var(--color-primary);
        stroke-width: 2;
        stroke-linecap: round;
        transition: stroke-dasharray 0.2s;
    }

    .ig-char-progress.warning {
        stroke: #f59e0b;
    }

    .ig-char-progress.danger {
        stroke: #ef4444;
    }

    .ig-char-number {
        position: absolute;
        top: 50%;
        left: 50%;
        transform: translate(-50%, -50%);
        font-size: 9px;
        font-weight: 600;
        color: var(--ig-text-secondary);
        display: none;
    }

    .ig-char-number.show {
        display: block;
    }

    .ig-create-emoji-row {
        display: flex;
        flex-wrap: wrap;
        gap: 4px;
        padding: 12px;
        margin-top: 12px;
        background: var(--ig-bg);
        border-radius: 12px;
        animation: fadeIn 0.2s ease;
    }

    .ig-create-emoji-row button {
        width: 36px;
        height: 36px;
        border: none;
        background: transparent;
        cursor: pointer;
        font-size: 20px;
        border-radius: 8px;
        transition: all 0.2s;
    }

    .ig-create-emoji-row button:hover {
        background: var(--ig-surface-hover);
        transform: scale(1.15);
    }

    /* GIF Picker Styles */
    .ig-gif-picker {
        margin-top: 12px;
        background: var(--ig-bg);
        border-radius: 14px;
        overflow: hidden;
        animation: fadeIn 0.2s ease;
        border: 1px solid var(--ig-border);
    }

    .ig-gif-search {
        display: flex;
        align-items: center;
        gap: 10px;
        padding: 12px 14px;
        border-bottom: 1px solid var(--ig-border);
    }

    .ig-gif-search i {
        width: 18px;
        height: 18px;
        color: var(--ig-text-secondary);
    }

    .ig-gif-search input {
        flex: 1;
        border: none;
        background: transparent;
        font-size: 14px;
        color: var(--ig-text-primary);
        outline: none;
    }

    .ig-gif-search input::placeholder {
        color: var(--ig-text-secondary);
    }

    .ig-gif-grid {
        display: grid;
        grid-template-columns: repeat(3, 1fr);
        gap: 4px;
        max-height: 250px;
        overflow-y: auto;
        padding: 4px;
    }

    .ig-gif-grid::-webkit-scrollbar {
        width: 6px;
    }

    .ig-gif-grid::-webkit-scrollbar-thumb {
        background: var(--ig-border);
        border-radius: 3px;
    }

    .ig-gif-item {
        aspect-ratio: 1;
        overflow: hidden;
        border-radius: 8px;
        cursor: pointer;
        transition: all 0.2s;
        position: relative;
    }

    .ig-gif-item:hover {
        transform: scale(1.03);
        box-shadow: 0 4px 12px rgba(0, 0, 0, 0.2);
    }

    .ig-gif-item img {
        width: 100%;
        height: 100%;
        object-fit: cover;
    }

    .ig-gif-loading {
        grid-column: 1 / -1;
        display: flex;
        flex-direction: column;
        align-items: center;
        justify-content: center;
        padding: 40px;
        gap: 12px;
        color: var(--ig-text-secondary);
        font-size: 13px;
    }

    .ig-gif-spinner {
        width: 28px;
        height: 28px;
        border: 3px solid var(--ig-border);
        border-top-color: var(--color-primary);
        border-radius: 50%;
        animation: spin 0.8s linear infinite;
    }

    .ig-gif-powered {
        padding: 8px;
        text-align: center;
        font-size: 11px;
        color: var(--ig-text-secondary);
        border-top: 1px solid var(--ig-border);
    }

    @keyframes spin {
        to {
            transform: rotate(360deg);
        }
    }

    @keyframes fadeIn {
        from {
            opacity: 0;
            transform: translateY(-10px);
        }

        to {
            opacity: 1;
            transform: translateY(0);
        }
    }

    /* Story Viewer Modal */
    .ig-story-viewer {
        position: fixed;
        inset: 0;
        background: rgba(0, 0, 0, 0.95);
        z-index: 10000;
        display: none;
        align-items: center;
        justify-content: center;
    }

    /* Hide bottom navbar when story viewer is open */
    body.story-viewer-open .ig-bottom-nav {
        display: none !important;
    }

    body.story-viewer-open {
        overflow: hidden;
    }

    .ig-story-viewer.show {
        display: flex;
    }

    .ig-story-container {
        position: relative;
        max-width: 420px;
        width: 100%;
        height: 90vh;
        max-height: 750px;
        background: var(--ig-surface);
        border-radius: 16px;
        overflow: hidden;
    }

    .ig-story-header {
        position: absolute;
        top: 0;
        left: 0;
        right: 0;
        padding: 16px;
        background: linear-gradient(to bottom, rgba(0, 0, 0, 0.6), transparent);
        z-index: 10;
    }

    .ig-story-progress {
        display: flex;
        gap: 4px;
        margin-bottom: 12px;
    }

    .ig-story-progress-bar {
        flex: 1;
        height: 2px;
        background: rgba(255, 255, 255, 0.3);
        border-radius: 1px;
        overflow: hidden;
    }

    .ig-story-progress-fill {
        height: 100%;
        background: white;
        width: 0;
        transition: width 0.1s linear;
    }

    .ig-story-user {
        display: flex;
        align-items: center;
        gap: 10px;
    }

    .ig-story-avatar {
        width: 32px;
        height: 32px;
        border-radius: 22%;
        object-fit: cover;
        border: 2px solid white;
    }

    .ig-story-username {
        color: white;
        font-weight: 600;
        font-size: 14px;
    }

    .ig-story-time {
        color: rgba(255, 255, 255, 0.7);
        font-size: 12px;
        margin-left: 8px;
    }

    .ig-story-close {
        position: absolute;
        top: 16px;
        right: 16px;
        background: none;
        border: none;
        cursor: pointer;
        padding: 8px;
        z-index: 11;
    }

    .ig-story-close svg {
        width: 24px;
        height: 24px;
        color: white;
    }

    .ig-story-content {
        position: absolute;
        inset: 0;
        display: flex;
        align-items: center;
        justify-content: center;
    }

    .ig-story-content img {
        width: 100%;
        height: 100%;
        object-fit: cover;
    }

    .ig-story-text-content {
        width: 100%;
        height: 100%;
        display: flex;
        align-items: center;
        justify-content: center;
        padding: 60px 30px;
        text-align: center;
    }

    .ig-story-text-content p {
        color: white;
        font-size: 24px;
        line-height: 1.4;
        text-shadow: 0 2px 4px rgba(0, 0, 0, 0.3);
    }

    .ig-story-nav {
        position: absolute;
        top: 50%;
        transform: translateY(-50%);
        background: rgba(255, 255, 255, 0.2);
        border: none;
        width: 40px;
        height: 40px;
        border-radius: 50%;
        cursor: pointer;
        display: flex;
        align-items: center;
        justify-content: center;
        backdrop-filter: blur(10px);
        transition: all 0.2s;
        z-index: 10;
    }

    .ig-story-nav:hover {
        background: rgba(255, 255, 255, 0.3);
    }

    .ig-story-nav svg {
        width: 20px;
        height: 20px;
        color: white;
    }

    .ig-story-prev {
        left: 16px;
    }

    .ig-story-next {
        right: 16px;
    }

    .ig-story-actions {
        position: absolute;
        bottom: 0;
        left: 0;
        right: 0;
        padding: 16px;
        background: linear-gradient(to top, rgba(0, 0, 0, 0.6), transparent);
        display: flex;
        align-items: center;
        gap: 12px;
    }

    .ig-story-input {
        flex: 1;
        background: rgba(255, 255, 255, 0.1);
        border: 1px solid rgba(255, 255, 255, 0.3);
        border-radius: 24px;
        padding: 12px 16px;
        color: white;
        font-size: 14px;
    }

    .ig-story-input::placeholder {
        color: rgba(255, 255, 255, 0.6);
    }

    .ig-story-action-btn {
        background: none;
        border: none;
        cursor: pointer;
        padding: 8px;
    }

    .ig-story-action-btn svg {
        width: 24px;
        height: 24px;
        color: white;
    }

    @media (max-width: 480px) {
        .ig-story-container {
            width: 100%;
            max-width: 100%;
            height: 100vh;
            height: 100dvh;
            /* Dynamic viewport height for mobile browsers */
            max-height: 100%;
            border-radius: 0;
            position: fixed;
            inset: 0;
        }

        .ig-story-viewer {
            padding: 0;
        }

        .ig-story-header {
            padding-top: env(safe-area-inset-top, 16px);
        }

        .ig-story-actions {
            padding-bottom: env(safe-area-inset-bottom, 16px);
        }

        .ig-story-nav {
            opacity: 0;
            /* Hide but keep clickable for touch navigation */
        }
    }

    /* Private Profile Styles */
    .ig-requests-badge {
        position: absolute;
        top: -4px;
        right: -4px;
        min-width: 18px;
        height: 18px;
        background: #ef4444;
        color: white;
        border-radius: 9px;
        font-size: 11px;
        font-weight: 600;
        display: flex;
        align-items: center;
        justify-content: center;
        padding: 0 5px;
    }

    .ig-profile-btn.requested {
        background: var(--ig-surface-hover);
        color: var(--ig-text-primary);
        border: 1px solid var(--ig-border);
    }

    .ig-profile-btn.requested:hover {
        background: var(--ig-border);
    }

    .ig-profile-btn.blocked {
        background: var(--ig-surface-hover);
        color: var(--ig-text-secondary);
        cursor: not-allowed;
    }

    /* Follow Request Item */
    .ig-follow-request-item {
        display: flex;
        align-items: center;
        gap: 12px;
        padding: 14px 16px;
        border-bottom: 1px solid var(--ig-border);
    }

    .ig-follow-request-item:last-child {
        border-bottom: none;
    }

    .ig-follow-request-avatar {
        width: 48px;
        height: 48px;
        border-radius: 50%;
        object-fit: cover;
        flex-shrink: 0;
    }

    .ig-follow-request-avatar-placeholder {
        width: 48px;
        height: 48px;
        border-radius: 50%;
        background: var(--odnix-gradient);
        display: flex;
        align-items: center;
        justify-content: center;
        font-weight: 600;
        color: white;
        font-size: 16px;
        flex-shrink: 0;
    }

    .ig-follow-request-info {
        flex: 1;
        min-width: 0;
    }

    .ig-follow-request-name {
        font-weight: 600;
        font-size: 14px;
        color: var(--ig-text-primary);
    }

    .ig-follow-request-username {
        font-size: 13px;
        color: var(--ig-text-secondary);
    }

    .ig-follow-request-time {
        font-size: 12px;
        color: var(--ig-text-secondary);
    }

    .ig-follow-request-actions {
        display: flex;
        gap: 8px;
        flex-shrink: 0;
    }

    .ig-follow-request-btn {
        padding: 8px 16px;
        border-radius: 8px;
        font-size: 13px;
        font-weight: 600;
        cursor: pointer;
        transition: all 0.2s;
        border: none;
    }

    .ig-follow-request-btn.accept {
        background: var(--odnix-gradient);
        color: white;
    }

    .ig-follow-request-btn.accept:hover {
        opacity: 0.9;
    }

    .ig-follow-request-btn.decline {
        background: var(--ig-surface-hover);
        color: var(--ig-text-primary);
        border: 1px solid var(--ig-border);
    }

    .ig-follow-request-btn.decline:hover {
        background: var(--ig-border);
    }

    .ig-no-requests {
        padding: 60px 20px;
        text-align: center;
        color: var(--ig-text-secondary);
    }

    .ig-no-requests i {
        width: 48px;
        height: 48px;
        margin-bottom: 16px;
        opacity: 0.5;
    }

    .ig-no-requests h3 {
        font-size: 18px;
        font-weight: 600;
        color: var(--ig-text-primary);
        margin-bottom: 8px;
    }

    .ig-no-requests p {
        font-size: 14px;
    }

    /* ===== Scribe Feed (Twitter-style timeline) ===== */
    .scribe-feed {
        display: flex;
        flex-direction: column;
        gap: 12px;
        width: 100%;
        max-width: 720px;
        margin: 0 auto;
    }

    .scribe-card {
        display: flex;
        gap: 12px;
        padding: 14px 16px;
        background: var(--ig-surface);
        border: 1px solid var(--ig-border);
        border-radius: 14px;
        box-shadow: var(--shadow-sm);
        transition: background 0.2s ease, border-color 0.2s ease;
    }

    .scribe-card:hover {
        background: var(--ig-surface-hover);
        border-color: var(--ig-border-light);
    }

    .scribe-avatar {
        width: 44px;
        height: 44px;
        border-radius: 50%;
        overflow: hidden;
        flex-shrink: 0;
        background: var(--ig-surface-hover);
        border: 1px solid var(--ig-border);
        display: grid;
        place-items: center;
        font-weight: 700;
        color: var(--ig-text-secondary);
    }

    .scribe-avatar img {
        width: 100%;
        height: 100%;
        object-fit: cover;
        display: block;
    }

    .scribe-avatar-fallback {
        display: none;
        width: 100%;
        height: 100%;
        align-items: center;
        justify-content: center;
        background: var(--ig-surface-hover);
        color: var(--ig-text-secondary);
    }

    .scribe-main {
        flex: 1;
        min-width: 0;
    }

    .scribe-header-top {
        display: flex;
        align-items: center;
        gap: 6px;
        flex-wrap: wrap;
    }

    .scribe-name {
        font-weight: 700;
        color: var(--ig-text-primary);
    }

    .scribe-username,
    .scribe-time,
    .scribe-dot {
        color: var(--ig-text-secondary);
        font-size: 13px;
    }

    .scribe-body {
        margin-top: 6px;
        cursor: pointer;
    }

    .scribe-text {
        margin: 0 0 10px 0;
        color: var(--ig-text-primary);
        font-size: 15px;
        line-height: 1.5;
        word-break: break-word;
    }

    .scribe-media {
        margin-top: 8px;
        overflow: hidden;
        border-radius: 12px;
        border: 1px solid var(--ig-border);
        background: var(--ig-surface-hover);
    }

    .scribe-media img {
        width: 100%;
        display: block;
        object-fit: cover;
    }

    .scribe-code {
        margin-top: 8px;
        border: 1px solid var(--ig-border);
        border-radius: 12px;
        overflow: hidden;
        background: var(--ig-surface-hover);
    }

    .scribe-code iframe {
        width: 100%;
        min-height: 220px;
        display: block;
    }

    .scribe-footer {
        display: flex;
        gap: 18px;
        align-items: center;
        margin-top: 10px;
        color: var(--ig-text-secondary);
        font-size: 13px;
    }

    .scribe-metric {
        display: flex;
        align-items: center;
        gap: 6px;
    }

    .scribe-metric i,
    .scribe-metric svg {
        width: 18px;
        height: 18px;
    }

    @media (max-width: 768px) {
        .scribe-card {
            padding: 12px 14px;
        }

        .scribe-feed {
            max-width: 100%;
        }
    }
</style>
{% endblock %}

{% block content %}
<!-- Include Shared Navbar -->
{% include 'chat/partials/navbar.html' %}

<!-- Main Profile Content -->
<div class="ig-profile-container">
    <div class="ig-profile">
        <!-- Profile Header -->
        <header class="ig-profile-header">
            <!-- Profile Picture -->
            <div class="ig-profile-avatar-section">
                <div class="ig-profile-avatar-container">
                    {% if profile_user.has_active_story %}
                    <div class="ig-profile-avatar-ring" onclick="viewUserStories('{{ profile_user.username }}')">
                        {% else %}
                        <div class="ig-profile-avatar-ring no-story">
                            {% endif %}
                            <img src="{{ profile_user.profile_picture_url }}" alt="{{ profile_user.full_name }}"
                                class="ig-profile-avatar"
                                onerror="this.outerHTML='<div class=\'ig-profile-avatar-placeholder\'>{{ profile_user.initials }}</div>'">
                        </div>
                    </div>
                </div>

                <!-- Profile Info -->
                <div class="ig-profile-info">
                    <div class="ig-profile-username-row">
                        <h1 class="ig-profile-username">
                            {{ profile_user.username }}
                            {% if profile_user.is_private %}
                            <i data-lucide="lock" class="ig-private-badge" title="Private Account"
                                style="width: 16px; height: 16px; margin-left: 6px; color: var(--ig-text-secondary);"></i>
                            {% endif %}
                        </h1>

                        {% if is_own_profile %}
                        <a href="{% url 'update_profile' %}" class="ig-profile-btn">Edit Profile</a>
                        {% if pending_requests_count > 0 %}
                        <button class="ig-profile-btn secondary" onclick="openFollowRequestsModal()"
                            style="position: relative;">
                            <i data-lucide="user-plus" style="width: 16px; height: 16px;"></i>
                            <span class="ig-requests-badge">{{ pending_requests_count }}</span>
                        </button>
                        {% endif %}
                        <button class="ig-profile-settings-btn" onclick="openSettingsModal()">
                            <i data-lucide="settings"></i>
                        </button>
                        {% elif is_blocked %}
                        <button class="ig-profile-btn blocked" disabled>Blocked</button>
                        {% elif is_following %}
                        <button class="ig-profile-btn following" onclick="toggleFollow('{{ profile_user.username }}')"
                            data-username="{{ profile_user.username }}" id="followBtn">Following</button>
                        <button class="ig-profile-btn secondary"
                            onclick="startChat('{{ profile_user.username }}')">Message</button>
                        {% elif follow_request_status == 'pending' %}
                        <button class="ig-profile-btn requested" onclick="toggleFollow('{{ profile_user.username }}')"
                            data-username="{{ profile_user.username }}" id="followBtn">Requested</button>
                        {% else %}
                        <button class="ig-profile-btn primary" onclick="toggleFollow('{{ profile_user.username }}')"
                            data-username="{{ profile_user.username }}" id="followBtn">
                            {% if profile_user.is_private%}Request
                            {% else %}Follow
                            {% endif %}</button>
                        {% endif %}
                    </div>

                    <!-- Stats (Desktop) -->
                    <div class="ig-profile-stats desktop-only">
                        <div class="ig-profile-stat">
                            <span class="ig-stat-count">{{ tweets|length }}</span>
                            <span class="ig-stat-label">scribes</span>
                        </div>
                        <div class="ig-profile-stat" onclick="openFollowersModal()">
                            <span class="ig-stat-count" id="followersCount">{{ profile_user.follower_count }}</span>
                            <span class="ig-stat-label">followers</span>
                        </div>
                        <div class="ig-profile-stat" onclick="openFollowingModal()">
                            <span class="ig-stat-count" id="followingCount">{{ profile_user.following_count }}</span>
                            <span class="ig-stat-label">following</span>
                        </div>
                    </div>

                    <!-- Bio -->
                    <div class="ig-profile-bio">
                        <h2 class="ig-profile-name">{{ profile_user.full_name }}</h2>
                        {% if profile_user.bio %}
                        <p class="ig-profile-bio-text">{{ profile_user.bio|linebreaksbr }}</p>
                        {% endif %}
                        {% if profile_user.location %}
                        <span class="ig-profile-location">
                            <i data-lucide="map-pin" style="width: 12px; height: 12px;"></i>
                            {{ profile_user.location }}
                        </span>
                        {% endif %}
                    </div>
                </div>
        </header>

        <!-- Stats (Mobile) -->
        <div class="ig-profile-stats-mobile mobile-only">
            <div class="ig-profile-stat">
                <span class="ig-stat-count">{{ tweets|length }}</span>
                <span class="ig-stat-label">scribes</span>
            </div>
            <div class="ig-profile-stat" onclick="openFollowersModal()">
                <span class="ig-stat-count" id="followersCountMobile">{{ profile_user.follower_count }}</span>
                <span class="ig-stat-label">followers</span>
            </div>
            <div class="ig-profile-stat" onclick="openFollowingModal()">
                <span class="ig-stat-count" id="followingCountMobile">{{ profile_user.following_count }}</span>
                <span class="ig-stat-label">following</span>
            </div>
        </div>

        <!-- Story Highlights Section -->
        {% if is_own_profile or user_stories %}
        <div class="ig-highlights">
            {% if is_own_profile %}
            <!-- Add New Story Button -->
            <button class="ig-highlight-item" onclick="openStoryModal()">
                <div class="ig-highlight-add">
                    <i data-lucide="plus"></i>
                </div>
                <span class="ig-highlight-label">New</span>
            </button>
            {% endif %}

            <!-- User's Active Stories -->
            {% for story in user_stories %}
            <button class="ig-highlight-item ig-highlight-story" onclick="viewStoryFromProfile({{ story.id }})">
                <div class="ig-highlight-preview" {% if story.media_url %}
                    style="background-image: url('{{ story.media_url }}'); background-size: cover; background-position: center;"
                    {% else %} style="background: {{ story.background_color }};" {% endif %}>
                    {% if not story.media_url %}
                    <span class="ig-highlight-text-preview">{{ story.content|truncatechars:10 }}</span>
                    {% endif %}
                </div>
                <span class="ig-highlight-label">{{ story.created_at|timesince|truncatewords:1 }}</span>
            </button>
            {% empty %}
            {% if not is_own_profile %}
            <!-- No stories message for other users -->
            {% endif %}
            {% endfor %}
        </div>
        {% endif %}

        <!-- Content Tabs -->
        <div class="ig-profile-tabs">
            <button class="ig-profile-tab active" data-tab="posts">
                <i data-lucide="grid-3x3"></i>
                <span class="tab-text">Scribe</span>
            </button>
            <button class="ig-profile-tab" data-tab="reels">
                <i data-lucide="play-square"></i>
                <span class="tab-text">Omzo</span>
            </button>
            {% if is_own_profile %}
            <button class="ig-profile-tab" data-tab="saved">
                <i data-lucide="bookmark"></i>
                <span class="tab-text">Saved</span>
            </button>
            {% endif %}
        </div>

        <!-- Scribes Feed (match homepage style) -->
        {% if can_view_profile %}
        <style>
            /* Align profile feed width with homepage center column */
            #profilePostsFeed {
                display: flex;
                flex-direction: column;
                gap: 28px;
                width: 100%;
                max-width: 520px;
                margin: 0 auto;
            }
            @media (max-width: 768px) {
                #profilePostsFeed {
                    max-width: 100%;
                    gap: 20px;
                }
            }
            /* Ensure individual cards donâ€™t stretch wider on desktop */
            #profilePostsFeed .ig-post {
                width: 100%;
                max-width: 520px;
                margin: 0 auto;
            }
        </style>
        <div class="ig-profile-content" id="postsTab">
            {% if tweets %}
            <section class="ig-posts" id="profilePostsFeed">
                {% for tweet in tweets %}
                <article class="ig-post" data-tweet-id="{{ tweet.id }}">
                    <!-- Post Header -->
                    <header class="ig-post-header">
                        <a href="{% url 'user_profile' tweet.user.username %}" class="ig-post-user">
                            <img src="{{ tweet.user.profile_picture_url }}" alt="{{ tweet.user.full_name }}" class="ig-post-avatar"
                                onerror="this.outerHTML='<div class=\'ig-post-avatar-placeholder\'>{{ tweet.user.initials }}</div>'">
                            <div class="ig-post-user-info">
                                <span class="ig-post-username">{{ tweet.user.username }}</span>
                            </div>
                        </a>
                        <button class="ig-post-more" onclick="openPostDetail({{ tweet.id }})">
                            <i data-lucide="more-horizontal"></i>
                        </button>
                    </header>

                    <!-- Post Media -->
                    {% if tweet.content_type == 'code_scribe' %}
                    <div class="ig-post-media">
                        <iframe class="ig-code-scribe-view" title="Code Scribe"
                            style="width: 100%; min-height: 260px; border: none; background: var(--ig-bg);"
                            data-code-bundle="{{ tweet.code_bundle|urlencode }}"
                            data-code-html="{{ tweet.code_html|default:''|urlencode }}"
                            data-code-css="{{ tweet.code_css|default:''|urlencode }}"
                            data-code-js="{{ tweet.code_js|default:''|urlencode }}"></iframe>
                    </div>
                    {% elif tweet.image_url %}
                    <div class="ig-post-media" onclick="openImageModal('{{ tweet.image_url }}')">
                        <img src="{{ tweet.image_url }}" alt="Post image">
                    </div>
                    {% endif %}

                    <!-- Post Actions -->
                    <div class="ig-post-actions">
                        <div class="ig-post-actions-left">
                            <button class="ig-post-action-btn {% if tweet.is_liked %}liked{% endif %}"
                                onclick="toggleLike({{ tweet.id }})" data-tweet-id="{{ tweet.id }}">
                                <i data-lucide="heart"></i>
                            </button>
                            <button class="ig-post-action-btn" onclick="toggleComments({{ tweet.id }})">
                                <i data-lucide="message-circle"></i>
                            </button>
                        </div>
                    </div>

                    <!-- Post Details -->
                    <div class="ig-post-details">
                        <div class="ig-post-likes">
                            <span class="like-count" data-tweet-id="{{ tweet.id }}">{{ tweet.like_count }}</span> likes
                        </div>

                        {% if tweet.content %}
                        <div class="ig-post-caption">
                            <span class="username">{{ tweet.user.username }}</span>
                            <span>{{ tweet.content|linkify_hashtags_mentions }}</span>
                        </div>
                        {% endif %}

                        {% if tweet.comment_count > 0 %}
                        <div class="ig-post-view-comments" onclick="openPostDetail({{ tweet.id }})">
                            View all {{ tweet.comment_count }} comments
                        </div>
                        {% endif %}

                        <time class="ig-post-time">{{ tweet.timestamp|timesince }} ago</time>
                    </div>

                    <!-- Comment Input -->
                    <div class="ig-post-comment-input">
                        <input type="text" placeholder="Add a comment..." id="comment-input-{{ tweet.id }}"
                            maxlength="500" onkeypress="handleCommentKeypress(event, {{ tweet.id }})">
                        <button onclick="addComment({{ tweet.id }})">Post</button>
                    </div>

                    <!-- Comments Section (Hidden by default) -->
                    <div id="comments-{{ tweet.id }}" class="ig-comments-section" style="display: none;">
                        <div class="ig-comments-list" id="comments-list-{{ tweet.id }}"></div>
                    </div>
                </article>
                {% endfor %}
            </section>
            {% else %}
            <!-- No Scribes -->
            <div class="ig-no-posts">
                {% if is_own_profile %}
                <div class="ig-no-posts-icon">
                    <i data-lucide="camera"></i>
                </div>
                <h3>Share Scribes</h3>
                <p>When you share scribes, they will appear in your profile timeline.</p>
                <button class="ig-auth-btn" onclick="openCreatePostModal()"
                    style="width: auto; padding: 8px 16px; margin-top: 16px;">Share your first scribe</button>
                {% else %}
                <div class="ig-no-posts-icon">
                    <i data-lucide="camera-off"></i>
                </div>
                <h3>No Scribes Yet</h3>
                {% endif %}
            </div>
            {% endif %}
        </div>

        <!-- Omzo Tab Content -->
        <div class="ig-profile-content" id="reelsTab" style="display: none;">
            {% if reels %}
            <div class="ig-posts-grid">
                {% for reel in reels %}
                <div class="ig-grid-item" onclick="window.location.href='{% url 'reels' %}?reel_id={{ reel.id }}'">
                    <video src="{{ reel.video_file.url }}" class="ig-grid-video"
                        style="width: 100%; height: 100%; object-fit: cover;" preload="metadata"></video>
                    <div class="ig-grid-overlay">
                        <div class="ig-grid-stats">
                            <span><i data-lucide="heart"></i> {{ reel.likes.count }}</span>
                            <span><i data-lucide="message-circle"></i> {{ reel.comments.count }}</span>
                        </div>
                    </div>
                </div>
                {% endfor %}
            </div>
            {% else %}
            <div class="ig-no-posts">
                <div class="ig-no-posts-icon">
                    <i data-lucide="video-off"></i>
                </div>
                <h3>No Omzo Yet</h3>
                {% if is_own_profile %}
                <p>Record and share short videos.</p>
                <button class="ig-auth-btn" onclick="document.getElementById('globalReelInput').click()"
                    style="width: auto; padding: 8px 16px; margin-top: 16px;">Create Reel</button>
                {% endif %}
            </div>
            {% endif %}
        </div>


        <!-- Saved Posts Grid (Only for own profile) -->
        {% if is_own_profile %}
        <div class="ig-profile-content" id="savedTab" style="display: none;">
            {% if saved_posts %}
            <div class="ig-posts-grid">
                {% for post in saved_posts %}
                <div class="ig-grid-item" onclick="openPostDetail({{ post.id }})">
                    {% if post.content_type == 'code_scribe' %}
                    <!-- Code Scribe Display -->
                    <div style="width: 100%; height: 100%; background: var(--ig-surface); display: flex; align-items: center; justify-content: center; position: relative; overflow: hidden;">
                        <iframe class="ig-code-scribe-view" sandbox="allow-scripts allow-modals" 
                            data-code-bundle="{{ post.code_bundle|urlencode }}"
                            data-code-html="{{ post.code_html|default:''|urlencode }}"
                            data-code-css="{{ post.code_css|default:''|urlencode }}"
                            data-code-js="{{ post.code_js|default:''|urlencode }}"
                            style="width: 100%; height: 100%; border: none; display: block; background: white;"></iframe>
                    </div>
                    {% elif post.image_url %}
                    <img src="{{ post.image_url }}" alt="" loading="lazy">
                    {% else %}
                    <div class="ig-grid-text-post">
                        <p>{{ post.content|truncatechars:100 }}</p>
                    </div>
                    {% endif %}
                    <div class="ig-grid-overlay">
                        <div class="ig-grid-stats">
                            <span><i data-lucide="heart"></i> {{ post.like_count }}</span>
                            <span><i data-lucide="message-circle"></i> {{ post.comment_count }}</span>
                        </div>
                    </div>
                </div>
                {% endfor %}
            </div>
            {% else %}
            <!-- No Saved Posts -->
            <div class="ig-no-posts">
                <div class="ig-no-posts-icon">
                    <i data-lucide="bookmark"></i>
                </div>
                <h3>Save</h3>
                <p>Save photos and videos that you want to see again. No one is notified, and only you can see what
                    you've
                    saved.</p>
            </div>
            {% endif %}
        </div>
        {% endif %}

        {% else %}
        <!-- Private/Blocked Account -->
        <div class="ig-private-profile">
            {% if is_blocked %}
            <div class="ig-private-icon">
                <i data-lucide="ban"></i>
            </div>
            <h3>Profile Unavailable</h3>
            <p>This profile is not available.</p>
            {% else %}
            <div class="ig-private-icon">
                <i data-lucide="lock"></i>
            </div>
            <h3>This Account is Private</h3>
            <p>Follow this account to see their photos and videos.</p>
            {% endif %}
        </div>
        {% endif %}
    </div>
</div>

<!-- Chats Panel (Same as Dashboard) -->
<div id="chatsPanel" class="ig-modal-overlay" style="display: none;" onclick="closeChatsPanel(event)">
    <div class="ig-direct" style="margin: 0; margin-left: auto; height: 100vh; border-radius: 0; max-width: 400px;"
        onclick="event.stopPropagation()">
        <div class="ig-direct-sidebar" style="width: 100%;">
            <header class="ig-direct-header">
                <button onclick="closeChatsPanel()"
                    style="background: none; border: none; cursor: pointer; padding: 8px;">
                    <i data-lucide="arrow-left" style="width: 24px; height: 24px;"></i>
                </button>
                <h2 class="ig-direct-title">{{ current_user.username }}</h2>
                <button class="ig-direct-new">
                    <i data-lucide="edit"></i>
                </button>
            </header>
            <div class="ig-direct-list">
                {% for chat in private_chats %}
                {% for participant in chat.participants.all %}
                {% if participant != current_user %}
                <a href="{% url 'chat_detail' chat.id %}" class="ig-direct-item">
                    <img src="{{ participant.profile_picture_url }}" alt="{{ participant.full_name }}"
                        class="ig-direct-item-avatar">
                    <div class="ig-direct-item-info">
                        <div class="ig-direct-item-name">{{ participant.full_name }}</div>
                        <div class="ig-direct-item-preview">@{{ participant.username }}</div>
                    </div>
                </a>
                {% endif %}
                {% endfor %}
                {% endfor %}
                {% for chat in group_chats %}
                <a href="{% url 'chat_detail' chat.id %}" class="ig-direct-item">
                    <div
                        style="width: 56px; height: 56px; border-radius: 50%; background: var(--brand-gradient); display: flex; align-items: center; justify-content: center;">
                        <i data-lucide="users" style="color: white; width: 24px; height: 24px;"></i>
                    </div>
                    <div class="ig-direct-item-info">
                        <div class="ig-direct-item-name">{{ chat.name }}</div>
                        <div class="ig-direct-item-preview">{{ chat.participant_count }} members</div>
                    </div>
                </a>
                {% endfor %}
            </div>
        </div>
    </div>
</div>

<!-- Create Post Modal (Same as Dashboard) -->
<div id="createPostModal" class="ig-modal-overlay" style="display: none;" onclick="closeCreatePostModal(event)">
    <div class="ig-create-modal" onclick="event.stopPropagation()">
        <header class="ig-create-header">
            <button class="ig-create-back" onclick="closeCreatePostModal()">
                <i data-lucide="x"></i>
            </button>
            <h2 class="ig-create-title">Create Post</h2>
            <button class="ig-create-next" onclick="submitPost()" id="sharePostBtn">Share</button>
        </header>
        <div class="ig-create-body">
            <!-- User info and text input -->
            <div class="ig-create-sidebar" id="createSidebar">
                <div class="ig-create-user">
                    <img src="{{ current_user.profile_picture_url }}" alt="" class="ig-create-avatar"
                        onerror="this.outerHTML='<div class=\'ig-create-avatar-placeholder\'>{{ current_user.initials }}</div>'">
                    <div class="ig-create-user-info">
                        <span class="ig-create-username">{{ current_user.username }}</span>
                        <span class="ig-create-visibility"><i data-lucide="globe"
                                style="width: 12px; height: 12px;"></i> Public</span>
                    </div>
                </div>

                <div class="ig-create-textarea-wrapper">
                    <textarea class="ig-create-textarea" id="postCaption" placeholder="What's happening?"
                        maxlength="280" oninput="updateCharCount()"></textarea>

                    <!-- Image Preview Area -->
                    <div id="postImagePreview" class="ig-create-image-preview" style="display: none;">
                        <button class="ig-create-image-remove" onclick="removePostImage()">
                            <i data-lucide="x"></i>
                        </button>
                        <img id="postPreviewImg" src="" alt="Preview">
                    </div>
                </div>

                <!-- Action Row -->
                <div class="ig-create-actions">
                    <div class="ig-create-actions-left">
                        <label class="ig-create-action-btn" title="Add photo">
                            <i data-lucide="image"></i>
                            <input type="file" accept="image/*" id="postImageInput" style="display: none;"
                                onchange="handlePostImageSelect(event)">
                        </label>
                        <button type="button" class="ig-create-action-btn" onclick="toggleGifPicker()" title="Add GIF">
                            <i data-lucide="sparkles"></i>
                        </button>
                        <button type="button" class="ig-create-action-btn emoji-btn" onclick="toggleEmojiPicker()"
                            title="Add emoji">
                            <i data-lucide="smile"></i>
                        </button>
                        <button type="button" class="ig-create-action-btn" onclick="#"
                            title="Create web code snippet">
                            <i data-lucide="code-editor"></i>
                        </button>
                    </div>
                    <div class="ig-create-actions-right">
                        <div class="ig-create-char-count">
                            <svg viewBox="0 0 36 36" class="ig-char-circle">
                                <path class="ig-char-bg"
                                    d="M18 2.0845 a 15.9155 15.9155 0 0 1 0 31.831 a 15.9155 15.9155 0 0 1 0 -31.831">
                                </path>
                                <path class="ig-char-progress" id="charCircle" stroke-dasharray="0, 100"
                                    d="M18 2.0845 a 15.9155 15.9155 0 0 1 0 31.831 a 15.9155 15.9155 0 0 1 0 -31.831">
                                </path>
                            </svg>
                            <span id="captionCharCount" class="ig-char-number">0</span>
                        </div>
                    </div>
                </div>

                <!-- GIF Picker -->
                <div class="ig-gif-picker" id="gifPicker" style="display: none;">
                    <div class="ig-gif-search">
                        <i data-lucide="search"></i>
                        <input type="text" id="gifSearchInput" placeholder="Search GIFs..."
                            oninput="searchGifs(this.value)">
                    </div>
                    <div class="ig-gif-grid" id="gifGrid">
                        <div class="ig-gif-loading">
                            <div class="ig-gif-spinner"></div>
                            <span>Loading GIFs...</span>
                        </div>
                    </div>
                    <div class="ig-gif-powered">
                        <span>Powered by GIPHY</span>
                    </div>
                </div>

                <!-- Quick Emoji Row -->
                <div class="ig-create-emoji-row" id="emojiPicker" style="display: none;">
                    <button type="button" onclick="insertEmoji('ðŸ˜Š')">ðŸ˜Š</button>
                    <button type="button" onclick="insertEmoji('â¤ï¸')">â¤ï¸</button>
                    <button type="button" onclick="insertEmoji('ðŸ”¥')">ðŸ”¥</button>
                    <button type="button" onclick="insertEmoji('ðŸ‘')">ðŸ‘</button>
                    <button type="button" onclick="insertEmoji('ðŸ˜‚')">ðŸ˜‚</button>
                    <button type="button" onclick="insertEmoji('ðŸŽ‰')">ðŸŽ‰</button>
                    <button type="button" onclick="insertEmoji('ðŸ’¯')">ðŸ’¯</button>
                    <button type="button" onclick="insertEmoji('âœ¨')">âœ¨</button>
                    <button type="button" onclick="insertEmoji('ðŸ™Œ')">ðŸ™Œ</button>
                    <button type="button" onclick="insertEmoji('ðŸ˜')">ðŸ˜</button>
                    <button type="button" onclick="insertEmoji('ðŸ¤”')">ðŸ¤”</button>
                    <button type="button" onclick="insertEmoji('ðŸ‘€')">ðŸ‘€</button>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Create Story Modal - Professional Design -->
<div id="storyModal" class="ig-modal-overlay" style="display: none;" onclick="closeStoryModal(event)">
    <div class="ig-story-create-wrapper" onclick="event.stopPropagation()">
        <header class="ig-story-create-header">
            <button class="ig-story-close-btn" onclick="closeStoryModal()">
                <i data-lucide="x"></i>
            </button>
            <h2 class="ig-story-create-title">Create Story</h2>
            <button class="ig-story-share-btn" onclick="createStory()">
                <i data-lucide="send"></i>
                Share
            </button>
        </header>

        <div class="ig-story-create-body">
            <!-- Story Preview Canvas -->
            <div class="ig-story-canvas-wrapper">
                <div class="ig-story-canvas" id="storyPreviewContainer">
                    <!-- Image Layer -->
                    <div id="storyPreviewImage" class="ig-story-preview-img" style="display: none;">
                        <img id="storyPreviewImg" src="" alt="Preview" draggable="false">
                    </div>
                    <!-- Draggable Text Layer -->
                    <div id="storyPreviewText" class="ig-story-canvas-text" contenteditable="true"
                        data-placeholder="Tap to add text..."
                        style="top: 50%; left: 50%; transform: translate(-50%, -50%);"
                        onclick="event.stopPropagation()"></div>
                </div>
            </div>

            <!-- Story Controls Panel -->
            <div class="ig-story-controls-panel">
                <h3 class="ig-story-panel-title">
                    <i data-lucide="wand-2"></i>
                    Customize Your Story
                </h3>

                <div class="ig-story-control-group">
                    <!-- Add Photo -->
                    <label class="ig-story-control-item">
                        <div class="ig-story-control-icon photo">
                            <i data-lucide="image-plus"></i>
                        </div>
                        <div class="ig-story-control-info">
                            <span class="ig-story-control-label">Add Photo</span>
                            <span class="ig-story-control-desc">Upload from gallery</span>
                        </div>
                        <input type="file" accept="image/*" id="storyImageInput" style="display: none;"
                            onchange="handleStoryImageSelect(event)">
                    </label>

                    <!-- Image Controls (shown when image is added) -->
                    <div id="storyImageControls" class="ig-story-image-controls" style="display: none;">
                        <button type="button" class="ig-story-remove-img" onclick="removeStoryImage()">
                            <i data-lucide="trash-2"></i>
                            Remove Image
                        </button>
                    </div>

                    <div class="ig-story-control-divider"></div>

                    <!-- Text Position Controls -->
                    <div class="ig-story-text-position">
                        <span class="ig-story-preset-label">Text Position</span>
                        <div class="ig-story-position-btns">
                            <button type="button" class="ig-story-pos-btn" onclick="setTextPosition('top')" title="Top">
                                <i data-lucide="align-start-vertical"></i>
                            </button>
                            <button type="button" class="ig-story-pos-btn active" onclick="setTextPosition('center')"
                                title="Center">
                                <i data-lucide="align-center-vertical"></i>
                            </button>
                            <button type="button" class="ig-story-pos-btn" onclick="setTextPosition('bottom')"
                                title="Bottom">
                                <i data-lucide="align-end-vertical"></i>
                            </button>
                            <button type="button" class="ig-story-pos-btn" onclick="enableTextDrag()" title="Custom"
                                id="customPosBtn">
                                <i data-lucide="move"></i>
                            </button>
                        </div>
                    </div>

                    <div class="ig-story-control-divider"></div>

                    <!-- Gradient Presets -->
                    <div class="ig-story-preset-colors">
                        <span class="ig-story-preset-label">Background</span>
                        <div class="ig-story-preset-grid">
                            <button type="button" class="ig-story-preset active"
                                style="background: linear-gradient(135deg, #667eea, #764ba2);"
                                onclick="setStoryGradient('#667eea', '#764ba2', this)"></button>
                            <button type="button" class="ig-story-preset"
                                style="background: linear-gradient(135deg, #f093fb, #f5576c);"
                                onclick="setStoryGradient('#f093fb', '#f5576c', this)"></button>
                            <button type="button" class="ig-story-preset"
                                style="background: linear-gradient(135deg, #4facfe, #00f2fe);"
                                onclick="setStoryGradient('#4facfe', '#00f2fe', this)"></button>
                            <button type="button" class="ig-story-preset"
                                style="background: linear-gradient(135deg, #43e97b, #38f9d7);"
                                onclick="setStoryGradient('#43e97b', '#38f9d7', this)"></button>
                            <button type="button" class="ig-story-preset"
                                style="background: linear-gradient(135deg, #fa709a, #fee140);"
                                onclick="setStoryGradient('#fa709a', '#fee140', this)"></button>
                            <button type="button" class="ig-story-preset"
                                style="background: linear-gradient(135deg, #a8edea, #fed6e3);"
                                onclick="setStoryGradient('#a8edea', '#fed6e3', this)"></button>
                            <button type="button" class="ig-story-preset"
                                style="background: linear-gradient(135deg, #ff9a9e, #fecfef);"
                                onclick="setStoryGradient('#ff9a9e', '#fecfef', this)"></button>
                            <button type="button" class="ig-story-preset" style="background: #000000;"
                                onclick="setStoryBackground('#000000', this)"></button>
                        </div>
                    </div>

                    <div class="ig-story-control-divider"></div>

                    <!-- Text Color -->
                    <div class="ig-story-color-row">
                        <label class="ig-story-color-label">
                            <span>Text Color</span>
                            <div class="ig-story-color-preview" id="textColorPreview" style="background: #ffffff;">
                            </div>
                            <input type="color" id="storyTextColor" value="#ffffff"
                                onchange="changeStoryTextColor(this.value)">
                        </label>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<style>
    /* Professional Create Story Modal for Profile Page */
    #storyModal.ig-modal-overlay {
        z-index: 9999 !important;
    }

    .ig-story-create-wrapper {
        background: var(--ig-surface);
        border-radius: 24px;
        overflow: hidden;
        width: 95%;
        max-width: 800px;
        max-height: 90vh;
        box-shadow: 0 25px 80px rgba(0, 0, 0, 0.4);
        animation: modalSlideUp 0.3s cubic-bezier(0.16, 1, 0.3, 1);
        display: flex;
        flex-direction: column;
    }

    @keyframes modalSlideUp {
        from {
            opacity: 0;
            transform: translateY(20px) scale(0.98);
        }

        to {
            opacity: 1;
            transform: translateY(0) scale(1);
        }
    }

    .ig-story-create-header {
        display: flex;
        align-items: center;
        justify-content: space-between;
        padding: 16px 24px;
        border-bottom: 1px solid var(--ig-border);
        background: linear-gradient(135deg, rgba(102, 126, 234, 0.08), rgba(118, 75, 162, 0.08));
    }

    .ig-story-close-btn {
        width: 40px;
        height: 40px;
        border-radius: 50%;
        border: none;
        background: var(--ig-bg);
        cursor: pointer;
        display: flex;
        align-items: center;
        justify-content: center;
        transition: all 0.2s;
        color: var(--ig-text-primary);
    }

    .ig-story-close-btn:hover {
        background: var(--ig-surface-hover);
        transform: scale(1.1);
    }

    .ig-story-close-btn i {
        width: 22px;
        height: 22px;
    }

    .ig-story-create-title {
        font-size: 18px;
        font-weight: 700;
        background: var(--odnix-gradient);
        -webkit-background-clip: text;
        -webkit-text-fill-color: transparent;
        background-clip: text;
    }

    .ig-story-share-btn {
        display: flex;
        align-items: center;
        gap: 8px;
        background: var(--odnix-gradient);
        color: white;
        border: none;
        padding: 10px 20px;
        border-radius: 25px;
        font-weight: 600;
        font-size: 14px;
        cursor: pointer;
        transition: all 0.2s;
        box-shadow: 0 4px 15px rgba(102, 126, 234, 0.35);
    }

    .ig-story-share-btn:hover {
        transform: translateY(-2px);
        box-shadow: 0 6px 25px rgba(102, 126, 234, 0.45);
    }

    .ig-story-share-btn i {
        width: 18px;
        height: 18px;
    }

    .ig-story-create-body {
        display: flex;
        gap: 24px;
        padding: 24px;
        flex: 1;
        overflow: hidden;
    }

    /* Story Canvas Styles */
    .ig-story-canvas-wrapper {
        display: flex;
        align-items: center;
        justify-content: center;
        padding: 20px;
    }

    .ig-story-canvas {
        position: relative;
        width: 320px;
        aspect-ratio: 9/16;
        border-radius: 16px;
        overflow: hidden;
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        display: flex;
        align-items: center;
        justify-content: center;
        border: 2px solid var(--ig-border);
        box-shadow: 0 10px 40px rgba(0, 0, 0, 0.2);
    }

    .ig-story-preview-img {
        position: absolute;
        inset: 0;
    }

    .ig-story-preview-img img {
        width: 100%;
        height: 100%;
        object-fit: cover;
    }

    .ig-story-canvas-text {
        position: absolute;
        width: 90%;
        text-align: center;
        color: white;
        font-size: 20px;
        font-weight: 600;
        text-shadow: 0 2px 10px rgba(0, 0, 0, 0.3);
        outline: none;
        min-height: 30px;
        word-wrap: break-word;
        z-index: 5;
        cursor: move;
    }

    .ig-story-canvas-text:empty:before {
        content: attr(data-placeholder);
        color: rgba(255, 255, 255, 0.5);
        pointer-events: none;
    }

    .ig-story-controls-panel {
        flex: 1;
        display: flex;
        flex-direction: column;
        gap: 20px;
        overflow-y: auto;
        -webkit-overflow-scrolling: touch;
    }

    .ig-story-preset-colors {
        display: flex;
        flex-direction: column;
        gap: 12px;
        pointer-events: auto;
    }

    .ig-story-preset-grid {
        display: flex;
        gap: 10px;
        flex-wrap: wrap;
        pointer-events: auto;
    }

    .ig-story-panel-title {
        display: flex;
        align-items: center;
        gap: 10px;
        font-size: 16px;
        font-weight: 600;
        color: var(--ig-text-primary);
        margin-bottom: 8px;
    }

    .ig-story-panel-title i {
        width: 20px;
        height: 20px;
        color: var(--color-primary);
    }

    .ig-story-control-group {
        display: flex;
        flex-direction: column;
        gap: 16px;
    }

    .ig-story-control-item {
        display: flex;
        align-items: center;
        gap: 16px;
        padding: 16px;
        background: var(--ig-bg);
        border-radius: 16px;
        cursor: pointer;
        transition: all 0.2s;
        border: 1px solid var(--ig-border);
    }

    .ig-story-control-item:hover {
        background: var(--ig-surface-hover);
        border-color: var(--color-primary);
        transform: translateY(-2px);
    }

    .ig-story-control-icon {
        width: 48px;
        height: 48px;
        border-radius: 14px;
        display: flex;
        align-items: center;
        justify-content: center;
        flex-shrink: 0;
    }

    .ig-story-control-icon.photo {
        background: linear-gradient(135deg, #667eea, #764ba2);
    }

    .ig-story-control-icon i {
        width: 24px;
        height: 24px;
        color: white;
    }

    .ig-story-control-info {
        display: flex;
        flex-direction: column;
        gap: 2px;
    }

    .ig-story-control-label {
        font-weight: 600;
        font-size: 15px;
        color: var(--ig-text-primary);
    }

    .ig-story-control-desc {
        font-size: 13px;
        color: var(--ig-text-secondary);
    }

    .ig-story-control-divider {
        height: 1px;
        background: var(--ig-border);
        margin: 4px 0;
    }

    .ig-story-preset-label {
        font-size: 13px;
        font-weight: 500;
        color: var(--ig-text-secondary);
    }

    .ig-story-preset {
        width: 44px;
        height: 44px;
        border-radius: 12px;
        border: 2px solid transparent;
        cursor: pointer;
        transition: all 0.2s;
        box-shadow: 0 2px 8px rgba(0, 0, 0, 0.15);
        pointer-events: auto;
        -webkit-appearance: none;
        appearance: none;
        outline: none;
    }

    .ig-story-preset:hover {
        transform: scale(1.1);
        border-color: white;
        box-shadow: 0 4px 15px rgba(0, 0, 0, 0.25);
    }

    .ig-story-preset.active {
        border-color: var(--color-primary);
        transform: scale(1.05);
        box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.3);
    }

    /* Draggable Text */
    .ig-story-text-draggable {
        position: absolute;
        cursor: move;
        padding: 12px 16px;
        border-radius: 8px;
        transition: background 0.2s;
        min-width: 50px;
        max-width: 90%;
    }

    .ig-story-text-draggable:focus {
        cursor: text;
        background: rgba(0, 0, 0, 0.2);
        outline: 2px dashed rgba(255, 255, 255, 0.5);
    }

    .ig-story-text-draggable.dragging {
        cursor: grabbing;
        background: rgba(0, 0, 0, 0.3);
        outline: 2px solid rgba(255, 255, 255, 0.8);
    }

    /* Image Controls */
    .ig-story-image-controls {
        display: flex;
        flex-direction: column;
        gap: 14px;
        padding: 16px;
        background: var(--ig-bg);
        border-radius: 14px;
        border: 1px solid var(--ig-border);
    }

    .ig-story-slider-control {
        display: flex;
        align-items: center;
        gap: 12px;
    }

    .ig-story-slider-control label {
        display: flex;
        align-items: center;
        gap: 6px;
        font-size: 13px;
        font-weight: 500;
        color: var(--ig-text-primary);
        min-width: 70px;
    }

    .ig-story-slider-control label i {
        width: 16px;
        height: 16px;
    }

    .ig-story-slider-control input[type="range"] {
        flex: 1;
        height: 6px;
        -webkit-appearance: none;
        appearance: none;
        background: var(--ig-border);
        border-radius: 3px;
        outline: none;
    }

    .ig-story-slider-control input[type="range"]::-webkit-slider-thumb {
        -webkit-appearance: none;
        appearance: none;
        width: 18px;
        height: 18px;
        border-radius: 50%;
        background: var(--odnix-gradient);
        cursor: pointer;
        border: 2px solid white;
        box-shadow: 0 2px 6px rgba(0, 0, 0, 0.2);
    }

    .ig-story-slider-control span {
        font-size: 12px;
        color: var(--ig-text-secondary);
        min-width: 45px;
        text-align: right;
    }

    .ig-story-remove-img {
        display: flex;
        align-items: center;
        justify-content: center;
        gap: 8px;
        padding: 10px;
        background: rgba(239, 68, 68, 0.1);
        color: #ef4444;
        border: none;
        border-radius: 10px;
        font-size: 13px;
        font-weight: 500;
        cursor: pointer;
        transition: all 0.2s;
    }

    .ig-story-remove-img:hover {
        background: rgba(239, 68, 68, 0.2);
    }

    .ig-story-remove-img i {
        width: 16px;
        height: 16px;
    }

    /* Text Position Controls */
    .ig-story-text-position {
        display: flex;
        flex-direction: column;
        gap: 10px;
    }

    .ig-story-position-btns {
        display: flex;
        gap: 8px;
    }

    .ig-story-pos-btn {
        flex: 1;
        display: flex;
        align-items: center;
        justify-content: center;
        padding: 12px;
        background: var(--ig-bg);
        border: 1px solid var(--ig-border);
        border-radius: 10px;
        cursor: pointer;
        transition: all 0.2s;
        color: var(--ig-text-primary);
    }

    .ig-story-pos-btn:hover {
        background: var(--ig-surface-hover);
        border-color: var(--color-primary);
    }

    .ig-story-pos-btn.active {
        background: var(--odnix-gradient);
        color: white;
        border-color: transparent;
    }

    .ig-story-pos-btn i {
        width: 20px;
        height: 20px;
    }

    /* Color Row */
    .ig-story-color-row {
        display: flex;
        gap: 12px;
    }

    .ig-story-color-label {
        display: flex;
        align-items: center;
        gap: 12px;
        padding: 14px 16px;
        background: var(--ig-bg);
        border-radius: 12px;
        cursor: pointer;
        transition: all 0.2s;
        border: 1px solid var(--ig-border);
        flex: 1;
    }

    .ig-story-color-label:hover {
        border-color: var(--color-primary);
    }

    .ig-story-color-label span {
        flex: 1;
        font-size: 14px;
        font-weight: 500;
        color: var(--ig-text-primary);
    }

    .ig-story-color-label input[type="color"] {
        width: 0;
        height: 0;
        opacity: 0;
        position: absolute;
    }

    .ig-story-color-preview {
        width: 28px;
        height: 28px;
        border-radius: 50%;
        border: 2px solid var(--ig-border);
        box-shadow: 0 2px 8px rgba(0, 0, 0, 0.15);
    }

    @media (max-width: 768px) {
        .ig-story-create-wrapper {
            max-width: 100%;
            max-height: 100vh;
            border-radius: 0;
            height: 100vh;
        }

        .ig-story-create-body {
            flex-direction: column;
            overflow-y: auto;
            -webkit-overflow-scrolling: touch;
            flex: 1;
            padding-bottom: 100px;
        }

        .ig-story-canvas-wrapper {
            padding: 10px;
            flex-shrink: 0;
        }

        .ig-story-canvas {
            width: 200px;
            border-radius: 12px;
        }

        .ig-story-canvas-text {
            font-size: 14px;
        }

        .ig-story-controls-panel {
            padding: 0 16px 20px;
            flex-shrink: 0;
            overflow: visible;
        }

        .ig-story-preset-grid {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 12px;
        }

        .ig-story-preset {
            width: 100%;
            aspect-ratio: 1;
            height: auto;
            min-height: 44px;
            cursor: pointer;
        }

        .ig-story-control-item {
            padding: 12px;
        }

        .ig-story-text-position .ig-story-position-btns {
            gap: 8px;
        }

        .ig-story-pos-btn {
            padding: 10px;
            min-width: 44px;
            min-height: 44px;
        }
    }
</style>

<!-- Post Detail Modal -->
<div id="postDetailModal" class="ig-modal-overlay" style="display: none;" onclick="closePostDetail(event)">
    <button class="ig-detail-close-btn" onclick="closePostDetail()">
        <i data-lucide="x"></i>
    </button>
    <div class="ig-post-detail-wrapper" onclick="event.stopPropagation()">
        <div class="ig-post-detail-media" id="postDetailMedia"></div>
        <div class="ig-post-detail-sidebar">
            <header class="ig-detail-header" id="postDetailHeader"></header>
            <div class="ig-detail-comments" id="postDetailComments">
                <div class="ig-detail-caption" id="postDetailCaption"></div>
            </div>
            <div class="ig-detail-actions" id="postDetailActions"></div>
            <div class="ig-detail-info" id="postDetailInfo"></div>
            <div class="ig-detail-comment-form">
                <button class="ig-emoji-btn"><i data-lucide="smile"></i></button>
                <input type="text" id="postDetailCommentInput" placeholder="Add a comment..."
                    class="ig-detail-comment-input">
                <button class="ig-post-comment-btn" id="postCommentBtn" onclick="postCommentFromDetail()">Post</button>
            </div>
        </div>
    </div>
</div>

<!-- Followers Modal -->
<div id="followersModal" class="ig-modal-overlay" style="display: none;" onclick="closeFollowersModal(event)">
    <div class="ig-modal" onclick="event.stopPropagation()">
        <header class="ig-modal-header">
            <h2 class="ig-modal-title">Followers</h2>
            <button class="ig-modal-close" onclick="closeFollowersModal()">
                <i data-lucide="x"></i>
            </button>
        </header>
        <div class="ig-modal-body" id="followersList">
            <div class="ig-loading">
                <div class="ig-spinner"></div>
            </div>
        </div>
    </div>
</div>

<!-- Following Modal -->
<div id="followingModal" class="ig-modal-overlay" style="display: none;" onclick="closeFollowingModal(event)">
    <div class="ig-modal" onclick="event.stopPropagation()">
        <header class="ig-modal-header">
            <h2 class="ig-modal-title">Following</h2>
            <button class="ig-modal-close" onclick="closeFollowingModal()">
                <i data-lucide="x"></i>
            </button>
        </header>
        <div class="ig-modal-body" id="followingList">
            <div class="ig-loading">
                <div class="ig-spinner"></div>
            </div>
        </div>
    </div>
</div>

<!-- Follow Requests Modal -->
<div id="followRequestsModal" class="ig-modal-overlay" style="display: none;" onclick="closeFollowRequestsModal(event)">
    <div class="ig-modal" onclick="event.stopPropagation()" style="max-width: 400px;">
        <header class="ig-modal-header">
            <h2 class="ig-modal-title">Follow Requests</h2>
            <button class="ig-modal-close" onclick="closeFollowRequestsModal()">
                <i data-lucide="x"></i>
            </button>
        </header>
        <div class="ig-modal-body" id="followRequestsList" style="padding: 0; max-height: 60vh; overflow-y: auto;">
            <div class="ig-loading">
                <div class="ig-spinner"></div>
            </div>
        </div>
    </div>
</div>

<!-- Settings Modal -->
<div id="settingsModal" class="ig-modal-overlay" style="display: none;" onclick="closeSettingsModal(event)">
    <div class="ig-modal" onclick="event.stopPropagation()" style="max-width: 400px;">
        <header class="ig-modal-header">
            <h2 class="ig-modal-title">Settings</h2>
            <button class="ig-modal-close" onclick="closeSettingsModal()">
                <i data-lucide="x"></i>
            </button>
        </header>
        <div class="ig-settings-list">
            <a href="{% url 'update_profile' %}" class="ig-settings-item">
                <i data-lucide="user"></i>
                <span>Edit Profile</span>
            </a>
            
            <!-- Theme Section -->
            <div class="ig-settings-section">
                <h3 class="ig-settings-section-title">Appearance</h3>
                <a href="{% url 'update_profile' %}#theme-section" class="ig-settings-item">
                    <i data-lucide="palette"></i>
                    <span>Customize Theme</span>
                    <span class="ig-settings-value">{{ user.theme|default:"light"|title }}</span>
                    <i data-lucide="chevron-right" style="width: 16px; height: 16px; opacity: 0.5;"></i>
                </a>
            </div>

            <!-- Privacy Section -->
            <div class="ig-settings-section">
                <h3 class="ig-settings-section-title">Privacy</h3>
                <button class="ig-settings-item" onclick="togglePrivacy()">
                    <i data-lucide="lock"></i>
                    <span>Private Account</span>
                    <div class="ig-toggle {% if current_user.is_private %}active{% endif %}" id="privacyToggle"></div>
                </button>
            </div>

            <!-- Account Section -->
            <div class="ig-settings-section">
                <h3 class="ig-settings-section-title">Account</h3>
                <a href="{% url 'logout' %}" class="ig-settings-item danger">
                    <i data-lucide="log-out"></i>
                    <span>Log Out</span>
                </a>
            </div>
        </div>
    </div>
</div>

<!-- Search Modal -->
<div id="searchModal" class="ig-modal-overlay" style="display: none;" onclick="closeSearchModal(event)">
    <div class="ig-modal" style="max-width: 500px; height: 80vh; max-height: 600px;" onclick="event.stopPropagation()">
        <header class="ig-modal-header" style="flex-direction: column; gap: 12px; align-items: stretch;">
            <div style="display: flex; align-items: center; justify-content: space-between;">
                <h2 class="ig-modal-title">Search</h2>
                <button class="ig-modal-close" onclick="closeSearchModal()">
                    <i data-lucide="x"></i>
                </button>
            </div>
            <div class="ig-search-bar" style="width: 100%; display: flex;">
                <i data-lucide="search" class="search-icon"></i>
                <input type="text" placeholder="Search users..." id="mobileSearchInput"
                    onkeyup="handleMobileSearch(event)" style="width: 100%;">
            </div>
        </header>
        <div class="ig-modal-body" style="padding: 0; overflow-y: auto;">
            <div id="searchResults">
                <div style="text-align: center; padding: 40px 20px; color: var(--color-text-secondary);">
                    <i data-lucide="search" style="width: 40px; height: 40px; margin-bottom: 12px;"></i>
                    <p style="font-size: 14px;">Search for users by username or name</p>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Create Post Modal -->
<div id="createPostModal" class="ig-modal-overlay" style="display: none;" onclick="closeCreatePostModal(event)">
    <div class="ig-create-modal" onclick="event.stopPropagation()">
        <header class="ig-create-header">
            <button class="ig-create-back" onclick="closeCreatePostModal()">
                <i data-lucide="x"></i>
            </button>
            <h2 class="ig-create-title">Create new post</h2>
            <button class="ig-create-next" onclick="submitPost()" id="sharePostBtn">Share</button>
        </header>
        <div class="ig-create-body">
            <div class="ig-create-media" id="createMediaArea">
                <div class="ig-create-dropzone" id="createDropzone">
                    <i data-lucide="image"></i>
                    <h3>Drag photos here</h3>
                    <label class="ig-create-select-btn">
                        Select from computer
                        <input type="file" accept="image/*" id="postImageInput" style="display: none;"
                            onchange="handlePostImageSelect(event)">
                    </label>
                </div>
                <div id="postImagePreview" style="display: none;">
                    <img id="postPreviewImg" src="" alt="Preview"
                        style="max-width: 100%; max-height: 400px; object-fit: contain;">
                </div>
            </div>
            <div class="ig-create-sidebar" id="createSidebar" style="display: none;">
                <div class="ig-create-user">
                    <img src="{{ current_user.profile_picture_url }}" alt="" class="ig-post-avatar"
                        onerror="this.outerHTML='<div class=\'ig-post-avatar-placeholder\'>{{ current_user.initials }}</div>'">
                    <span class="ig-post-username">{{ current_user.username }}</span>
                </div>
                <textarea class="ig-create-textarea" id="postCaption" placeholder="Write a caption..."
                    maxlength="280"></textarea>
                <div style="padding: 0 16px; font-size: 12px; color: var(--color-text-secondary);">
                    <span id="captionCharCount">0</span>/280
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Story Viewer Modal -->
<div id="storyViewerModal" class="ig-story-viewer" onclick="closeStoryViewer(event)">
    <div class="ig-story-container" onclick="event.stopPropagation()">
        <div class="ig-story-header">
            <div class="ig-story-progress" id="storyProgressBars"></div>
            <div class="ig-story-user">
                <img src="" alt="" class="ig-story-avatar" id="storyViewerAvatar">
                <span class="ig-story-username" id="storyViewerUsername"></span>
                <span class="ig-story-time" id="storyViewerTime"></span>
            </div>
        </div>
        <button class="ig-story-close" onclick="closeStoryViewer()">
            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <path d="M18 6L6 18M6 6l12 12" />
            </svg>
        </button>
        <div class="ig-story-content" id="storyViewerContent"></div>
        <button class="ig-story-nav ig-story-prev" onclick="navigateStory(-1)">
            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <path d="M15 18l-6-6 6-6" />
            </svg>
        </button>
        <button class="ig-story-nav ig-story-next" onclick="navigateStory(1)">
            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <path d="M9 18l6-6-6-6" />
            </svg>
        </button>
        <div class="ig-story-actions">
            <input type="text" class="ig-story-input" id="storyReplyInput" placeholder="Send message...">
            <button class="ig-story-action-btn" onclick="toggleStoryLike()">
                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" id="storyLikeIcon">
                    <path
                        d="M20.84 4.61a5.5 5.5 0 0 0-7.78 0L12 5.67l-1.06-1.06a5.5 5.5 0 0 0-7.78 7.78l1.06 1.06L12 21.23l7.78-7.78 1.06-1.06a5.5 5.5 0 0 0 0-7.78z">
                    </path>
                </svg>
            </button>
            <button class="ig-story-action-btn" onclick="sendStoryReply()">
                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <line x1="22" y1="2" x2="11" y2="13"></line>
                    <polygon points="22 2 15 22 11 13 2 9 22 2"></polygon>
                </svg>
            </button>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
    function getCSRFToken() {
        const token = document.querySelector('meta[name="csrf-token"]');
        if (token) return token.getAttribute('content');
        const cookie = document.cookie.split(';').find(c => c.trim().startsWith('csrftoken='));
        return cookie ? cookie.split('=')[1] : '';
    }

    document.addEventListener('DOMContentLoaded', function () {
        if (typeof lucide !== 'undefined') {
            lucide.createIcons();
        }

        // Tab switching handled below in the complete tab handler

        // Hydrate any Code Scribe iframes in the profile grids
        initCodeScribePreviews();
    });

    // Modal functions
    function openChatsPanel() {
        document.getElementById('chatsPanel').style.display = 'flex';
        lucide.createIcons();
    }

    function closeChatsPanel(event) {
        if (!event || event.target === event.currentTarget) {
            document.getElementById('chatsPanel').style.display = 'none';
        }
    }

    function openSearchModal() {
        document.getElementById('searchModal').style.display = 'flex';
        document.getElementById('mobileSearchInput').focus();
        lucide.createIcons();
    }

    function closeSearchModal(event) {
        if (!event || event.target === event.currentTarget) {
            document.getElementById('searchModal').style.display = 'none';
        }
    }

    let searchTimeout;
    function handleMobileSearch(event) {
        const query = event.target.value.trim();
        const container = document.getElementById('searchResults');

        clearTimeout(searchTimeout);

        if (query.length === 0) {
            container.innerHTML = `
            <div style="text-align: center; padding: 40px 20px; color: var(--color-text-secondary);">
                <i data-lucide="search" style="width: 40px; height: 40px; margin-bottom: 12px;"></i>
                <p style="font-size: 14px;">Search for users by username or name</p>
            </div>
        `;
            lucide.createIcons();
            return;
        }

        searchTimeout = setTimeout(() => {
            fetch(`{% url 'search_users_for_mention' %}?q=${encodeURIComponent(query)}`)
                .then(response => response.json())
                .then(data => {
                    if (data.users && data.users.length > 0) {
                        container.innerHTML = data.users.map(u => `
                    <a href="/chat/profile/${u.username}/" style="display: flex; align-items: center; gap: 12px; padding: 12px 16px; text-decoration: none; color: inherit;">
                        <img src="${u.avatar || u.profile_picture_url || ''}" alt="" style="width: 44px; height: 44px; border-radius: 22%; object-fit: cover;">
                        <div>
                            <div style="font-weight: 600; font-size: 14px;">${u.username}</div>
                            <div style="font-size: 13px; color: var(--color-text-secondary);">${u.full_name || u.name || ''}</div>
                        </div>
                    </a>
                `).join('');
                    } else {
                        container.innerHTML = '<p style="text-align: center; color: var(--color-text-secondary); padding: 24px;">No users found</p>';
                    }
                });
        }, 300);
    }

    // GIPHY API Key
    const GIPHY_API_KEY = 'GlVGYHkr3WSBnllca54iNt0yFbjz7L65';

    function openCreatePostModal() {
        document.getElementById('createPostModal').style.display = 'flex';
        if (typeof lucide !== 'undefined') lucide.createIcons();
        // Load trending GIFs
        loadTrendingGifs();
    }

    function closeCreatePostModal(event) {
        if (!event || event.target === event.currentTarget) {
            document.getElementById('createPostModal').style.display = 'none';
            // Reset form
            document.getElementById('postCaption').value = '';
            document.getElementById('postImageInput').value = '';
            document.getElementById('postImagePreview').style.display = 'none';
            document.getElementById('postPreviewImg').src = '';
            const charCount = document.getElementById('captionCharCount');
            if (charCount) charCount.textContent = '0';
            // Clear GIF selection
            window.selectedGifUrl = null;
            // Hide pickers
            const gifPicker = document.getElementById('gifPicker');
            const emojiPicker = document.getElementById('emojiPicker');
            if (gifPicker) gifPicker.style.display = 'none';
            if (emojiPicker) emojiPicker.style.display = 'none';
        }
    }

    function handlePostImageSelect(event) {
        const file = event.target.files[0];
        if (file) {
            // Clear any GIF URL when selecting a regular image
            window.selectedGifUrl = null;
            const reader = new FileReader();
            reader.onload = function (e) {
                document.getElementById('postPreviewImg').src = e.target.result;
                document.getElementById('postImagePreview').style.display = 'block';
                if (typeof lucide !== 'undefined') lucide.createIcons();
            };
            reader.readAsDataURL(file);
        }
    }

    function removePostImage() {
        document.getElementById('postPreviewImg').src = '';
        document.getElementById('postImagePreview').style.display = 'none';
        document.getElementById('postImageInput').value = '';
        // Also clear GIF URL
        window.selectedGifUrl = null;
    }

    function updateCharCount() {
        const textarea = document.getElementById('postCaption');
        const countEl = document.getElementById('captionCharCount');
        const circleEl = document.getElementById('charCircle');

        if (textarea && countEl) {
            const length = textarea.value.length;
            const maxLength = 280;
            const percentage = (length / maxLength) * 100;

            // Update circle progress
            if (circleEl) {
                circleEl.style.strokeDasharray = `${percentage}, 100`;
                circleEl.classList.remove('warning', 'danger');
                if (percentage >= 90) {
                    circleEl.classList.add('danger');
                } else if (percentage >= 70) {
                    circleEl.classList.add('warning');
                }
            }

            // Show number when close to limit
            if (length >= 260) {
                countEl.textContent = maxLength - length;
                countEl.classList.add('show');
            } else {
                countEl.classList.remove('show');
            }
        }
    }

    function toggleEmojiPicker() {
        const picker = document.getElementById('emojiPicker');
        const gifPicker = document.getElementById('gifPicker');

        // Close GIF picker if open
        if (gifPicker) gifPicker.style.display = 'none';

        if (picker) {
            picker.style.display = picker.style.display === 'none' ? 'flex' : 'none';
        }
    }

    function insertEmoji(emoji) {
        const textarea = document.getElementById('postCaption');
        if (textarea) {
            const start = textarea.selectionStart;
            const end = textarea.selectionEnd;
            const text = textarea.value;
            textarea.value = text.substring(0, start) + emoji + text.substring(end);
            textarea.selectionStart = textarea.selectionEnd = start + emoji.length;
            textarea.focus();
            updateCharCount();
        }
    }

    function toggleGifPicker() {
        const picker = document.getElementById('gifPicker');
        const emojiPicker = document.getElementById('emojiPicker');

        // Close emoji picker if open
        if (emojiPicker) emojiPicker.style.display = 'none';

        if (picker) {
            const isHidden = picker.style.display === 'none';
            picker.style.display = isHidden ? 'block' : 'none';
            if (isHidden) {
                loadTrendingGifs();
            }
        }
    }

    function loadTrendingGifs() {
        const grid = document.getElementById('gifGrid');
        if (!grid) return;

        grid.innerHTML = '<div class="ig-gif-loading"><div class="ig-gif-spinner"></div><span>Loading GIFs...</span></div>';

        fetch(`https://api.giphy.com/v1/gifs/trending?api_key=${GIPHY_API_KEY}&limit=20&rating=g`)
            .then(response => response.json())
            .then(data => {
                displayGifs(data.data);
            })
            .catch(err => {
                grid.innerHTML = '<div class="ig-gif-loading"><span>Failed to load GIFs</span></div>';
            });
    }

    let gifSearchTimeout;
    function searchGifs(query) {
        clearTimeout(gifSearchTimeout);
        const grid = document.getElementById('gifGrid');

        if (!query.trim()) {
            loadTrendingGifs();
            return;
        }

        gifSearchTimeout = setTimeout(() => {
            grid.innerHTML = '<div class="ig-gif-loading"><div class="ig-gif-spinner"></div><span>Searching...</span></div>';

            fetch(`https://api.giphy.com/v1/gifs/search?api_key=${GIPHY_API_KEY}&q=${encodeURIComponent(query)}&limit=20&rating=g`)
                .then(response => response.json())
                .then(data => {
                    displayGifs(data.data);
                })
                .catch(err => {
                    grid.innerHTML = '<div class="ig-gif-loading"><span>Search failed</span></div>';
                });
        }, 300);
    }

    function displayGifs(gifs) {
        const grid = document.getElementById('gifGrid');
        if (!gifs || gifs.length === 0) {
            grid.innerHTML = '<div class="ig-gif-loading"><span>No GIFs found</span></div>';
            return;
        }

        grid.innerHTML = gifs.map(gif => `
        <div class="ig-gif-item" onclick="selectGif('${gif.images.original.url}')">
            <img src="${gif.images.fixed_height_small.url}" alt="${gif.title}" loading="lazy">
        </div>
    `).join('');
    }

    function selectGif(gifUrl) {
        // Set the GIF as the post image
        const preview = document.getElementById('postImagePreview');
        const img = document.getElementById('postPreviewImg');

        if (preview && img) {
            img.src = gifUrl;
            preview.style.display = 'block';

            // Store the GIF URL for upload
            window.selectedGifUrl = gifUrl;

            // Close GIF picker
            const picker = document.getElementById('gifPicker');
            if (picker) picker.style.display = 'none';

            showIGToast('GIF added!', 'success');
            if (typeof lucide !== 'undefined') lucide.createIcons();
        }
    }

    function submitPost() {
        const caption = document.getElementById('postCaption').value;
        const imageInput = document.getElementById('postImageInput');
        const gifUrl = window.selectedGifUrl;

        // Allow post with just GIF (no text required)
        if (!caption && !imageInput.files[0] && !gifUrl) {
            showIGToast('Please add a caption, image, or GIF', 'error');
            return;
        }

        const formData = new FormData();
        formData.append('content', caption || '');

        // Check if we have a regular image file
        if (imageInput.files[0]) {
            formData.append('image', imageInput.files[0]);
            doPostSubmit(formData);
        }
        // Check if we have a GIF URL
        else if (gifUrl) {
            // Fetch the GIF and convert to blob
            showIGToast('Uploading GIF...', 'info');
            fetch(gifUrl)
                .then(response => response.blob())
                .then(blob => {
                    formData.append('image', blob, 'gif_image.gif');
                    doPostSubmit(formData);
                })
                .catch(err => {
                    console.error('GIF fetch error:', err);
                    showIGToast('Failed to upload GIF, posting text only', 'error');
                    doPostSubmit(formData);
                });
        } else {
            doPostSubmit(formData);
        }
    }

    function doPostSubmit(formData) {
        fetch('{% url "post_tweet" %}', {
            method: 'POST',
            headers: {
                'X-CSRFToken': getCSRFToken()
            },
            body: formData
        })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    // Clear GIF URL
                    window.selectedGifUrl = null;
                    closeCreatePostModal();
                    showIGToast('Post shared!', 'success');
                    location.reload();
                } else {
                    showIGToast(data.error || 'Failed to share post', 'error');
                }
            })
            .catch(err => {
                console.error('Post error:', err);
                showIGToast('Failed to share post', 'error');
            });
    }

    // Story functions - Simplified
    let storyTextPosition = 'center';
    let isTextDragging = false;
    let textDragOffset = { x: 0, y: 0 };

    function openStoryModal() {
        document.getElementById('storyModal').style.display = 'flex';

        // Hide bottom nav on mobile
        const bottomNav = document.querySelector('.ig-bottom-nav');
        if (bottomNav) bottomNav.style.display = 'none';

        // Reset the form
        const textEl = document.getElementById('storyPreviewText');
        textEl.innerText = '';
        textEl.style.top = '50%';
        textEl.style.left = '50%';
        textEl.style.transform = 'translate(-50%, -50%)';
        textEl.style.color = '#ffffff';

        document.getElementById('storyPreviewImage').style.display = 'none';
        document.getElementById('storyPreviewImg').src = '';
        document.getElementById('storyImageInput').value = '';
        document.getElementById('storyPreviewContainer').style.background = 'linear-gradient(135deg, #667eea 0%, #764ba2 100%)';

        // Hide image controls
        const imgControls = document.getElementById('storyImageControls');
        if (imgControls) imgControls.style.display = 'none';

        // Reset position buttons
        document.querySelectorAll('.ig-story-pos-btn').forEach(btn => btn.classList.remove('active'));
        document.querySelectorAll('.ig-story-pos-btn')[1]?.classList.add('active');

        // Reset gradient presets
        document.querySelectorAll('.ig-story-preset').forEach(p => p.classList.remove('active'));
        document.querySelector('.ig-story-preset')?.classList.add('active');

        storyTextPosition = 'center';

        // Initialize text drag
        initTextDrag();

        if (typeof lucide !== 'undefined') {
            lucide.createIcons();
        }
    }

    function closeStoryModal(event) {
        if (!event || event.target === event.currentTarget) {
            document.getElementById('storyModal').style.display = 'none';

            // Show bottom nav again on mobile
            const bottomNav = document.querySelector('.ig-bottom-nav');
            if (bottomNav && window.innerWidth <= 768) {
                bottomNav.style.display = 'flex';
            }
        }
    }

    function handleStoryImageSelect(event) {
        const file = event.target.files[0];
        if (file) {
            const reader = new FileReader();
            reader.onload = function (e) {
                const img = document.getElementById('storyPreviewImg');
                img.src = e.target.result;
                document.getElementById('storyPreviewImage').style.display = 'block';

                // Show image controls
                const imgControls = document.getElementById('storyImageControls');
                if (imgControls) imgControls.style.display = 'flex';

                if (typeof lucide !== 'undefined') lucide.createIcons();
            };
            reader.readAsDataURL(file);
        }
    }

    function removeStoryImage() {
        document.getElementById('storyPreviewImg').src = '';
        document.getElementById('storyPreviewImage').style.display = 'none';
        document.getElementById('storyImageInput').value = '';
        const imgControls = document.getElementById('storyImageControls');
        if (imgControls) imgControls.style.display = 'none';
    }

    // Text Position Functions
    function setTextPosition(position) {
        storyTextPosition = position;
        const textEl = document.getElementById('storyPreviewText');
        if (!textEl) return;

        // Update active button
        document.querySelectorAll('.ig-story-pos-btn').forEach(btn => btn.classList.remove('active'));
        event.target.closest('.ig-story-pos-btn')?.classList.add('active');

        // Reset custom position
        textEl.style.left = '50%';

        switch (position) {
            case 'top':
                textEl.style.top = '15%';
                textEl.style.transform = 'translateX(-50%)';
                break;
            case 'center':
                textEl.style.top = '50%';
                textEl.style.transform = 'translate(-50%, -50%)';
                break;
            case 'bottom':
                textEl.style.top = '75%';
                textEl.style.transform = 'translateX(-50%)';
                break;
        }
    }

    function enableTextDrag() {
        storyTextPosition = 'custom';
        document.querySelectorAll('.ig-story-pos-btn').forEach(btn => btn.classList.remove('active'));
        document.getElementById('customPosBtn')?.classList.add('active');
        showIGToast('Drag text to any position', 'info');
    }

    function initTextDrag() {
        const textEl = document.getElementById('storyPreviewText');
        if (!textEl) return;

        textEl.addEventListener('mousedown', startTextDrag);
        textEl.addEventListener('touchstart', startTextDrag, { passive: false });
    }

    function startTextDrag(e) {
        // Don't start drag if clicking to edit
        if (document.activeElement === e.target) return;

        const textEl = document.getElementById('storyPreviewText');
        if (textEl.innerText.trim() === '') return;

        e.preventDefault();
        isTextDragging = true;
        textEl.classList.add('dragging');

        const rect = textEl.getBoundingClientRect();
        const clientX = e.touches ? e.touches[0].clientX : e.clientX;
        const clientY = e.touches ? e.touches[0].clientY : e.clientY;

        textDragOffset = {
            x: clientX - rect.left - rect.width / 2,
            y: clientY - rect.top - rect.height / 2
        };

        document.addEventListener('mousemove', moveTextDrag);
        document.addEventListener('mouseup', endTextDrag);
        document.addEventListener('touchmove', moveTextDrag, { passive: false });
        document.addEventListener('touchend', endTextDrag);
    }

    function moveTextDrag(e) {
        if (!isTextDragging) return;
        e.preventDefault();

        const textEl = document.getElementById('storyPreviewText');
        const container = document.getElementById('storyPreviewContainer');
        if (!textEl || !container) return;

        const containerRect = container.getBoundingClientRect();
        const clientX = e.touches ? e.touches[0].clientX : e.clientX;
        const clientY = e.touches ? e.touches[0].clientY : e.clientY;

        let left = ((clientX - containerRect.left - textDragOffset.x) / containerRect.width) * 100;
        let top = ((clientY - containerRect.top - textDragOffset.y) / containerRect.height) * 100;

        left = Math.max(10, Math.min(90, left));
        top = Math.max(10, Math.min(90, top));

        textEl.style.left = `${left}%`;
        textEl.style.top = `${top}%`;
        textEl.style.transform = 'translate(-50%, -50%)';

        storyTextPosition = 'custom';
        document.querySelectorAll('.ig-story-pos-btn').forEach(btn => btn.classList.remove('active'));
        document.getElementById('customPosBtn')?.classList.add('active');
    }

    function endTextDrag() {
        isTextDragging = false;
        const textEl = document.getElementById('storyPreviewText');
        if (textEl) textEl.classList.remove('dragging');

        document.removeEventListener('mousemove', moveTextDrag);
        document.removeEventListener('mouseup', endTextDrag);
        document.removeEventListener('touchmove', moveTextDrag);
        document.removeEventListener('touchend', endTextDrag);
    }

    function setStoryGradient(color1, color2, btn) {
        const preview = document.getElementById('storyPreviewContainer');
        if (preview) {
            preview.style.background = `linear-gradient(135deg, ${color1} 0%, ${color2} 100%)`;
        }
        document.querySelectorAll('.ig-story-preset').forEach(p => p.classList.remove('active'));
        if (btn) btn.classList.add('active');
    }

    function setStoryBackground(color, btn) {
        const preview = document.getElementById('storyPreviewContainer');
        if (preview) {
            preview.style.background = color;
        }
        document.querySelectorAll('.ig-story-preset').forEach(p => p.classList.remove('active'));
        if (btn) btn.classList.add('active');
    }

    function changeStoryTextColor(color) {
        const text = document.getElementById('storyPreviewText');
        if (text) {
            text.style.color = color;
        }
        const preview = document.getElementById('textColorPreview');
        if (preview) {
            preview.style.background = color;
        }
    }

    // Follow toggle - Enhanced for private accounts
    function toggleFollow(username) {
        const btn = document.querySelector(`[data-username="${username}"]`);
        if (!btn) return;

        // Store original state
        const originalText = btn.textContent;
        const wasRequested = btn.classList.contains('requested');

        // Show loading state
        btn.disabled = true;
        btn.textContent = wasRequested ? 'Canceling...' : 'Loading...';

        fetch('{% url "toggle_follow" %}', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': getCSRFToken()
            },
            body: JSON.stringify({ username: username })
        })
            .then(response => response.json())
            .then(data => {
                btn.disabled = false;

                if (data.success) {
                    // Remove all states first
                    btn.classList.remove('primary', 'following', 'requested');

                    if (data.is_following) {
                        btn.textContent = 'Following';
                        btn.classList.add('following');
                    } else if (data.follow_request_status === 'pending') {
                        btn.textContent = 'Requested';
                        btn.classList.add('requested');
                    } else {
                        // Check if target is private (use original text as hint)
                        const isPrivate = originalText === 'Request' || originalText === 'Requested';
                        btn.textContent = isPrivate ? 'Request' : 'Follow';
                        btn.classList.add('primary');
                    }

                    // Update follower counts if provided
                    if (data.follower_count !== undefined) {
                        const followersCount = document.getElementById('followersCount');
                        const followersCountMobile = document.getElementById('followersCountMobile');
                        if (followersCount) followersCount.textContent = data.follower_count;
                        if (followersCountMobile) followersCountMobile.textContent = data.follower_count;
                    }
                } else {
                    // Restore original state on error
                    btn.textContent = originalText;
                    if (wasRequested) btn.classList.add('requested');
                    console.error('Follow error:', data.error);
                }
            })
            .catch(err => {
                btn.disabled = false;
                btn.textContent = originalText;
                if (wasRequested) btn.classList.add('requested');
                console.error('Follow error:', err);
            });
    }

    // Follow Requests Modal
    function openFollowRequestsModal() {
        document.getElementById('followRequestsModal').style.display = 'flex';
        loadFollowRequests();
        if (typeof lucide !== 'undefined') lucide.createIcons();
    }

    function closeFollowRequestsModal(event) {
        if (!event || event.target === event.currentTarget) {
            document.getElementById('followRequestsModal').style.display = 'none';
        }
    }

    function loadFollowRequests() {
        const listContainer = document.getElementById('followRequestsList');
        listContainer.innerHTML = '<div class="ig-loading"><div class="ig-spinner"></div></div>';

        fetch('{% url "get_follow_requests" %}')
            .then(response => response.json())
            .then(data => {
                if (data.success && data.requests.length > 0) {
                    listContainer.innerHTML = data.requests.map(req => `
                <div class="ig-follow-request-item" id="request-${req.username}">
                    ${req.profile_pic
                            ? `<img src="${req.profile_pic}" alt="${req.username}" class="ig-follow-request-avatar">`
                            : `<div class="ig-follow-request-avatar-placeholder">${req.full_name.charAt(0).toUpperCase()}</div>`
                        }
                    <div class="ig-follow-request-info">
                        <div class="ig-follow-request-name">${req.full_name}</div>
                        <div class="ig-follow-request-username">@${req.username}</div>
                        <div class="ig-follow-request-time">${req.requested_at}</div>
                    </div>
                    <div class="ig-follow-request-actions">
                        <button class="ig-follow-request-btn accept" onclick="handleFollowRequest('${req.username}', 'accept')">
                            Confirm
                        </button>
                        <button class="ig-follow-request-btn decline" onclick="handleFollowRequest('${req.username}', 'decline')">
                            Delete
                        </button>
                    </div>
                </div>
            `).join('');
                } else {
                    listContainer.innerHTML = `
                <div class="ig-no-requests">
                    <i data-lucide="user-check"></i>
                    <h3>No Follow Requests</h3>
                    <p>When someone requests to follow you, you'll see it here.</p>
                </div>
            `;
                }
                if (typeof lucide !== 'undefined') lucide.createIcons();
            })
            .catch(err => {
                console.error('Error loading follow requests:', err);
                listContainer.innerHTML = `
            <div class="ig-no-requests">
                <i data-lucide="alert-circle"></i>
                <h3>Error</h3>
                <p>Could not load follow requests. Try again later.</p>
            </div>
        `;
                if (typeof lucide !== 'undefined') lucide.createIcons();
            });
    }

    function handleFollowRequest(username, action) {
        const requestItem = document.getElementById(`request-${username}`);
        if (!requestItem) return;

        // Show loading state
        const buttons = requestItem.querySelectorAll('.ig-follow-request-btn');
        buttons.forEach(btn => {
            btn.disabled = true;
            btn.style.opacity = '0.5';
        });

        fetch('{% url "manage_follow_request" %}', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': getCSRFToken()
            },
            body: JSON.stringify({ username: username, action: action })
        })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    // Animate removal
                    requestItem.style.opacity = '0';
                    requestItem.style.transform = 'translateX(100%)';
                    requestItem.style.transition = 'all 0.3s ease';

                    setTimeout(() => {
                        requestItem.remove();

                        // Check if list is now empty
                        const listContainer = document.getElementById('followRequestsList');
                        if (!listContainer.querySelector('.ig-follow-request-item')) {
                            listContainer.innerHTML = `
                        <div class="ig-no-requests">
                            <i data-lucide="user-check"></i>
                            <h3>No Follow Requests</h3>
                            <p>When someone requests to follow you, you'll see it here.</p>
                        </div>
                    `;
                            if (typeof lucide !== 'undefined') lucide.createIcons();
                        }

                        // Update badge count
                        updateRequestsBadge();

                        // Update follower count if accepted
                        if (action === 'accept') {
                            const followersCount = document.getElementById('followersCount');
                            const followersCountMobile = document.getElementById('followersCountMobile');
                            if (followersCount) {
                                followersCount.textContent = parseInt(followersCount.textContent) + 1;
                            }
                            if (followersCountMobile) {
                                followersCountMobile.textContent = parseInt(followersCountMobile.textContent) + 1;
                            }
                        }
                    }, 300);
                } else {
                    // Re-enable buttons on error
                    buttons.forEach(btn => {
                        btn.disabled = false;
                        btn.style.opacity = '1';
                    });
                    console.error('Error:', data.error);
                }
            })
            .catch(err => {
                buttons.forEach(btn => {
                    btn.disabled = false;
                    btn.style.opacity = '1';
                });
                console.error('Error handling follow request:', err);
            });
    }

    function updateRequestsBadge() {
        fetch('{% url "get_follow_requests" %}')
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    const count = data.requests.length;
                    const badge = document.querySelector('.ig-requests-badge');
                    const badgeBtn = badge?.parentElement;

                    if (count === 0 && badgeBtn) {
                        badgeBtn.style.display = 'none';
                    } else if (badge) {
                        badge.textContent = count;
                    }
                }
            });
    }

    // Start chat
    function startChat(username) {
        fetch('{% url "create_chat" %}', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': getCSRFToken()
            },
            body: JSON.stringify({ username: username })
        })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    window.location.href = `/chat/chat/${data.chat_id}/`;
                } else {
                    console.error('Failed to start chat:', data.error);
                }
            });
    }

    // Post detail
    let currentDetailTweetId = null;

    function openPostDetail(tweetId) {
        currentDetailTweetId = tweetId;
        fetch(`/api/tweet/${tweetId}/`)
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    const tweet = data.tweet;

                    // Media section
                    const mediaDiv = document.getElementById('postDetailMedia');
                    if (tweet.image_url) {
                        mediaDiv.innerHTML = `<img src="${tweet.image_url}" alt="Post image">`;
                        mediaDiv.classList.remove('text-only');
                    } else {
                        mediaDiv.innerHTML = `
                    <div class="ig-detail-text-post">
                        <p>${tweet.content}</p>
                    </div>`;
                        mediaDiv.classList.add('text-only');
                    }

                    // Header
                    document.getElementById('postDetailHeader').innerHTML = `
                <a href="/profile/${tweet.username}/" class="ig-detail-user">
                    <img src="${tweet.avatar}" alt="${tweet.username}" class="ig-detail-avatar">
                    <div class="ig-detail-user-info">
                        <span class="ig-detail-username">${tweet.username}</span>
                        <span class="ig-detail-location">Original Post</span>
                    </div>
                </a>
                <button class="ig-detail-more-btn">
                    <i data-lucide="more-horizontal"></i>
                </button>
            `;

                    // Caption in comments section
                    document.getElementById('postDetailCaption').innerHTML = tweet.content ? `
                <div class="ig-detail-caption-content">
                    <img src="${tweet.avatar}" alt="" class="ig-detail-caption-avatar">
                    <div class="ig-detail-caption-text">
                        <span class="ig-detail-caption-username">${tweet.username}</span>
                        <span class="ig-detail-caption-body">${tweet.content}</span>
                        <span class="ig-detail-caption-time">${tweet.time_ago}</span>
                    </div>
                </div>
            ` : '';

                    // Load comments
                    loadPostComments(tweetId);

                    // Actions
                    document.getElementById('postDetailActions').innerHTML = `
                <div class="ig-detail-actions-row">
                    <div class="ig-detail-actions-left">
                        <button class="ig-detail-action-btn ${tweet.is_liked ? 'liked' : ''}" onclick="toggleLikeFromDetail(${tweet.id})" id="detailLikeBtn">
                            <i data-lucide="${tweet.is_liked ? 'heart' : 'heart'}"></i>
                        </button>
                        <button class="ig-detail-action-btn" onclick="document.getElementById('postDetailCommentInput').focus()">
                            <i data-lucide="message-circle"></i>
                        </button>
                        <button class="ig-detail-action-btn">
                            <i data-lucide="send"></i>
                        </button>
                    </div>
                    <button class="ig-detail-action-btn">
                        <i data-lucide="bookmark"></i>
                    </button>
                </div>
            `;

                    // Info section
                    document.getElementById('postDetailInfo').innerHTML = `
                <div class="ig-detail-likes" id="detailLikesSection">
                    <span class="ig-detail-like-count" id="detailLikeCount">${tweet.like_count.toLocaleString()}</span> likes
                </div>
                <time class="ig-detail-time">${tweet.time_ago}</time>
            `;

                    lucide.createIcons();
                    document.getElementById('postDetailModal').style.display = 'flex';
                    document.body.style.overflow = 'hidden';
                }
            });
    }

    function loadPostComments(tweetId) {
        fetch(`/api/tweet/${tweetId}/comments/`)
            .then(response => response.json())
            .then(data => {
                const commentsDiv = document.getElementById('postDetailComments');
                const captionDiv = document.getElementById('postDetailCaption').innerHTML;

                if (data.success && data.comments && data.comments.length > 0) {
                    const commentsHtml = data.comments.map(comment => `
                <div class="ig-detail-comment">
                    <img src="${comment.avatar}" alt="" class="ig-detail-comment-avatar">
                    <div class="ig-detail-comment-content">
                        <span class="ig-detail-comment-username">${comment.username}</span>
                        <span class="ig-detail-comment-text">${comment.content}</span>
                        <div class="ig-detail-comment-meta">
                            <span class="ig-detail-comment-time">${comment.time_ago}</span>
                            <button class="ig-detail-comment-reply">Reply</button>
                        </div>
                    </div>
                    <button class="ig-detail-comment-like">
                        <i data-lucide="heart"></i>
                    </button>
                </div>
            `).join('');
                    commentsDiv.innerHTML = `<div class="ig-detail-caption" id="postDetailCaption">${captionDiv}</div>${commentsHtml}`;
                } else {
                    commentsDiv.innerHTML = `<div class="ig-detail-caption" id="postDetailCaption">${captionDiv}</div>
                <div class="ig-detail-no-comments">
                    <p>No comments yet.</p>
                    <span>Start the conversation.</span>
                </div>`;
                }
                lucide.createIcons();
            })
            .catch(() => {
                // If comments API doesn't exist, just show caption
            });
    }

    function postCommentFromDetail() {
        const input = document.getElementById('postDetailCommentInput');
        const content = input.value.trim();
        if (!content || !currentDetailTweetId) return;

        fetch('{% url "add_comment" %}', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': getCSRFToken()
            },
            body: JSON.stringify({ tweet_id: currentDetailTweetId, content: content })
        })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    input.value = '';
                    loadPostComments(currentDetailTweetId);
                    showIGToast('Comment posted!', 'success');
                }
            });
    }

    function closePostDetail(event) {
        if (!event || event.target === event.currentTarget) {
            document.getElementById('postDetailModal').style.display = 'none';
            document.body.style.overflow = '';
            currentDetailTweetId = null;
        }
    }

    function toggleLikeFromDetail(tweetId) {
        fetch('{% url "toggle_like" %}', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': getCSRFToken()
            },
            body: JSON.stringify({ tweet_id: tweetId })
        })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    document.getElementById('detailLikeCount').textContent = data.like_count;
                }
            });
    }

    // Followers/Following modals
    function openFollowersModal() {
        document.getElementById('followersModal').style.display = 'flex';
        loadFollowers();
    }

    function closeFollowersModal(event) {
        if (!event || event.target === event.currentTarget) {
            document.getElementById('followersModal').style.display = 'none';
        }
    }

    function loadFollowers() {
        fetch('/api/profile/{{ profile_user.username }}/followers/')
            .then(response => response.json())
            .then(data => {
                const list = document.getElementById('followersList');
                if (data.followers && data.followers.length > 0) {
                    list.innerHTML = data.followers.map(f => `
                <a href="/profile/${f.username}/" style="display: flex; align-items: center; gap: 12px; padding: 12px 16px; text-decoration: none; color: inherit;">
                    <img src="${f.avatar}" alt="" style="width: 44px; height: 44px; border-radius: 22%;">
                    <div style="flex: 1;">
                        <div style="font-weight: 600;">${f.username}</div>
                        <div style="color: var(--ig-text-secondary); font-size: 14px;">${f.full_name}</div>
                    </div>
                </a>
            `).join('');
                } else {
                    list.innerHTML = '<p style="text-align: center; padding: 24px; color: var(--ig-text-secondary);">No followers yet</p>';
                }
            });
    }

    function openFollowingModal() {
        document.getElementById('followingModal').style.display = 'flex';
        loadFollowing();
    }

    function closeFollowingModal(event) {
        if (!event || event.target === event.currentTarget) {
            document.getElementById('followingModal').style.display = 'none';
        }
    }

    function loadFollowing() {
        fetch('/api/profile/{{ profile_user.username }}/following/')
            .then(response => response.json())
            .then(data => {
                const list = document.getElementById('followingList');
                if (data.following && data.following.length > 0) {
                    list.innerHTML = data.following.map(f => `
                <a href="/profile/${f.username}/" style="display: flex; align-items: center; gap: 12px; padding: 12px 16px; text-decoration: none; color: inherit;">
                    <img src="${f.avatar}" alt="" style="width: 44px; height: 44px; border-radius: 22%;">
                    <div style="flex: 1;">
                        <div style="font-weight: 600;">${f.username}</div>
                        <div style="color: var(--ig-text-secondary); font-size: 14px;">${f.full_name}</div>
                    </div>
                </a>
            `).join('');
                } else {
                    list.innerHTML = '<p style="text-align: center; padding: 24px; color: var(--ig-text-secondary);">Not following anyone yet</p>';
                }
            });
    }

    // Settings modal
    function openSettingsModal() {
        document.getElementById('settingsModal').style.display = 'flex';
    }

    function closeSettingsModal(event) {
        if (!event || event.target === event.currentTarget) {
            document.getElementById('settingsModal').style.display = 'none';
        }
    }

    function toggleTheme() {
        // Use the global toggleTheme function from base.html
        if (window.toggleThemeGlobal) {
            window.toggleThemeGlobal();
        }
    }

    function togglePrivacy() {
        fetch('{% url "toggle_account_privacy" %}', {
            method: 'POST',
            headers: { 'X-CSRFToken': getCSRFToken() }
        })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    const toggle = document.getElementById('privacyToggle');
                    toggle.classList.toggle('active', data.is_private);
                }
            });
    }

    // Create Story
    function createStory() {
        const textContent = document.getElementById('storyPreviewText').innerText.trim();
        const imageInput = document.getElementById('storyImageInput');
        const textColor = document.getElementById('storyTextColor')?.value || '#ffffff';

        if (!textContent && (!imageInput || !imageInput.files[0])) {
            showIGToast('Please add text or an image', 'error');
            return;
        }

        // Get the actual background style from the preview container
        const container = document.getElementById('storyPreviewContainer');
        const computedBg = container ? container.style.background : '#6366f1';

        // Get text position
        let textPos = storyTextPosition || 'center';
        if (textPos === 'custom') {
            const textEl = document.getElementById('storyPreviewText');
            const top = parseFloat(textEl.style.top);
            if (top < 35) textPos = 'top';
            else if (top > 65) textPos = 'bottom';
            else textPos = 'center';
        }

        const formData = new FormData();
        if (textContent) formData.append('content', textContent);
        if (imageInput && imageInput.files[0]) formData.append('media', imageInput.files[0]);
        formData.append('background_color', computedBg.includes('gradient') ? '#6366f1' : computedBg);
        formData.append('text_color', textColor);
        formData.append('text_position', textPos);

        fetch('{% url "create_story" %}', {
            method: 'POST',
            headers: {
                'X-CSRFToken': getCSRFToken()
            },
            body: formData
        })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    closeStoryModal();
                    showIGToast('Story shared!', 'success');
                    location.reload();
                } else {
                    showIGToast(data.error || 'Failed to create story', 'error');
                }
            });
    }

    // Story Viewer Functions
    let currentStories = [];
    let currentStoryIndex = 0;
    let storyTimer = null;
    let storyProgressInterval = null;
    const STORY_DURATION = 5000; // 5 seconds per story

    function viewStoryFromProfile(storyId) {
        // Load user's stories and find the selected one
        fetch(`/api/user-stories/{{ profile_user.username }}/`)
            .then(response => response.json())
            .then(data => {
                if (data.success && data.stories && data.stories.length > 0) {
                    currentStories = data.stories;
                    currentStoryIndex = currentStories.findIndex(s => s.id === storyId);
                    if (currentStoryIndex === -1) currentStoryIndex = 0;

                    showStoryViewer();
                    displayCurrentStory();
                } else {
                    showIGToast('Story not found', 'error');
                }
            })
            .catch(err => {
                console.error('Error loading stories:', err);
                showIGToast('Failed to load story', 'error');
            });
    }

    function showStoryViewer() {
        const modal = document.getElementById('storyViewerModal');
        modal.classList.add('show');
        document.body.style.overflow = 'hidden';
        document.body.classList.add('story-viewer-open');

        // Hide bottom navbar when story viewer is open
        const bottomNav = document.querySelector('.ig-bottom-nav');
        if (bottomNav) bottomNav.style.display = 'none';

        // Create progress bars
        const progressContainer = document.getElementById('storyProgressBars');
        progressContainer.innerHTML = currentStories.map((_, i) => `
        <div class="ig-story-progress-bar">
            <div class="ig-story-progress-fill" id="storyProgress${i}"></div>
        </div>
    `).join('');
    }

    function displayCurrentStory() {
        if (currentStoryIndex >= currentStories.length) {
            closeStoryViewer();
            return;
        }

        const story = currentStories[currentStoryIndex];

        // Update avatar and username - use user object if available
        const avatar = story.user?.profile_picture_url || '{{ profile_user.profile_picture_url }}';
        const username = story.user?.username || '{{ profile_user.username }}';
        document.getElementById('storyViewerAvatar').src = avatar;
        document.getElementById('storyViewerUsername').textContent = username;
        document.getElementById('storyViewerTime').textContent = story.created_at || '';

        // Update content
        const contentDiv = document.getElementById('storyViewerContent');
        if (story.media_url) {
            contentDiv.innerHTML = `<img src="${story.media_url}" alt="Story">`;
            contentDiv.style.background = '';
        } else {
            contentDiv.style.background = story.background_color || '#6366f1';
            contentDiv.innerHTML = `
            <div class="ig-story-text-content">
                <p style="color: ${story.text_color || '#ffffff'}">${story.content || ''}</p>
            </div>
        `;
        }

        // Update like icon
        const likeIcon = document.getElementById('storyLikeIcon');
        if (story.is_liked) {
            likeIcon.setAttribute('fill', '#ff3b5c');
            likeIcon.setAttribute('stroke', '#ff3b5c');
        } else {
            likeIcon.setAttribute('fill', 'none');
            likeIcon.setAttribute('stroke', 'currentColor');
        }

        // Mark story as viewed
        markStoryViewed(story.id);

        // Reset previous progress bars
        for (let i = 0; i < currentStoryIndex; i++) {
            const bar = document.getElementById(`storyProgress${i}`);
            if (bar) bar.style.width = '100%';
        }
        for (let i = currentStoryIndex + 1; i < currentStories.length; i++) {
            const bar = document.getElementById(`storyProgress${i}`);
            if (bar) bar.style.width = '0%';
        }

        // Start progress animation
        startStoryProgress();
    }

    function startStoryProgress() {
        if (storyProgressInterval) clearInterval(storyProgressInterval);
        if (storyTimer) clearTimeout(storyTimer);

        const progressBar = document.getElementById(`storyProgress${currentStoryIndex}`);
        if (!progressBar) return;

        let progress = 0;
        const increment = 100 / (STORY_DURATION / 100);

        progressBar.style.width = '0%';

        storyProgressInterval = setInterval(() => {
            progress += increment;
            progressBar.style.width = `${Math.min(progress, 100)}%`;

            if (progress >= 100) {
                clearInterval(storyProgressInterval);
                navigateStory(1);
            }
        }, 100);
    }

    function navigateStory(direction) {
        if (storyProgressInterval) clearInterval(storyProgressInterval);
        if (storyTimer) clearTimeout(storyTimer);

        const newIndex = currentStoryIndex + direction;

        if (newIndex < 0) {
            // Already at first story, do nothing
            startStoryProgress();
            return;
        }

        if (newIndex >= currentStories.length) {
            closeStoryViewer();
            return;
        }

        currentStoryIndex = newIndex;
        displayCurrentStory();
    }

    function closeStoryViewer(event) {
        if (event && event.target !== event.currentTarget) return;

        if (storyProgressInterval) clearInterval(storyProgressInterval);
        if (storyTimer) clearTimeout(storyTimer);

        const modal = document.getElementById('storyViewerModal');
        modal.classList.remove('show');
        document.body.style.overflow = '';
        document.body.classList.remove('story-viewer-open');

        // Restore bottom navbar on mobile
        const bottomNav = document.querySelector('.ig-bottom-nav');
        if (bottomNav && window.innerWidth <= 768) {
            bottomNav.style.display = 'flex';
        }

        currentStories = [];
        currentStoryIndex = 0;
    }

    function markStoryViewed(storyId) {
        fetch('/api/story/mark-viewed/', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': getCSRFToken()
            },
            body: JSON.stringify({ story_id: storyId })
        }).catch(err => console.error('Error marking story viewed:', err));
    }

    function toggleStoryLike() {
        if (!currentStories.length) return;
        const story = currentStories[currentStoryIndex];

        fetch('/api/story/toggle-like/', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': getCSRFToken()
            },
            body: JSON.stringify({ story_id: story.id })
        })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    const likeIcon = document.getElementById('storyLikeIcon');
                    if (data.is_liked) {
                        likeIcon.setAttribute('fill', '#ff3b5c');
                        likeIcon.setAttribute('stroke', '#ff3b5c');
                    } else {
                        likeIcon.setAttribute('fill', 'none');
                        likeIcon.setAttribute('stroke', 'currentColor');
                    }
                    story.is_liked = data.is_liked;
                }
            });
    }

    function sendStoryReply() {
        const input = document.getElementById('storyReplyInput');
        const content = input.value.trim();
        if (!content || !currentStories.length) return;

        const story = currentStories[currentStoryIndex];

        fetch('/api/story/add-reply/', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': getCSRFToken()
            },
            body: JSON.stringify({ story_id: story.id, content: content })
        })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    input.value = '';
                    showIGToast('Reply sent!', 'success');
                } else {
                    showIGToast(data.error || 'Failed to send reply', 'error');
                }
            });
    }

    // Profile Tab Switching
    document.addEventListener('DOMContentLoaded', () => {
        const tabs = document.querySelectorAll('.ig-profile-tab');
        const contents = {
            'posts': document.getElementById('postsTab'),
            'reels': document.getElementById('reelsTab'),
            'saved': document.getElementById('savedTab')
        };

        tabs.forEach(tab => {
            tab.addEventListener('click', () => {
                const target = tab.dataset.tab;

                // Update active tab
                tabs.forEach(t => t.classList.remove('active'));
                tab.classList.add('active');

                // Show content
                Object.values(contents).forEach(content => {
                    if (content) content.style.display = 'none';
                });

                if (contents[target]) {
                    contents[target].style.display = 'block';
                }
            });
        });
    });

    function initCodeScribePreviews() {
        const frames = document.querySelectorAll('.ig-code-scribe-view');
        frames.forEach(frame => {
            let encoded = frame.getAttribute('data-code-bundle') || '';
            let html = encoded ? decodeURIComponent(encoded) : '';
            if (!html) {
                const h = frame.getAttribute('data-code-html') || '';
                const c = frame.getAttribute('data-code-css') || '';
                const j = frame.getAttribute('data-code-js') || '';
                const htmlDec = h ? decodeURIComponent(h) : '';
                const cssDec = c ? decodeURIComponent(c) : '';
                const jsDec = j ? decodeURIComponent(j) : '';
                html = `<!DOCTYPE html><html><head><meta charset="utf-8"><style>${cssDec}</style></head><body>${htmlDec}<script>${jsDec}<\/script></body></html>`;
            }
            // Prefer srcdoc to avoid quoting issues
            try {
                frame.srcdoc = html;
            } catch (e) {
                const doc = frame.contentDocument || frame.contentWindow.document;
                doc.open();
                doc.write(html);
                doc.close();
            }
        });
    }

    // ===== Profile Feed: Like & Comments (match homepage) =====
    function showIGToast(message, type = 'info') {
        const container = document.getElementById('ig-toast-container') || document.body;
        const toast = document.createElement('div');
        toast.className = 'ig-notification';
        toast.style.cssText = 'position: fixed; bottom: 80px; left: 50%; transform: translateX(-50%); background: ' + (type === 'error' ? '#ed4956' : type === 'success' ? '#00a884' : 'var(--ig-text-primary)') + '; color: white; padding: 12px 24px; border-radius: 8px; z-index: 9999; box-shadow: 0 4px 12px rgba(0,0,0,0.3); font-size: 14px;';
        toast.textContent = message;
        container.appendChild(toast);
        setTimeout(() => { toast.style.opacity = '0'; toast.style.transition = 'opacity 0.3s'; setTimeout(() => toast.remove(), 300); }, 3000);
    }

    function handleCommentKeypress(event, tweetId) {
        if (event.key === 'Enter' && !event.shiftKey) {
            event.preventDefault();
            addComment(tweetId);
        }
    }

    function toggleLike(tweetId) {
        const btn = document.querySelector(`.ig-post-action-btn[data-tweet-id="${tweetId}"]`);
        const countEl = document.querySelector(`.like-count[data-tweet-id="${tweetId}"]`);

        const wasLiked = btn && btn.classList.contains('liked');
        if (btn) btn.classList.toggle('liked');
        if (countEl) {
            const currentCount = parseInt(countEl.textContent) || 0;
            countEl.textContent = wasLiked ? currentCount - 1 : currentCount + 1;
        }
        if (!wasLiked && btn) { btn.style.transform = 'scale(1.2)'; setTimeout(() => btn.style.transform = 'scale(1)', 200); }

        fetch('{% url "toggle_like" %}', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json', 'X-CSRFToken': getCSRFToken() },
            body: JSON.stringify({ tweet_id: tweetId })
        })
        .then(r => r.json())
        .then(data => {
            if (!data.success) throw new Error(data.error || 'Failed to like');
            if (btn) btn.classList.toggle('liked', data.is_liked === true);
            if (countEl) countEl.textContent = data.like_count;
        })
        .catch(err => {
            if (btn) btn.classList.toggle('liked');
            if (countEl) {
                const currentCount = parseInt(countEl.textContent) || 0;
                countEl.textContent = wasLiked ? currentCount + 1 : currentCount - 1;
            }
            showIGToast(err.message || 'Failed to like post', 'error');
        });
    }

    function addComment(tweetId) {
        const input = document.getElementById(`comment-input-${tweetId}`);
        const content = (input?.value || '').trim();
        if (!content) return;

        fetch('{% url "add_comment" %}', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json', 'X-CSRFToken': getCSRFToken() },
            body: JSON.stringify({ tweet_id: tweetId, content })
        })
        .then(r => r.json())
        .then(data => {
            if (data.success) {
                input.value = '';
                toggleComments(tweetId);
            } else {
                showIGToast(data.error || 'Failed to add comment', 'error');
            }
        })
        .catch(() => showIGToast('Failed to add comment', 'error'));
    }

    function toggleComments(tweetId) {
        const section = document.getElementById(`comments-${tweetId}`);
        if (!section) return;
        const isHidden = section.style.display === 'none' || !section.style.display;
        section.style.display = isHidden ? 'block' : 'none';
        if (isHidden) loadComments(tweetId);
    }

    function loadComments(tweetId) {
        fetch(`/chat/api/tweet/${tweetId}/comments/`)
            .then(r => r.json())
            .then(data => {
                const list = document.getElementById(`comments-list-${tweetId}`);
                if (!list) return;
                if (data.comments && data.comments.length) {
                    list.innerHTML = data.comments.map(c => `
                        <div class="ig-comment" style="display:flex;gap:12px;padding:12px 16px;">
                            <img src="${c.user_profile_picture || ''}" alt="" style="width:32px;height:32px;border-radius:22%;object-fit:cover;" onerror="this.outerHTML='\\
<div style=\\'width:32px;height:32px;border-radius:22%;background:var(--odnix-gradient);display:flex;align-items:center;justify-content:center;color:white;font-size:12px;font-weight:600;\\'>${c.user_initials || 'U'}<\\/div>'">
                            <div style="flex:1;">
                                <span style="font-weight:600;font-size:14px;color:var(--ig-text-primary);">${c.user_username || 'User'}</span>
                                <span style="font-size:14px;margin-left:4px;color:var(--ig-text-primary);">${c.content}</span>
                                <div style="font-size:12px;color:var(--ig-text-secondary);margin-top:4px;">${c.timestamp || ''}</div>
                            </div>
                        </div>`).join('');
                } else {
                    list.innerHTML = '<p style="text-align:center;color:var(--ig-text-secondary);padding:16px;">No comments yet</p>';
                }
            })
            .catch(() => {});
    }
</script>
{% endblock %}