{% extends 'chat/base.html' %}
{% load tweet_extras %}

{% block title %}Dashboard - Odnix{% endblock %}

{% block extra_head %}
<meta name="user-id" content="{{ current_user.id }}">
{% endblock %}

{% block content %}
<div class="main-container">
    <!-- Desktop Sidebar -->
    <div class="sidebar-enhanced desktop-only" id="sidebar">
        <div class="sidebar-header">
            <h1 class="logo">Odnix</h1>

            <!-- Profile section -->
            <div class="user-info-compact">
                <div class="user-avatar-large">
                    <img src="{{ current_user.profile_picture_url }}" alt="{{ current_user.full_name }}"
                        onerror="this.style.display='none'; this.nextElementSibling.style.display='flex';">
                    <div class="avatar-fallback">{{ current_user.initials }}</div>
                </div>
                <div class="user-details-large">
                    <div class="user-name-large">{{ current_user.full_name }}</div>
                    <div class="user-status-large">@{{ current_user.username }}</div>
                </div>
            </div>
        </div>

        <!-- Navigation -->
        <nav class="sidebar-nav-compact">
            <a href="{% url 'dashboard' %}" class="nav-item-compact active">
                <i data-lucide="home" class="nav-icon"></i>
                <span class="nav-text">Home</span>
            </a>
            <a href="{% url 'reels' %}" class="nav-item-compact">
                <i data-lucide="play-square" class="nav-icon"></i>
                <span class="nav-text">Reels</span>
            </a>
            <a href="{% url 'profile' %}" class="nav-item-compact">
                <i data-lucide="user" class="nav-icon"></i>
                <span class="nav-text">Profile</span>
            </a>
        </nav>

        <!-- Create Group Button -->
        <div class="create-group-section">
            <button id="createGroupBtn" class="btn btn--primary btn--full-width">Create Group</button>
        </div>

        <!-- Discover Groups Button -->
        <div class="discover-groups-section">
            <a href="{% url 'discover_groups' %}" class="btn btn--outline btn--full-width">
                <i data-lucide="compass"></i>
                <span>Discover Groups</span>
            </a>
        </div>

        <!-- Story Replies Inbox Button -->
        <div class="story-inbox-section">
            <button onclick="openStoryInbox()" class="btn btn--outline btn--full-width story-inbox-btn">
                <i data-lucide="message-circle"></i>
                Story Replies
                <span class="story-inbox-badge" id="storyInboxBadge" style="display: none;">0</span>
            </button>
        </div>

        <!-- Active Chats Section -->
        <div class="sidebar-section">
            <h3 class="sidebar-section-title">
                Active Chats
                <span class="section-count">{{ private_chats.count|add:group_chats.count }}</span>
            </h3>
            <div class="sidebar-chat-list">
                <!-- Group Chats -->
                {% for chat in group_chats %}
                <a href="{% url 'chat_detail' chat.id %}" class="sidebar-chat-item group-chat">
                    <div class="chat-avatar-small group-avatar">
                        <i data-lucide="users" class="group-icon"></i>
                    </div>
                    <div class="chat-info-small">
                        <div class="chat-name-small">
                            {{ chat.name }}
                            {% if chat.admin == user %}<i data-lucide="crown" class="admin-badge"></i>{% endif %}
                        </div>
                        <div class="chat-meta">
                            <span class="participant-count">{{ chat.participant_count }} members</span>
                            {% if chat.messages.last %}‚Ä¢ {{ chat.updated_at|timesince }} ago{% endif %}
                        </div>
                    </div>
                </a>
                {% endfor %}

                <!-- Private Chats -->
                {% for chat in private_chats %}
                <a href="{% url 'chat_detail' chat.id %}" class="sidebar-chat-item private-chat">
                    <div class="chat-avatar-small">
                        {% for participant in chat.participants.all %}
                        {% if participant != user %}
                        <img src="{{ participant.profile_picture_url }}" alt="{{ participant.full_name }}"
                            onerror="this.style.display='none'; this.nextElementSibling.style.display='flex';">
                        <div class="avatar-fallback-small">{{ participant.name.0 }}{{ participant.lastname.0 }}</div>
                        {% endif %}
                        {% endfor %}
                    </div>
                    <div class="chat-info-small">
                        <div class="chat-name-small">
                            {% for participant in chat.participants.all %}
                            {% if participant != user %}{{ participant.full_name }}{% endif %}
                            {% endfor %}
                        </div>
                        <div class="chat-meta">
                            {% if chat.messages.last %}{{ chat.updated_at|timesince }} ago{% else %}No messages{% endif
                            %}
                        </div>
                    </div>
                </a>
                {% empty %}
                <div class="empty-state-small">
                    <p>No active chats yet</p>
                </div>
                {% endfor %}
            </div>
        </div>

        <!-- All Users Section -->
        <div class="sidebar-section">
            <h3 class="sidebar-section-title">
                Search Users
            </h3>

            <input type="text" id="userSearchInput" placeholder="Search by name or username..." class="search-bar">

            <div id="searchResults" class="sidebar-users-list">
                <!-- Dynamic results will appear here -->
            </div>
        </div>
    </div>

    <!-- Mobile Bottom Navigation -->
    <nav class="bottom-navbar mobile-only" id="bottomNavbar">
        <div class="bottom-nav-container">
            <!-- Profile Tab - Direct Link -->
            <a href="{% url 'profile' %}" class="bottom-nav-tab" data-tab="profile">
                <div class="user-avatar-nano">
                    <img src="{{ current_user.profile_picture_url }}" alt="{{ current_user.full_name }}"
                        onerror="this.style.display='none'; this.nextElementSibling.style.display='flex';">
                    <div class="avatar-fallback-nano">{{ current_user.initials }}</div>
                </div>
                <span class="bottom-nav-label">Profile</span>
            </a>

            <a href="{% url 'messages' %}" class="bottom-nav-tab" data-tab="chats">
                <div class="nav-icon-wrapper">
                    <i data-lucide="message-circle" class="nav-icon"></i>
                    {% if private_chats.count|add:group_chats.count > 0 %}
                    <span class="nav-badge">{{ private_chats.count|add:group_chats.count }}</span>
                    {% endif %}
                </div>
                <span class="bottom-nav-label">Chats</span>
            </a>

            <!-- Home Tab - Current/Active - Scrolls to top -->
            <button type="button" class="bottom-nav-tab active" data-tab="home" id="homeTabBtn">
                <div class="nav-icon-wrapper">
                    <i data-lucide="home" class="nav-icon"></i>
                </div>
                <span class="bottom-nav-label">Home</span>
            </button>

            <!-- Reels Tab -->
            <a href="{% url 'reels' %}" class="bottom-nav-tab" data-tab="reels">
                <div class="nav-icon-wrapper">
                    <i data-lucide="play-square" class="nav-icon"></i>
                </div>
                <span class="bottom-nav-label">Reels</span>
            </a>

            <!-- Search Tab -->
            <button type="button" class="bottom-nav-tab" data-tab="search" id="searchTabBtn">
                <div class="nav-icon-wrapper">
                    <i data-lucide="search" class="nav-icon"></i>
                </div>
                <span class="bottom-nav-label">Search</span>
            </button>

            <!-- More/Actions Tab -->
            <button type="button" class="bottom-nav-tab" data-tab="more" id="moreTabBtn">
                <div class="nav-icon-wrapper">
                    <i data-lucide="settings" class="nav-icon"></i>
                </div>
                <span class="bottom-nav-label">More</span>
            </button>
        </div>
    </nav>

    <!-- Mobile Modals -->
    <!-- Chats Modal with Search -->
    <div id="chatsModal" class="mobile-modal">
        <div class="mobile-modal-header">
            <h3>Chats <span class="section-count">{{ private_chats.count|add:group_chats.count }}</span></h3>
        </div>
        <div class="mobile-modal-content">
            <!-- Search Section -->
            <div class="mobile-search-section">
                <div class="search-container">
                    <div class="search-input-wrapper">
                        <i data-lucide="search" class="search-icon"></i>
                        <input type="text" id="userSearchInput" class="search-input"
                            placeholder="Search users to start a chat..." onkeyup="searchUsers()">
                        <button class="search-clear" onclick="clearSearch()" style="display: none;"><i
                                data-lucide="x"></i></button>
                    </div>
                </div>
                <div id="searchResults" class="search-results" style="display: none;">
                    <!-- Search results will be populated here -->
                </div>
            </div>

            <!-- Create Group Button -->
            <div class="mobile-action-section">
                <button id="mobileCreateGroupBtn" class="btn btn--primary btn--full-width">Create Group</button>
                <a href="{% url 'discover_groups' %}" class="btn btn--outline btn--full-width"
                    style="margin-top: 0.75rem;">
                    <i data-lucide="compass"></i>
                    <span>Discover Groups</span>
                </a>
            </div>

            <!-- Active Chats List -->
            <div class="mobile-chat-list">
                <h4 class="chat-section-title">Active Chats</h4>

                <!-- Group Chats -->
                {% for chat in group_chats %}
                <a href="{% url 'chat_detail' chat.id %}" class="mobile-chat-item group-chat">
                    <div class="chat-avatar-small group-avatar">
                        <i data-lucide="users" class="group-icon"></i>
                    </div>
                    <div class="chat-info-small">
                        <div class="chat-name-small">
                            {{ chat.name }}
                            {% if chat.admin == user %}<i data-lucide="crown" class="admin-badge"></i>{% endif %}
                        </div>
                        <div class="chat-meta">
                            <span class="participant-count">{{ chat.participant_count }} members</span>
                            {% if chat.messages.last %}‚Ä¢ {{ chat.updated_at|timesince }} ago{% endif %}
                        </div>
                    </div>
                </a>
                {% endfor %}

                <!-- Private Chats -->
                {% for chat in private_chats %}
                <a href="{% url 'chat_detail' chat.id %}" class="mobile-chat-item private-chat">
                    <div class="chat-avatar-small">
                        {% for participant in chat.participants.all %}
                        {% if participant != user %}
                        <img src="{{ participant.profile_picture_url }}" alt="{{ participant.full_name }}"
                            onerror="this.style.display='none'; this.nextElementSibling.style.display='flex';">
                        <div class="avatar-fallback-small">{{ participant.name.0 }}{{ participant.lastname.0 }}</div>
                        {% endif %}
                        {% endfor %}
                    </div>
                    <div class="chat-info-small">
                        <div class="chat-name-small">
                            {% for participant in chat.participants.all %}
                            {% if participant != user %}{{ participant.full_name }}{% endif %}
                            {% endfor %}
                        </div>
                        <div class="chat-meta">
                            {% if chat.messages.last %}{{ chat.updated_at|timesince }} ago{% else %}No messages{% endif
                            %}
                        </div>
                    </div>
                </a>
                {% empty %}
                <div class="empty-state-mobile">
                    <i data-lucide="message-circle" class="empty-icon"></i>
                    <h4>No Active Chats</h4>
                    <p>Search for users above to start a conversation</p>
                </div>
                {% endfor %}
            </div>
        </div>

        <!-- Navbar inside modal -->
        <nav class="bottom-navbar mobile-only" style="position: absolute; bottom: 0; left: 0; right: 0;">
            <div class="bottom-nav-container">
                <a href="{% url 'profile' %}" class="bottom-nav-tab" data-tab="profile">
                    <div class="user-avatar-nano">
                        <img src="{{ current_user.profile_picture_url }}" alt="{{ current_user.full_name }}"
                            onerror="this.style.display='none'; this.nextElementSibling.style.display='flex';">
                        <div class="avatar-fallback-nano">{{ current_user.initials }}</div>
                    </div>
                    <span class="bottom-nav-label">Profile</span>
                </a>

                <button type="button" class="bottom-nav-tab active" data-tab="chats">
                    <div class="nav-icon-wrapper">
                        <i data-lucide="message-circle" class="nav-icon"></i>
                    </div>
                    <span class="bottom-nav-label">Chats</span>
                </button>

                <button type="button" class="bottom-nav-tab" data-tab="home" onclick="closeMobileModal()">
                    <div class="nav-icon-wrapper">
                        <i data-lucide="home" class="nav-icon"></i>
                    </div>
                    <span class="bottom-nav-label">Home</span>
                </button>

                <button type="button" class="bottom-nav-tab" data-tab="search" id="searchTabBtnInChat">
                    <div class="nav-icon-wrapper">
                        <i data-lucide="search" class="nav-icon"></i>
                    </div>
                    <span class="bottom-nav-label">Search</span>
                </button>

                <button type="button" class="bottom-nav-tab" data-tab="more" id="moreTabBtnInChat">
                    <div class="nav-icon-wrapper">
                        <i data-lucide="settings" class="nav-icon"></i>
                    </div>
                    <span class="bottom-nav-label">More</span>
                </button>
            </div>
        </nav>
    </div>

    <!-- Search Modal -->
    <div id="searchModal" class="mobile-modal">
        <div class="mobile-modal-header">
            <h3>Search Users</h3>
            <button class="modal-close" onclick="closeMobileModal()"><i data-lucide="x"></i></button>
        </div>
        <div class="mobile-modal-content">
            <div class="mobile-search-section">
                <div class="search-container">
                    <div class="search-input-wrapper">
                        <i data-lucide="search" class="search-icon"></i>
                        <input type="text" id="userSearchInputAlt" class="search-input" placeholder="Search users..."
                            onkeyup="searchUsersAlt()">
                        <button class="search-clear" onclick="clearSearchAlt()" style="display: none;"><i
                                data-lucide="x"></i></button>
                    </div>
                </div>
                <div id="searchResultsAlt" class="search-results">
                    <!-- Default show all users initially -->
                    <div class="search-results-list">
                        {% for other_user in other_users %}
                        <div class="search-result-item" data-username="{{ other_user.username }}"
                            data-fullname="{{ other_user.full_name|lower }}">
                            <div class="user-avatar-small">
                                <img src="{{ other_user.profile_picture_url }}" alt="{{ other_user.full_name }}"
                                    onerror="this.style.display='none'; this.nextElementSibling.style.display='flex';">
                                <div class="avatar-fallback-small">{{ other_user.name.0 }}{{ other_user.lastname.0 }}
                                </div>
                            </div>
                            <div class="user-info-search">
                                <div class="user-name-search">{{ other_user.full_name }}</div>
                                <div class="user-username-search">@{{ other_user.username }}</div>
                            </div>
                            <div class="user-actions-search">
                                <button onclick="startChat('{{ other_user.username }}')"
                                    class="btn-search btn--primary">Chat</button>
                                <a href="{% url 'user_profile' other_user.username %}"
                                    class="btn-search btn--secondary">Profile</a>
                            </div>
                        </div>
                        {% endfor %}
                    </div>
                </div>
            </div>
        </div>

        <!-- Navbar inside modal -->
        <nav class="bottom-navbar mobile-only" style="position: absolute; bottom: 0; left: 0; right: 0;">
            <div class="bottom-nav-container">
                <a href="{% url 'profile' %}" class="bottom-nav-tab" data-tab="profile">
                    <div class="user-avatar-nano">
                        <img src="{{ current_user.profile_picture_url }}" alt="{{ current_user.full_name }}"
                            onerror="this.style.display='none'; this.nextElementSibling.style.display='flex';">
                        <div class="avatar-fallback-nano">{{ current_user.initials }}</div>
                    </div>
                    <span class="bottom-nav-label">Profile</span>
                </a>

                <a href="{% url 'messages' %}" class="bottom-nav-tab" data-tab="chats">
                    <div class="nav-icon-wrapper">
                        <i data-lucide="message-circle" class="nav-icon"></i>
                    </div>
                    <span class="bottom-nav-label">Chats</span>
                </a>

                <button type="button" class="bottom-nav-tab" data-tab="home" onclick="closeMobileModal()">
                    <div class="nav-icon-wrapper">
                        <i data-lucide="home" class="nav-icon"></i>
                    </div>
                    <span class="bottom-nav-label">Home</span>
                </button>

                <button type="button" class="bottom-nav-tab active" data-tab="search">
                    <div class="nav-icon-wrapper">
                        <i data-lucide="search" class="nav-icon"></i>
                    </div>
                    <span class="bottom-nav-label">Search</span>
                </button>

                <button type="button" class="bottom-nav-tab" data-tab="more" id="moreTabBtnInSearch">
                    <div class="nav-icon-wrapper">
                        <i data-lucide="settings" class="nav-icon"></i>
                    </div>
                    <span class="bottom-nav-label">More</span>
                </button>
            </div>
        </nav>
    </div>
    <div id="moreModal" class="mobile-modal">
        <div class="mobile-modal-header">
            <h3>More Options</h3>
            <button class="modal-close" onclick="closeMobileModal()"><i data-lucide="x"></i></button>
        </div>
        <div class="mobile-modal-content">
            <nav class="mobile-nav-list">
                <a href="{% url 'dashboard' %}" class="mobile-nav-item">
                    <i data-lucide="home" class="nav-icon"></i>
                    <span class="nav-text">Home</span>
                </a>
                <a href="{% url 'profile' %}" class="mobile-nav-item">
                    <i data-lucide="user" class="nav-icon"></i>
                    <span class="nav-text">My Profile</span>
                </a>
                <a href="{% url 'reels' %}" class="mobile-nav-item">
                    <i data-lucide="play-square" class="nav-icon"></i>
                    <span class="nav-text">Reels</span>
                </a>
                <button onclick="closeMobileModal(); openCreateGroupModal();" class="mobile-nav-item">
                    <i data-lucide="users" class="nav-icon"></i>
                    <span class="nav-text">Create Group</span>
                </button>
                <button onclick="closeMobileModal(); openStoryModal();" class="mobile-nav-item">
                    <i data-lucide="plus-circle" class="nav-icon"></i>
                    <span class="nav-text">Add Story</span>
                </button>
                <button onclick="closeMobileModal(); openCreateMenu();" class="mobile-nav-item">
                    <i data-lucide="plus-square" class="nav-icon"></i>
                    <span class="nav-text">Create</span>
                </button>
                <button onclick="closeMobileModal(); openStoryInbox();" class="mobile-nav-item">
                    <i data-lucide="message-circle" class="nav-icon"></i>
                    <span class="nav-text">Story Replies</span>
                    <span class="story-inbox-badge-mobile" id="storyInboxBadgeMobile" style="display: none;">0</span>
                </button>
                <button onclick="closeMobileModal(); window.location.href='{% url 'logout' %}';"
                    class="mobile-nav-item logout-item">
                    <i data-lucide="log-out" class="nav-icon"></i>
                    <span class="nav-text">Logout</span>
                </button>
            </nav>
        </div>
    </div>

    <!-- Main Content Area - Social Media Feed -->
    <div class="main-content-area social-feed">
        <!-- Mobile Header -->
        <div class="mobile-header mobile-only">
            <h2 class="mobile-logo">Odnix</h2>
            <div class="mobile-header-actions">
                {% comment %} <div class="mobile-user-avatar">
                    <img src="{{ current_user.profile_picture_url }}" alt="{{ current_user.full_name }}"
                        class="profile-avatar-small"
                        onerror="this.style.display='none'; this.nextElementSibling.style.display='flex';">
                    <div class="avatar-fallback-small">{{ current_user.name.0 }}{{ current_user.lastname.0 }}</div>
                </div> {% endcomment %}
            </div>
        </div>

        <!-- ENHANCED Stories Section - Instagram-style -->
        <div class="stories-section">
            <div class="stories-wrapper">
                <button class="stories-scroll-btn stories-scroll-left" onclick="scrollStories(-1)"
                    style="display: none;">
                    <i data-lucide="chevron-left"></i>
                </button>
                <div class="stories-container" id="storiesContainer">
                    <!-- FIXED: Your Own Story - Enhanced with Multiple Story Support -->
                    {% if user_story %}
                    <div class="story-item own-story" onclick="viewUserStories()">
                        <div class="story-ring own-story-ring" data-story-count="{{ user_story_count }}">
                            <svg class="story-segments" viewBox="0 0 100 100">
                                <!-- Segments will be generated by JS based on story count -->
                            </svg>
                            <div class="story-avatar">
                                <img src="{{ current_user.profile_picture_url }}" alt="Your story">
                            </div>
                        </div>
                        <div class="story-username">Your Story{% if user_story_count > 1 %}s{% endif %}</div>
                    </div>
                    {% endif %}

                    <!-- Always show Add Story option -->
                    <div class="story-item add-story" onclick="openStoryModal()">
                        <div class="story-ring add-ring">
                            <div class="story-avatar">
                                <div class="add-story-plus">
                                    <i data-lucide="plus"></i>
                                </div>
                            </div>
                        </div>
                        <div class="story-username">Add Story</div>
                    </div>

                    <!-- FIXED: Friends Stories - Enhanced with Multiple Story Support + Viewed States -->
                    {% for story_data in stories_by_user %}
                    <div class="story-item {% if story_data.all_viewed %}viewed{% endif %}"
                        onclick="viewUserStories('{{ story_data.user.username }}')">
                        <div class="story-ring {% if story_data.all_viewed %}viewed{% endif %}"
                            data-story-count="{{ story_data.story_count }}"
                            data-viewed-count="{{ story_data.viewed_count|default:0 }}">
                            <svg class="story-segments" viewBox="0 0 100 100">
                                <!-- Segments will be generated by JS -->
                            </svg>
                            <div class="story-avatar">
                                <img src="{{ story_data.user.profile_picture_url }}"
                                    alt="{{ story_data.user.full_name }}">
                            </div>
                        </div>
                        <div class="story-username">{{ story_data.user.name }}</div>
                    </div>
                    {% empty %}
                    <div class="no-stories-placeholder">
                        <span>No stories yet</span>
                    </div>
                    {% endfor %}
                </div>
                <button class="stories-scroll-btn stories-scroll-right" onclick="scrollStories(1)">
                    <i data-lucide="chevron-right"></i>
                </button>
            </div>
        </div>

        <!-- Tweet Compose Section -->
        <div class="compose-tweet-section">
            <div class="compose-header">
                <h3>What's happening?</h3>
            </div>

            <form id="tweetForm" method="post" action="{% url 'post_tweet' %}" enctype="multipart/form-data">
                {% csrf_token %}
                <div class="compose-main">
                    <div class="compose-avatar">
                        <img src="{{ current_user.profile_picture_url }}" alt="{{ current_user.full_name }}"
                            onerror="this.style.display='none'; this.nextElementSibling.style.display='flex';">
                        <div class="avatar-fallback">{{ current_user.initials }}</div>
                    </div>
                    <div class="compose-content">
                        <div class="tweet-input-container">
                            {{ tweet_form.content }}
                        </div>
                        <div id="imagePreview" class="image-preview" style="display: none;">
                            <img id="previewImg" src="#" alt="Preview">
                            <button type="button" class="remove-image-btn" onclick="removeImageFixed()"><i
                                    data-lucide="x"></i></button>
                        </div>
                    </div>
                </div>
                <div class="compose-actions">
                    <div class="compose-tools">
                        {{ tweet_form.image }}
                        <label for="{{ tweet_form.image.id_for_label }}" class="tool-btn image-btn">
                            <i data-lucide="camera"></i> Photo
                        </label>
                    </div>
                    <div class="compose-submit">
                        <span id="charCount" class="char-count">280</span>
                        <button type="button" id="tweetBtn" class="btn btn--primary" onclick="postTweetFixed()"
                            disabled>Tweet</button>
                    </div>
                </div>
            </form>
        </div>

        <!-- Pending Join Requests -->
        {% if pending_requests %}
        <div class="admin-section">
            <h3>Pending Group Join Requests ({{ pending_requests.count }})</h3>
            <div class="join-requests-list">
                {% for request in pending_requests %}
                <div class="join-request-item" data-request-id="{{ request.id }}">
                    <div class="request-info">
                        <div class="requester-avatar">
                            <img src="{{ request.user.profile_picture_url }}" alt="{{ request.user.full_name }}"
                                class="profile-avatar-small"
                                onerror="this.style.display='none'; this.nextElementSibling.style.display='flex';">
                            <div class="avatar-fallback-small">{{ request.user.name.0 }}{{ request.user.lastname.0 }}
                            </div>
                        </div>
                        <div class="request-details">
                            <div class="requester-name">{{ request.user.full_name }}</div>
                            <div class="request-group">wants to join <strong>{{ request.group.name }}</strong></div>
                            {% if request.message %}
                            <div class="request-message">"{{ request.message }}"</div>
                            {% endif %}
                            <div class="request-time">{{ request.requested_at|timesince }} ago</div>
                        </div>
                    </div>
                    <div class="request-actions">
                        <button onclick="manageJoinRequest({{ request.id }}, 'approve')"
                            class="btn btn--primary btn--small">Approve</button>
                        <button onclick="manageJoinRequest({{ request.id }}, 'reject')"
                            class="btn btn--danger btn--small">Reject</button>
                    </div>
                </div>
                {% endfor %}
            </div>
        </div>
        {% endif %}

        <!-- Tweet Feed -->
        <div class="tweets-feed">
            {% for tweet in tweets_data %}
            <div class="tweet-item" data-tweet-id="{{ tweet.id }}">
                <div class="tweet-header">
                    <div class="tweet-user-info">
                        <div class="tweet-avatar">
                            <img src="{{ tweet.profile_picture_url }}" alt="{{ tweet.fullname }}"
                                onerror="this.style.display='none'; this.nextElementSibling.style.display='flex';">
                            <div class="avatar-fallback">{{ tweet.user_initials }}</div>
                        </div>
                        <div class="tweet-user-details">
                            <div class="tweet-full-name">{{ tweet.fullname }}</div>
                            <div class="tweet-username">@{{ tweet.username }} ‚Ä¢ {{ tweet.time_ago }}</div>
                        </div>
                    </div>
                </div>

                <div class="tweet-content">
                    <p>{{ tweet.content|linkify_hashtags_mentions }}</p>
                    {% if tweet.image_url %}
                    <div class="tweet-image">
                        <img src="{{ tweet.image_url }}" alt="Tweet image"
                            onclick="openImageModal('{{ tweet.image_url }}')">
                    </div>
                    {% endif %}
                </div>

                <div class="tweet-actions">
                    <button class="action-btn comment-btn" onclick="toggleComments({{ tweet.id }})">
                        <i data-lucide="message-circle" class="action-icon"></i> <span>{{ tweet.comment_count }}</span>
                    </button>
                    <button class="action-btn like-btn {% if tweet.is_liked %}liked{% endif %}"
                        onclick="toggleLike({{ tweet.id }})">
                        <i data-lucide="{% if tweet.is_liked %}heart{% else %}heart{% endif %}"
                            class="like-icon action-icon"></i>
                        <span class="like-count">{{ tweet.like_count }}</span>
                    </button>
                </div>

                <!-- Comments Section -->
                <div id="comments-{{ tweet.id }}" class="comments-section" style="display: none;">
                    <div class="add-comment">
                        <div class="comment-avatar">
                            <img src="{{ current_user.profile_picture_url }}" alt="{{ current_user.full_name }}"
                                onerror="this.style.display='none'; this.nextElementSibling.style.display='flex';">
                            <div class="avatar-fallback">{{ current_user.initials }}</div>
                        </div>
                        <div class="comment-input-container">
                            <textarea placeholder="Add a comment..." maxlength="500"
                                id="comment-input-{{ tweet.id }}"></textarea>
                            <button onclick="addComment({{ tweet.id }})"
                                class="btn btn--primary btn--small">Post</button>
                        </div>
                    </div>
                    <div class="comments-list" id="comments-list-{{ tweet.id }}">
                        {% for comment in tweet.recent_comments %}
                        <div class="comment-item">
                            <div class="comment-avatar">
                                <img src="{{ comment.user.profile_picture_url }}" alt="{{ comment.user.full_name }}"
                                    onerror="this.style.display='none'; this.nextElementSibling.style.display='flex';">
                                <div class="avatar-fallback">{{ comment.user.initials }}</div>
                            </div>
                            <div class="comment-content">
                                <div class="comment-header">
                                    <span class="comment-author">{{ comment.user.full_name }}</span>
                                    <span class="comment-time">{{ comment.timestamp|timesince }} ago</span>
                                </div>
                                <p class="comment-text">{{ comment.content }}</p>
                            </div>
                        </div>
                        {% endfor %}
                    </div>
                </div>
            </div>
            {% empty %}
            <div class="empty-feed">
                <h3>Welcome to Odnix! üëã</h3>
                <p>Start following people to see their tweets in your feed.</p>
                <p>Or create your first tweet above! üê¶</p>
            </div>
            {% endfor %}
        </div>
    </div>
</div>

<!-- ENHANCED Story View Modal - Instagram-style Fullscreen -->
<div id="storyViewModal" class="story-view-modal" style="display: none;">
    <div class="story-view-wrapper">
        <!-- Progress bars at top -->
        <div class="story-progress-container" id="storyProgressContainer">
            <!-- Progress bars will be added dynamically -->
        </div>

        <!-- Header -->
        <div class="story-view-header">
            <div class="story-user-info">
                <img id="storyUserAvatar" src="#" alt="#" class="story-user-avatar">
                <div class="story-user-details">
                    <div id="storyUserName" class="story-user-name"></div>
                    <div id="storyTime" class="story-time"></div>
                </div>
            </div>
            <div class="story-header-actions">
                <button class="story-action-btn" onclick="toggleStoryMute()">
                    <i data-lucide="volume-2" id="storyMuteIcon"></i>
                </button>
                <button class="story-action-btn story-close-btn" onclick="closeStoryModal()">
                    <i data-lucide="x"></i>
                </button>
            </div>
        </div>

        <!-- Main Content -->
        <div class="story-content-wrapper">
            <button class="story-nav-arrow story-nav-prev" onclick="navigateStory(-1)">
                <i data-lucide="chevron-left"></i>
            </button>

            <div class="story-content-display" id="storyContentDisplay">
                <!-- Story content will be populated here -->
            </div>

            <button class="story-nav-arrow story-nav-next" onclick="navigateStory(1)">
                <i data-lucide="chevron-right"></i>
            </button>
        </div>

        <!-- Footer -->
        <div class="story-view-footer">
            <div class="story-reply-container">
                <input type="text" class="story-reply-input" id="storyReplyInput" placeholder="Send message..."
                    maxlength="500">
                <button class="story-send-btn" onclick="sendStoryReply()">
                    <i data-lucide="send"></i>
                </button>
            </div>
            <div class="story-quick-actions">
                <button class="story-quick-btn" onclick="toggleStoryLike()" id="storyLikeBtn">
                    <i data-lucide="heart"></i>
                </button>
                <button class="story-quick-btn" onclick="shareStory()">
                    <i data-lucide="send"></i>
                </button>
            </div>
        </div>

        <!-- Story Stats (for own stories) -->
        <div class="story-stats-bar" id="storyStatsBar" style="display: none;">
            <button class="story-stat-btn" onclick="showStoryViewers()">
                <i data-lucide="eye"></i>
                <span id="viewCount">0</span> views
            </button>
            <button class="story-stat-btn" onclick="showStoryReplies()">
                <i data-lucide="message-circle"></i>
                <span id="replyCount">0</span> replies
            </button>
            <button class="story-stat-btn">
                <i data-lucide="heart"></i>
                <span id="likeCount">0</span> likes
            </button>
        </div>
    </div>
</div>

<!-- Story Viewers Modal -->
<div id="storyViewersModal" class="modal" style="display: none;">
    <div class="modal-content story-list-modal">
        <div class="modal-header">
            <h3>Story Viewers</h3>
            <span class="modal-close" onclick="closeStoryViewersModal()"><i data-lucide="x"></i></span>
        </div>
        <div class="modal-body">
            <div id="storyViewersList" class="story-list">
                <!-- Viewers will be populated here -->
            </div>
        </div>
    </div>
</div>

<!-- Story Replies Modal -->
<div id="storyRepliesModal" class="modal" style="display: none;">
    <div class="modal-content story-list-modal">
        <div class="modal-header">
            <h3>Story Replies</h3>
            <span class="modal-close" onclick="closeStoryRepliesModal()"><i data-lucide="x"></i></span>
        </div>
        <div class="modal-body">
            <div id="storyRepliesList" class="story-list">
                <!-- Replies will be populated here -->
            </div>
        </div>
    </div>
</div>

<!-- Create Story Modal -->
<div id="storyModal" class="modal" style="display: none;">
    <div class="modal-content story-modal">
        <div class="modal-header">
            <h3>Create Story</h3>
            <span class="modal-close" onclick="closeCreateStoryModal()"><i data-lucide="x"></i></span>
        </div>
        <div class="modal-body">
            <!-- Story Preview Area -->
            <div class="story-preview-container" id="storyPreviewContainer">
                <div class="story-preview" id="storyPreview">
                    <div class="story-preview-text" id="storyPreviewText" contenteditable="true"
                        data-placeholder="Tap to write your story..."></div>
                    <div class="story-preview-image" id="storyPreviewImage" style="display: none;">
                        <img id="storyPreviewImg" src="" alt="Preview">
                    </div>
                    <div class="story-preview-placeholder" id="storyPreviewPlaceholder">
                        <i data-lucide="plus-circle"></i>
                        <span>Add text or photo</span>
                        <small class="story-drop-hint">Drag & drop an image here</small>
                    </div>
                </div>
            </div>

            <!-- Story Content Input -->
            <div class="story-input-section">
                <textarea id="storyText" placeholder="Write something..." maxlength="200"></textarea>
                <div class="story-char-count"><span id="storyCharCount">0</span>/200</div>
            </div>

            <!-- Story Tools Bar -->
            <div class="story-tools-bar">
                <div class="story-tool-group">
                    <!-- Image Upload Button -->
                    <label class="story-tool-btn" id="imageUploadBtn" title="Add Photo">
                        <i data-lucide="image"></i>
                        <input type="file" id="storyImageInput" accept="image/*" style="display: none;">
                    </label>

                    <!-- Remove Image Button -->
                    <button class="story-tool-btn story-tool-danger" id="removeImageBtn" onclick="removeStoryImage()"
                        style="display: none;" title="Remove Photo">
                        <i data-lucide="x"></i>
                    </button>
                </div>

                <!-- Image Controls (shown when image is selected) -->
                <div class="story-tool-group" id="imageControls" style="display: none;">
                    <button class="story-tool-btn" onclick="zoomImage(0.1)" title="Zoom In">
                        <i data-lucide="zoom-in"></i>
                    </button>
                    <button class="story-tool-btn" onclick="zoomImage(-0.1)" title="Zoom Out">
                        <i data-lucide="zoom-out"></i>
                    </button>
                    <button class="story-tool-btn" onclick="resetImageTransform()" title="Reset Image">
                        <i data-lucide="maximize"></i>
                    </button>
                </div>

                <!-- Text Position Selector -->
                <div class="story-tool-group text-position-group" id="textPositionGroup">
                    <button class="story-tool-btn position-btn" data-position="top" onclick="setTextPosition('top')"
                        title="Text on Top">
                        <i data-lucide="arrow-up-to-line"></i>
                    </button>
                    <button class="story-tool-btn position-btn active" data-position="center"
                        onclick="setTextPosition('center')" title="Text in Center">
                        <i data-lucide="align-center-vertical"></i>
                    </button>
                    <button class="story-tool-btn position-btn" data-position="bottom"
                        onclick="setTextPosition('bottom')" title="Text on Bottom">
                        <i data-lucide="arrow-down-to-line"></i>
                    </button>
                </div>

                <!-- Text Styling -->
                <div class="story-tool-group">
                    <button class="story-tool-btn" onclick="adjustFontSize(-2)" title="Decrease Font Size">
                        <i data-lucide="minus"></i>
                    </button>
                    <button class="story-tool-btn" onclick="adjustFontSize(2)" title="Increase Font Size">
                        <i data-lucide="plus"></i>
                    </button>
                    <button class="story-tool-btn" onclick="toggleTextBold()" title="Bold Text" id="boldBtn">
                        <i data-lucide="bold"></i>
                    </button>
                    <button class="story-tool-btn" onclick="toggleTextShadow()" title="Text Shadow" id="shadowBtn">
                        <i data-lucide="moon"></i>
                    </button>
                </div>

                <!-- Text Alignment -->
                <div class="story-tool-group text-align-group">
                    <button class="story-tool-btn align-btn active" data-align="center" onclick="setTextAlign('center')"
                        title="Center">
                        <i data-lucide="align-center"></i>
                    </button>
                    <button class="story-tool-btn align-btn" data-align="left" onclick="setTextAlign('left')"
                        title="Left">
                        <i data-lucide="align-left"></i>
                    </button>
                    <button class="story-tool-btn align-btn" data-align="right" onclick="setTextAlign('right')"
                        title="Right">
                        <i data-lucide="align-right"></i>
                    </button>
                </div>

                <div class="story-tool-group">
                    <!-- Background Color -->
                    <label class="story-tool-btn color-tool" title="Background Color">
                        <i data-lucide="palette"></i>
                        <input type="color" id="bgColor" value="#667eea">
                        <span class="color-indicator" id="bgColorIndicator" style="background: #667eea;"></span>
                    </label>

                    <!-- Text Color -->
                    <label class="story-tool-btn color-tool" title="Text Color">
                        <i data-lucide="type"></i>
                        <input type="color" id="textColor" value="#ffffff">
                        <span class="color-indicator" id="textColorIndicator" style="background: #ffffff;"></span>
                    </label>
                </div>
            </div>

            <!-- Hidden inputs for styling -->
            <input type="hidden" id="textPosition" value="center">
            <input type="hidden" id="textAlign" value="center">
            <input type="hidden" id="textFontSize" value="20">
            <input type="hidden" id="textBold" value="false">
            <input type="hidden" id="textShadow" value="true">
            <input type="hidden" id="imageZoom" value="1">
            <input type="hidden" id="imageX" value="0">
            <input type="hidden" id="imageY" value="0">

            <!-- Hidden legacy elements for compatibility -->
            <div id="textStoryContent" style="display: none;"></div>
            <div id="imageStoryContent" style="display: none;"></div>
        </div>
        <div class="modal-footer">
            <button class="btn btn--secondary" onclick="closeCreateStoryModal()">Cancel</button>
            <button class="btn btn--primary" onclick="createStory()" id="postStoryBtn">
                <i data-lucide="send"></i> Post Story
            </button>
        </div>
    </div>
</div>

<!-- Image Modal -->
<div id="imageModal" class="modal image-modal" style="display: none;" onclick="closeImageModal()">
    <div class="modal-content image-modal-content">
        <img id="modalImage" src="#" alt="Full size image">
        <span class="modal-close" onclick="closeImageModal()"><i data-lucide="x"></i></span>
    </div>
</div>

<!-- Create Group Modal -->
<div id="createGroupModal" class="modal" style="display: none;">
    <div class="modal-content">
        <div class="modal-header">
            <h3>Create New Group</h3>
            <span class="modal-close" onclick="closeCreateGroupModal()"><i data-lucide="x"></i></span>
        </div>
        <div class="modal-body">
            <form id="createGroupForm">
                <div class="form-group">
                    <label class="form-label">Group Name</label>
                    <input type="text" id="groupName" class="form-control" maxlength="100" required>
                </div>
                <div class="form-group">
                    <label class="form-label">Description</label>
                    <textarea id="groupDescription" class="form-control" rows="3" maxlength="500"></textarea>
                </div>
                <div class="form-group">
                    <label class="form-label">Maximum Members</label>
                    <select id="maxParticipants" class="form-control">
                        <option value="10">10 members</option>
                        <option value="25">25 members</option>
                        <option value="50" selected>50 members</option>
                        <option value="100">100 members</option>
                        <option value="250">250 members</option>
                    </select>
                </div>
                <div class="form-group">
                    <label class="checkbox-label">
                        <input type="checkbox" id="isPublic">
                        <span class="checkmark"></span>
                        Make group discoverable publicly
                    </label>
                </div>
            </form>
        </div>
        <div class="modal-footer">
            <button type="button" class="btn btn--secondary" onclick="closeCreateGroupModal()">Cancel</button>
            <button type="submit" class="btn btn--primary" onclick="createGroup()">Create Group</button>
        </div>
    </div>
</div>

<!-- Group Created Modal -->
<div id="groupCreatedModal" class="modal" style="display: none;">
    <div class="modal-content">
        <div class="modal-header">
            <h3>‚úÖ Group Created Successfully!</h3>
        </div>
        <div class="modal-body">
            <div id="groupCreatedInfo">
                <p>Your group <strong id="createdGroupName"></strong> has been created!</p>
            </div>
            <div class="invite-link-section">
                <label class="form-label">Share this invite link:</label>
                <div class="invite-link-container">
                    <input type="text" id="inviteLink" class="form-control" readonly>
                    <button onclick="copyInviteLink()" class="btn btn--primary">Copy</button>
                </div>
            </div>
        </div>
        <div class="modal-footer">
            <button type="button" class="btn btn--primary" onclick="goToNewGroup()">Go to Group</button>
        </div>
    </div>
</div>

<style>
    /* CSS VARIABLES - ALL ORIGINAL FROM YOUR FILE */
    :root {
        --color-primary: #667eea;
        --color-secondary: #764ba2;
        --color-success: #28a745;
        --color-danger: #dc3545;
        --color-warning: #ffc107;
        --color-info: #17a2b8;
        --color-background: #f8f9fa;
        --color-surface: #ffffff;
        --color-border: #e1e5e9;
        --color-text: #2c3e50;
        --color-text-secondary: #6c757d;
        --color-text-muted: #95a5a6;
    }

    body {
        margin: 0;
        font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, sans-serif;
        background: var(--color-background);
        color: var(--color-text);
        line-height: 1.6;
    }

    .main-container {
        display: flex;
        min-height: 100vh;
        position: relative;
    }

    /* ALL YOUR ORIGINAL DESKTOP SIDEBAR STYLES - PRESERVED EXACTLY */
    .sidebar-enhanced {
        width: 350px;
        background: var(--color-surface);
        border-right: 1px solid var(--color-border);
        display: flex;
        flex-direction: column;
        height: 100vh;
        overflow: hidden;
        box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
        position: sticky;
        top: 0;
    }

    .sidebar-header {
        padding: 1.5rem;
        border-bottom: 1px solid var(--color-border);
    }

    .logo {
        font-size: 2rem;
        font-weight: 900;
        background: linear-gradient(135deg, var(--color-primary), var(--color-secondary));
        -webkit-background-clip: text;
        -webkit-text-fill-color: transparent;
        background-clip: text;
        margin: 0 0 1.5rem 0;
        text-align: center;
    }

    .mobile-logo {
        font-size: 1.5rem;
        font-weight: 900;
        background: linear-gradient(135deg, var(--color-primary), var(--color-secondary));
        -webkit-background-clip: text;
        -webkit-text-fill-color: transparent;
        background-clip: text;
        margin: 0;
    }

    /* ALL YOUR USER INFO STYLES - PRESERVED */
    .user-info-compact {
        display: flex;
        align-items: center;
        gap: 1rem;
        padding: 1rem;
        background: linear-gradient(135deg, rgba(102, 126, 234, 0.05), rgba(118, 75, 162, 0.05));
        border-radius: 1rem;
    }

    .user-avatar-large {
        width: 60px;
        height: 60px;
        border-radius: 50%;
        overflow: hidden;
        position: relative;
        border: 3px solid var(--color-primary);
        flex-shrink: 0;
    }

    .user-avatar-large img {
        width: 100%;
        height: 100%;
        object-fit: cover;
    }

    .avatar-fallback {
        position: absolute;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background: linear-gradient(135deg, var(--color-primary), var(--color-secondary));
        color: white;
        display: none;
        align-items: center;
        justify-content: center;
        font-weight: 700;
        font-size: 1.5rem;
    }

    .user-details-large {
        flex: 1;
        min-width: 0;
    }

    .user-name-large {
        font-weight: 700;
        font-size: 1.1rem;
        color: var(--color-text);
        margin-bottom: 0.25rem;
        white-space: nowrap;
        overflow: hidden;
        text-overflow: ellipsis;
    }

    .user-status-large {
        color: var(--color-text-secondary);
        font-size: 0.9rem;
        white-space: nowrap;
        overflow: hidden;
        text-overflow: ellipsis;
    }

    /* ALL YOUR NAVIGATION STYLES - PRESERVED */
    .sidebar-nav-compact {
        padding: 1rem;
        border-bottom: 1px solid var(--color-border);
    }

    .nav-item-compact {
        display: flex;
        align-items: center;
        padding: 0.75rem 1rem;
        margin-bottom: 0.5rem;
        border-radius: 0.75rem;
        text-decoration: none;
        color: var(--color-text);
        transition: all 0.3s ease;
        border: none;
        background: none;
        width: 100%;
        cursor: pointer;
        font-size: 0.95rem;
        font-weight: 500;
    }

    .nav-item-compact:hover,
    .nav-item-compact.active {
        background: linear-gradient(135deg, var(--color-primary), var(--color-secondary));
        color: white;
        text-decoration: none;
        transform: translateY(-1px);
        box-shadow: 0 4px 15px rgba(102, 126, 234, 0.3);
    }

    .nav-icon {
        font-size: 1.2rem;
        margin-right: 0.75rem;
        width: 20px;
        text-align: center;
    }

    .nav-item-compact .nav-icon[data-lucide] {
        width: 1.2rem !important;
        height: 1.2rem !important;
        font-size: 1.2rem !important;
    }

    /* ALL YOUR SIDEBAR SECTIONS - PRESERVED EXACTLY */
    .sidebar-section {
        flex: 1;
        overflow-y: auto;
        padding: 1rem;
        border-bottom: 1px solid var(--color-border);
    }

    .sidebar-section-title {
        font-size: 0.95rem;
        font-weight: 700;
        color: var(--color-text);
        margin-bottom: 1rem;
        display: flex;
        align-items: center;
        justify-content: space-between;
    }

    .section-count {
        background: var(--color-primary);
        color: white;
        padding: 0.25rem 0.5rem;
        border-radius: 1rem;
        font-size: 0.75rem;
        font-weight: 600;
    }

    /* ALL YOUR CHAT AND USER STYLES - PRESERVED */
    .sidebar-chat-item,
    .mobile-chat-item {
        display: flex;
        align-items: center;
        padding: 0.75rem;
        border-radius: 0.75rem;
        text-decoration: none;
        color: inherit;
        transition: all 0.3s ease;
        margin-bottom: 0.5rem;
        border: 1px solid transparent;
    }

    .sidebar-chat-item:hover,
    .mobile-chat-item:hover {
        background: rgba(102, 126, 234, 0.05);
        text-decoration: none;
        color: inherit;
        border-color: rgba(102, 126, 234, 0.2);
        transform: translateY(-1px);
    }

    .chat-avatar-small {
        width: 40px;
        height: 40px;
        border-radius: 50%;
        overflow: hidden;
        margin-right: 0.75rem;
        position: relative;
        background: linear-gradient(135deg, var(--color-primary), var(--color-secondary));
        display: flex;
        align-items: center;
        justify-content: center;
        color: white;
        font-weight: 700;
        font-size: 0.9rem;
        flex-shrink: 0;
    }

    .group-avatar {
        background: linear-gradient(135deg, #28a745, #20c997);
    }

    .chat-avatar-small img {
        width: 100%;
        height: 100%;
        object-fit: cover;
    }

    .avatar-fallback-small {
        position: absolute;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background: linear-gradient(135deg, var(--color-primary), var(--color-secondary));
        color: white;
        display: none;
        align-items: center;
        justify-content: center;
        font-weight: 700;
        font-size: 0.9rem;
    }

    .chat-info-small {
        flex: 1;
        min-width: 0;
    }

    .chat-name-small {
        font-weight: 600;
        margin-bottom: 0.25rem;
        font-size: 0.9rem;
        overflow: hidden;
        text-overflow: ellipsis;
        white-space: nowrap;
    }

    .chat-meta {
        font-size: 0.75rem;
        color: var(--color-text-secondary);
        display: flex;
        align-items: center;
        gap: 0.5rem;
    }

    .admin-badge {
        margin-left: 0.5rem;
        font-size: 0.7rem;
    }

    .participant-count {
        font-size: 0.75rem;
    }

    .chat-section-title {
        color: var(--color-text);
        font-size: 1rem;
        font-weight: 700;
        margin: 1.5rem 0 1rem 0;
        padding-top: 1rem;
        border-top: 1px solid var(--color-border);
    }

    /* ALL YOUR USER ITEMS - PRESERVED */
    .sidebar-user-item {
        display: flex;
        align-items: center;
        padding: 0.75rem;
        border-radius: 0.75rem;
        margin-bottom: 0.5rem;
        transition: all 0.3s ease;
        border: 1px solid transparent;
    }

    .sidebar-user-item:hover {
        background: rgba(102, 126, 234, 0.05);
        border-color: rgba(102, 126, 234, 0.2);
        transform: translateY(-1px);
    }

    .user-avatar-tiny {
        width: 35px;
        height: 35px;
        border-radius: 50%;
        overflow: hidden;
        margin-right: 0.75rem;
        position: relative;
        background: linear-gradient(135deg, var(--color-primary), var(--color-secondary));
        display: flex;
        align-items: center;
        justify-content: center;
        color: white;
        font-weight: 700;
        font-size: 0.8rem;
        flex-shrink: 0;
    }

    .user-avatar-tiny img {
        width: 100%;
        height: 100%;
        object-fit: cover;
    }

    .avatar-fallback-tiny {
        position: absolute;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background: linear-gradient(135deg, var(--color-primary), var(--color-secondary));
        color: white;
        display: none;
        align-items: center;
        justify-content: center;
        font-weight: 700;
        font-size: 0.8rem;
    }

    .user-info-tiny {
        flex: 1;
        min-width: 0;
    }

    .user-name-tiny {
        font-weight: 600;
        margin-bottom: 0.5rem;
        font-size: 0.85rem;
    }

    .profile-link-small {
        color: inherit;
        text-decoration: none;
        overflow: hidden;
        text-overflow: ellipsis;
        white-space: nowrap;
        display: block;
    }

    .profile-link-small:hover {
        color: var(--color-primary);
        text-decoration: none;
    }

    .user-actions-tiny {
        display: flex;
        gap: 0.5rem;
    }

    /* ALL YOUR BUTTON STYLES - PRESERVED */
    .btn {
        display: inline-flex;
        align-items: center;
        justify-content: center;
        gap: 0.5rem;
        padding: 0.75rem 1.5rem;
        border: none;
        border-radius: 0.75rem;
        cursor: pointer;
        font-weight: 600;
        font-size: 0.9rem;
        text-decoration: none;
        transition: all 0.3s ease;
        outline: none;
    }

    .btn--primary {
        background: linear-gradient(135deg, var(--color-primary), var(--color-secondary));
        color: white;
        box-shadow: 0 2px 10px rgba(102, 126, 234, 0.3);
    }

    .btn--primary:hover {
        transform: translateY(-2px);
        box-shadow: 0 4px 20px rgba(102, 126, 234, 0.4);
        text-decoration: none;
        color: white;
    }

    .btn--primary:disabled {
        opacity: 0.5;
        cursor: not-allowed;
        transform: none;
        box-shadow: 0 2px 10px rgba(102, 126, 234, 0.3);
    }

    .btn--secondary {
        background: var(--color-surface);
        color: var(--color-text);
        border: 2px solid var(--color-border);
    }

    .btn--secondary:hover {
        background: var(--color-background);
        transform: translateY(-1px);
        text-decoration: none;
        color: var(--color-text);
    }

    .btn--danger {
        background: var(--color-danger);
        color: white;
    }

    .btn--danger:hover {
        background: #c82333;
        transform: translateY(-1px);
        color: white;
    }

    .btn--small {
        padding: 0.5rem 1rem;
        font-size: 0.8rem;
    }

    .btn--full-width {
        width: 100%;
    }

    .btn-tiny {
        padding: 0.5rem 1rem;
        font-size: 0.8rem;
        border: 1px solid var(--color-border);
        background: none;
        border-radius: 0.75rem;
        cursor: pointer;
        transition: all 0.3s ease;
        font-weight: 500;
        text-decoration: none;
        display: inline-flex;
        align-items: center;
        justify-content: center;
    }

    .btn-tiny.btn--primary {
        background: var(--color-primary);
        color: white;
        border-color: var(--color-primary);
    }

    .btn-tiny:hover {
        transform: translateY(-1px);
        box-shadow: 0 2px 5px rgba(0, 0, 0, 0.1);
        text-decoration: none;
    }

    .create-group-section {
        padding: 1rem;
        border-bottom: 1px solid var(--color-border);
    }

    .story-inbox-section {
        padding: 0.5rem 1rem 1rem;
    }

    .story-inbox-btn {
        display: flex;
        align-items: center;
        justify-content: center;
        gap: 0.5rem;
        font-size: 0.85rem;
        position: relative;
    }

    .story-inbox-btn svg {
        width: 16px;
        height: 16px;
    }

    .story-inbox-badge {
        background: linear-gradient(135deg, #ef4444, #dc2626);
        color: white;
        font-size: 0.7rem;
        font-weight: 700;
        padding: 2px 6px;
        border-radius: 10px;
        min-width: 18px;
        text-align: center;
    }

    .sidebar-footer-compact {
        padding: 1rem;
        border-top: 1px solid var(--color-border);
    }

    .sidebar-users-list,
    .sidebar-chat-list {
        display: flex;
        flex-direction: column;
    }

    /* MOBILE NAVIGATION - ALL YOUR STYLES PRESERVED */
    .bottom-navbar {
        position: fixed;
        bottom: 0;
        left: 0;
        right: 0;
        width: 100%;
        background: var(--color-surface);
        border-top: 1px solid var(--color-border);
        z-index: 1000;
        box-shadow: 0 -2px 10px rgba(0, 0, 0, 0.1);
        padding: 0;
        padding-bottom: env(safe-area-inset-bottom, 0px);
        /* Safe area for iPhone home bar */
        margin: 0;
    }

    .bottom-nav-container {
        display: flex;
        justify-content: space-around;
        align-items: center;
        padding: 0.5rem 0.25rem;
        width: 100%;
        max-width: 100%;
        margin: 0;
        gap: 0;
    }

    .bottom-nav-tab {
        display: flex;
        flex-direction: column;
        align-items: center;
        justify-content: center;
        gap: 0.25rem;
        padding: 0.75rem 0.5rem;
        cursor: pointer;
        transition: all 0.2s ease;
        border-radius: 0.75rem;
        position: relative;
        flex: 1;
        max-width: 80px;
        text-decoration: none;
        color: inherit;
        -webkit-tap-highlight-color: transparent;
        touch-action: manipulation;
        user-select: none;
        -webkit-user-select: none;
        /* Reset button styles */
        background: none;
        border: none;
        outline: none;
        font-family: inherit;
    }

    .bottom-nav-tab:focus {
        outline: none;
    }

    .bottom-nav-tab:active {
        transform: scale(0.95);
        background: rgba(102, 126, 234, 0.15);
    }

    .bottom-nav-tab:hover {
        background: rgba(102, 126, 234, 0.1);
        text-decoration: none;
        color: inherit;
    }

    .bottom-nav-tab.active {
        background: linear-gradient(135deg, rgba(102, 126, 234, 0.1), rgba(118, 75, 162, 0.1)) !important;
        color: var(--color-primary) !important;
    }

    .nav-icon-wrapper {
        position: relative;
        display: flex;
        align-items: center;
        justify-content: center;
    }

    .bottom-nav-tab .nav-icon {
        font-size: 1.4rem;
        margin: 0;
        width: auto;
    }

    .bottom-nav-tab .nav-icon[data-lucide] {
        width: 1.4rem !important;
        height: 1.4rem !important;
        font-size: 1.4rem !important;
    }

    .bottom-nav-label {
        font-size: 0.7rem;
        font-weight: 600;
        text-align: center;
        color: inherit;
    }

    .nav-badge {
        position: absolute;
        top: -6px;
        right: -6px;
        background: var(--color-primary);
        color: white;
        border-radius: 50%;
        min-width: 18px;
        height: 18px;
        font-size: 0.6rem;
        display: flex;
        align-items: center;
        justify-content: center;
        font-weight: 700;
        border: 2px solid var(--color-surface);
    }

    .user-avatar-nano {
        width: 26px;
        height: 26px;
        min-width: 26px;
        min-height: 26px;
        border-radius: 50%;
        overflow: hidden;
        position: relative;
        background: linear-gradient(135deg, var(--color-primary), var(--color-secondary));
        display: flex;
        align-items: center;
        justify-content: center;
        color: white;
        font-weight: 700;
        font-size: 0.65rem;
        flex-shrink: 0;
        border: 1.5px solid rgba(102, 126, 234, 0.3);
    }

    .user-avatar-nano img {
        width: 100%;
        height: 100%;
        object-fit: cover;
        display: block;
    }

    .avatar-fallback-nano {
        position: absolute;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background: linear-gradient(135deg, var(--color-primary), var(--color-secondary));
        color: white;
        display: none;
        align-items: center;
        justify-content: center;
        font-weight: 700;
        font-size: 0.65rem;
    }

    /* Profile tab specific styling */
    a.bottom-nav-tab[data-tab="profile"],
    button.bottom-nav-tab[data-tab="profile"] {
        padding: 0.6rem 0.25rem;
    }

    /*SEARCH BARR....!!*/
    .search-bar {
        width: 100%;
        padding: 8px 10px;
        margin-bottom: 10px;
        border-radius: 6px;
        border: 1px solid #ccc;
        outline: none;
    }

    .sidebar-user-item {
        display: flex;
        align-items: center;
        justify-content: space-between;
        padding: 6px;
        border-bottom: 1px solid #eee;
    }

    /* MOBILE MODALS - FULL SCREEN PAGES */
    .mobile-modal {
        position: fixed;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
        /* Full screen - covers navbar */
        background: var(--color-surface);
        z-index: 3000;
        /* Above navbar (z-index: 2000) */
        display: none;
        flex-direction: column;
        pointer-events: none;
    }

    .mobile-modal.active {
        display: flex;
        pointer-events: auto;
    }

    .mobile-modal-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        padding: 1rem;
        border-bottom: 1px solid var(--color-border);
        background: var(--color-surface);
        position: sticky;
        top: 0;
        z-index: 10;
    }

    .mobile-modal-header h3 {
        margin: 0;
        font-size: 1.2rem;
        color: var(--color-text);
    }

    .mobile-modal-content {
        flex: 1;
        overflow-y: auto;
        -webkit-overflow-scrolling: touch;
        padding: 1rem;
        padding-bottom: 120px;
        /* Extra space for scrolling */
    }

    .modal-close {
        background: none;
        border: none;
        font-size: 1.5rem;
        cursor: pointer;
        color: var(--color-text-secondary);
        padding: 0.5rem;
        border-radius: 50%;
        transition: all 0.3s ease;
    }

    .modal-close:hover {
        background: var(--color-background);
        color: var(--color-text);
    }

    /* SEARCH FUNCTIONALITY - ALL YOUR STYLES PRESERVED */
    .mobile-search-section {
        margin-bottom: 1.5rem;
    }

    .search-container {
        position: relative;
        margin-bottom: 1rem;
    }

    .search-input-wrapper {
        position: relative;
        display: flex;
        align-items: center;
    }

    .search-input {
        width: 100%;
        padding: 1rem 1rem 1rem 3rem;
        border: 2px solid var(--color-border);
        border-radius: 2rem;
        font-size: 1rem;
        background: var(--color-surface);
        transition: all 0.3s ease;
    }

    .search-input:focus {
        border-color: var(--color-primary);
        outline: none;
        box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
    }

    .search-icon {
        position: absolute;
        left: 1rem;
        font-size: 1.2rem;
        color: var(--color-text-secondary);
        z-index: 1;
    }

    .search-clear {
        position: absolute;
        right: 1rem;
        background: none;
        border: none;
        font-size: 1.2rem;
        color: var(--color-text-secondary);
        cursor: pointer;
        padding: 0.25rem;
        border-radius: 50%;
        transition: all 0.3s ease;
    }

    .search-clear:hover {
        background: rgba(220, 53, 69, 0.1);
        color: var(--color-danger);
    }

    .search-results {
        max-height: 400px;
        overflow-y: auto;
        border-radius: 1rem;
        background: var(--color-surface);
    }

    .search-results-list {
        display: flex;
        flex-direction: column;
        gap: 0.5rem;
    }

    .search-result-item {
        display: flex;
        align-items: center;
        padding: 1rem;
        border-radius: 0.75rem;
        border: 1px solid var(--color-border);
        transition: all 0.3s ease;
        background: var(--color-surface);
    }

    .search-result-item:hover {
        border-color: rgba(102, 126, 234, 0.3);
        transform: translateY(-1px);
        box-shadow: 0 2px 10px rgba(102, 126, 234, 0.1);
    }

    .user-avatar-small {
        width: 45px;
        height: 45px;
        border-radius: 50%;
        overflow: hidden;
        margin-right: 1rem;
        position: relative;
        background: linear-gradient(135deg, var(--color-primary), var(--color-secondary));
        display: flex;
        align-items: center;
        justify-content: center;
        color: white;
        font-weight: 700;
        font-size: 1rem;
        flex-shrink: 0;
    }

    .user-avatar-small img {
        width: 100%;
        height: 100%;
        object-fit: cover;
    }

    .user-info-search {
        flex: 1;
        margin-left: 1rem;
        min-width: 0;
    }

    .user-name-search {
        font-weight: 700;
        font-size: 1rem;
        margin-bottom: 0.25rem;
        color: var(--color-text);
    }

    .user-username-search {
        color: var(--color-text-secondary);
        font-size: 0.9rem;
    }

    .user-actions-search {
        display: flex;
        gap: 0.5rem;
        margin-left: 1rem;
    }

    .btn-search {
        padding: 0.5rem 1rem;
        font-size: 0.8rem;
        border: 1px solid var(--color-border);
        background: none;
        border-radius: 0.75rem;
        cursor: pointer;
        transition: all 0.3s ease;
        font-weight: 500;
        text-decoration: none;
        display: inline-flex;
        align-items: center;
        justify-content: center;
    }

    .btn-search.btn--primary {
        background: var(--color-primary);
        color: white;
        border-color: var(--color-primary);
    }

    .btn-search.btn--secondary {
        background: var(--color-surface);
        color: var(--color-text);
        border-color: var(--color-border);
    }

    .btn-search:hover {
        transform: translateY(-1px);
        box-shadow: 0 2px 5px rgba(0, 0, 0, 0.1);
        text-decoration: none;
    }

    .btn-search.btn--primary:hover {
        color: white;
    }

    .btn-search.btn--secondary:hover {
        color: var(--color-text);
    }

    .mobile-action-section {
        margin-bottom: 1.5rem;
    }

    .mobile-chat-list {
        display: flex;
        flex-direction: column;
        gap: 0.5rem;
    }

    .mobile-nav-list {
        display: flex;
        flex-direction: column;
        gap: 0.5rem;
    }

    .mobile-nav-item {
        display: flex;
        align-items: center;
        gap: 1rem;
        padding: 1rem;
        border-radius: 0.75rem;
        text-decoration: none;
        color: var(--color-text);
        transition: all 0.3s ease;
        border: 1px solid transparent;
        background: none;
        cursor: pointer;
        font-size: 1rem;
        font-weight: 500;
        width: 100%;
        text-align: left;
    }

    .mobile-nav-item:hover {
        background: rgba(102, 126, 234, 0.05);
        border-color: rgba(102, 126, 234, 0.2);
        text-decoration: none;
        color: var(--color-text);
    }

    .mobile-nav-item .nav-icon {
        width: 24px;
        height: 24px;
        color: var(--color-primary);
    }

    .mobile-nav-item.logout-item {
        margin-top: 1rem;
        border-top: 1px solid var(--color-border);
        padding-top: 1.5rem;
        color: var(--color-danger, #ef4444);
    }

    .mobile-nav-item.logout-item .nav-icon {
        color: var(--color-danger, #ef4444);
    }

    .story-inbox-badge-mobile {
        background: var(--color-primary);
        color: white;
        border-radius: 50%;
        min-width: 20px;
        height: 20px;
        font-size: 0.7rem;
        display: flex;
        align-items: center;
        justify-content: center;
        font-weight: 700;
        margin-left: auto;
    }

    /* MAIN CONTENT - ALL YOUR STYLES PRESERVED */
    .main-content-area {
        flex: 1;
        overflow-y: auto;
        background: var(--color-background);
        min-height: 100vh;
    }

    .social-feed {
        padding: 0;
    }

    .mobile-header {
        position: sticky;
        top: 0;
        display: flex;
        align-items: center;
        justify-content: space-between;
        padding: 1rem;
        background: var(--color-surface);
        border-bottom: 1px solid var(--color-border);
        z-index: 100;
        box-shadow: 0 2px 5px rgba(0, 0, 0, 0.05);
    }

    .mobile-header-actions {
        display: flex;
        align-items: center;
        gap: 1rem;
    }

    .mobile-user-avatar {
        width: 32px;
        height: 32px;
        min-width: 32px;
        min-height: 32px;
        background: linear-gradient(135deg, var(--color-primary), var(--color-secondary));
        color: white;
        border-radius: 50%;
        display: flex;
        align-items: center;
        justify-content: center;
        font-weight: 700;
        font-size: 0.85rem;
        overflow: hidden;
        position: relative;
        flex-shrink: 0;
    }

    .mobile-user-avatar img {
        width: 100%;
        height: 100%;
        object-fit: cover;
        display: block;
        border-radius: 50%;
    }

    .mobile-user-avatar .avatar-fallback-small {
        position: absolute;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        display: none;
        align-items: center;
        justify-content: center;
        background: linear-gradient(135deg, var(--color-primary), var(--color-secondary));
        color: white;
        font-weight: 700;
        font-size: 0.85rem;
        border-radius: 50%;
    }

    /* STORIES SECTION - ENHANCED WITH VIEWED STORIES + IMAGE FIXES */
    .stories-section {
        background: var(--color-surface);
        border-bottom: 1px solid var(--color-border);
        padding: 1rem 0;
        position: relative;
    }

    .stories-wrapper {
        position: relative;
        padding: 0 1rem;
    }

    .stories-scroll-btn {
        position: absolute;
        top: 50%;
        transform: translateY(-50%);
        width: 36px;
        height: 36px;
        border-radius: 50%;
        background: var(--color-surface);
        border: 1px solid var(--color-border);
        box-shadow: 0 2px 8px rgba(0, 0, 0, 0.15);
        cursor: pointer;
        z-index: 10;
        display: flex;
        align-items: center;
        justify-content: center;
        color: var(--color-text);
        transition: all 0.2s ease;
    }

    .stories-scroll-btn:hover {
        background: var(--color-background);
        transform: translateY(-50%) scale(1.1);
        box-shadow: 0 4px 12px rgba(0, 0, 0, 0.2);
    }

    .stories-scroll-left {
        left: 0;
    }

    .stories-scroll-right {
        right: 0;
    }

    .stories-container {
        display: flex;
        gap: 1rem;
        overflow-x: auto;
        padding: 0.75rem 0.5rem;
        scroll-behavior: smooth;
        scrollbar-width: none;
        -ms-overflow-style: none;
    }

    .stories-container::-webkit-scrollbar {
        display: none;
    }

    .story-item {
        display: flex;
        flex-direction: column;
        align-items: center;
        cursor: pointer;
        transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        padding: 0.5rem;
        border-radius: 1rem;
        flex-shrink: 0;
        position: relative;
        min-width: 80px;
    }

    .story-item:hover {
        transform: translateY(-4px) scale(1.02);
    }

    .story-item:active {
        transform: scale(0.95);
    }

    .story-ring {
        width: 72px;
        height: 72px;
        border-radius: 50%;
        padding: 3px;
        background: transparent;
        display: flex;
        align-items: center;
        justify-content: center;
        margin-bottom: 0.5rem;
        position: relative;
        transition: all 0.3s ease;
    }

    /* Story segments SVG container */
    .story-segments {
        position: absolute;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        transform: rotate(-90deg);
        z-index: 1;
    }

    .story-segment {
        fill: none;
        stroke-width: 3;
        stroke-linecap: round;
        transition: all 0.3s ease;
    }

    .story-segment.unseen {
        stroke: url(#storyGradient);
        filter: drop-shadow(0 2px 4px rgba(220, 39, 67, 0.4));
    }

    .story-segment.seen {
        stroke: #94a3b8;
    }

    /* Fallback for single story or no JS */
    .story-ring:not([data-story-count]) {
        background: linear-gradient(135deg, #f09433, #e6683c, #dc2743, #cc2366, #bc1888);
        background-size: 200% 200%;
        animation: gradientShift 3s ease infinite;
        box-shadow: 0 4px 15px rgba(220, 39, 67, 0.3);
    }

    @keyframes gradientShift {
        0% {
            background-position: 0% 50%;
        }

        50% {
            background-position: 100% 50%;
        }

        100% {
            background-position: 0% 50%;
        }
    }

    .own-story-ring {
        /* Own story uses purple gradient */
    }

    .own-story-ring .story-segment.unseen {
        stroke: url(#ownStoryGradient);
        filter: drop-shadow(0 2px 4px rgba(102, 126, 234, 0.4));
    }

    .add-ring {
        background: linear-gradient(135deg, #e2e8f0, #cbd5e1) !important;
        box-shadow: 0 4px 10px rgba(0, 0, 0, 0.1) !important;
        animation: none !important;
    }

    .add-ring:hover {
        background: linear-gradient(135deg, var(--color-primary), var(--color-secondary)) !important;
    }

    .add-story-plus {
        width: 100%;
        height: 100%;
        display: flex;
        align-items: center;
        justify-content: center;
        background: var(--color-surface);
        border-radius: 50%;
        color: var(--color-primary);
        transition: all 0.3s ease;
    }

    .add-story-plus svg {
        width: 28px;
        height: 28px;
        stroke-width: 2.5;
    }

    .add-story:hover .add-story-plus {
        color: white;
        background: transparent;
    }

    /* Viewed Stories - All segments are gray */
    .story-ring.viewed .story-segment {
        stroke: #94a3b8 !important;
        filter: none !important;
    }

    .story-item.viewed .story-username {
        color: var(--color-text-muted);
    }

    .story-item:hover .story-ring.viewed .story-segment {
        stroke: #64748b !important;
    }

    /* Story avatar */
    .story-avatar {
        width: calc(100% - 6px);
        height: calc(100% - 6px);
        border-radius: 50%;
        overflow: hidden;
        border: 3px solid var(--color-surface);
        display: flex;
        align-items: center;
        justify-content: center;
        background: var(--color-background);
        position: relative;
        z-index: 2;
    }

    .story-avatar img {
        width: 100%;
        height: 100%;
        object-fit: cover;
        transition: transform 0.3s ease;
    }

    .story-item:hover .story-avatar img {
        transform: scale(1.1);
    }

    .story-username {
        font-size: 0.75rem;
        font-weight: 600;
        text-align: center;
        color: var(--color-text);
        max-width: 76px;
        overflow: hidden;
        text-overflow: ellipsis;
        white-space: nowrap;
        margin-top: 2px;
    }

    .no-stories-placeholder {
        display: flex;
        align-items: center;
        justify-content: center;
        padding: 1rem 2rem;
        color: var(--color-text-muted);
        font-size: 0.85rem;
        font-style: italic;
    }

    /* TWEET COMPOSE - ALL YOUR STYLES PRESERVED */
    .compose-tweet-section {
        background: var(--color-surface);
        border-bottom: 1px solid var(--color-border);
        padding: 1.5rem;
        margin-bottom: 0;
        position: relative;
    }

    .compose-header h3 {
        font-size: 1.4rem;
        font-weight: 700;
        margin-bottom: 1rem;
        color: var(--color-text);
    }

    .compose-main {
        display: flex;
        gap: 1rem;
        margin-bottom: 1rem;
    }

    .compose-avatar {
        flex-shrink: 0;
        position: relative;
        width: 56px;
        height: 56px;
    }

    .compose-avatar img,
    .compose-avatar .avatar-fallback {
        width: 56px;
        height: 56px;
        border-radius: 50%;
        object-fit: cover;
    }

    .compose-content {
        flex: 1;
    }

    .tweet-input-container {
        width: 100%;
        position: relative;
    }

    #id_content {
        width: 100%;
        min-height: 140px;
        padding: 1rem;
        border: 2px solid var(--color-border);
        border-radius: 1rem;
        font-family: inherit;
        font-size: 1.2rem;
        line-height: 1.6;
        resize: none;
        outline: none;
        transition: all 0.3s ease;
        background: var(--color-background);
        color: var(--color-text);
    }

    #id_content:focus {
        border-color: var(--color-primary);
        background: var(--color-surface);
        box-shadow: 0 0 0 4px rgba(102, 126, 234, 0.1);
        transform: translateY(-2px);
    }

    .compose-actions {
        display: flex;
        justify-content: space-between;
        align-items: center;
        padding-top: 1rem;
        border-top: 1px solid var(--color-border);
    }

    .compose-tools {
        display: flex;
        gap: 0.5rem;
    }

    #id_image {
        display: none !important;
    }

    .image-btn {
        display: inline-flex;
        align-items: center;
        gap: 0.5rem;
        padding: 0.75rem 1rem;
        background: var(--color-background);
        border: 2px solid var(--color-border);
        border-radius: 0.75rem;
        color: var(--color-text);
        font-size: 0.9rem;
        font-weight: 600;
        cursor: pointer;
        transition: all 0.3s ease;
        box-shadow: 0 2px 5px rgba(0, 0, 0, 0.05);
    }

    .image-btn:hover {
        border-color: var(--color-primary);
        background: var(--color-surface);
        transform: translateY(-1px);
        box-shadow: 0 4px 15px rgba(102, 126, 234, 0.1);
    }

    .compose-submit {
        display: flex;
        align-items: center;
        gap: 1rem;
    }

    .char-count {
        font-size: 0.9rem;
        font-weight: 700;
        color: var(--color-text-secondary);
        padding: 0.5rem 1rem;
        background: var(--color-background);
        border-radius: 0.5rem;
        min-width: 48px;
        text-align: center;
    }

    .char-count.warning {
        color: var(--color-warning);
        background: rgba(255, 193, 7, 0.1);
    }

    .char-count.danger {
        color: var(--color-danger);
        background: rgba(220, 53, 69, 0.1);
    }

    /* IMAGE PREVIEW - FIXED FOR BETTER ASPECT RATIOS */
    .image-preview {
        margin-top: 1rem;
        position: relative;
        border-radius: 1rem;
        overflow: hidden;
        background: var(--color-background);
        border: 2px solid var(--color-border);
        box-shadow: 0 10px 30px rgba(0, 0, 0, 0.1);
        max-height: 400px;
    }

    .image-preview img {
        width: 100%;
        height: auto;
        max-height: 400px;
        object-fit: contain;
        display: block;
        background: var(--color-surface);
    }

    .remove-image-btn {
        position: absolute;
        top: 0.75rem;
        right: 0.75rem;
        background: rgba(0, 0, 0, 0.8);
        color: white;
        border: none;
        width: 36px;
        height: 36px;
        border-radius: 50%;
        cursor: pointer;
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 1.1rem;
        transition: all 0.3s ease;
        backdrop-filter: blur(10px);
    }

    .remove-image-btn:hover {
        background: rgba(0, 0, 0, 0.9);
        transform: scale(1.1);
    }

    /* TWEET FEED - ALL YOUR STYLES + IMAGE FIXES */
    .tweets-feed {
        padding: 1rem;
    }

    .tweet-item {
        background: var(--color-surface);
        border-radius: 1rem;
        padding: 1.5rem;
        margin-bottom: 1rem;
        border: 1px solid var(--color-border);
        transition: all 0.3s ease;
        box-shadow: 0 2px 5px rgba(0, 0, 0, 0.05);
    }

    .tweet-item:hover {
        box-shadow: 0 4px 15px rgba(0, 0, 0, 0.1);
        transform: translateY(-2px);
    }

    .tweet-header {
        margin-bottom: 1rem;
    }

    .tweet-user-info {
        display: flex;
        align-items: center;
    }

    .tweet-avatar {
        width: 50px;
        height: 50px;
        border-radius: 50%;
        overflow: hidden;
        margin-right: 1rem;
        position: relative;
        border: 2px solid var(--color-primary);
        flex-shrink: 0;
    }

    .tweet-avatar img {
        width: 100%;
        height: 100%;
        object-fit: cover;
    }

    .tweet-user-details {
        flex: 1;
    }

    .tweet-full-name {
        font-weight: 700;
        color: var(--color-text);
        margin-bottom: 0.25rem;
    }

    .tweet-username {
        color: var(--color-text-secondary);
        font-size: 0.9rem;
    }

    .tweet-content {
        margin-bottom: 1rem;
    }

    .tweet-content p {
        font-size: 1.1rem;
        line-height: 1.5;
        color: var(--color-text);
        margin-bottom: 0.5rem;
    }

    /* Hashtag and Mention Links */
    .hashtag-link {
        color: #667eea;
        text-decoration: none;
        font-weight: 600;
        transition: color 0.2s;
    }

    .hashtag-link:hover {
        color: #764ba2;
        text-decoration: underline;
    }

    .mention-link {
        color: #10b981;
        text-decoration: none;
        font-weight: 600;
        transition: color 0.2s;
    }

    .mention-link:hover {
        color: #059669;
        text-decoration: underline;
    }

    /* TWEET IMAGES - FIXED FOR BETTER ASPECT RATIOS */
    .tweet-image {
        margin-top: 1rem;
        border-radius: 1rem;
        overflow: hidden;
        max-height: 500px;
        position: relative;
        background: var(--color-background);
        border: 1px solid var(--color-border);
    }

    .tweet-image img {
        width: 100%;
        height: auto;
        max-height: 500px;
        object-fit: contain;
        cursor: pointer;
        transition: all 0.3s ease;
        display: block;
        background: var(--color-surface);
    }

    .tweet-image.tall-image {
        max-height: 400px;
        display: flex;
        align-items: center;
        justify-content: center;
    }

    .tweet-image.tall-image img {
        max-width: 100%;
        max-height: 400px;
        width: auto;
        height: auto;
        object-fit: contain;
    }

    .tweet-image.wide-image img {
        width: 100%;
        height: auto;
        max-height: 500px;
        object-fit: contain;
    }

    .tweet-image img:hover {
        transform: scale(1.01);
        box-shadow: 0 4px 20px rgba(0, 0, 0, 0.1);
    }

    .tweet-actions {
        display: flex;
        justify-content: space-around;
        padding: 1rem 0;
        border-top: 1px solid var(--color-border);
    }

    .action-btn {
        display: flex;
        align-items: center;
        gap: 0.5rem;
        background: none;
        border: none;
        cursor: pointer;
        padding: 0.5rem 1rem;
        border-radius: 2rem;
        transition: all 0.3s ease;
        font-size: 0.9rem;
        color: var(--color-text-secondary);
    }

    .action-btn:hover {
        background: rgba(102, 126, 234, 0.1);
        color: var(--color-primary);
    }

    .action-btn.liked {
        color: #e91e63;
    }

    .action-btn.liked .like-icon {
        animation: heartbeat 0.3s ease;
    }

    @keyframes heartbeat {
        0% {
            transform: scale(1);
        }

        50% {
            transform: scale(1.2);
        }

        100% {
            transform: scale(1);
        }
    }

    /* COMMENTS - ALL YOUR STYLES PRESERVED */
    .comments-section {
        border-top: 1px solid var(--color-border);
        margin-top: 1rem;
        padding-top: 1rem;
    }

    .add-comment {
        display: flex;
        gap: 1rem;
        margin-bottom: 1rem;
    }

    .comment-avatar {
        width: 40px;
        height: 40px;
        border-radius: 50%;
        overflow: hidden;
        position: relative;
        border: 2px solid var(--color-border);
        flex-shrink: 0;
    }

    .comment-avatar img {
        width: 100%;
        height: 100%;
        object-fit: cover;
    }

    .comment-input-container {
        flex: 1;
        display: flex;
        flex-direction: column;
        gap: 0.75rem;
    }

    .comment-input-container textarea {
        width: 100%;
        border: 2px solid var(--color-border);
        border-radius: 0.75rem;
        padding: 0.75rem;
        resize: none;
        font-family: inherit;
        font-size: 0.9rem;
        line-height: 1.4;
    }

    .comment-input-container textarea:focus {
        border-color: var(--color-primary);
        outline: none;
    }

    .comment-input-container button {
        align-self: flex-end;
    }

    .comments-list {
        display: flex;
        flex-direction: column;
        gap: 1rem;
    }

    .comment-item {
        display: flex;
        gap: 1rem;
        padding: 1rem;
        background: rgba(102, 126, 234, 0.02);
        border-radius: 0.75rem;
        border: 1px solid rgba(102, 126, 234, 0.1);
    }

    .comment-content {
        flex: 1;
    }

    .comment-header {
        display: flex;
        align-items: center;
        gap: 0.75rem;
        margin-bottom: 0.5rem;
    }

    .comment-author {
        font-weight: 600;
        color: var(--color-text);
    }

    .comment-time {
        color: var(--color-text-secondary);
        font-size: 0.8rem;
    }

    .comment-text {
        color: var(--color-text);
        line-height: 1.4;
        margin: 0;
    }

    /* ADMIN SECTION - ALL YOUR STYLES PRESERVED */
    .admin-section {
        background: var(--color-surface);
        border-radius: 1rem;
        padding: 1.5rem;
        margin: 0 1rem 1rem;
        border: 1px solid var(--color-border);
        box-shadow: 0 2px 10px rgba(0, 0, 0, 0.05);
    }

    .admin-section h3 {
        margin: 0 0 1rem 0;
        color: var(--color-text);
    }

    .join-requests-list {
        display: flex;
        flex-direction: column;
        gap: 1rem;
    }

    .join-request-item {
        display: flex;
        justify-content: space-between;
        align-items: center;
        padding: 1rem;
        background: rgba(102, 126, 234, 0.02);
        border-radius: 0.75rem;
        border: 1px solid rgba(102, 126, 234, 0.1);
    }

    .request-info {
        display: flex;
        align-items: center;
        gap: 1rem;
        flex: 1;
    }

    .requester-avatar {
        width: 40px;
        height: 40px;
        border-radius: 50%;
        background: linear-gradient(135deg, var(--color-primary), var(--color-secondary));
        color: white;
        display: flex;
        align-items: center;
        justify-content: center;
        font-weight: 700;
        font-size: 0.9rem;
        flex-shrink: 0;
    }

    .request-details {
        flex: 1;
    }

    .requester-name {
        font-weight: 600;
        margin-bottom: 0.25rem;
        color: var(--color-text);
    }

    .request-group {
        color: var(--color-text-secondary);
        font-size: 0.9rem;
        margin-bottom: 0.25rem;
    }

    .request-message {
        font-style: italic;
        color: var(--color-text-secondary);
        font-size: 0.85rem;
        margin-bottom: 0.25rem;
    }

    .request-time {
        color: var(--color-text-muted);
        font-size: 0.8rem;
    }

    .request-actions {
        display: flex;
        gap: 0.75rem;
    }

    /* EMPTY STATES - ALL YOUR STYLES PRESERVED */
    .empty-state-small,
    .empty-state-mobile,
    .empty-feed {
        text-align: center;
        padding: 2rem;
        color: var(--color-text-secondary);
    }

    .empty-state-mobile {
        padding: 3rem 1rem;
    }

    .empty-state-mobile .empty-icon {
        font-size: 3rem;
        margin-bottom: 1rem;
    }

    .empty-state-mobile h4 {
        color: var(--color-text);
        margin-bottom: 0.5rem;
    }

    .empty-feed {
        background: var(--color-surface);
        border-radius: 1rem;
        margin: 1rem;
        box-shadow: 0 2px 10px rgba(0, 0, 0, 0.05);
    }

    .empty-feed h3 {
        color: var(--color-text);
        margin-bottom: 1rem;
    }

    /* MODALS - ALL YOUR STYLES + STORY MODAL ENHANCEMENTS */
    .modal {
        display: none;
        position: fixed;
        z-index: 3000;
        left: 0;
        top: 0;
        width: 100%;
        height: 100%;
        background-color: rgba(0, 0, 0, 0.5);
        align-items: center;
        justify-content: center;
        backdrop-filter: blur(5px);
    }

    .modal-content {
        background: var(--color-surface);
        border-radius: 1rem;
        max-width: 500px;
        width: 90%;
        max-height: 80vh;
        overflow-y: auto;
        box-shadow: 0 10px 40px rgba(0, 0, 0, 0.3);
        animation: modalSlideIn 0.3s ease;
    }

    @keyframes modalSlideIn {
        from {
            opacity: 0;
            transform: scale(0.8);
        }

        to {
            opacity: 1;
            transform: scale(1);
        }
    }

    .modal-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        padding: 1.5rem;
        border-bottom: 1px solid var(--color-border);
    }

    .modal-header h3 {
        margin: 0;
        color: var(--color-text);
    }

    .modal-body {
        padding: 1.5rem;
    }

    .modal-footer {
        display: flex;
        justify-content: flex-end;
        gap: 1rem;
        padding: 1.5rem;
        border-top: 1px solid var(--color-border);
    }

    /* ==================== ENHANCED STORY VIEW MODAL - Instagram Style ==================== */
    .story-view-modal {
        position: fixed;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
        background: #000;
        z-index: 99999;
        display: flex;
        align-items: center;
        justify-content: center;
    }

    /* Hide bottom navbar when story modal is open */
    body.story-modal-open .bottom-navbar {
        display: none !important;
    }

    .story-view-wrapper {
        position: relative;
        width: 100%;
        max-width: 420px;
        height: 100vh;
        max-height: 100vh;
        background: #000;
        display: flex;
        flex-direction: column;
    }

    /* Progress bars */
    .story-progress-container {
        position: absolute;
        top: 0;
        left: 0;
        right: 0;
        display: flex;
        gap: 4px;
        padding: 12px 12px 8px;
        z-index: 10;
    }

    .story-progress-bar {
        flex: 1;
        height: 3px;
        background: rgba(255, 255, 255, 0.3);
        border-radius: 2px;
        overflow: hidden;
    }

    .story-progress-fill {
        height: 100%;
        background: #fff;
        width: 0%;
        transition: width 0.1s linear;
    }

    .story-progress-bar.completed .story-progress-fill {
        width: 100%;
    }

    .story-progress-bar.active .story-progress-fill {
        animation: progressFill 5s linear forwards;
    }

    @keyframes progressFill {
        from {
            width: 0%;
        }

        to {
            width: 100%;
        }
    }

    /* Header */
    .story-view-header {
        position: absolute;
        top: 24px;
        left: 0;
        right: 0;
        display: flex;
        align-items: center;
        justify-content: space-between;
        padding: 8px 12px;
        z-index: 10;
        background: linear-gradient(to bottom, rgba(0, 0, 0, 0.6) 0%, transparent 100%);
    }

    .story-user-info {
        display: flex;
        align-items: center;
        gap: 10px;
    }

    .story-user-avatar {
        width: 36px;
        height: 36px;
        border-radius: 50%;
        object-fit: cover;
        border: 2px solid #fff;
    }

    .story-user-details {
        display: flex;
        flex-direction: column;
    }

    .story-user-name {
        font-weight: 600;
        color: #fff;
        font-size: 0.9rem;
    }

    .story-time {
        font-size: 0.75rem;
        color: rgba(255, 255, 255, 0.7);
    }

    .story-header-actions {
        display: flex;
        align-items: center;
        gap: 8px;
    }

    .story-action-btn {
        background: transparent;
        border: none;
        color: #fff;
        width: 36px;
        height: 36px;
        border-radius: 50%;
        display: flex;
        align-items: center;
        justify-content: center;
        cursor: pointer;
        transition: all 0.2s ease;
    }

    .story-action-btn:hover {
        background: rgba(255, 255, 255, 0.2);
    }

    .story-close-btn:hover {
        background: rgba(255, 255, 255, 0.3);
    }

    /* Main Content */
    .story-content-wrapper {
        flex: 1;
        display: flex;
        align-items: center;
        justify-content: center;
        position: relative;
        overflow: hidden;
    }

    .story-nav-arrow {
        position: absolute;
        top: 50%;
        transform: translateY(-50%);
        background: rgba(255, 255, 255, 0.1);
        border: none;
        color: #fff;
        width: 44px;
        height: 44px;
        border-radius: 50%;
        display: flex;
        align-items: center;
        justify-content: center;
        cursor: pointer;
        z-index: 5;
        transition: all 0.2s ease;
        opacity: 0;
    }

    .story-view-wrapper:hover .story-nav-arrow {
        opacity: 1;
    }

    .story-nav-arrow:hover {
        background: rgba(255, 255, 255, 0.3);
        transform: translateY(-50%) scale(1.1);
    }

    .story-nav-prev {
        left: 12px;
    }

    .story-nav-next {
        right: 12px;
    }

    .story-content-display {
        width: 100%;
        height: 100%;
        display: flex;
        align-items: center;
        justify-content: center;
        position: relative;
    }

    .story-content-display img,
    .story-content-display video {
        max-width: 100%;
        max-height: 100%;
        object-fit: contain;
        border-radius: 8px;
    }

    .story-content-display.text-story {
        padding: 2rem;
        text-align: center;
        display: flex;
        align-items: center;
        justify-content: center;
    }

    .story-text-content {
        font-size: 1.8rem;
        font-weight: 600;
        line-height: 1.4;
        word-wrap: break-word;
        max-width: 90%;
        text-shadow: 0 2px 10px rgba(0, 0, 0, 0.3);
        position: absolute;
        left: 50%;
        transform: translateX(-50%);
        width: 90%;
        text-align: center;
        transition: all 0.2s ease;
    }

    .story-text-content.bold {
        font-weight: 700;
    }

    .story-text-content.no-shadow {
        text-shadow: none;
    }

    .story-text-content.align-left {
        text-align: left;
        left: 5%;
        transform: translateX(0);
    }

    .story-text-content.align-right {
        text-align: right;
        left: auto;
        right: 5%;
        transform: translateX(0);
    }

    /* Story text position classes */
    .story-text-content.position-top,
    .story-text-overlay.position-top {
        top: 60px;
        bottom: auto;
    }

    .story-text-content.position-center,
    .story-text-overlay.position-center {
        top: 50%;
        transform: translate(-50%, -50%);
    }

    .story-text-content.position-bottom,
    .story-text-overlay.position-bottom {
        top: auto;
        bottom: 100px;
    }

    /* Story text overlay for image/video stories */
    .story-text-overlay {
        position: absolute;
        left: 50%;
        transform: translateX(-50%);
        width: 85%;
        text-align: center;
        font-size: 1.4rem;
        font-weight: 600;
        line-height: 1.4;
        word-wrap: break-word;
        text-shadow: 0 2px 10px rgba(0, 0, 0, 0.5);
        background: rgba(0, 0, 0, 0.5);
        padding: 0.75rem 1rem;
        border-radius: 12px;
        backdrop-filter: blur(4px);
        z-index: 5;
    }

    /* Footer */
    .story-view-footer {
        position: absolute;
        bottom: 0;
        left: 0;
        right: 0;
        display: flex;
        align-items: center;
        gap: 12px;
        padding: 16px 12px;
        padding-bottom: calc(24px + env(safe-area-inset-bottom, 20px));
        background: linear-gradient(to top, rgba(0, 0, 0, 0.8) 0%, transparent 100%);
        z-index: 10;
    }

    .story-reply-container {
        flex: 1;
        display: flex;
        align-items: center;
        background: rgba(255, 255, 255, 0.15);
        border: 1px solid rgba(255, 255, 255, 0.3);
        border-radius: 24px;
        padding: 4px 4px 4px 16px;
        backdrop-filter: blur(10px);
    }

    .story-reply-input {
        flex: 1;
        background: transparent;
        border: none;
        color: #fff;
        font-size: 0.9rem;
        padding: 8px 0;
        outline: none;
    }

    .story-reply-input::placeholder {
        color: rgba(255, 255, 255, 0.6);
    }

    .story-send-btn {
        background: var(--color-primary);
        border: none;
        color: #fff;
        width: 36px;
        height: 36px;
        border-radius: 50%;
        display: flex;
        align-items: center;
        justify-content: center;
        cursor: pointer;
        transition: all 0.2s ease;
    }

    .story-send-btn:hover {
        background: var(--color-secondary);
        transform: scale(1.05);
    }

    .story-quick-actions {
        display: flex;
        gap: 8px;
    }

    .story-quick-btn {
        background: transparent;
        border: none;
        color: #fff;
        width: 40px;
        height: 40px;
        border-radius: 50%;
        display: flex;
        align-items: center;
        justify-content: center;
        cursor: pointer;
        transition: all 0.2s ease;
    }

    .story-quick-btn:hover {
        background: rgba(255, 255, 255, 0.2);
        transform: scale(1.1);
    }

    .story-quick-btn.liked {
        color: #ef4444;
    }

    .story-quick-btn.liked svg {
        fill: #ef4444;
    }

    /* Stats bar for own stories */
    .story-stats-bar {
        position: absolute;
        bottom: 80px;
        left: 0;
        right: 0;
        display: flex;
        justify-content: center;
        gap: 24px;
        z-index: 10;
    }

    .story-stat-btn {
        background: rgba(0, 0, 0, 0.5);
        border: none;
        color: #fff;
        padding: 8px 16px;
        border-radius: 20px;
        display: flex;
        align-items: center;
        gap: 6px;
        cursor: pointer;
        font-size: 0.85rem;
        backdrop-filter: blur(10px);
        transition: all 0.2s ease;
    }

    .story-stat-btn:hover {
        background: rgba(255, 255, 255, 0.2);
    }

    /* Spin animation for loaders */
    @keyframes spin {
        from {
            transform: rotate(0deg);
        }

        to {
            transform: rotate(360deg);
        }
    }

    .spin {
        animation: spin 1s linear infinite;
    }

    /* Responsive */
    @media (max-width: 480px) {
        .story-view-wrapper {
            max-width: 100%;
            border-radius: 0;
        }

        .story-nav-arrow {
            width: 36px;
            height: 36px;
            opacity: 0.7;
        }

        .story-nav-prev {
            left: 4px;
        }

        .story-nav-next {
            right: 4px;
        }

        .story-text-content {
            font-size: 1.4rem;
        }
    }

    @media (min-width: 768px) {
        .story-view-wrapper {
            max-height: 90vh;
            border-radius: 12px;
            overflow: hidden;
        }
    }

    /* Story Modal specific styles */
    .story-modal {
        max-width: 500px;
        width: 95%;
    }

    /* Story Preview Container */
    .story-preview-container {
        margin-bottom: 1rem;
    }

    .story-preview {
        position: relative;
        width: 100%;
        height: 280px;
        border-radius: 16px;
        overflow: hidden;
        display: flex;
        align-items: center;
        justify-content: center;
        transition: all 0.3s ease;
        border: 2px dashed transparent;
    }

    .story-preview.drag-over {
        border-color: rgba(102, 126, 234, 0.7);
        box-shadow: 0 0 0 4px rgba(102, 126, 234, 0.08);
    }

    .story-preview-placeholder {
        display: flex;
        flex-direction: column;
        align-items: center;
        gap: 0.5rem;
        color: rgba(255, 255, 255, 0.7);
    }

    .story-preview-placeholder i {
        width: 48px;
        height: 48px;
        opacity: 0.6;
    }

    .story-preview-placeholder span {
        font-size: 0.9rem;
    }

    .story-drop-hint {
        font-size: 0.8rem;
        opacity: 0.8;
    }

    .story-preview-text {
        position: absolute;
        left: 50%;
        transform: translateX(-50%);
        width: 90%;
        text-align: center;
        font-size: 1.25rem;
        font-weight: 600;
        line-height: 1.5;
        word-wrap: break-word;
        z-index: 2;
        text-shadow: 0 1px 3px rgba(0, 0, 0, 0.3);
        transition: all 0.3s ease;
        outline: none;
        cursor: text;
    }

    .story-preview-text:empty:before {
        content: attr(data-placeholder);
        color: rgba(255, 255, 255, 0.6);
    }

    /* Text position variants */
    .story-preview-text.position-top {
        top: 20px;
        bottom: auto;
    }

    .story-preview-text.position-center {
        top: 50%;
        transform: translate(-50%, -50%);
    }

    .story-preview-text.position-bottom {
        top: auto;
        bottom: 20px;
    }

    .story-preview-image {
        position: absolute;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        z-index: 1;
        overflow: hidden;
        cursor: move;
        user-select: none;
    }

    .story-preview-image:active {
        cursor: grabbing;
    }

    .story-preview-image img {
        width: 100%;
        height: 100%;
        object-fit: contain;
        transition: transform 0.1s ease;
        transform-origin: center;
        pointer-events: none;
    }

    /* Story Input Section */
    .story-input-section {
        position: relative;
        margin-bottom: 1rem;
    }

    .story-input-section textarea {
        width: 100%;
        height: 80px;
        border: 2px solid var(--color-border);
        border-radius: 12px;
        padding: 1rem;
        padding-bottom: 2rem;
        font-size: 1rem;
        font-family: inherit;
        resize: none;
        transition: border-color 0.2s ease;
    }

    .story-input-section textarea:focus {
        border-color: var(--color-primary);
        outline: none;
    }

    .story-char-count {
        position: absolute;
        bottom: 8px;
        right: 12px;
        font-size: 0.75rem;
        color: var(--color-text-muted);
    }

    /* Story Tools Bar */
    .story-tools-bar {
        display: flex;
        justify-content: space-between;
        align-items: center;
        padding: 0.75rem;
        background: var(--color-surface);
        border-radius: 12px;
        border: 1px solid var(--color-border);
        flex-wrap: wrap;
        gap: 0.5rem;
    }

    .story-tool-group {
        display: flex;
        gap: 0.25rem;
        align-items: center;
    }

    .text-position-group {
        background: var(--color-bg);
        border-radius: 10px;
        padding: 4px;
        border: 1px solid var(--color-border);
    }

    .text-position-group .story-tool-btn {
        width: 36px;
        height: 36px;
        border: none;
        background: transparent;
        border-radius: 8px;
    }

    .text-position-group .story-tool-btn:hover {
        background: rgba(102, 126, 234, 0.1);
        color: var(--color-primary);
    }

    .text-position-group .story-tool-btn.active,
    .text-align-group .story-tool-btn.active,
    .story-tool-btn.active {
        background: var(--color-primary);
        color: white;
    }

    .text-align-group .story-tool-btn:hover {
        background: rgba(102, 126, 234, 0.1);
        color: var(--color-primary);
    }

    .story-tool-btn {
        display: flex;
        align-items: center;
        justify-content: center;
        width: 44px;
        height: 44px;
        border-radius: 12px;
        background: var(--color-bg);
        border: 2px solid var(--color-border);
        cursor: pointer;
        transition: all 0.2s ease;
        position: relative;
    }

    .story-tool-btn:hover {
        background: var(--color-primary);
        border-color: var(--color-primary);
        color: white;
    }

    .story-tool-btn i {
        width: 20px;
        height: 20px;
    }

    .story-tool-btn.story-tool-danger:hover {
        background: #ef4444;
        border-color: #ef4444;
    }

    .story-tool-btn.color-tool {
        overflow: hidden;
    }

    .story-tool-btn.color-tool input[type="color"] {
        position: absolute;
        width: 100%;
        height: 100%;
        opacity: 0;
        cursor: pointer;
    }

    .color-indicator {
        position: absolute;
        bottom: 4px;
        right: 4px;
        width: 12px;
        height: 12px;
        border-radius: 50%;
        border: 2px solid white;
        box-shadow: 0 1px 3px rgba(0, 0, 0, 0.2);
    }

    /* Legacy styles - kept for compatibility */
    .story-type-selector {
        display: flex;
        gap: 1rem;
        margin-bottom: 2rem;
    }

    .story-type-btn {
        flex: 1;
        padding: 1rem;
        border: 2px solid var(--color-border);
        background: var(--color-surface);
        border-radius: 0.75rem;
        cursor: pointer;
        transition: all 0.3s ease;
        font-weight: 600;
    }

    .story-type-btn.active,
    .story-type-btn:hover {
        border-color: var(--color-primary);
        background: rgba(102, 126, 234, 0.05);
    }

    .story-content-section textarea {
        width: 100%;
        height: 120px;
        border: 2px solid var(--color-border);
        border-radius: 0.75rem;
        padding: 1rem;
        font-size: 1rem;
        font-family: inherit;
        resize: none;
        margin-bottom: 1rem;
    }

    .story-content-section textarea:focus {
        border-color: var(--color-primary);
        outline: none;
    }

    .color-picker {
        display: flex;
        align-items: center;
        gap: 1rem;
        margin-top: 1rem;
    }

    .color-picker label {
        font-weight: 600;
        color: var(--color-text);
    }

    .color-picker input[type="color"] {
        width: 50px;
        height: 40px;
        border: 2px solid var(--color-border);
        border-radius: 0.5rem;
        cursor: pointer;
    }

    /* Image Modal */
    .image-modal {
        background: rgba(0, 0, 0, 0.9);
    }

    .image-modal-content {
        position: relative;
        max-width: 90vw;
        max-height: 90vh;
        background: none;
        border-radius: 0;
        box-shadow: none;
    }

    .image-modal-content img {
        width: 100%;
        height: auto;
        max-height: 90vh;
        object-fit: contain;
    }

    .image-modal .modal-close {
        position: absolute;
        top: 1rem;
        right: 1rem;
        background: rgba(0, 0, 0, 0.7);
        color: white;
        z-index: 1001;
    }

    /* Story Modal Overlay Styles */
    .story-modal-overlay {
        position: fixed;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
        background: rgba(0, 0, 0, 0.8);
        display: flex;
        align-items: center;
        justify-content: center;
        z-index: 10001;
        padding: 1rem;
        backdrop-filter: blur(4px);
    }

    .story-viewers-modal,
    .story-replies-modal,
    .story-inbox-modal {
        background: var(--color-surface);
        border-radius: 16px;
        width: 100%;
        max-width: 400px;
        max-height: 80vh;
        overflow: hidden;
        box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
        animation: modalSlideUp 0.3s ease;
    }

    .story-inbox-modal {
        max-width: 500px;
    }

    @keyframes modalSlideUp {
        from {
            opacity: 0;
            transform: translateY(20px) scale(0.95);
        }

        to {
            opacity: 1;
            transform: translateY(0) scale(1);
        }
    }

    .story-modal-header {
        display: flex;
        align-items: center;
        justify-content: space-between;
        padding: 1rem 1.25rem;
        border-bottom: 1px solid var(--color-border);
    }

    .story-modal-title {
        font-size: 1.1rem;
        font-weight: 700;
        color: var(--color-text);
        display: flex;
        align-items: center;
        gap: 0.5rem;
        margin: 0;
    }

    .story-modal-title svg {
        width: 20px;
        height: 20px;
        color: var(--color-primary);
    }

    .story-modal-close {
        background: none;
        border: none;
        font-size: 1.5rem;
        color: var(--color-text-muted);
        cursor: pointer;
        padding: 0.25rem;
        line-height: 1;
        transition: color 0.2s ease;
    }

    .story-modal-close:hover {
        color: var(--color-text);
    }

    .story-modal-content {
        padding: 0.5rem;
        max-height: calc(80vh - 60px);
        overflow-y: auto;
    }

    .story-modal-empty {
        text-align: center;
        padding: 3rem 1rem;
        color: var(--color-text-muted);
    }

    .story-modal-empty svg {
        width: 48px;
        height: 48px;
        margin-bottom: 1rem;
        opacity: 0.5;
    }

    .story-modal-empty p {
        font-size: 1rem;
        margin-bottom: 0.5rem;
    }

    .story-modal-empty small {
        font-size: 0.85rem;
        opacity: 0.7;
    }

    /* Viewer item styles */
    .story-viewer-item {
        display: flex;
        align-items: center;
        gap: 0.75rem;
        padding: 0.75rem 1rem;
        border-radius: 12px;
        transition: background 0.2s ease;
    }

    .story-viewer-item:hover {
        background: var(--color-background);
    }

    .story-viewer-avatar {
        width: 44px;
        height: 44px;
        border-radius: 50%;
        object-fit: cover;
    }

    .story-viewer-info {
        flex: 1;
    }

    .story-viewer-name {
        font-weight: 600;
        color: var(--color-text);
    }

    .story-viewer-time {
        font-size: 0.8rem;
        color: var(--color-text-muted);
    }

    /* Reply item styles */
    .story-reply-item {
        display: flex;
        align-items: flex-start;
        gap: 0.75rem;
        padding: 0.75rem 1rem;
        border-radius: 12px;
        transition: background 0.2s ease;
    }

    .story-reply-item:hover {
        background: var(--color-background);
    }

    .story-reply-avatar {
        width: 40px;
        height: 40px;
        border-radius: 50%;
        object-fit: cover;
        flex-shrink: 0;
    }

    .story-reply-info {
        flex: 1;
        min-width: 0;
    }

    .story-reply-username {
        font-weight: 600;
        color: var(--color-text);
        margin-bottom: 0.25rem;
    }

    .story-reply-time {
        font-size: 0.75rem;
        color: var(--color-text-muted);
        margin-left: 0.5rem;
    }

    .story-reply-content {
        color: var(--color-text);
        font-size: 0.9rem;
        line-height: 1.4;
        word-break: break-word;
    }

    .story-reply-actions {
        margin-top: 0.5rem;
    }

    .story-reply-actions button {
        background: none;
        border: none;
        color: var(--color-text-muted);
        cursor: pointer;
        padding: 0.25rem;
        border-radius: 4px;
        transition: all 0.2s ease;
    }

    .story-reply-actions button:hover {
        color: #ef4444;
        background: rgba(239, 68, 68, 0.1);
    }

    .story-reply-actions svg {
        width: 14px;
        height: 14px;
    }

    /* Story Inbox Styles */
    .story-inbox-content {
        padding: 0;
    }

    .story-inbox-group {
        border-bottom: 1px solid var(--color-border);
    }

    .story-inbox-group:last-child {
        border-bottom: none;
    }

    .story-inbox-story-header {
        display: flex;
        align-items: center;
        gap: 0.75rem;
        padding: 1rem;
        cursor: pointer;
        transition: background 0.2s ease;
    }

    .story-inbox-story-header:hover {
        background: var(--color-background);
    }

    .story-inbox-preview {
        width: 48px;
        height: 48px;
        border-radius: 8px;
        overflow: hidden;
        flex-shrink: 0;
        border: 2px solid var(--color-border);
    }

    .story-inbox-preview img {
        width: 100%;
        height: 100%;
        object-fit: cover;
    }

    .story-inbox-preview .text-preview {
        width: 100%;
        height: 100%;
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 0.6rem;
        text-align: center;
        padding: 4px;
        overflow: hidden;
    }

    .story-inbox-story-info {
        flex: 1;
        min-width: 0;
    }

    .story-inbox-story-time {
        font-size: 0.8rem;
        color: var(--color-text-muted);
    }

    .story-inbox-reply-count {
        font-weight: 600;
        color: var(--color-text);
    }

    .story-inbox-story-header>svg {
        width: 20px;
        height: 20px;
        color: var(--color-text-muted);
    }

    .story-inbox-replies {
        padding: 0 0.5rem 0.5rem;
    }

    .story-inbox-reply {
        display: flex;
        align-items: flex-start;
        gap: 0.75rem;
        padding: 0.75rem;
        border-radius: 12px;
        margin-bottom: 0.25rem;
        transition: background 0.2s ease;
    }

    .story-inbox-reply:hover {
        background: var(--color-background);
    }

    .story-inbox-reply.unread {
        background: rgba(102, 126, 234, 0.08);
        border-left: 3px solid var(--color-primary);
    }

    .story-inbox-reply-avatar {
        width: 36px;
        height: 36px;
        border-radius: 50%;
        object-fit: cover;
        flex-shrink: 0;
    }

    .story-inbox-reply-content {
        flex: 1;
        min-width: 0;
    }

    .story-inbox-reply-header {
        display: flex;
        align-items: center;
        gap: 0.5rem;
        margin-bottom: 0.25rem;
    }

    .story-inbox-reply-username {
        font-weight: 600;
        font-size: 0.85rem;
        color: var(--color-text);
    }

    .story-inbox-reply-time {
        font-size: 0.75rem;
        color: var(--color-text-muted);
    }

    .story-inbox-reply-text {
        font-size: 0.9rem;
        color: var(--color-text);
        line-height: 1.4;
        word-break: break-word;
    }

    .story-inbox-reply-delete {
        background: none;
        border: none;
        color: var(--color-text-muted);
        cursor: pointer;
        padding: 0.25rem;
        border-radius: 4px;
        opacity: 0;
        transition: all 0.2s ease;
    }

    .story-inbox-reply:hover .story-inbox-reply-delete {
        opacity: 1;
    }

    .story-inbox-reply-delete:hover {
        color: #ef4444;
        background: rgba(239, 68, 68, 0.1);
    }

    .story-inbox-reply-delete svg {
        width: 14px;
        height: 14px;
    }

    /* Form elements */
    .form-group {
        margin-bottom: 1.5rem;
    }

    .form-label {
        display: block;
        margin-bottom: 0.5rem;
        font-weight: 600;
        color: var(--color-text);
    }

    .form-control {
        width: 100%;
        padding: 0.75rem;
        border: 2px solid var(--color-border);
        border-radius: 0.5rem;
        font-size: 1rem;
        transition: all 0.3s ease;
    }

    .form-control:focus {
        border-color: var(--color-primary);
        outline: none;
        box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
    }

    .checkbox-label {
        display: flex;
        align-items: center;
        gap: 0.75rem;
        cursor: pointer;
        font-weight: 500;
        color: var(--color-text);
    }

    .checkbox-label input[type="checkbox"] {
        width: 20px;
        height: 20px;
        accent-color: var(--color-primary);
    }

    .invite-link-container {
        display: flex;
        gap: 0.5rem;
        align-items: center;
    }

    .invite-link-container input {
        flex: 1;
    }

    .tool-btn {
        background: none;
        border: none;
        cursor: pointer;
    }

    /* RESPONSIVE DESIGN - ALL YOUR STYLES PRESERVED */
    .desktop-only {
        display: flex;
    }

    .mobile-only {
        display: none;
    }

    @media (max-width: 768px) {
        .desktop-only {
            display: none;
        }

        .mobile-only {
            display: flex;
        }

        .mobile-header.mobile-only {
            display: flex;
        }

        html,
        body {
            height: 100%;
            overflow-x: hidden;
        }

        .main-container {
            flex-direction: column;
            min-height: 100vh;
            padding-bottom: 80px;
            /* Space for bottom navbar */
        }

        .main-content-area {
            width: 100%;
            padding-top: 0;
            padding-bottom: 100px;
            /* Extra padding so content can scroll past navbar */
            overflow-y: auto;
            -webkit-overflow-scrolling: touch;
        }

        .social-feed {
            padding-bottom: 20px;
        }

        .stories-container {
            padding: 0 0.5rem;
            gap: 1rem;
        }

        .compose-tweet-section {
            margin: 0.5rem;
        }

        .tweets-feed {
            padding: 0.5rem;
            padding-bottom: 100px;
            /* Space for bottom navbar */
        }

        .tweet-item {
            padding: 1rem;
        }

        .tweet-item:last-child {
            margin-bottom: 100px;
            /* Extra space for last tweet to scroll past navbar */
        }

        .tweet-image {
            max-height: 400px;
            border-radius: 0.5rem;
        }

        .tweet-image img {
            max-height: 400px;
        }

        .image-preview {
            max-height: 300px;
            border-radius: 0.5rem;
        }

        .image-preview img {
            max-height: 300px;
        }

        .modal-content {
            width: 95%;
            margin: 1rem;
        }

        .modal-footer {
            flex-direction: column;
            gap: 0.75rem;
        }

        .modal-footer .btn {
            width: 100%;
        }

        .compose-actions {
            flex-direction: column;
            gap: 1rem;
            align-items: stretch;
        }

        .compose-submit {
            justify-content: space-between;
        }

        .tweet-actions {
            justify-content: space-between;
            padding: 0.75rem 0;
        }

        .action-btn {
            padding: 0.5rem;
            font-size: 0.8rem;
        }

        .request-actions {
            flex-direction: column;
            gap: 0.5rem;
        }

        .join-request-item {
            flex-direction: column;
            align-items: stretch;
            gap: 1rem;
        }

        .search-results {
            max-height: 300px;
        }

        .user-actions-search {
            flex-direction: column;
            gap: 0.25rem;
        }

        .btn-search {
            padding: 0.4rem 0.8rem;
            font-size: 0.75rem;
        }

        .story-ring {
            width: 60px;
            height: 60px;
        }
    }

    /* ANIMATIONS - ALL YOUR STYLES PRESERVED */
    .tweet-item,
    .story-item,
    .sidebar-chat-item,
    .sidebar-user-item,
    .mobile-chat-item,
    .search-result-item {
        animation: fadeInUp 0.3s ease;
    }

    @keyframes fadeInUp {
        from {
            opacity: 0;
            transform: translateY(20px);
        }

        to {
            opacity: 1;
            transform: translateY(0);
        }
    }

    /* SCROLLBAR STYLING - ALL YOUR STYLES PRESERVED */
    ::-webkit-scrollbar {
        width: 6px;
    }

    ::-webkit-scrollbar-track {
        background: var(--color-background);
    }

    ::-webkit-scrollbar-thumb {
        background: var(--color-border);
        border-radius: 3px;
    }

    ::-webkit-scrollbar-thumb:hover {
        background: var(--color-text-secondary);
    }

    /* Additional Mobile Styles for Stories */
    @media (max-width: 480px) {
        .story-ring {
            width: 56px;
            height: 56px;
        }

        .story-avatar {
            width: calc(100% - 4px);
            height: calc(100% - 4px);
            border: 2px solid var(--color-surface);
        }

        .story-username {
            font-size: 0.7rem;
            max-width: 60px;
        }

        .story-item {
            min-width: 64px;
            padding: 0.25rem;
        }

        .stories-container {
            gap: 0.5rem;
            padding: 0.5rem 0.25rem;
        }

        .add-story-plus svg {
            width: 22px;
            height: 22px;
        }
    }

    /* Gesture support indicators for touch devices */
    @media (pointer: coarse) {
        .story-nav-arrow {
            opacity: 0.5;
        }

        .story-view-wrapper:hover .story-nav-arrow {
            opacity: 0.7;
        }
    }

    /* Landscape mode adjustments */
    @media (max-height: 500px) and (orientation: landscape) {
        .story-view-wrapper {
            max-width: 300px;
        }

        .story-view-header {
            padding: 4px 12px;
        }

        .story-view-footer {
            padding: 12px 12px;
            padding-bottom: calc(20px + env(safe-area-inset-bottom, 16px));
        }

        .story-progress-container {
            padding: 8px 12px 4px;
        }
    }
</style>
<script>
    /* ENHANCED JAVASCRIPT - MULTIPLE STORIES + VIEWED STORIES + IMAGE FIXES */

    let createdGroupId = null;
    let selectedStoryType = 'text';
    let currentImageFile = null;
    let activeMobileModal = null;
    let isPosting = false;

    // NEW: Multiple stories support + viewed stories tracking
    let currentStoriesData = [];
    let currentStoryIndex = 0;
    let currentUsername = null;
    let viewedStories = JSON.parse(localStorage.getItem('viewedStories') || '{}');

    // Initialize user data safely
    let allUsers = [];
    {% if other_users %}
    allUsers = [
        {% for user in other_users %}
    {
        username: "{{ user.username }}",
            fullname: "{{ user.full_name|escapejs }}",
                profile_picture_url: "{{ user.profile_picture_url|escapejs }}",
                    initials: "{{ user.name.0 }}{{ user.lastname.0 }}"
    } {% if not forloop.last %}, {% endif %}
    {% endfor %}
];
    {% endif %}

    // Search logic (no AJAX, uses existing user list)
    const input = document.getElementById('userSearchInput');
    const allUserItems = document.querySelectorAll('.sidebar-user-item');

    if (input) {
        input.addEventListener('keyup', function () {
            const q = this.value.toLowerCase().trim();
            let found = 0;

            allUserItems.forEach(item => {
                const text = item.textContent.toLowerCase();
                const show = q && text.includes(q);
                item.style.display = show ? 'flex' : 'none';
                if (show) found++;
            });

            // Optional: show "No users found" if none match
            const container = document.querySelector('.sidebar-users-list');
            if (container) {
                let msg = container.querySelector('.no-results-msg');
                if (!msg) {
                    msg = document.createElement('p');
                    msg.className = 'no-results-msg';
                    msg.style.display = 'none';
                    msg.style.textAlign = 'center';
                    msg.style.color = '#888';
                    msg.style.marginTop = '10px';
                    container.appendChild(msg);
                }
                msg.textContent = found === 0 && q ? 'No users found.' : '';
                msg.style.display = (found === 0 && q) ? 'block' : 'none';
            }
        });
    }

    // Get CSRF token
    function getCSRFToken() {
        const cookies = document.cookie.split(';');
        for (let cookie of cookies) {
            const [name, value] = cookie.trim().split('=');
            if (name === 'csrftoken') return value;
        }
        return '';
    }
    // ENHANCED: View user stories with multiple story support + viewed tracking
    async function viewUserStories(username = null) {
        try {
            const targetUsername = username || '{{ current_user.username }}';
            currentUsername = targetUsername;

            console.log('Loading stories for user:', targetUsername);

            // Fetch all stories for the user
            const response = await fetch(`/api/user-stories/${targetUsername}/`);
            console.log('API response status:', response.status);

            if (!response.ok) {
                throw new Error(`HTTP error! status: ${response.status}`);
            }

            const data = await response.json();
            console.log('Stories API response:', data);

            if (data.success && data.stories && data.stories.length > 0) {
                currentStoriesData = data.stories;
                currentStoryIndex = 0;
                showStoryModal();
                displayCurrentStory();

                // Mark stories as viewed after 1 second
                setTimeout(() => {
                    markUserStoriesAsViewed(targetUsername);
                }, 1000);
            } else {
                console.log('No stories available or API returned error:', data);
                showNotification('No stories available', 'info');
            }
        } catch (error) {
            console.error('Error fetching stories:', error);
            showNotification('Failed to load stories', 'error');
            // Still try to show modal if we have any data
            if (currentStoriesData && currentStoriesData.length > 0) {
                showStoryModal();
                displayCurrentStory();
            }
        }
    }

    // NEW: Mark all stories from a user as viewed
    function markUserStoriesAsViewed(username) {
        if (!viewedStories[username]) {
            viewedStories[username] = [];
        }

        // Mark all current stories as viewed
        currentStoriesData.forEach(story => {
            if (!viewedStories[username].includes(story.id)) {
                viewedStories[username].push(story.id);
            }
        });

        // Save to localStorage
        localStorage.setItem('viewedStories', JSON.stringify(viewedStories));

        // Update UI to show viewed state
        updateStoryRingsAfterViewing(username);

        console.log(`Marked ${currentStoriesData.length} stories as viewed for user: ${username}`);
    }

    // NEW: Update story rings to show viewed state
    function updateStoryRingsAfterViewing(username) {
        // Find and update the story ring for this user
        const storyItems = document.querySelectorAll('.story-item');
        storyItems.forEach(item => {
            const onclick = item.getAttribute('onclick');
            if (onclick && onclick.includes(username)) {
                const ring = item.querySelector('.story-ring');
                const storyItem = item;

                if (ring && !ring.classList.contains('own-story-ring') && !ring.classList.contains('add-ring')) {
                    ring.classList.add('viewed');
                    storyItem.classList.add('viewed');
                }
            }
        });
    }

    // NEW: Check if user's stories are viewed on page load
    function checkViewedStories() {
        const storyItems = document.querySelectorAll('.story-item');

        storyItems.forEach(item => {
            const onclick = item.getAttribute('onclick');
            if (onclick) {
                // Extract username from onclick attribute
                const match = onclick.match(/viewUserStories\('([^']+)'\)/);
                if (match) {
                    const username = match[1];
                    const userViewedStories = viewedStories[username];

                    if (userViewedStories && userViewedStories.length > 0) {
                        const ring = item.querySelector('.story-ring');
                        if (ring && !ring.classList.contains('own-story-ring') && !ring.classList.contains('add-ring')) {
                            ring.classList.add('viewed');
                            item.classList.add('viewed');
                        }
                    }
                }
            }
        });

        console.log('Checked viewed stories on page load');
    }

    // ENHANCED: Display current story with better image handling
    function displayCurrentStory() {
        if (!currentStoriesData || currentStoriesData.length === 0) return;

        const story = currentStoriesData[currentStoryIndex];

        // Update user info
        document.getElementById('storyUserAvatar').src = story.user.profile_picture_url;
        document.getElementById('storyUserName').textContent = story.user.full_name;
        document.getElementById('storyTime').textContent = story.created_at;

        // Update content display
        const contentDisplay = document.getElementById('storyContentDisplay');
        const textPosition = story.text_position || 'center';

        if (story.story_type === 'text') {
            contentDisplay.className = 'story-content-display text-story';
            contentDisplay.style.backgroundColor = story.background_color;
            contentDisplay.innerHTML = `<div class="story-text-content position-${textPosition}" style="color: ${story.text_color};">${story.content}</div>`;
        } else if (story.story_type === 'image') {
            contentDisplay.className = 'story-content-display';
            contentDisplay.style.backgroundColor = '#000';
            // If there's content (caption), show it over the image
            if (story.content) {
                contentDisplay.innerHTML = `
                <img src="${story.media_url}" alt="Story image" style="max-width: 100%; max-height: 100%; object-fit: contain;">
                <div class="story-text-overlay position-${textPosition}" style="color: ${story.text_color};">${story.content}</div>
            `;
            } else {
                contentDisplay.innerHTML = `<img src="${story.media_url}" alt="Story image" style="max-width: 100%; max-height: 100%; object-fit: contain;">`;
            }
        } else if (story.story_type === 'video') {
            contentDisplay.className = 'story-content-display';
            contentDisplay.style.backgroundColor = '#000';
            if (story.content) {
                contentDisplay.innerHTML = `
                <video src="${story.media_url}" autoplay loop playsinline style="max-width: 100%; max-height: 100%; object-fit: contain;"></video>
                <div class="story-text-overlay position-${textPosition}" style="color: ${story.text_color};">${story.content}</div>
            `;
            } else {
                contentDisplay.innerHTML = `<video src="${story.media_url}" autoplay loop playsinline style="max-width: 100%; max-height: 100%; object-fit: contain;"></video>`;
            }
        }

        // Initialize story interactions
        initializeStoryInteractions(story);

        // Update progress bars
        updateStoryProgressBars();

        // Update like button state
        const likeBtn = document.getElementById('storyLikeBtn');
        if (likeBtn) {
            if (story.is_liked) {
                likeBtn.classList.add('liked');
            } else {
                likeBtn.classList.remove('liked');
            }
        }

        // Update stats for own stories
        const statsBar = document.getElementById('storyStatsBar');
        const metaTag = document.querySelector('meta[name="user-id"]');
        const currentUserId = metaTag ? parseInt(metaTag.getAttribute('content')) : null;
        const isOwner = story.user && story.user.id === currentUserId;

        if (statsBar) {
            if (isOwner) {
                statsBar.style.display = 'flex';
                const viewCount = document.getElementById('viewCount');
                const likeCount = document.getElementById('likeCount');
                const replyCount = document.getElementById('replyCount');
                if (viewCount) viewCount.textContent = story.view_count || 0;
                if (likeCount) likeCount.textContent = story.like_count || 0;
                if (replyCount) replyCount.textContent = story.reply_count || 0;
            } else {
                statsBar.style.display = 'none';
            }
        }

        // Show/hide navigation buttons
        const prevBtn = document.querySelector('.story-nav-prev');
        const nextBtn = document.querySelector('.story-nav-next');

        if (prevBtn) prevBtn.style.visibility = currentStoryIndex > 0 ? 'visible' : 'hidden';
        if (nextBtn) nextBtn.style.visibility = currentStoryIndex < currentStoriesData.length - 1 ? 'visible' : 'hidden';

        // Start auto-advance timer
        startStoryTimer();

        // Refresh Lucide icons
        if (window.lucide && window.lucide.createIcons) {
            window.lucide.createIcons();
        }
    }

    // Story auto-advance timer
    let storyTimerInterval = null;
    const STORY_DURATION = 5000; // 5 seconds per story

    function startStoryTimer() {
        // Clear any existing timer
        if (storyTimerInterval) {
            clearInterval(storyTimerInterval);
        }

        // Start new timer
        storyTimerInterval = setTimeout(() => {
            if (currentStoryIndex < currentStoriesData.length - 1) {
                navigateStory(1);
            } else {
                // Auto close when all stories are viewed
                closeStoryModal();
            }
        }, STORY_DURATION);
    }

    function stopStoryTimer() {
        if (storyTimerInterval) {
            clearTimeout(storyTimerInterval);
            storyTimerInterval = null;
        }
    }

    // Update progress bars
    function updateStoryProgressBars() {
        const container = document.getElementById('storyProgressContainer');
        if (!container) return;

        container.innerHTML = '';

        for (let i = 0; i < currentStoriesData.length; i++) {
            const bar = document.createElement('div');
            bar.className = 'story-progress-bar';

            const fill = document.createElement('div');
            fill.className = 'story-progress-fill';

            if (i < currentStoryIndex) {
                bar.classList.add('completed');
            } else if (i === currentStoryIndex) {
                bar.classList.add('active');
            }

            bar.appendChild(fill);
            container.appendChild(bar);
        }
    }

    // Initialize story interactions (like, reply, viewers, etc.)
    function initializeStoryInteractions(story) {
        try {
            // Update like button state
            const likeBtn = document.getElementById('storyLikeBtn');
            if (likeBtn) {
                const likeIcon = likeBtn.querySelector('[data-lucide]');
                if (story.is_liked) {
                    likeBtn.classList.add('liked');
                    if (likeIcon) likeIcon.setAttribute('data-lucide', 'heart');
                } else {
                    likeBtn.classList.remove('liked');
                    if (likeIcon) likeIcon.setAttribute('data-lucide', 'heart');
                }
            }

            // Setup reply input enter key handler
            const replyInput = document.getElementById('storyReplyInput');
            if (replyInput) {
                replyInput.onkeypress = function (e) {
                    if (e.key === 'Enter') {
                        sendStoryReply();
                    }
                };
            }

            // Show/hide stats bar for owner
            const metaTag = document.querySelector('meta[name="user-id"]');
            if (!metaTag) {
                console.warn('User ID meta tag not found');
                return;
            }

            const currentUserId = parseInt(metaTag.getAttribute('content'));
            if (isNaN(currentUserId)) {
                console.warn('Invalid user ID');
                return;
            }

            const isOwner = story.user && typeof story.user.id !== 'undefined' && story.user.id === currentUserId;
            const statsBar = document.getElementById('storyStatsBar');

            if (statsBar) {
                if (isOwner) {
                    statsBar.style.display = 'flex';
                } else {
                    statsBar.style.display = 'none';
                }
            }

            // Refresh Lucide icons
            if (window.lucide && window.lucide.createIcons) {
                window.lucide.createIcons();
            }
        } catch (error) {
            console.error('Error initializing story interactions:', error);
        }
    }

    // ENHANCED: Update story indicators (now uses progress bars)
    function updateStoryIndicators() {
        // This function is replaced by updateStoryProgressBars()
        updateStoryProgressBars();
    }

    // ENHANCED: Navigate between stories
    function navigateStory(direction) {
        const newIndex = currentStoryIndex + direction;

        if (newIndex >= 0 && newIndex < currentStoriesData.length) {
            currentStoryIndex = newIndex;
            displayCurrentStory();

            // Mark story as viewed
            if (currentStoriesData[currentStoryIndex]) {
                markStoryAsViewed(currentStoriesData[currentStoryIndex].id);
            }
        }
    }

    // ENHANCED: Mark story as viewed
    async function markStoryAsViewed(storyId) {
        try {
            await fetch(`/api/story/${storyId}/`, {
                method: 'POST',
                headers: {
                    'X-CSRFToken': getCSRFToken(),
                }
            });
        } catch (error) {
            console.error('Error marking story as viewed:', error);
        }
    }

    // ENHANCED: Show story modal
    function showStoryModal() {
        document.getElementById('storyViewModal').style.display = 'flex';
        document.body.classList.add('story-modal-open');
    }

    // ENHANCED: Enhanced image handling for tweets
    function handleTweetImage(img) {
        img.onload = function () {
            const aspectRatio = this.naturalWidth / this.naturalHeight;
            const container = this.parentElement;

            // Remove existing classes
            container.classList.remove('tall-image', 'wide-image');

            // Add appropriate class based on aspect ratio
            if (aspectRatio < 0.75) {
                // Very tall image (height > 1.33 * width)
                container.classList.add('tall-image');
            } else if (aspectRatio > 2) {
                // Very wide image (width > 2 * height)
                container.classList.add('wide-image');
            }

            console.log(`Image loaded: ${this.naturalWidth}x${this.naturalHeight}, aspect ratio: ${aspectRatio.toFixed(2)}`);
        };
    }

    // ENHANCED: Enhanced preview image handling
    function handlePreviewImage(img) {
        img.onload = function () {
            const aspectRatio = this.naturalWidth / this.naturalHeight;
            const container = this.parentElement;

            console.log(`Preview loaded: ${this.naturalWidth}x${this.naturalHeight}, aspect ratio: ${aspectRatio.toFixed(2)}`);

            // Ensure container has proper height constraint
            if (aspectRatio < 0.75) {
                container.style.maxHeight = '300px';
                container.style.display = 'flex';
                container.style.alignItems = 'center';
                container.style.justifyContent = 'center';
            } else {
                container.style.maxHeight = '400px';
                container.style.display = 'block';
            }
        };
    }

    // NEW: Initialize image handling for existing tweet images
    function initializeTweetImages() {
        const tweetImages = document.querySelectorAll('.tweet-image img');
        tweetImages.forEach(img => {
            handleTweetImage(img);
        });
        console.log(`Initialized enhanced image handling for ${tweetImages.length} tweet images`);
    }

    // ALL YOUR ORIGINAL STORY FUNCTIONS - PRESERVED FOR BACKWARD COMPATIBILITY
    function viewStory(storyId) {
        fetch(`/api/story/${storyId}/`)
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    const story = data.story;
                    const textPosition = story.text_position || 'center';
                    document.getElementById('storyUserAvatar').src = story.user.profile_picture_url;
                    document.getElementById('storyUserName').textContent = story.user.full_name;
                    document.getElementById('storyTime').textContent = story.created_at;
                    document.getElementById('storyViewCount').textContent = `${story.view_count} views`;

                    const contentDisplay = document.getElementById('storyContentDisplay');
                    if (story.story_type === 'text') {
                        contentDisplay.className = 'story-content-display text-story';
                        contentDisplay.style.backgroundColor = story.background_color;
                        contentDisplay.innerHTML = `<div class="story-text-content position-${textPosition}" style="color: ${story.text_color};">${story.content}</div>`;
                    } else if (story.story_type === 'image') {
                        contentDisplay.className = 'story-content-display';
                        contentDisplay.style.backgroundColor = '#000';
                        if (story.content) {
                            contentDisplay.innerHTML = `
                        <img src="${story.media_url}" alt="Story image">
                        <div class="story-text-overlay position-${textPosition}" style="color: ${story.text_color};">${story.content}</div>
                    `;
                        } else {
                            contentDisplay.innerHTML = `<img src="${story.media_url}" alt="Story image">`;
                        }
                    }

                    document.getElementById('storyViewModal').style.display = 'flex';
                    document.body.classList.add('story-modal-open');
                } else {
                    showNotification(`Failed to load story: ${data.error}`, 'error');
                }
            })
            .catch(error => {
                console.error('Error:', error);
                showNotification('Network error. Please try again.', 'error');
            });
    }

    function createStory() {
        const formData = new FormData();
        const content = document.getElementById('storyText').value.trim();
        const bgColor = document.getElementById('bgColor').value;
        const textColor = document.getElementById('textColor').value;
        const textPosition = document.getElementById('textPosition').value;
        const imageFile = document.getElementById('storyImageInput').files[0];

        // Determine story type based on content
        let storyType = 'text';
        if (imageFile && content) {
            storyType = 'image'; // Image with text caption
        } else if (imageFile) {
            storyType = 'image';
        } else if (content) {
            storyType = 'text';
        } else {
            showNotification('Please add text or an image', 'error');
            return;
        }

        formData.append('story_type', storyType);
        formData.append('content', content);
        formData.append('background_color', bgColor);
        formData.append('text_color', textColor);
        formData.append('text_position', textPosition);

        if (imageFile) {
            formData.append('media', imageFile);
        }

        // Disable button while posting
        const postBtn = document.getElementById('postStoryBtn');
        if (postBtn) {
            postBtn.disabled = true;
            postBtn.innerHTML = '<i data-lucide="loader" class="spin"></i> Posting...';
            lucide.createIcons();
        }

        fetch('/api/create-story/', {
            method: 'POST',
            headers: {
                'X-CSRFToken': getCSRFToken(),
            },
            body: formData
        })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    closeCreateStoryModal();
                    showNotification('Story created successfully!', 'success');
                    setTimeout(() => location.reload(), 1000);
                } else {
                    showNotification(`Failed to create story: ${data.error}`, 'error');
                    if (postBtn) {
                        postBtn.disabled = false;
                        postBtn.innerHTML = '<i data-lucide="send"></i> Post Story';
                        lucide.createIcons();
                    }
                }
            })
            .catch(error => {
                console.error('Error:', error);
                showNotification('Network error. Please try again.', 'error');
                if (postBtn) {
                    postBtn.disabled = false;
                    postBtn.innerHTML = '<i data-lucide="send"></i> Post Story';
                    lucide.createIcons();
                }
            });
    }

    // Set text position for story
    function setTextPosition(position) {
        document.getElementById('textPosition').value = position;

        // Update button states
        document.querySelectorAll('.position-btn').forEach(btn => {
            btn.classList.remove('active');
        });
        document.querySelector(`.position-btn[data-position="${position}"]`).classList.add('active');

        // Update preview
        updateStoryPreview();
    }

    function openStoryModal() {
        document.getElementById('storyModal').style.display = 'flex';
        initStoryModalListeners();
        initImagePanning();
        // Reset text position to center
        setTextPosition('center');
        setTextAlign('center');
        // Reset image transform
        resetImageTransform();
        // Reset text styling
        document.getElementById('textFontSize').value = 20;
        document.getElementById('textBold').value = 'false';
        document.getElementById('textShadow').value = 'true';
        document.getElementById('boldBtn')?.classList.remove('active');
        document.getElementById('shadowBtn')?.classList.add('active');
        updateStoryPreview();
        lucide.createIcons();
    }

    function closeCreateStoryModal() {
        document.getElementById('storyModal').style.display = 'none';
        // Reset form
        document.getElementById('storyText').value = '';
        document.getElementById('storyImageInput').value = '';
        document.getElementById('bgColor').value = '#667eea';
        document.getElementById('textColor').value = '#ffffff';
        document.getElementById('textPosition').value = 'center';
        document.getElementById('textAlign').value = 'center';
        document.getElementById('textFontSize').value = 20;
        document.getElementById('textBold').value = 'false';
        document.getElementById('textShadow').value = 'true';
        document.getElementById('removeImageBtn').style.display = 'none';
        document.getElementById('imageControls').style.display = 'none';
        // Reset buttons
        document.querySelectorAll('.position-btn').forEach(btn => btn.classList.remove('active'));
        document.querySelector('.position-btn[data-position="center"]')?.classList.add('active');
        document.querySelectorAll('.align-btn').forEach(btn => btn.classList.remove('active'));
        document.querySelector('.align-btn[data-align="center"]')?.classList.add('active');
        document.getElementById('boldBtn')?.classList.remove('active');
        document.getElementById('shadowBtn')?.classList.add('active');
        // Reset image transform
        resetImageTransform();
        updateStoryPreview();
    }

    function closeStoryModal() {
        document.getElementById('storyModal').style.display = 'none';
        document.getElementById('storyViewModal').style.display = 'none';
        document.body.classList.remove('story-modal-open');
        document.getElementById('storyText').value = '';
        document.getElementById('storyImageInput').value = '';
        // Reset preview
        const previewImg = document.getElementById('storyPreviewImg');
        if (previewImg) previewImg.src = '';
        document.getElementById('removeImageBtn').style.display = 'none';
        // Stop the timer
        stopStoryTimer();
        // Reset multiple story variables
        currentStoriesData = [];
        currentStoryIndex = 0;
    }

    // Initialize story modal event listeners
    function initStoryModalListeners() {
        const storyText = document.getElementById('storyText');
        const bgColor = document.getElementById('bgColor');
        const textColor = document.getElementById('textColor');
        const imageInput = document.getElementById('storyImageInput');
        const preview = document.getElementById('storyPreview');
        const previewTextEditable = document.getElementById('storyPreviewText');

        // Text input listener
        storyText.addEventListener('input', function () {
            document.getElementById('storyCharCount').textContent = this.value.length;
            if (document.activeElement !== previewTextEditable) {
                previewTextEditable.innerText = this.value;
            }
            updateStoryPreview();
        });

        // Inline editable preview -> textarea sync
        previewTextEditable.addEventListener('input', function () {
            storyText.value = this.innerText;
            document.getElementById('storyCharCount').textContent = storyText.value.length;
            updateStoryPreview();
        });

        // Color change listeners
        bgColor.addEventListener('input', function () {
            document.getElementById('bgColorIndicator').style.background = this.value;
            updateStoryPreview();
        });

        textColor.addEventListener('input', function () {
            document.getElementById('textColorIndicator').style.background = this.value;
            updateStoryPreview();
        });

        // Image input listener
        if (imageInput && !imageInput.dataset.listenerAdded) {
            imageInput.dataset.listenerAdded = 'true';
            imageInput.addEventListener('change', function () {
                if (this.files && this.files[0]) {
                    const reader = new FileReader();
                    reader.onload = function (e) {
                        document.getElementById('storyPreviewImg').src = e.target.result;
                        document.getElementById('storyPreviewImage').style.display = 'block';
                        document.getElementById('removeImageBtn').style.display = 'flex';
                        const imgControls = document.getElementById('imageControls');
                        if (imgControls) imgControls.style.display = 'flex';
                        resetImageTransform();
                        updateStoryPreview();
                    };
                    reader.readAsDataURL(this.files[0]);
                }
            });
        }

        // Drag & drop support for image selection
        if (preview) {
            const handleDragOver = (event) => {
                event.preventDefault();
                preview.classList.add('drag-over');
            };
            const clearDrag = () => preview.classList.remove('drag-over');
            preview.addEventListener('dragenter', handleDragOver);
            preview.addEventListener('dragover', handleDragOver);
            preview.addEventListener('dragleave', clearDrag);
            preview.addEventListener('drop', (event) => {
                event.preventDefault();
                clearDrag();
                const file = event.dataTransfer?.files?.[0];
                if (!file) return;
                if (!file.type.startsWith('image/')) {
                    showNotification('Please drop an image file.', 'error');
                    return;
                }
                const dt = new DataTransfer();
                dt.items.add(file);
                imageInput.files = dt.files;
                imageInput.dispatchEvent(new Event('change'));
            });
        }
    }

    // Remove selected image
    function removeStoryImage() {
        document.getElementById('storyImageInput').value = '';
        document.getElementById('storyPreviewImg').src = '';
        document.getElementById('storyPreviewImage').style.display = 'none';
        document.getElementById('removeImageBtn').style.display = 'none';
        document.getElementById('imageControls').style.display = 'none';
        resetImageTransform();
        updateStoryPreview();
    }

    // Update the story preview
    function updateStoryPreview() {
        const preview = document.getElementById('storyPreview');
        const previewText = document.getElementById('storyPreviewText');
        const previewImage = document.getElementById('storyPreviewImage');
        const placeholder = document.getElementById('storyPreviewPlaceholder');

        const content = document.getElementById('storyText').value.trim();
        const bgColor = document.getElementById('bgColor').value;
        const textColor = document.getElementById('textColor').value;
        const textPosition = document.getElementById('textPosition').value;
        const hasImage = document.getElementById('storyPreviewImg').src &&
            document.getElementById('storyPreviewImg').src !== window.location.href;

        // Set background color
        preview.style.background = hasImage ? 'linear-gradient(135deg, #1a1a2e 0%, #16213e 100%)' : bgColor;

        // Keep inline editor in sync
        if (document.activeElement !== previewText) {
            previewText.innerText = content;
        }

        // Update text
        previewText.style.color = textColor;

        // Update text position
        previewText.className = 'story-preview-text position-' + textPosition;

        // Show/hide elements based on content
        if (content || hasImage) {
            placeholder.style.display = 'none';
            previewText.style.display = content ? 'block' : 'none';
            previewImage.style.display = hasImage ? 'block' : 'none';

            // If has image, add text overlay styling
            if (hasImage && content) {
                previewText.style.background = 'rgba(0, 0, 0, 0.5)';
                previewText.style.padding = '0.75rem 1rem';
                previewText.style.borderRadius = '8px';
            } else {
                previewText.style.background = 'transparent';
                previewText.style.padding = '0';
            }
        } else {
            placeholder.style.display = 'flex';
            previewText.style.display = 'none';
            previewImage.style.display = 'none';
        }
    }

    // ===== ADVANCED IMAGE MANIPULATION =====

    let imageZoom = 1;
    let imageX = 0;
    let imageY = 0;
    let isDragging = false;
    let startX, startY;

    // Initialize image panning on story modal
    function initImagePanning() {
        const previewImage = document.getElementById('storyPreviewImage');
        const previewImg = document.getElementById('storyPreviewImg');

        if (!previewImage || !previewImg) return;

        previewImage.addEventListener('mousedown', startDrag);
        previewImage.addEventListener('touchstart', startDrag);
        document.addEventListener('mousemove', drag);
        document.addEventListener('touchmove', drag);
        document.addEventListener('mouseup', endDrag);
        document.addEventListener('touchend', endDrag);
    }

    function startDrag(e) {
        if (!document.getElementById('storyPreviewImg').src) return;

        isDragging = true;
        const evt = e.type.includes('touch') ? e.touches[0] : e;
        startX = evt.clientX - imageX;
        startY = evt.clientY - imageY;
        e.preventDefault();
    }

    function drag(e) {
        if (!isDragging) return;

        const evt = e.type.includes('touch') ? e.touches[0] : e;
        imageX = evt.clientX - startX;
        imageY = evt.clientY - startY;

        const xInput = document.getElementById('imageX');
        const yInput = document.getElementById('imageY');
        if (xInput) xInput.value = imageX;
        if (yInput) yInput.value = imageY;

        applyImageTransform();
        e.preventDefault();
    }

    function endDrag() {
        isDragging = false;
    }

    function zoomImage(delta) {
        imageZoom += delta;
        imageZoom = Math.max(0.5, Math.min(3, imageZoom)); // Clamp between 0.5x and 3x

        const zoomInput = document.getElementById('imageZoom');
        if (zoomInput) zoomInput.value = imageZoom;
        applyImageTransform();

        // Show/hide image controls
        const imageControls = document.getElementById('imageControls');
        const previewImg = document.getElementById('storyPreviewImg');
        const hasImage = previewImg && previewImg.src && previewImg.src !== window.location.href;
        if (imageControls && hasImage) {
            imageControls.style.display = 'flex';
        }
    }

    function resetImageTransform() {
        imageZoom = 1;
        imageX = 0;
        imageY = 0;

        const zoomInput = document.getElementById('imageZoom');
        const xInput = document.getElementById('imageX');
        const yInput = document.getElementById('imageY');

        if (zoomInput) zoomInput.value = 1;
        if (xInput) xInput.value = 0;
        if (yInput) yInput.value = 0;

        applyImageTransform();
    }

    function applyImageTransform() {
        const img = document.getElementById('storyPreviewImg');
        if (img && img.src) {
            img.style.transform = `scale(${imageZoom}) translate(${imageX / imageZoom}px, ${imageY / imageZoom}px)`;
        }
    }

    // ===== TEXT STYLING FUNCTIONS =====

    function adjustFontSize(delta) {
        const fontSizeInput = document.getElementById('textFontSize');
        if (!fontSizeInput) return;

        let currentSize = parseInt(fontSizeInput.value) || 20;
        currentSize += delta;
        currentSize = Math.max(12, Math.min(48, currentSize)); // Clamp between 12px and 48px

        fontSizeInput.value = currentSize;

        const previewText = document.getElementById('storyPreviewText');
        if (previewText) {
            previewText.style.fontSize = currentSize + 'px';
        }
    }

    function toggleTextBold() {
        const boldInput = document.getElementById('textBold');
        if (!boldInput) return;

        const isBold = boldInput.value === 'true';
        boldInput.value = (!isBold).toString();

        const boldBtn = document.getElementById('boldBtn');
        const previewText = document.getElementById('storyPreviewText');

        if (boldBtn) {
            boldBtn.classList.toggle('active', !isBold);
        }

        if (previewText) {
            if (!isBold) {
                previewText.classList.add('bold');
            } else {
                previewText.classList.remove('bold');
            }
        }
    }

    function toggleTextShadow() {
        const shadowInput = document.getElementById('textShadow');
        if (!shadowInput) return;

        const hasShadow = shadowInput.value === 'true';
        shadowInput.value = (!hasShadow).toString();

        const shadowBtn = document.getElementById('shadowBtn');
        const previewText = document.getElementById('storyPreviewText');

        if (shadowBtn) {
            shadowBtn.classList.toggle('active', !hasShadow);
        }

        if (previewText) {
            if (!hasShadow) {
                previewText.classList.remove('no-shadow');
            } else {
                previewText.classList.add('no-shadow');
            }
        }
    }

    function setTextAlign(align) {
        const alignInput = document.getElementById('textAlign');
        if (alignInput) alignInput.value = align;

        // Update button states
        document.querySelectorAll('.align-btn').forEach(btn => {
            btn.classList.remove('active');
        });
        const activeBtn = document.querySelector(`.align-btn[data-align="${align}"]`);
        if (activeBtn) activeBtn.classList.add('active');

        // Update preview
        const previewText = document.getElementById('storyPreviewText');
        if (previewText) {
            previewText.classList.remove('align-left', 'align-right');
            if (align !== 'center') {
                previewText.classList.add('align-' + align);
            }
        }
    }

    // ===== STORY INTERACTION FUNCTIONS =====

    // Toggle like on current story
    async function toggleStoryLike() {
        if (!currentStoriesData.length || currentStoryIndex < 0) return;

        const story = currentStoriesData[currentStoryIndex];
        const likeBtn = document.getElementById('storyLikeBtn');
        if (!likeBtn) return;

        const likeIcon = likeBtn.querySelector('[data-lucide]');

        try {
            const response = await fetch(`/api/story/toggle-like/`, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'X-CSRFToken': getCSRFToken(),
                },
                body: JSON.stringify({ story_id: story.id })
            });

            const data = await response.json();

            if (data.success) {
                // Update UI
                if (data.is_liked) {
                    likeBtn.classList.add('liked');
                } else {
                    likeBtn.classList.remove('liked');
                }

                // Update like count in stats bar
                const likeCountElement = document.getElementById('likeCount');
                if (likeCountElement && data.like_count !== undefined) {
                    likeCountElement.textContent = data.like_count;
                }

                // Update the story data
                currentStoriesData[currentStoryIndex].is_liked = data.is_liked;
                currentStoriesData[currentStoryIndex].like_count = data.like_count;

                // Refresh Lucide icons
                if (window.lucide && window.lucide.createIcons) {
                    window.lucide.createIcons();
                }

                console.log(`Story ${story.id} ${data.is_liked ? 'liked' : 'unliked'}`);
            } else {
                showNotification(data.error || 'Failed to toggle like', 'error');
            }
        } catch (error) {
            console.error('Error toggling story like:', error);
            showNotification('Failed to toggle like. Please try again.', 'error');
        }
    }

    // Send reply to current story
    async function sendStoryReply() {
        if (!currentStoriesData.length || currentStoryIndex < 0) return;

        const story = currentStoriesData[currentStoryIndex];
        const replyInput = document.getElementById('storyReplyInput');
        if (!replyInput) return;

        const replyText = replyInput.value.trim();

        if (!replyText) {
            showNotification('Please enter a reply', 'error');
            return;
        }

        try {
            const response = await fetch(`/api/story/add-reply/`, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'X-CSRFToken': getCSRFToken(),
                },
                body: JSON.stringify({
                    story_id: story.id,
                    content: replyText
                })
            });

            const data = await response.json();

            if (data.success) {
                replyInput.value = '';

                // Check if current user is the story owner
                const metaTag = document.querySelector('meta[name="user-id"]');
                const currentUserId = metaTag ? parseInt(metaTag.getAttribute('content')) : null;
                const isOwnStory = story.user && story.user.id === currentUserId;

                if (isOwnStory) {
                    showNotification('Reply sent! Check your replies to see it.', 'success');
                } else {
                    showNotification('Reply sent successfully!', 'success');
                }

                console.log(`Reply sent to story ${story.id}`);
            } else {
                showNotification(data.error || 'Failed to send reply', 'error');
            }
        } catch (error) {
            console.error('Error sending story reply:', error);
            showNotification('Failed to send reply. Please try again.', 'error');
        }
    }

    // Share story function
    function shareStory() {
        if (!currentStoriesData.length || currentStoryIndex < 0) return;

        const story = currentStoriesData[currentStoryIndex];
        const storyUrl = `${window.location.origin}/story/${story.id}/`;

        if (navigator.share) {
            navigator.share({
                title: `${story.user.full_name}'s Story`,
                text: 'Check out this story!',
                url: storyUrl
            }).then(() => {
                showNotification('Shared successfully!', 'success');
            }).catch((error) => {
                console.log('Share cancelled or failed:', error);
            });
        } else {
            // Fallback: copy to clipboard
            navigator.clipboard.writeText(storyUrl).then(() => {
                showNotification('Link copied to clipboard!', 'success');
            }).catch(() => {
                showNotification('Failed to copy link', 'error');
            });
        }
    }

    // Mute/Unmute story (for video stories)
    let storyMuted = false;
    function toggleStoryMute() {
        storyMuted = !storyMuted;
        const video = document.querySelector('.story-content-display video');
        const muteIcon = document.getElementById('storyMuteIcon');

        if (video) {
            video.muted = storyMuted;
        }

        if (muteIcon) {
            muteIcon.setAttribute('data-lucide', storyMuted ? 'volume-x' : 'volume-2');
            if (window.lucide && window.lucide.createIcons) {
                window.lucide.createIcons();
            }
        }
    }

    // Show story viewers modal
    async function showStoryViewers() {
        if (!currentStoriesData.length || currentStoryIndex < 0) return;

        const story = currentStoriesData[currentStoryIndex];

        try {
            const response = await fetch(`/api/story/${story.id}/viewers/`);
            const data = await response.json();

            if (data.success) {
                const modal = createViewersModal(data.viewers);
                document.body.appendChild(modal);
            } else {
                showNotification(data.error || 'Failed to load viewers', 'error');
            }
        } catch (error) {
            console.error('Error loading story viewers:', error);
            showNotification('Failed to load viewers. Please try again.', 'error');
        }
    }

    // Show story replies modal
    async function showStoryReplies() {
        if (!currentStoriesData.length || currentStoryIndex < 0) return;

        const story = currentStoriesData[currentStoryIndex];

        try {
            const response = await fetch(`/api/story/${story.id}/replies/`);

            if (!response.ok) {
                showNotification('‚ùå Failed to get story replies', 'error');
                return;
            }

            const data = await response.json();

            if (data.success) {
                const modal = createRepliesModal(data.replies || []);
                document.body.appendChild(modal);
            } else {
                showNotification('‚ùå ' + (data.error || 'Failed to get story replies'), 'error');
            }
        } catch (error) {
            console.error('Error loading story replies:', error);
            showNotification('‚ùå Failed to get story replies', 'error');
        }
    }

    // Create viewers modal
    function createViewersModal(viewers) {
        const modal = document.createElement('div');
        modal.className = 'story-modal-overlay';
        modal.onclick = (e) => {
            if (e.target === modal) modal.remove();
        };

        modal.innerHTML = `
        <div class="story-viewers-modal">
            <div class="story-modal-header">
                <h3 class="story-modal-title">Viewed by</h3>
                <button class="story-modal-close" onclick="this.closest('.story-modal-overlay').remove()">&times;</button>
            </div>
            <div class="story-modal-content">
                ${viewers.length > 0 ?
                viewers.map(viewer => `
                        <div class="story-viewer-item">
                            <img src="${viewer.profile_picture_url || 'data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iNDAiIGhlaWdodD0iNDAiIHZpZXdCb3g9IjAgMCA0MCA0MCIgZmlsbD0ibm9uZSIgeG1sbnM9Imh0dHA6Ly93d3cudzMub3JnLzIwMDAvc3ZnIj4KPGNpcmNsZSBjeD0iMjAiIGN5PSIyMCIgcj0iMjAiIGZpbGw9IiNFNUU3RUIiLz4KPHBhdGggZD0iTTIwIDIwQzIyLjc2MTQgMjAgMjUgMTcuNzYxNCAyNSAxNUMyNSAxMi4yMzg2IDIyLjc2MTQgMTAgMjAgMTBDMTcuMjM4NiAxMCAxNSAxMi4yMzg2IDE1IDE1QzE1IDE3Ljc2MTQgMTcuMjM4NiAyMCAyMCAyMFoiIGZpbGw9IiM5Q0E0QUYiLz4KPC9zdmc+'}" 
                                 alt="${viewer.username}" 
                                 class="story-viewer-avatar">
                            <div class="story-viewer-info">
                                <div class="story-viewer-name">${viewer.username}</div>
                                <div class="story-viewer-time">${formatTimeAgo(viewer.viewed_at)}</div>
                            </div>
                        </div>
                    `).join('') :
                `<div class="story-modal-empty">
                        <i data-lucide="eye" class="lucide"></i>
                        <p>No views yet</p>
                    </div>`
            }
            </div>
        </div>
    `;

        // Initialize Lucide icons
        setTimeout(() => {
            if (window.lucide && window.lucide.createIcons) {
                window.lucide.createIcons();
            }
        }, 100);

        return modal;
    }

    // Create replies modal
    function createRepliesModal(replies) {
        // Create modal overlay
        const modal = document.createElement('div');
        modal.className = 'story-modal-overlay';
        modal.onclick = (e) => {
            if (e.target === modal) modal.remove();
        };

        // Create modal content
        const modalContent = document.createElement('div');
        modalContent.className = 'story-replies-modal';

        // Create header
        const header = document.createElement('div');
        header.className = 'story-modal-header';
        header.innerHTML = `
        <h3 class="story-modal-title">Replies</h3>
        <button class="story-modal-close" onclick="this.closest('.story-modal-overlay').remove()">&times;</button>
    `;

        // Create content area
        const content = document.createElement('div');
        content.className = 'story-modal-content';

        if (replies && replies.length > 0) {
            replies.forEach(reply => {
                const replyItem = document.createElement('div');
                replyItem.className = 'story-reply-item';

                const avatar = document.createElement('img');
                avatar.src = reply.replier?.profile_picture_url || 'data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iNDAiIGhlaWdodD0iNDAiIHZpZXdCb3g9IjAgMCA0MCA0MCIgZmlsbD0ibm9uZSIgeG1sbnM9Imh0dHA6Ly93d3cudzMub3JnLzIwMDAvc3ZnIj4KPGNpcmNsZSBjeD0iMjAiIGN5PSIyMCIgcj0iMjAiIGZpbGw9IiNFNUU3RUIiLz4KPHBhdGggZD0iTTIwIDIwQzIyLjc2MTQgMjAgMjUgMTcuNzYxNCAyNSAxNUMyNSAxMi4yMzg2IDIyLjc2MTQgMTAgMjAgMTBDMTcuMjM4NiAxMCAxNSAxMi4yMzg2IDE1IDE1QzE1IDE3Ljc2MTQgMTcuMjM4NiAyMCAyMCAyMFoiIGZpbGw9IiM5Q0E0QUYiLz4KPC9zdmc+';
                avatar.alt = reply.replier?.username || 'User';
                avatar.className = 'story-reply-avatar';

                const info = document.createElement('div');
                info.className = 'story-reply-info';
                info.innerHTML = `
                <div class="story-reply-username">${reply.replier?.username || 'Unknown'}</div>
                <div class="story-reply-time">${formatTimeAgo(reply.created_at)}</div>
                <div class="story-reply-content">${escapeHtml(reply.content || '')}</div>
                <div class="story-reply-actions">
                    <button class="story-reply-action delete" onclick="deleteReply(${reply.id})">
                        <i data-lucide="trash-2" class="lucide"></i>
                    </button>
                </div>
            `;

                replyItem.appendChild(avatar);
                replyItem.appendChild(info);
                content.appendChild(replyItem);
            });
        } else {
            content.innerHTML = `
            <div class="story-modal-empty">
                <i data-lucide="message-circle" class="lucide"></i>
                <p>No replies yet</p>
            </div>
        `;
        }

        modalContent.appendChild(header);
        modalContent.appendChild(content);
        modal.appendChild(modalContent);

        // Initialize Lucide icons
        setTimeout(() => {
            if (window.lucide && window.lucide.createIcons) {
                window.lucide.createIcons();
            }
        }, 100);

        return modal;
    }

    // Delete reply
    async function deleteReply(replyId) {
        if (!confirm('Are you sure you want to delete this reply?')) return;

        try {
            const response = await fetch(`/api/replies/${replyId}/delete/`, {
                method: 'DELETE',
                headers: {
                    'X-CSRFToken': getCSRFToken(),
                }
            });

            const data = await response.json();

            if (data.success) {
                // Remove the reply from the modal
                const replyItem = document.querySelector(`[onclick="deleteReply(${replyId})"]`).closest('.story-reply-item');
                replyItem.remove();

                showNotification('Reply deleted successfully', 'success');
            } else {
                showNotification(data.error || 'Failed to delete reply', 'error');
            }
        } catch (error) {
            console.error('Error deleting reply:', error);
            showNotification('Failed to delete reply', 'error');
        }
    }

    // ===== STORY INBOX FUNCTIONS =====

    // Open the story inbox modal to see all replies to your stories
    async function openStoryInbox() {
        try {
            const response = await fetch('/api/story-inbox/');
            const data = await response.json();

            if (data.success) {
                const modal = createStoryInboxModal(data.replies || []);
                document.body.appendChild(modal);

                // Hide the badge after viewing
                const badge = document.getElementById('storyInboxBadge');
                if (badge) badge.style.display = 'none';
            } else {
                showNotification(data.error || 'Failed to load story inbox', 'error');
            }
        } catch (error) {
            console.error('Error loading story inbox:', error);
            showNotification('Failed to load story inbox', 'error');
        }
    }

    // Create story inbox modal
    function createStoryInboxModal(replies) {
        const modal = document.createElement('div');
        modal.className = 'story-modal-overlay';
        modal.onclick = (e) => {
            if (e.target === modal) modal.remove();
        };

        const groupedReplies = groupRepliesByStory(replies);

        modal.innerHTML = `
        <div class="story-inbox-modal">
            <div class="story-modal-header">
                <h3 class="story-modal-title">
                    <i data-lucide="message-circle" class="lucide"></i>
                    Story Replies Inbox
                </h3>
                <button class="story-modal-close" onclick="this.closest('.story-modal-overlay').remove()">&times;</button>
            </div>
            <div class="story-modal-content story-inbox-content">
                ${Object.keys(groupedReplies).length > 0 ?
                Object.entries(groupedReplies).map(([storyId, storyData]) => `
                        <div class="story-inbox-group">
                            <div class="story-inbox-story-header" onclick="viewStoryFromInbox(${storyId})">
                                <div class="story-inbox-preview ${storyData.story.story_type}">
                                    ${storyData.story.story_type === 'image' ?
                        `<img src="${storyData.story.media_url}" alt="Story">` :
                        `<div class="text-preview" style="background: ${storyData.story.background_color}; color: ${storyData.story.text_color};">${(storyData.story.content || '').substring(0, 20)}...</div>`
                    }
                                </div>
                                <div class="story-inbox-story-info">
                                    <div class="story-inbox-story-time">Your story ‚Ä¢ ${formatTimeAgo(storyData.story.created_at)}</div>
                                    <div class="story-inbox-reply-count">${storyData.replies.length} ${storyData.replies.length === 1 ? 'reply' : 'replies'}</div>
                                </div>
                                <i data-lucide="chevron-right" class="lucide"></i>
                            </div>
                            <div class="story-inbox-replies">
                                ${storyData.replies.map(reply => `
                                    <div class="story-inbox-reply ${reply.is_read ? '' : 'unread'}">
                                        <img src="${reply.replier?.profile_picture_url || '/static/images/default-avatar.png'}" 
                                             alt="${reply.replier?.username}" 
                                             class="story-inbox-reply-avatar">
                                        <div class="story-inbox-reply-content">
                                            <div class="story-inbox-reply-header">
                                                <span class="story-inbox-reply-username">${reply.replier?.username || 'Unknown'}</span>
                                                <span class="story-inbox-reply-time">${formatTimeAgo(reply.created_at)}</span>
                                            </div>
                                            <div class="story-inbox-reply-text">${escapeHtml(reply.content || '')}</div>
                                        </div>
                                        <button class="story-inbox-reply-delete" onclick="deleteReplyFromInbox(${reply.id}, this)" title="Delete">
                                            <i data-lucide="trash-2" class="lucide"></i>
                                        </button>
                                    </div>
                                `).join('')}
                            </div>
                        </div>
                    `).join('') :
                `<div class="story-modal-empty">
                        <i data-lucide="message-circle" class="lucide"></i>
                        <p>No replies to your stories yet</p>
                        <small>When someone replies to your story, you'll see it here</small>
                    </div>`
            }
            </div>
        </div>
    `;

        // Initialize Lucide icons
        setTimeout(() => {
            if (window.lucide && window.lucide.createIcons) {
                window.lucide.createIcons();
            }
        }, 100);

        return modal;
    }

    // Group replies by story
    function groupRepliesByStory(replies) {
        const grouped = {};

        replies.forEach(reply => {
            const storyId = reply.story?.id;
            if (!storyId) return;

            if (!grouped[storyId]) {
                grouped[storyId] = {
                    story: reply.story,
                    replies: []
                };
            }
            grouped[storyId].replies.push(reply);
        });

        return grouped;
    }

    // View story from inbox
    async function viewStoryFromInbox(storyId) {
        // Close the inbox modal
        document.querySelector('.story-modal-overlay')?.remove();

        // Fetch and view the story
        try {
            const response = await fetch(`/api/story/${storyId}/`);
            const data = await response.json();

            if (data.success) {
                currentStoriesData = [data.story];
                currentStoryIndex = 0;
                showStoryModal();
                displayCurrentStory();
            }
        } catch (error) {
            console.error('Error viewing story from inbox:', error);
        }
    }

    // Delete reply from inbox
    async function deleteReplyFromInbox(replyId, button) {
        if (!confirm('Delete this reply?')) return;

        try {
            const response = await fetch(`/api/replies/${replyId}/delete/`, {
                method: 'DELETE',
                headers: {
                    'X-CSRFToken': getCSRFToken(),
                }
            });

            const data = await response.json();

            if (data.success) {
                // Remove the reply element
                const replyElement = button.closest('.story-inbox-reply');
                const groupElement = replyElement.closest('.story-inbox-group');
                replyElement.remove();

                // If no more replies in this group, remove the group
                if (groupElement.querySelectorAll('.story-inbox-reply').length === 0) {
                    groupElement.remove();
                }

                // If no more groups, show empty state
                const content = document.querySelector('.story-inbox-content');
                if (content && content.querySelectorAll('.story-inbox-group').length === 0) {
                    content.innerHTML = `
                    <div class="story-modal-empty">
                        <i data-lucide="message-circle" class="lucide"></i>
                        <p>No replies to your stories yet</p>
                        <small>When someone replies to your story, you'll see it here</small>
                    </div>
                `;
                    if (window.lucide && window.lucide.createIcons) {
                        window.lucide.createIcons();
                    }
                }

                showNotification('Reply deleted', 'success');
            } else {
                showNotification(data.error || 'Failed to delete', 'error');
            }
        } catch (error) {
            console.error('Error deleting reply:', error);
            showNotification('Failed to delete reply', 'error');
        }
    }

    // Check for new story replies (for badge)
    async function checkStoryInboxCount() {
        try {
            const response = await fetch('/api/story-inbox/count/');
            const data = await response.json();

            if (data.success && data.unread_count > 0) {
                const badge = document.getElementById('storyInboxBadge');
                if (badge) {
                    badge.textContent = data.unread_count;
                    badge.style.display = 'inline-block';
                }
            }
        } catch (error) {
            console.log('Could not check story inbox count');
        }
    }

    // Helper function to format time ago
    function formatTimeAgo(dateString) {
        const date = new Date(dateString);
        const now = new Date();
        const diffInSeconds = Math.floor((now - date) / 1000);

        if (diffInSeconds < 60) return 'Just now';
        if (diffInSeconds < 3600) return `${Math.floor(diffInSeconds / 60)}m ago`;
        if (diffInSeconds < 86400) return `${Math.floor(diffInSeconds / 3600)}h ago`;
        return `${Math.floor(diffInSeconds / 86400)}d ago`;
    }

    // Helper function to escape HTML
    function escapeHtml(text) {
        const div = document.createElement('div');
        div.textContent = text;
        return div.innerHTML;
    }

    function selectStoryType(type) {
        // Legacy function - kept for compatibility
        // No longer used in new UI
    }

    // ALL YOUR ORIGINAL TWEET POSTING FUNCTIONS - PRESERVED
    async function postTweetFixed() {
        if (isPosting) {
            console.log('Already posting, ignoring click');
            return;
        }

        console.log('postTweetFixed called');
        const tweetContent = document.getElementById('id_content');
        const tweetBtn = document.getElementById('tweetBtn');

        if (!tweetContent || !tweetBtn) {
            console.error('Form elements not found');
            showNotification('Form elements not found. Please refresh the page.', 'error');
            return;
        }

        const content = tweetContent.value.trim();

        // Validation
        if (!content && !currentImageFile) {
            showNotification('Please enter some content or select an image', 'error');
            return;
        }

        if (content.length > 280) {
            showNotification('Tweet must be 280 characters or less', 'error');
            return;
        }

        // Set posting state
        isPosting = true;
        tweetBtn.disabled = true;
        tweetBtn.textContent = 'Posting...';

        console.log('Preparing form data...');

        try {
            // Prepare form data
            const formData = new FormData();
            if (content) {
                formData.append('content', content);
            }
            if (currentImageFile) {
                formData.append('image', currentImageFile);
            }

            // Get CSRF token
            const csrfToken = getCSRFToken();
            if (!csrfToken) {
                throw new Error('No CSRF token found');
            }

            console.log('Sending request to /api/post-tweet/');

            // Make request
            const response = await fetch('/api/post-tweet/', {
                method: 'POST',
                headers: {
                    'X-CSRFToken': csrfToken,
                },
                body: formData
            });

            console.log('Response status:', response.status);
            const data = await response.json();
            console.log('Response data:', data);

            if (data.success) {
                // Clear form
                tweetContent.value = '';
                document.getElementById('charCount').textContent = '280';
                document.getElementById('charCount').className = 'char-count';
                removeImageFixed();

                showNotification(data.message || 'Tweet posted successfully!', 'success');

                // Reload page after short delay to show new tweet
                setTimeout(() => {
                    window.location.reload();
                }, 1500);
            } else {
                console.error('Server error:', data.error);
                showNotification(data.error || 'Failed to post tweet', 'error');
            }
        } catch (error) {
            console.error('Network error:', error);
            showNotification('Network error. Please check your connection and try again.', 'error');
        } finally {
            resetPostingState();
        }
    }

    function resetPostingState() {
        const tweetBtn = document.getElementById('tweetBtn');
        isPosting = false;
        if (tweetBtn) {
            tweetBtn.textContent = 'Tweet';
            updateTweetButton();
        }
    }

    function removeImageFixed() {
        const tweetImage = document.getElementById('id_image');
        const imagePreview = document.getElementById('imagePreview');

        if (tweetImage) {
            tweetImage.value = '';
        }
        if (imagePreview) {
            imagePreview.style.display = 'none';
        }
        currentImageFile = null;
        updateTweetButton();
    }

    function showNotification(message, type = 'info') {
        console.log('Showing notification:', message, type);

        const notification = document.createElement('div');
        notification.className = `notification notification--${type}`;
        notification.style.cssText = `
        position: fixed;
        top: 20px;
        right: 20px;
        padding: 1rem 1.5rem;
        border-radius: 0.75rem;
        color: white;
        font-weight: 600;
        z-index: 10000;
        transform: translateX(100%);
        transition: transform 0.3s ease;
        max-width: 350px;
        word-wrap: break-word;
        box-shadow: 0 10px 30px rgba(0, 0, 0, 0.2);
    `;

        const colors = {
            'success': '#28a745',
            'error': '#dc3545',
            'warning': '#ffc107',
            'info': '#17a2b8'
        };

        notification.style.backgroundColor = colors[type] || colors.info;
        notification.textContent = message;

        document.body.appendChild(notification);

        setTimeout(() => {
            notification.style.transform = 'translateX(0)';
        }, 100);

        setTimeout(() => {
            notification.style.transform = 'translateX(100%)';
            setTimeout(() => {
                if (notification.parentNode) {
                    notification.parentNode.removeChild(notification);
                }
            }, 300);
        }, 3000);
    }

    // ENHANCED: Tweet composer with enhanced image handling
    function initializeTweetComposer() {
        const tweetContent = document.getElementById('id_content');
        const tweetImage = document.getElementById('id_image');
        const charCount = document.getElementById('charCount');
        const tweetBtn = document.getElementById('tweetBtn');
        const imagePreview = document.getElementById('imagePreview');
        const previewImg = document.getElementById('previewImg');

        if (!tweetContent || !charCount || !tweetBtn) {
            console.error('Tweet composer elements not found');
            return;
        }

        console.log('Tweet composer elements found, setting up enhanced event listeners');

        // Character counter
        tweetContent.addEventListener('input', function () {
            const length = this.value.length;
            const remaining = 280 - length;

            charCount.textContent = remaining;
            charCount.className = 'char-count';

            if (remaining < 0) {
                charCount.classList.add('danger');
            } else if (remaining <= 20) {
                charCount.classList.add('warning');
            }

            updateTweetButton();
        });

        // ENHANCED: Image upload handler with better preview
        if (tweetImage) {
            tweetImage.addEventListener('change', function (e) {
                const file = e.target.files[0];
                if (!file) return;

                // Validate file
                if (file.size > 5 * 1024 * 1024) {
                    showNotification('Image file too large. Maximum size is 5MB.', 'error');
                    this.value = '';
                    return;
                }

                const validTypes = ['image/jpeg', 'image/jpg', 'image/png', 'image/gif', 'image/webp'];
                if (!validTypes.includes(file.type)) {
                    showNotification('Invalid image format. Use JPG, PNG, GIF, or WEBP.', 'error');
                    this.value = '';
                    return;
                }

                currentImageFile = file;

                // Show preview with enhanced handling
                const reader = new FileReader();
                reader.onload = function (e) {
                    if (previewImg && imagePreview) {
                        previewImg.src = e.target.result;
                        imagePreview.style.display = 'block';

                        // Apply enhanced image handling
                        handlePreviewImage(previewImg);
                    }
                };
                reader.readAsDataURL(file);

                updateTweetButton();
            });
        }
    }

    function updateTweetButton() {
        const tweetContent = document.getElementById('id_content');
        const tweetBtn = document.getElementById('tweetBtn');

        if (!tweetContent || !tweetBtn) return;

        const content = tweetContent.value.trim();
        const hasContent = content.length > 0 || currentImageFile;
        const isValidLength = content.length <= 280;

        tweetBtn.disabled = !hasContent || !isValidLength || isPosting;
    }

    // ALL YOUR ORIGINAL FUNCTIONS - PRESERVED EXACTLY
    function toggleLike(tweetId) {
        fetch('/api/toggle-like/', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': getCSRFToken(),
            },
            body: JSON.stringify({ tweet_id: tweetId })
        })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    const tweetItem = document.querySelector(`[data-tweet-id="${tweetId}"]`);
                    const likeBtn = tweetItem.querySelector('.like-btn');
                    const likeCount = likeBtn.querySelector('.like-count');

                    // Update liked state - Lucide icon stays the same, CSS handles color
                    if (data.is_liked) {
                        likeBtn.classList.add('liked');
                    } else {
                        likeBtn.classList.remove('liked');
                    }

                    likeCount.textContent = data.like_count;

                    // Refresh Lucide icons to ensure proper rendering
                    if (window.refreshLucideIcons) {
                        window.refreshLucideIcons();
                    }
                } else {
                    showNotification('Failed to toggle like', 'error');
                }
            })
            .catch(error => {
                console.error('Error:', error);
                showNotification('Network error', 'error');
            });
    }

    function toggleComments(tweetId) {
        const commentsSection = document.getElementById(`comments-${tweetId}`);
        const isVisible = commentsSection.style.display !== 'none';

        if (isVisible) {
            commentsSection.style.display = 'none';
        } else {
            commentsSection.style.display = 'block';
            loadComments(tweetId);
        }
    }

    function loadComments(tweetId) {
        fetch(`/api/tweet/${tweetId}/comments/`)
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    const commentsList = document.getElementById(`comments-list-${tweetId}`);
                    let commentsHtml = '';

                    data.comments.forEach(comment => {
                        commentsHtml += `
                    <div class="comment-item">
                        <div class="comment-avatar">
                            <img src="${comment.user_profile_picture}" alt="${comment.user_full_name}" onerror="this.style.display='none'; this.nextElementSibling.style.display='flex';">
                            <div class="avatar-fallback">${comment.user_initials}</div>
                        </div>
                        <div class="comment-content">
                            <div class="comment-header">
                                <span class="comment-author">${comment.user_full_name}</span>
                                <span class="comment-time">${comment.timestamp}</span>
                            </div>
                            <p class="comment-text">${comment.content}</p>
                        </div>
                    </div>
                `;
                    });

                    commentsList.innerHTML = commentsHtml;
                }
            })
            .catch(error => {
                console.error('Error loading comments:', error);
            });
    }

    function addComment(tweetId) {
        const commentInput = document.getElementById(`comment-input-${tweetId}`);
        const content = commentInput.value.trim();

        if (!content) {
            showNotification('Please enter a comment', 'error');
            return;
        }

        fetch('/api/add-comment/', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': getCSRFToken(),
            },
            body: JSON.stringify({
                tweet_id: tweetId,
                content: content
            })
        })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    commentInput.value = '';
                    showNotification('Comment added!', 'success');
                    loadComments(tweetId);

                    // Update comment count
                    const tweetItem = document.querySelector(`[data-tweet-id="${tweetId}"]`);
                    const commentBtn = tweetItem.querySelector('.comment-btn span');
                    commentBtn.textContent = parseInt(commentBtn.textContent) + 1;
                } else {
                    showNotification(`Failed to add comment: ${data.error}`, 'error');
                }
            })
            .catch(error => {
                console.error('Error:', error);
                showNotification('Network error', 'error');
            });
    }

    // MOBILE MODAL SYSTEM - CLEAN VERSION WITH FORCED CLASS REMOVAL
    function openMobileModal(modalType) {
        console.log('üîµ Opening modal:', modalType);

        // Close any existing modal first
        closeAllMobileModals();

        const modal = document.getElementById(`${modalType}Modal`);
        console.log('Modal element found:', modal ? 'YES' : 'NO');

        if (!modal) {
            console.error('‚ùå Modal not found:', modalType + 'Modal');
            return;
        }

        // STEP 1: AGGRESSIVELY remove active class from ALL tabs using multiple methods
        const allTabs = document.querySelectorAll('.bottom-nav-tab');
        console.log('Found tabs:', allTabs.length);
        allTabs.forEach(tab => {
            // Method 1: classList.remove
            tab.classList.remove('active');
            // Method 2: setAttribute to force class update
            const currentClass = tab.className.replace(/\bactive\b/g, '').trim();
            tab.setAttribute('class', currentClass);
            console.log('Cleaned tab:', tab.dataset.tab, 'new class:', tab.className);
        });

        // STEP 2: Add active class ONLY to the clicked tab
        const activeTab = document.querySelector(`.bottom-nav-tab[data-tab="${modalType}"]`);
        console.log('Tab to activate:', activeTab ? activeTab.dataset.tab : 'NOT FOUND');
        if (activeTab) {
            activeTab.classList.add('active');
            console.log('‚úÖ Activated tab:', modalType, 'class:', activeTab.className);
        }

        // STEP 3: Show the modal
        modal.classList.add('active');
        activeMobileModal = modalType;
        document.body.style.overflow = 'hidden';
        console.log('‚úÖ Modal shown:', modalType);

        // Focus search inputs
        if (modalType === 'chats') {
            setTimeout(() => {
                const searchInput = document.getElementById('userSearchInput');
                if (searchInput) searchInput.focus();
            }, 100);
        } else if (modalType === 'search') {
            setTimeout(() => {
                const searchInputAlt = document.getElementById('userSearchInputAlt');
                if (searchInputAlt) searchInputAlt.focus();
            }, 100);
        }

        // Re-init lucide icons
        if (typeof lucide !== 'undefined') {
            lucide.createIcons();
        }
    }

    function closeMobileModal() {
        closeAllMobileModals();
    }

    function closeAllMobileModals() {
        console.log('üî¥ Closing all modals');

        const allModals = document.querySelectorAll('.mobile-modal');
        allModals.forEach(modal => {
            modal.classList.remove('active');
        });
        activeMobileModal = null;
        document.body.style.overflow = '';

        // Restore home tab as active (we're on dashboard)
        document.querySelectorAll('.bottom-nav-tab').forEach(tab => {
            tab.classList.remove('active');
        });
        const homeTab = document.getElementById('homeTabBtn');
        if (homeTab) {
            homeTab.classList.add('active');
            console.log('‚úÖ Home tab restored');
        }
    }

    // Scroll to top function for Home button
    function scrollToTop() {
        window.scrollTo({
            top: 0,
            behavior: 'smooth'
        });
        // Also scroll the main content area if it exists
        const mainContent = document.querySelector('.main-content-area');
        if (mainContent) {
            mainContent.scrollTo({
                top: 0,
                behavior: 'smooth'
            });
        }
    }

    function searchUsers() {
        const searchInput = document.getElementById('userSearchInput');
        const searchResults = document.getElementById('searchResults');
        const query = searchInput.value.toLowerCase().trim();

        if (query.length === 0) {
            searchResults.style.display = 'none';
            document.querySelector('.search-clear').style.display = 'none';
            return;
        }

        document.querySelector('.search-clear').style.display = 'block';

        const filteredUsers = allUsers.filter(user =>
            user.fullname.toLowerCase().includes(query) ||
            user.username.toLowerCase().includes(query)
        );

        let resultsHtml = '';

        if (filteredUsers.length > 0) {
            resultsHtml = '<div class="search-results-list">';
            filteredUsers.slice(0, 10).forEach(user => {
                resultsHtml += `
                <div class="search-result-item">
                    <div class="user-avatar-small">
                        <img src="${user.profile_picture_url}" alt="${user.fullname}" onerror="this.style.display='none'; this.nextElementSibling.style.display='flex';">
                        <div class="avatar-fallback-small">${user.initials}</div>
                    </div>
                    <div class="user-info-search">
                        <div class="user-name-search">${user.fullname}</div>
                        <div class="user-username-search">@${user.username}</div>
                    </div>
                    <div class="user-actions-search">
                        <button onclick="startChat('${user.username}')" class="btn-search btn--primary">Chat</button>
                    </div>
                </div>
            `;
            });
            resultsHtml += '</div>';
        } else {
            resultsHtml = `
            <div class="empty-state-mobile">
                <div class="empty-icon">üîç</div>
                <h4>No Users Found</h4>
                <p>No users match your search query</p>
            </div>
        `;
        }

        searchResults.innerHTML = resultsHtml;
        searchResults.style.display = 'block';
    }

    function clearSearch() {
        const searchInput = document.getElementById('userSearchInput');
        const searchResults = document.getElementById('searchResults');

        searchInput.value = '';
        searchResults.style.display = 'none';
        document.querySelector('.search-clear').style.display = 'none';
        searchInput.focus();
    }

    function searchUsersAlt() {
        const searchInput = document.getElementById('userSearchInputAlt');
        const searchResults = document.getElementById('searchResultsAlt');
        const query = searchInput.value.toLowerCase().trim();

        if (query.length === 0) {
            searchResults.querySelector('.search-results-list').style.display = 'block';
            searchResults.querySelectorAll('.search-result-item').forEach(item => {
                item.style.display = 'flex';
            });
            document.querySelector('#searchModal .search-clear').style.display = 'none';
            return;
        }

        document.querySelector('#searchModal .search-clear').style.display = 'block';

        const resultItems = searchResults.querySelectorAll('.search-result-item');
        let visibleCount = 0;

        resultItems.forEach(item => {
            const fullname = item.dataset.fullname;
            const username = item.dataset.username;

            if (fullname.includes(query) || username.includes(query)) {
                item.style.display = 'flex';
                visibleCount++;
            } else {
                item.style.display = 'none';
            }
        });

        if (visibleCount === 0) {
            searchResults.innerHTML = `
            <div class="empty-state-mobile">
                <div class="empty-icon">üîç</div>
                <h4>No Users Found</h4>
                <p>No users match your search query</p>
            </div>
        `;
        }
    }

    function clearSearchAlt() {
        const searchInput = document.getElementById('userSearchInputAlt');
        const searchResults = document.getElementById('searchResultsAlt');

        searchInput.value = '';
        document.querySelector('#searchModal .search-clear').style.display = 'none';
        searchResults.querySelectorAll('.search-result-item').forEach(item => {
            item.style.display = 'flex';
        });
        searchInput.focus();
    }

    function startChat(username) {
        fetch('/api/create-chat/', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': getCSRFToken(),
            },
            body: JSON.stringify({ username: username })
        })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    closeMobileModal();
                    window.location.href = `/chat/${data.chat_id}/`;
                } else {
                    showNotification(`Error starting chat: ${data.error}`, 'error');
                }
            })
            .catch(error => {
                console.error('Error:', error);
                showNotification('Network error. Please try again.', 'error');
            });
    }

    // ALL YOUR ORIGINAL GROUP FUNCTIONS - PRESERVED
    function openCreateGroupModal() {
        closeMobileModal();
        document.getElementById('createGroupModal').style.display = 'flex';
    }

    function closeCreateGroupModal() {
        document.getElementById('createGroupModal').style.display = 'none';
        document.getElementById('createGroupForm').reset();
    }

    function createGroup() {
        const name = document.getElementById('groupName').value.trim();
        const description = document.getElementById('groupDescription').value.trim();
        const maxParticipants = parseInt(document.getElementById('maxParticipants').value);
        const isPublic = document.getElementById('isPublic').checked;

        if (!name) {
            showNotification('Group name is required', 'error');
            return;
        }

        fetch('/api/create-group/', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': getCSRFToken(),
            },
            body: JSON.stringify({
                name: name,
                description: description,
                max_participants: maxParticipants,
                is_public: isPublic
            })
        })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    closeCreateGroupModal();
                    createdGroupId = data.group.id;
                    document.getElementById('createdGroupName').textContent = data.group.name;
                    document.getElementById('inviteLink').value = data.group.invite_link;
                    document.getElementById('groupCreatedModal').style.display = 'flex';
                } else {
                    showNotification(`Failed to create group: ${data.error}`, 'error');
                }
            })
            .catch(error => {
                console.error('Error:', error);
                showNotification('Network error. Please try again.', 'error');
            });
    }

    function copyInviteLink() {
        const linkInput = document.getElementById('inviteLink');
        linkInput.select();
        document.execCommand('copy');
        showNotification('Invite link copied to clipboard!', 'success');
    }

    function goToNewGroup() {
        document.getElementById('groupCreatedModal').style.display = 'none';
        if (createdGroupId) {
            window.location.href = `/chat/${createdGroupId}/`;
        }
    }

    function manageJoinRequest(requestId, action) {
        fetch('/api/manage-join-request/', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': getCSRFToken(),
            },
            body: JSON.stringify({
                request_id: requestId,
                action: action
            })
        })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    const requestItem = document.querySelector(`[data-request-id="${requestId}"]`);
                    if (requestItem) {
                        requestItem.style.opacity = '0.5';
                        requestItem.style.transform = 'scale(0.95)';
                        setTimeout(() => requestItem.remove(), 300);
                    }

                    const actionText = action === 'approve' ? 'approved' : 'rejected';
                    showNotification(`${data.username}'s request ${actionText}`, 'success');
                } else {
                    showNotification(`Error: ${data.error}`, 'error');
                }
            })
            .catch(error => {
                console.error('Error:', error);
                showNotification('Network error. Please try again.', 'error');
            });
    }

    function openImageModal(imageUrl) {
        document.getElementById('modalImage').src = imageUrl;
        document.getElementById('imageModal').style.display = 'flex';
    }

    function closeImageModal() {
        document.getElementById('imageModal').style.display = 'none';
    }

    // NEW: Debug functions for viewed stories
    function clearViewedStories() {
        localStorage.removeItem('viewedStories');
        viewedStories = {};
        location.reload();
    }

    function debugViewedStories() {
        console.log('Current viewed stories:', viewedStories);
        console.log('LocalStorage:', localStorage.getItem('viewedStories'));
    }

    // Touch gesture support for story navigation
    let touchStartX = 0;
    let touchStartY = 0;
    let touchEndX = 0;
    let touchEndY = 0;

    // Scroll stories in the stories section
    function scrollStories(direction) {
        const container = document.getElementById('storiesContainer');
        if (!container) return;

        const scrollAmount = 200;
        container.scrollBy({
            left: direction * scrollAmount,
            behavior: 'smooth'
        });

        // Update scroll buttons visibility after scroll
        setTimeout(updateScrollButtons, 300);
    }

    function updateScrollButtons() {
        const container = document.getElementById('storiesContainer');
        const leftBtn = document.querySelector('.stories-scroll-left');
        const rightBtn = document.querySelector('.stories-scroll-right');

        if (!container || !leftBtn || !rightBtn) return;

        const canScrollLeft = container.scrollLeft > 0;
        const canScrollRight = container.scrollLeft < (container.scrollWidth - container.clientWidth - 10);

        leftBtn.style.display = canScrollLeft ? 'flex' : 'none';
        rightBtn.style.display = canScrollRight ? 'flex' : 'none';
    }

    function handleTouchStart(e) {
        touchStartX = e.changedTouches[0].screenX;
        touchStartY = e.changedTouches[0].screenY;
        // Pause the story timer while user is touching
        stopStoryTimer();
    }

    function handleTouchEnd(e) {
        touchEndX = e.changedTouches[0].screenX;
        touchEndY = e.changedTouches[0].screenY;
        handleSwipe();
    }

    function handleSwipe() {
        const horizontalSwipe = touchEndX - touchStartX;
        const verticalSwipe = touchEndY - touchStartY;
        const minSwipeDistance = 50;

        // Only handle horizontal swipes if they're more significant than vertical
        if (Math.abs(horizontalSwipe) > Math.abs(verticalSwipe) && Math.abs(horizontalSwipe) > minSwipeDistance) {
            if (horizontalSwipe < 0) {
                // Swipe left - next story
                navigateStory(1);
            } else {
                // Swipe right - previous story
                navigateStory(-1);
            }
        } else if (Math.abs(verticalSwipe) > minSwipeDistance * 2) {
            // Significant vertical swipe down - close story
            if (verticalSwipe > 0) {
                closeStoryModal();
            }
        } else {
            // Resume timer if no significant swipe
            if (currentStoriesData.length > 0) {
                startStoryTimer();
            }
        }
    }

    // Initialize touch events for story viewer
    function initializeStoryTouchEvents() {
        const storyWrapper = document.querySelector('.story-content-wrapper');
        if (storyWrapper) {
            storyWrapper.addEventListener('touchstart', handleTouchStart, false);
            storyWrapper.addEventListener('touchend', handleTouchEnd, false);
        }
    }

    // Tap zones for story navigation (left/right third of screen)
    function handleStoryTap(e) {
        const storyWrapper = document.querySelector('.story-view-wrapper');
        if (!storyWrapper) return;

        const rect = storyWrapper.getBoundingClientRect();
        const tapX = e.clientX - rect.left;
        const width = rect.width;

        // Left third - previous, right third - next, middle - pause/resume
        if (tapX < width * 0.3) {
            navigateStory(-1);
        } else if (tapX > width * 0.7) {
            navigateStory(1);
        } else {
            // Middle tap - toggle pause
            if (storyTimerInterval) {
                stopStoryTimer();
                showNotification('Story paused', 'info');
            } else {
                startStoryTimer();
            }
        }
    }

    // Generate story ring segments (Instagram-style)
    function generateStorySegments() {
        const storyRings = document.querySelectorAll('.story-ring[data-story-count]');

        storyRings.forEach(ring => {
            const count = parseInt(ring.getAttribute('data-story-count')) || 1;
            const viewedCount = parseInt(ring.getAttribute('data-viewed-count')) || 0;
            const svg = ring.querySelector('.story-segments');
            const isOwnStory = ring.classList.contains('own-story-ring');
            const isAllViewed = ring.classList.contains('viewed');

            if (!svg) return;

            // Clear existing segments
            svg.innerHTML = '';

            // Add gradient definitions
            const defs = document.createElementNS('http://www.w3.org/2000/svg', 'defs');

            // Instagram-style gradient for unseen stories
            const gradient = document.createElementNS('http://www.w3.org/2000/svg', 'linearGradient');
            gradient.setAttribute('id', 'storyGradient');
            gradient.setAttribute('x1', '0%');
            gradient.setAttribute('y1', '0%');
            gradient.setAttribute('x2', '100%');
            gradient.setAttribute('y2', '100%');

            const stop1 = document.createElementNS('http://www.w3.org/2000/svg', 'stop');
            stop1.setAttribute('offset', '0%');
            stop1.setAttribute('style', 'stop-color:#f09433');

            const stop2 = document.createElementNS('http://www.w3.org/2000/svg', 'stop');
            stop2.setAttribute('offset', '25%');
            stop2.setAttribute('style', 'stop-color:#e6683c');

            const stop3 = document.createElementNS('http://www.w3.org/2000/svg', 'stop');
            stop3.setAttribute('offset', '50%');
            stop3.setAttribute('style', 'stop-color:#dc2743');

            const stop4 = document.createElementNS('http://www.w3.org/2000/svg', 'stop');
            stop4.setAttribute('offset', '75%');
            stop4.setAttribute('style', 'stop-color:#cc2366');

            const stop5 = document.createElementNS('http://www.w3.org/2000/svg', 'stop');
            stop5.setAttribute('offset', '100%');
            stop5.setAttribute('style', 'stop-color:#bc1888');

            gradient.appendChild(stop1);
            gradient.appendChild(stop2);
            gradient.appendChild(stop3);
            gradient.appendChild(stop4);
            gradient.appendChild(stop5);
            defs.appendChild(gradient);

            // Purple gradient for own stories
            const ownGradient = document.createElementNS('http://www.w3.org/2000/svg', 'linearGradient');
            ownGradient.setAttribute('id', 'ownStoryGradient');
            ownGradient.setAttribute('x1', '0%');
            ownGradient.setAttribute('y1', '0%');
            ownGradient.setAttribute('x2', '100%');
            ownGradient.setAttribute('y2', '100%');

            const ownStop1 = document.createElementNS('http://www.w3.org/2000/svg', 'stop');
            ownStop1.setAttribute('offset', '0%');
            ownStop1.setAttribute('style', 'stop-color:#667eea');

            const ownStop2 = document.createElementNS('http://www.w3.org/2000/svg', 'stop');
            ownStop2.setAttribute('offset', '50%');
            ownStop2.setAttribute('style', 'stop-color:#7c3aed');

            const ownStop3 = document.createElementNS('http://www.w3.org/2000/svg', 'stop');
            ownStop3.setAttribute('offset', '100%');
            ownStop3.setAttribute('style', 'stop-color:#764ba2');

            ownGradient.appendChild(ownStop1);
            ownGradient.appendChild(ownStop2);
            ownGradient.appendChild(ownStop3);
            defs.appendChild(ownGradient);

            svg.appendChild(defs);

            // Calculate segment parameters
            const radius = 46;
            const circumference = 2 * Math.PI * radius;
            const gap = count > 1 ? 8 : 0; // Gap between segments in degrees (increased from 4)
            const totalGap = gap * count;
            const segmentAngle = (360 - totalGap) / count;
            const segmentLength = (segmentAngle / 360) * circumference;
            const gapLength = (gap / 360) * circumference;

            // Create segments
            for (let i = 0; i < count; i++) {
                const circle = document.createElementNS('http://www.w3.org/2000/svg', 'circle');
                circle.setAttribute('cx', '50');
                circle.setAttribute('cy', '50');
                circle.setAttribute('r', radius.toString());
                circle.classList.add('story-segment');

                // Determine if this segment is viewed
                const isViewed = isAllViewed || i < viewedCount;

                if (isViewed) {
                    circle.classList.add('seen');
                    circle.setAttribute('stroke', '#94a3b8');
                } else {
                    circle.classList.add('unseen');
                    if (isOwnStory) {
                        circle.setAttribute('stroke', 'url(#ownStoryGradient)');
                    } else {
                        circle.setAttribute('stroke', 'url(#storyGradient)');
                    }
                }

                // Set dash array for segment
                circle.setAttribute('stroke-dasharray', `${segmentLength} ${circumference}`);

                // Rotate to position each segment
                const rotateAngle = i * (segmentAngle + gap);
                circle.setAttribute('stroke-dashoffset', -((rotateAngle / 360) * circumference).toString());

                svg.appendChild(circle);
            }
        });
    }

    // ENHANCED: Initialize when DOM loads
    document.addEventListener('DOMContentLoaded', function () {
        console.log('Dashboard initialized with ENHANCED multiple stories support + image fixes + viewed stories');

        // Initialize Lucide icons
        if (window.lucide && window.lucide.createIcons) {
            window.lucide.createIcons();
            console.log('‚úÖ Lucide icons initialized on dashboard');
        } else {
            console.warn('‚ö†Ô∏è Lucide library not loaded on dashboard');
        }

        // Generate story ring segments
        generateStorySegments();

        // ============================================
        // MOBILE BOTTOM NAVBAR EVENT LISTENERS
        // ============================================
        const chatsTabBtn = document.getElementById('chatsTabBtn');
        const homeTabBtn = document.getElementById('homeTabBtn');
        const searchTabBtn = document.getElementById('searchTabBtn');
        const moreTabBtn = document.getElementById('moreTabBtn');

        if (chatsTabBtn) {
            chatsTabBtn.onclick = function (e) {
                e.preventDefault();
                console.log('üîµ Chats button clicked');
                openMobileModal('chats');
            };
        }

        if (homeTabBtn) {
            homeTabBtn.onclick = function (e) {
                e.preventDefault();
                console.log('üè† Home button clicked');
                closeAllMobileModals();
                scrollToTop();
            };
        }

        if (searchTabBtn) {
            searchTabBtn.onclick = function (e) {
                e.preventDefault();
                console.log('üîç Search button clicked');
                openMobileModal('search');
            };
        }

        if (moreTabBtn) {
            moreTabBtn.onclick = function (e) {
                e.preventDefault();
                console.log('‚öôÔ∏è More button clicked');
                openMobileModal('more');
            };
        }

        // Setup navbar buttons inside modals
        const searchTabBtnInChat = document.getElementById('searchTabBtnInChat');
        const moreTabBtnInChat = document.getElementById('moreTabBtnInChat');
        const chatsTabBtnInSearch = document.getElementById('chatsTabBtnInSearch');
        const moreTabBtnInSearch = document.getElementById('moreTabBtnInSearch');

        if (searchTabBtnInChat) {
            searchTabBtnInChat.onclick = function (e) {
                e.preventDefault();
                openMobileModal('search');
            };
        }
        if (moreTabBtnInChat) {
            moreTabBtnInChat.onclick = function (e) {
                e.preventDefault();
                openMobileModal('more');
            };
        }
        if (chatsTabBtnInSearch) {
            chatsTabBtnInSearch.onclick = function (e) {
                e.preventDefault();
                openMobileModal('chats');
            };
        }
        if (moreTabBtnInSearch) {
            moreTabBtnInSearch.onclick = function (e) {
                e.preventDefault();
                openMobileModal('more');
            };
        }

        console.log('‚úÖ Mobile bottom navbar initialized');
        // ============================================

        // Initialize all components
        initializeTweetComposer();
        initializeTweetImages();
        initializeStoryTouchEvents();
        updateScrollButtons();

        // Add scroll listener to stories container
        const storiesContainer = document.getElementById('storiesContainer');
        if (storiesContainer) {
            storiesContainer.addEventListener('scroll', updateScrollButtons);
        }

        // Check and update viewed stories after page loads
        setTimeout(() => {
            checkViewedStories();
            checkStoryInboxCount(); // Check for new story replies
        }, 500);

        const createGroupBtn = document.getElementById('createGroupBtn');
        const mobileCreateGroupBtn = document.getElementById('mobileCreateGroupBtn');

        if (createGroupBtn) {
            createGroupBtn.addEventListener('click', openCreateGroupModal);
        }
        if (mobileCreateGroupBtn) {
            mobileCreateGroupBtn.addEventListener('click', openCreateGroupModal);
        }

        const userSearchInput = document.getElementById('userSearchInput');
        const userSearchInputAlt = document.getElementById('userSearchInputAlt');

        if (userSearchInput) {
            userSearchInput.addEventListener('keyup', searchUsers);
        }
        if (userSearchInputAlt) {
            userSearchInputAlt.addEventListener('keyup', searchUsersAlt);
        }

        document.addEventListener('click', function (e) {
            if (e.target.classList.contains('mobile-modal') && e.target.classList.contains('active')) {
                closeMobileModal();
            }
        });

        // ENHANCED: Add keyboard navigation for stories
        document.addEventListener('keydown', function (e) {
            if (document.getElementById('storyViewModal').style.display === 'flex') {
                if (e.key === 'ArrowLeft') {
                    navigateStory(-1);
                } else if (e.key === 'ArrowRight') {
                    navigateStory(1);
                } else if (e.key === 'Escape') {
                    closeStoryModal();
                }
            }
        });

        console.log('Enhanced dashboard loaded with:');
        console.log('‚úÖ Multiple stories navigation');
        console.log('‚úÖ Instagram-style viewed stories tracking');
        console.log('‚úÖ Enhanced tweet image aspect ratio handling');
        console.log('‚úÖ Story count indicators with pulse animation');
        console.log('‚úÖ Keyboard navigation (arrow keys + ESC)');
        console.log('‚úÖ LocalStorage persistence for viewed states');
        console.log('‚úÖ Touch/swipe gestures for story navigation');
        console.log('‚úÖ Auto-advance progress bars');
        console.log('‚úÖ Story tap zones (left/middle/right)');
        console.log('‚úÖ Story Replies Inbox');
    });

    // Make story functions available globally
    window.viewUserStories = viewUserStories;
    window.openStoryModal = openStoryModal;
    window.scrollStories = scrollStories;
    window.openStoryInbox = openStoryInbox;

    // Make debug functions available globally
    window.clearViewedStories = clearViewedStories;
    window.debugViewedStories = debugViewedStories;

    console.log('Enhanced dashboard JavaScript loaded! üéâ‚ú®üéØ');
    console.log('New features:');
    console.log('üñºÔ∏è  Fixed tweet image aspect ratios - no more cropping!');
    console.log('üëÅÔ∏è  Instagram-style viewed stories with gray rings');
    console.log('üíæ Viewed stories persist across sessions');
    console.log('‚å®Ô∏è  Keyboard navigation: ‚Üê ‚Üí arrows, ESC to close');
    console.log('üëÜ Touch/swipe gestures for mobile');
    console.log('‚è±Ô∏è  Auto-advance with progress bars');
    console.log('üì¨ Story Replies Inbox');
</script>
{% endblock %}